                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="תמלול">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
    
    <title>מערכת תמלול למטפלים - אפליקציה</title>
    
    <!-- ספריית הצפנה -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        /* Header */
        .navbar {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 2px 20px rgba(99, 102, 241, 0.15);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #6366f1;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-links a {
            color: #64748b;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #6366f1;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* App Section */
        .app-section {
            padding: 60px 0;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .app-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .section {
            margin-bottom: 40px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        .section h2 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.8em;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 12px;
            font-weight: 600;
        }

        /* Modern Form Styling */
        .modern-form-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.12);
            border: 1px solid rgba(99, 102, 241, 0.1);
            position: relative;
            overflow: hidden;
        }

        .modern-form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
        }

        .modern-form-section h2 {
            color: #1e293b;
            margin-bottom: 28px;
            font-size: 1.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            border: none;
            padding: 0;
        }

        .modern-form-section h2::before {
            content: '🎤';
            font-size: 0.9em;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .modern-form-group {
            position: relative;
        }

        .modern-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modern-form-group input, 
        .modern-form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            background: white;
            color: #1f2937;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .modern-form-group input:focus, 
        .modern-form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-1px);
        }

        .modern-form-group input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        .input-mode-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .input-mode-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .input-mode-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #64748b;
            border: 2px solid #e5e7eb;
            padding: 14px 28px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .input-mode-btn:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .input-mode-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .input-mode-btn.active:hover {
            background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        /* Enhanced Action Button */
        .enhanced-transcribe-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 32px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .enhanced-transcribe-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .enhanced-transcribe-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .enhanced-transcribe-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
        }

        .enhanced-transcribe-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            color: #1f2937;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input::placeholder {
            color: #9ca3af;
        }

        .form-group small {
            color: #6b7280;
            font-size: 12px;
        }

        .recording-section {
            text-align: center;
            margin: 30px 0;
        }

        .record-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .record-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            animation: pulse 1s infinite;
        }

        .record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .upload-area {
            border: 2px dashed #6366f1;
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            background: #f8fafc;
            margin: 24px 0;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .upload-area:hover {
            border-color: #8b5cf6;
            background: #f0f9ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #10b981;
            background: #ecfdf5;
            color: #059669;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
        }

        .file-label:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .transcribe-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }

        .transcribe-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .transcribe-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            padding: 16px 24px;
            border-radius: 12px;
            margin: 24px 0;
            font-weight: 500;
            text-align: center;
            border: 1px solid transparent;
        }

        .status.loading {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #93c5fd;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }

        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }

        .result-area {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            direction: rtl;
            position: relative;
            color: #1f2937;
        }

        .result-area:empty::before {
            content: "התמלול יופיע כאן...";
            color: #9ca3af;
            font-style: italic;
        }

        .result-tabs {
            display: flex;
            margin-top: 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .result-tab {
            padding: 16px 24px;
            cursor: pointer;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            margin-left: 0;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6b7280;
            flex: 1;
            text-align: center;
        }

        .result-tab.active {
            background: white;
            border-bottom-color: #2563eb;
            color: #2563eb;
        }

        .result-tab:hover:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }

        .text-editor {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            margin-top: 16px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.8;
            direction: rtl;
            resize: vertical;
            width: 100%;
            font-family: inherit;
            outline: none;
            color: #1f2937;
        }

        .text-editor:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .text-editor::placeholder {
            color: #9ca3af;
        }

        .patients-section {
            background: transparent;
        }

        .patients-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .patient-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .patient-card:hover {
            border-color: #2563eb;
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .patient-card h3 {
            color: #1e293b;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .patient-card p {
            color: #64748b;
        }

        .delete-patient-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, #fca5a5 0%, #fecaca 100%);
            color: #7f1d1d;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(252, 165, 165, 0.6);
            z-index: 10;
            border: 2px solid rgba(127, 29, 29, 0.3);
        }

        .delete-patient-btn:hover {
            background: linear-gradient(135deg, #f87171 0%, #fca5a5 100%);
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(248, 113, 113, 0.8);
            border-color: rgba(127, 29, 29, 0.5);
            color: #7f1d1d;
        }

        .delete-session-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #fca5a5 0%, #fecaca 100%);
            color: #7f1d1d;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(252, 165, 165, 0.6);
            transition: all 0.3s ease;
            z-index: 10;
            border: 2px solid rgba(127, 29, 29, 0.3);
        }

        .delete-session-btn:hover {
            background: linear-gradient(135deg, #f87171 0%, #fca5a5 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(248, 113, 113, 0.8);
            border-color: rgba(127, 29, 29, 0.5);
            color: #7f1d1d;
        }

        .corrections-info {
            background: #ecfdf5;
            border: 1px solid #86efac;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            display: none;
        }

        .corrections-info.show {
            display: block;
        }

        .corrections-info h4 {
            color: #059669;
            margin-bottom: 12px;
        }

        .corrections-list {
            list-style: none;
            padding: 0;
            margin: 12px 0 0 0;
        }

        .corrections-list li {
            background: white;
            color: #1f2937;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            border-right: 4px solid #10b981;
        }

        .text-stats {
            background: #f8fafc;
            color: #64748b;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-size: 14px;
            border: 1px solid #e5e7eb;
        }

        .edit-controls {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .edit-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .fix-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
        }

        .fix-btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .revert-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .revert-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
        }

        .copy-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .save-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .sessions-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 95%;
            max-height: 85%;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            color: #1f2937;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .session-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #1f2937;
        }

        .session-item:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .session-item h4 {
            color: #2563eb;
            margin-bottom: 8px;
        }

        .session-item p {
            color: #64748b;
            margin: 4px 0;
        }

        .session-item small {
            color: #9ca3af;
        }

        .audio-player {
            width: 100%;
            margin: 15px 0;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .modern-form-section {
                padding: 20px 16px;
                margin-bottom: 20px;
                border-radius: 16px;
            }

            .form-grid {
                gap: 20px;
            }

            .modern-form-group input,
            .modern-form-group select {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 12px;
            }

            .input-mode-section {
                padding: 20px 16px;
                margin-bottom: 20px;
            }

            .input-mode-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .input-mode-btn {
                width: 100%;
                padding: 14px 20px;
                min-width: auto;
                font-size: 15px;
            }

            .enhanced-transcribe-btn {
                padding: 16px 28px;
                font-size: 17px;
                margin-top: 24px;
                border-radius: 16px;
            }

            .modern-form-section h2 {
                font-size: 1.5em;
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }

            .modern-form-section h2::before {
                font-size: 1.2em;
                padding: 10px;
            }

            /* Improved form labels for mobile */
            .modern-form-group label {
                font-size: 14px;
                margin-bottom: 10px;
            }

            /* Better upload area for mobile */
            .upload-area {
                padding: 30px 16px;
                margin: 20px 0;
            }

            .file-label {
                padding: 14px 24px;
                font-size: 15px;
            }

            /* Responsive recording section */
            .recording-section {
                margin: 20px 0;
            }

            .record-btn {
                width: 100%;
                max-width: 280px;
                padding: 16px 32px;
                font-size: 16px;
            }

            /* Better text input for mobile */
            #directTextInput {
                min-height: 150px;
                padding: 14px;
                font-size: 16px;
                border-radius: 12px;
            }

            /* Responsive tabs */
            .result-tabs {
                border-radius: 12px 12px 0 0;
            }

            .result-tab {
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Better modal for mobile */
            .modal-content {
                width: 95%;
                padding: 24px 16px;
                margin: 20px;
                max-height: 90vh;
            }

            /* Improved action buttons */
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .action-btn {
                width: 100%;
                padding: 14px 24px;
                font-size: 15px;
            }

            /* Better patient cards */
            .patient-card {
                padding: 20px 16px;
                margin-bottom: 12px;
            }

            /* Improved instructions */
            #whatsappInstructions {
                padding: 20px 16px;
                margin: 16px 0;
            }

            /* Small screen nav */
            .nav-container {
                padding: 0 16px;
            }

            .nav-links {
                display: none;
            }

            /* Focus improvements for mobile */
            .modern-form-group input:focus,
            .modern-form-group select:focus {
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                transform: none; /* Remove transform on mobile for better UX */
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .modern-form-section {
                padding: 16px 12px;
                margin-bottom: 16px;
            }

            .modern-form-section h2 {
                font-size: 1.4em;
            }

            .enhanced-transcribe-btn {
                padding: 14px 24px;
                font-size: 16px;
            }

            .input-mode-btn {
                padding: 12px 16px;
                font-size: 14px;
            }
        }

        /* אנימציות לסנכרון אוטומטי */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes syncPulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .sync-active {
            animation: syncPulse 2s ease-in-out infinite;
        }

        /* סטיילים למודל סיסמת הצפנה */
        #modalEncryptionPassword:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
        }

        .password-strength-weak {
            color: #ef4444;
        }

        .password-strength-medium {
            color: #f59e0b;
        }

        .password-strength-strong {
            color: #10b981;
        }

        /* אנימציה למודל סיסמה */
        #encryptionPasswordModal .modal-content {
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">🎤 תמלול מקצועי</a>
            <ul class="nav-links">
                <li><a href="/">דף הבית</a></li>
            </ul>
            
            <!-- User Info Section -->
            <div id="userSection" style="display: none;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="userGreeting" style="color: #1e293b; font-weight: 600;"></span>
                    <button id="logoutBtn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">🚪 יציאה</button>
                </div>
            </div>
            
            <!-- Login Button (shown when not authenticated) -->
            <button id="loginButton" class="cta-button" onclick="openLoginModal()">כניסה למערכת</button>
        </div>
    </nav>

    <!-- App Section -->
    <section class="app-section">
        <div class="container">
            <div class="app-container">
                <!-- תמלול חדש -->
                <div class="modern-form-section">
                    <h2>תמלול חדש</h2>
                    
                    <!-- בחירת סוג קלט -->
                    <div class="input-mode-section">
                        <div class="input-mode-buttons">
                            <button id="audioModeBtn" class="input-mode-btn active" onclick="switchInputMode('audio')">
                                🎵 קובץ שמע
                            </button>
                            <button id="textModeBtn" class="input-mode-btn" onclick="switchInputMode('text')">
                                📝 הכנס טקסט
                            </button>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="modern-form-group">
                            <label for="patientName">👤 שם המטופל:</label>
                            <input type="text" id="patientName" placeholder="הזן שם המטופל" value="" required autocomplete="off">
                        </div>

                        <div class="modern-form-group">
                            <label for="sessionDate">📅 תאריך הסשן:</label>
                            <input type="date" id="sessionDate">
                        </div>

                        <div id="qualityModeSection" class="modern-form-group">
                            <label for="qualityMode">⚙️ בחר שירות תמלול:</label>
                            <select id="qualityMode">
                                <option value="ivrit-ai">🏆 ivrit.ai - מותאם במיוחד לעברית (מקומי + מוצפן)</option>
                                <option value="assemblyai">⚠️ AssemblyAI - דיוק גבוה (ענן - לא מוצפן!)</option>
                                <option value="secure-assemblyai" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-weight: bold;">🔐 AssemblyAI מאובטח - הצפנה מקסימלית!</option>
                                <option value="hybrid-encrypted" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold;">🛡️ תמלול היברידי מוצפן - חיסיון מוחלט!</option>
                            </select>
                            <small>
                                <strong>🛡️ רמות פרטיות שונות:</strong><br>
                                🏆 <strong>ivrit.ai:</strong> עיבוד מקומי מותאם לעברית + הצפנה<br>
                                ⚠️ <strong>AssemblyAI רגיל:</strong> עיבוד בענן - השמע והתמלול נשלחים פתוחים!<br>
                                🔐 <strong>AssemblyAI מאובטח:</strong> עיבוד בענן + הצפנה מיידית של התוצאות + מחיקה מאובטחת<br>
                                🛡️ <strong>היברידי מוצפן:</strong> תמלול + הצפנה + סנכרון אוטומטי לענן<br><br>
                                ✅ <strong>הצפנה דו-שכבתית:</strong> כל הנתונים מוצפנים עם הסיסמה האישית שלך<br>
                                ✅ <strong>סנכרון בין מכשירים:</strong> גש לסשנים שלך מכל מכשיר עם הסיסמה<br>
                                ✅ <strong>גיבוי אוטומטי:</strong> הכל נשמר מוצפן בענן
                            </small>
                        </div>
                    </div>

                    <!-- שדה סיסמת הצפנה - מוצג רק במצב היברידי -->
                    <div id="encryptionPasswordSection" class="modern-form-group" style="display: none;">
                        <label for="encryptionPassword">🔐 סיסמת הצפנה אישית:</label>
                        <input type="password" id="encryptionPassword" placeholder="הזן את סיסמת ההצפנה האישית שלך">
                        <small style="color: #ef4444; font-weight: 600;">
                            📝 <strong>חשוב:</strong> זו הסיסמה האישית שלך להצפנה. בלעדיה לא תוכל לגשת לסשנים מוצפנים!<br>
                            💡 אם עדיין לא יצרת סיסמת הצפנה, לחץ על כפתור "🔒 הצפנה" למעלה
                        </small>
                    </div>

                    <!-- הקלטה -->
                    <div id="recordingSection" class="recording-section">
                        <h3>הקלטה ישירה</h3>
                        <button id="recordBtn" class="record-btn">🎤 התחל הקלטה</button>
                        <div id="recordingStatus" style="display: none; margin-top: 15px; color: #dc2626; font-weight: bold;">
                            🔴 מקליט... <span id="recordingTime">00:00</span>
                        </div>
                        <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 15px;"></audio>
                    </div>

                    <!-- העלאת קובץ שמע -->
                    <div id="audioInputSection">
                        <div class="upload-area" id="uploadArea">
                            <div style="font-size: 2em; margin-bottom: 15px;">📁</div>
                            <p><strong>גרור קובץ שמע לכאן או לחץ לבחירה</strong></p>
                            <p style="margin: 10px 0; font-size: 14px;">תומך ב: MP3, WAV, M4A, WEBM, OGG, OPUS</p>
                            <label for="audioFile" class="file-label">בחר קובץ שמע</label>
                            <input type="file" id="audioFile" class="file-input" accept="audio/*">
                            <div id="fileName" style="margin-top: 15px; font-weight: bold; color: #2563eb;"></div>
                        </div>
                    </div>

                    <!-- הכנסת טקסט ישיר -->
                    <div id="textInputSection" style="display: none;">
                        <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 16px; padding: 24px; margin: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label for="directTextInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">📝 הכנס טקסט ישירות:</label>
                                <textarea id="directTextInput" placeholder="הדבק או הקלד כאן את הטקסט שברצונך לעבד..." style="width: 100%; min-height: 200px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; line-height: 1.6; resize: vertical; font-family: inherit; direction: rtl;"></textarea>
                            </div>
                            <div style="color: #6b7280; font-size: 14px;">
                                💡 <strong>טיפ:</strong> אפשר להדביק טקסט מתמלול קיים, ממסך, או כל טקסט אחר שברצונך לתקן ולעבד
                            </div>
                        </div>
                    </div>

                    <!-- הוראות לקבצי ווטסאפ -->
                    <div id="whatsappInstructions" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #0ea5e9; border-radius: 12px; padding: 24px; margin: 20px 0;">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left: 8px; flex-shrink: 0;">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.516" fill="#25D366"/>
                            </svg>
                            <h4 style="color: #0f172a; margin: 0; font-size: 16px; font-weight: 600;">העברת קובץ שמע מווטסאפ</h4>
                        </div>
                        
                        <div style="color: #475569; font-size: 14px; line-height: 1.6; text-align: right;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #0ea5e9; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-left: 8px; flex-shrink: 0;">1</span>
                                <span>לחץ על הודעת השמע בווטסאפ</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #0ea5e9; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-left: 8px; flex-shrink: 0;">2</span>
                                <span>בחר "Share" או "שתף"</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <span style="background: #0ea5e9; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-left: 8px; flex-shrink: 0;">3</span>
                                <span>בחר את אפליקציית התמלול</span>
                            </div>
                        </div>
                    </div>

                    <button id="transcribeBtn" class="enhanced-transcribe-btn" disabled>🎯 התחל תמלול</button>

                    <div id="status" class="status" style="display: none;"></div>

                    <!-- תוצאות -->
                    <div id="resultsSection" style="display: none;">
                        <div class="result-tabs">
                            <button class="result-tab active" data-tab="original">טקסט מקורי</button>
                            <button class="result-tab" data-tab="corrected">טקסט מתוקן</button>
                            <button class="result-tab" data-tab="edited">עריכה ידנית</button>
                        </div>

                        <div id="originalResult" class="result-area"></div>
                        <div id="correctedResult" class="result-area" style="display: none;"></div>
                        
                        <div id="editedSection" style="display: none;">
                            <textarea id="textEditor" class="text-editor" placeholder="ערוך את הטקסט כאן..."></textarea>
                            <div class="edit-controls">
                                <button id="fixTextBtn" class="edit-btn fix-btn">🔧 תקן טקסט</button>
                                <button id="revertBtn" class="edit-btn revert-btn">↶ חזור למקור</button>
                            </div>
                        </div>

                        <div id="correctionsInfo" class="corrections-info">
                            <h4>תיקונים שבוצעו:</h4>
                            <ul id="correctionsList" class="corrections-list"></ul>
                        </div>

                        <div id="textStats" class="text-stats"></div>

                        <div class="action-buttons" style="justify-content: center;">
                            <button id="copyBtn" class="action-btn copy-btn">📋 העתק טקסט</button>
                            <button id="saveBtn" class="action-btn save-btn">💾 שמור סשן</button>
                            <button id="generateFormBtn" class="action-btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white;">📋 צור טופס טיפול</button>
                        </div>
                    </div>
                </div>

                <!-- סנכרון בין מכשירים -->
                <div class="section" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid rgba(6, 182, 212, 0.2);">
                    <h2 style="color: #0891b2; border-bottom-color: #0891b2;">🔄 סנכרון בין מכשירים</h2>
                    
                    <div style="background: rgba(255, 255, 255, 0.8); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="color: #0f172a; margin-bottom: 15px; font-size: 16px;">
                            <strong>🛡️ סנכרון מאובטח:</strong> כל הנתונים מוצפנים עם הסיסמה האישית שלך לפני השליחה לענן
                        </p>
                        
                        <div id="syncStatus" style="background: #f8fafc; border: 1px solid #e5e7eb; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; color: #64748b;">
                            🔄 מתחיל סנכרון אוטומטי...
                        </div>
                        
                        <!-- מחוון סנכרון אוטומטי -->
                        <div id="autoSyncIndicator" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid rgba(6, 182, 212, 0.3); padding: 20px; border-radius: 16px; margin: 20px 0; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 15px;">
                                <div id="syncSpinner" style="width: 24px; height: 24px; border: 3px solid #e0f2fe; border-top: 3px solid #0891b2; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <span id="autoSyncStatus" style="font-weight: 600; color: #0891b2; font-size: 16px;">סנכרון אוטומטי פעיל</span>
                            </div>
                            <div id="syncProgress" style="background: #e0f2fe; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 15px;">
                                <div id="syncProgressBar" style="background: linear-gradient(90deg, #0891b2, #06b6d4); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px; color: #0c4a6e;">
                                <span id="lastSyncTime">סנכרון אחרון: טוען...</span>
                                <span id="nextSyncTime">סנכרון הבא: 30 שניות</span>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                            <button id="syncToCloudBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 16px 24px; font-size: 16px; font-weight: 600; opacity: 0.7;" disabled>
                                📤 סנכרון אוטומטי פעיל
                            </button>
                            
                            <button id="syncFromCloudBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 16px 24px; font-size: 16px; font-weight: 600; opacity: 0.7;" disabled>
                                📥 סנכרון אוטומטי פעיל
                            </button>
                            
                            <button id="toggleAutoSyncBtn" class="action-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 16px 24px; font-size: 16px; font-weight: 600;">
                                ⏸️ עצור סנכרון אוטומטי
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: rgba(6, 182, 212, 0.1); border-radius: 8px; font-size: 14px; color: #0f172a;">
                            💡 <strong>טיפ:</strong> הסנכרון מאפשר לך לגשת לסשנים שלך מכל מכשיר עם הסיסמת ההצפנה האישית
                        </div>
                    </div>
                </div>

                <!-- ניהול מטופלים -->
                <div id="therapistSection" class="section patients-section">
                    <h2>👨‍⚕️ ניהול מטופלים</h2>
                    
                    <!-- כפתור טעינת קבצים מקומיים -->
                    <div style="text-align: center; margin: 30px 0;">
                        <input type="file" id="localFilesInput" multiple accept=".json" style="display: none;">
                        <button id="loadLocalFilesBtn" class="action-btn" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-size: 16px; padding: 16px 32px;">
                            📂 טען קבצי תמלול מקומיים
                        </button>
                    </div>

                    <!-- רשימת קבצים מקומיים -->
                    <div id="localFilesList" style="display: none;">
                        <h3 style="color: #1e293b; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                            📋 קבצי תמלול מקומיים
                        </h3>
                        <div id="localFilesContainer"></div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <!-- מודלים -->
    <div id="sessionsModal" class="sessions-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeSessions()">×</button>
            <h2 id="modalTitle">סשנים של מטופל</h2>
            <div id="sessionsList"></div>
        </div>
    </div>

    <div id="sessionContentModal" class="sessions-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeSessionContent()">×</button>
            <h2 id="sessionContentTitle">תוכן סשן</h2>
            <div id="sessionContentBody"></div>
        </div>
    </div>

    <div id="treatmentFormModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-modal" onclick="closeTreatmentForm()">×</button>
            <h2>טופס טיפול מקצועי</h2>
            <div id="treatmentFormContent"></div>
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="copyTreatmentForm()" class="action-btn copy-btn">📋 העתק טופס</button>
                <button onclick="exportTreatmentForm()" class="action-btn" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white;">📄 ייצא לWord</button>
            </div>
        </div>
    </div>

    <!-- מודל בחירת פעולה לסשן קיים -->
    <div id="sessionChoiceModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="closeSessionChoice()">×</button>
            <h2 style="color: #f59e0b; text-align: center; margin-bottom: 30px;">⚠️ קיים סשן באותו תאריך</h2>
            
            <div id="existingSessionInfo" style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e5e7eb;">
                <!-- פרטי הסשן הקיים יוצגו כאן -->
            </div>
            
            <div style="text-align: center;">
                <p style="margin-bottom: 30px; font-size: 16px; color: #374151;">מה ברצונך לעשות?</p>
                
                <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto;">
                    <button id="replaceSessionBtn" class="action-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; width: 100%;">
                        🔄 החלף את הסשן הקיים
                    </button>
                    
                    <button id="createNewSessionBtn" class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; width: 100%;">
                        ➕ צור סשן חדש עם חותמת זמן
                    </button>
                    
                    <button id="cancelSaveBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; width: 100%;">
                        ❌ ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודל אישור מחיקה -->
    <div id="deleteConfirmModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeDeleteConfirm()">×</button>
            <h2 id="deleteConfirmTitle" style="color: #ef4444; text-align: center; margin-bottom: 30px;">⚠️ אישור מחיקה</h2>
            
            <div id="deleteConfirmMessage" style="background: #fef2f2; border: 1px solid #fecaca; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: center; color: #7f1d1d; font-size: 16px; line-height: 1.6;">
                <!-- הודעת האישור תוצג כאן -->
            </div>
            
            <div style="text-align: center;">
                <div style="display: flex; gap: 15px; max-width: 300px; margin: 0 auto;">
                    <button id="confirmDeleteBtn" class="action-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; flex: 1;">
                        🗑️ מחק
                    </button>
                    
                    <button id="cancelDeleteBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; flex: 1;">
                        ❌ ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודל הכנסת סיסמת הצפנה -->
    <div id="encryptionPasswordModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="closeEncryptionPasswordModal()">×</button>
            <h2 style="color: #6366f1; text-align: center; margin-bottom: 30px;">🔐 הזן סיסמת הצפנה אישית</h2>
            
            <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid rgba(99, 102, 241, 0.2); padding: 25px; border-radius: 16px; margin-bottom: 30px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 3em; margin-bottom: 15px;">🛡️</div>
                    <h3 style="color: #1e293b; margin-bottom: 15px;">תמלול מאובטח עם הצפנה מקסימלית</h3>
                    <p style="color: #64748b; line-height: 1.6; margin-bottom: 20px;">
                        הסיסמה האישית שלך תשמש להצפנת התמלול בצורה מאובטחת.<br>
                        <strong>רק אתה תוכל לפענח את התמלול עם הסיסמה הזו!</strong>
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label for="modalEncryptionPassword" style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151; text-align: right;">
                        🔑 סיסמת הצפנה (לפחות 8 תווים):
                    </label>
                    <div style="position: relative;">
                        <input type="password" id="modalEncryptionPassword" 
                               placeholder="הזן סיסמה חזקה להצפנה..." 
                               style="width: 100%; padding: 16px 50px 16px 20px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; background: white; color: #1f2937; transition: all 0.3s ease; direction: ltr; text-align: center;">
                        <button type="button" id="togglePasswordVisibility" 
                                style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6b7280; cursor: pointer; font-size: 18px; padding: 5px;"
                                onclick="togglePasswordVisibility()">
                            👁️
                        </button>
                    </div>
                    <div id="passwordStrength" style="margin-top: 8px; font-size: 14px; text-align: center;"></div>
                </div>
                
                <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; gap: 10px; color: #dc2626; font-weight: 600; margin-bottom: 10px;">
                        ⚠️ <span>חשוב מאוד - זכור את הסיסמה!</span>
                    </div>
                    <ul style="color: #7f1d1d; font-size: 14px; line-height: 1.5; margin: 0; padding-right: 20px;">
                        <li>בלי הסיסמה הזו לא תוכל לקרוא את התמלול בעתיד</li>
                        <li>המערכת לא שומרת את הסיסמה - רק אתה יודע אותה</li>
                        <li>מומלץ לשמור את הסיסמה במקום בטוח</li>
                    </ul>
                </div>
            </div>
            
            <div style="text-align: center;">
                <div style="display: flex; gap: 15px; max-width: 400px; margin: 0 auto;">
                    <button id="confirmEncryptionBtn" class="action-btn" 
                            style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; flex: 1; font-size: 16px; padding: 16px 24px;" 
                            disabled>
                        🔐 התחל תמלול מאובטח
                    </button>
                    
                    <button id="cancelEncryptionBtn" class="action-btn" 
                            style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; flex: 1;">
                        ❌ ביטול
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- מודל התרעת מגבלות -->
    <div id="limitWarningModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="closeLimitWarning()">×</button>
            <h2 id="limitWarningTitle" style="color: #f59e0b; text-align: center; margin-bottom: 30px;">⚠️ הגעת למגבלה</h2>
            
            <div id="limitWarningMessage" style="background: #fffbeb; border: 1px solid #fde68a; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; color: #92400e; font-size: 16px; line-height: 1.6;">
                <!-- הודעת המגבלה תוצג כאן -->
            </div>
            
            <div style="text-align: center;">
                <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto;">
                    <button id="upgradeBtn" class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; width: 100%; font-size: 16px; padding: 16px 24px;">
                        💎 שדרג למנוי מלא
                    </button>
                    
                    <button id="closeLimitBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; width: 100%;">
                        ✅ הבנתי
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let recordingInterval;
        let currentPatientName = '';
        let currentSessionFilename = '';
        let originalTranscript = '';
        let correctedTranscript = '';
        let currentUser = null;
        let sessionToken = null;
        let userEncryptionKey = null; // מפתח הצפנה אישי של המטפל

        // פונקציה לאיפוס הטופס לתמלול חדש
        function resetFormForNewTranscription() {
            // איפוס שדות הטופס - אבל השארת תאריך נוכחי
            const patientNameField = document.getElementById('patientName');
            if (patientNameField) {
                patientNameField.value = ''; // שדה ריק עבור מטופל חדש - לא מייל!
            }
            
            const sessionDateField = document.getElementById('sessionDate');
            if (sessionDateField) {
                sessionDateField.value = new Date().toISOString().split('T')[0]; // תאריך היום
            }
            
            // איפוס קובץ שמע
            const audioFile = document.getElementById('audioFile');
            if (audioFile) {
                audioFile.value = '';
            }
            
            // איפוס שם קובץ
            const fileName = document.getElementById('fileName');
            if (fileName) {
                fileName.textContent = '';
            }
            
            // איפוס טקסט ישיר
            const directTextInput = document.getElementById('directTextInput');
            if (directTextInput) {
                directTextInput.value = '';
            }
            
            // ביטול כפתור תמלול
            const transcribeBtn = document.getElementById('transcribeBtn');
            if (transcribeBtn) {
                transcribeBtn.disabled = true;
            }
            
            // הסתרת תוצאות קודמות
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            
            // הסתרת הודעות סטטוס
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
            
            console.log('✅ הטופס אופס לתמלול חדש - שדה שם המטופל ריק');
        }

        // פונקציה לאיפוס הטופס אחרי תמלול מוצלח
        function resetAfterSuccessfulTranscription() {
            setTimeout(() => {
                resetFormForNewTranscription();
                showStatus('✨ מוכן לתמלול הבא! הטופס אופס', 'success');
            }, 3000); // המתנה של 3 שניות אחרי התמלול
        }

        // בדיקת אימות בטעינת הדף
        async function checkAuth() {
            try {
                sessionToken = localStorage.getItem('session_token');
                
                if (!sessionToken) {
                    console.log('אין session token - מפנה לדף הבית');
                    window.location.href = '/';
                    return false;
                }

                const response = await fetch('/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user_info;
                    console.log('אימות הצליח:', currentUser);
                    updateUserInterface();
                    
                    // בדיקת מגבלות אחרי אימות מוצלח
                    await checkUserLimits();
                    
                    return true;
                } else {
                    localStorage.removeItem('session_token');
                    sessionToken = null;
                    currentUser = null;
                    console.log('אימות נכשל - מפנה לדף הבית');
                    window.location.href = '/';
                    return false;
                }
            } catch (error) {
                console.error('שגיאה בבדיקת אימות:', error);
                showStatus('⚠️ שגיאה בבדיקת אימות', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return false;
            }
        }

        // בדיקת מגבלות משתמש
        async function checkUserLimits() {
            if (!currentUser || !sessionToken) return;
            
            try {
                // בדיקת מגבלת סשנים
                const sessionResponse = await fetch('/subscription/check-session-limit', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                let sessionData = null;
                if (sessionResponse.ok) {
                    sessionData = await sessionResponse.json();
                    console.log('📊 נתוני סשנים מהשרת:', sessionData);
                } else {
                    console.log('⚠️ לא הצליח לקבל נתוני סשנים מהשרת - יוצר נתונים ברירת מחדל');
                    // יצירת נתונים ברירת מחדל עם הודעה ברורה
                    sessionData = {
                        can_create_session: true,
                        sessions_used: 0,
                        sessions_limit: 5,
                        status: 'trial',
                        sessions_remaining: 5
                    };
                    console.log('📊 נתוני סשנים ברירת מחדל:', sessionData);
                }
                
                // בדיקת מגבלת מטופלים
                const patientsResponse = await fetch('/patients', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                let patientsData = null;
                if (patientsResponse.ok) {
                    patientsData = await patientsResponse.json();
                    console.log('👥 נתוני מטופלים מהשרת:', patientsData);
                } else {
                    console.log('⚠️ לא הצליח לקבל נתוני מטופלים מהשרת');
                    // יצירת נתונים ברירת מחדל
                    patientsData = {
                        patients: [],
                        patient_limits: {
                            can_add_patient: true,
                            current_patients: 0,
                            max_patients: 1,
                            status: 'trial'
                        }
                    };
                }
                
                // עדכון תצוגה פשוטה של מונה מטופלים
                updatePatientsLimitDisplay();
                
            } catch (error) {
                console.error('שגיאה בבדיקת מגבלות:', error);
                // במקרה של שגיאה, נציג נתונים ברירת מחדל
                const defaultSessionData = {
                    can_create_session: true,
                    sessions_used: 0,
                    sessions_limit: 5,
                    status: 'trial',
                    sessions_remaining: 5
                };
                const defaultPatientsData = {
                    patients: [],
                    patient_limits: {
                        can_add_patient: true,
                        current_patients: 0,
                        max_patients: 1,
                        status: 'trial'
                    }
                };
                updateCombinedLimitsDisplay(defaultSessionData, defaultPatientsData);
            }
        }


        // לוגיקה חדשה ופשוטה למגבלות משתמש חינמי
        function updatePatientsLimitDisplay() {
            const appContainer = document.querySelector('.app-container');
            if (!appContainer || !currentUser) return;
            
            // הסרת תצוגה קיימת אם יש
            const existingInfo = document.getElementById('appUserInfo');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // קבלת נתונים מקומיים
            const { patientCount, sessionCount } = getLocalUserStats();
            
            console.log('👥 מספר מטופלים:', patientCount);
            console.log('📝 מספר סשנים:', sessionCount);
            
            // יצירת תצוגה חדשה
            const userInfo = document.createElement('div');
            userInfo.id = 'appUserInfo';
            
            let statusMessage = '';
            let statusColor = '#10b981';
            let bgColor = 'rgba(16, 185, 129, 0.1)';
            let borderColor = 'rgba(16, 185, 129, 0.2)';
            let needsUpgrade = false;
            
            // לוגיקה פשוטה:
            // מטופלים: 0 או 1 מותר
            // סשנים: 0-5 מותר
            
            if (patientCount === 0) {
                statusMessage = `👥 מטופלים: 0 מתוך 1 | 📝 סשנים: ${sessionCount} מתוך 5<br>✅ ניתן להוסיף מטופל ראשון`;
            } else if (patientCount === 1) {
                if (sessionCount < 5) {
                    statusMessage = `👥 מטופלים: 1 מתוך 1 | 📝 סשנים: ${sessionCount} מתוך 5<br>✅ ניתן להוסיף עוד ${5 - sessionCount} סשנים`;
                } else {
                    statusMessage = `👥 מטופלים: 1 מתוך 1 | 📝 סשנים: ${sessionCount} מתוך 5<br>🚫 הגעת למגבלת הסשנים - מחק סשנים או שדרג`;
                    statusColor = '#ef4444';
                    bgColor = 'rgba(239, 68, 68, 0.1)';
                    borderColor = 'rgba(239, 68, 68, 0.2)';
                    needsUpgrade = true;
                }
            } else {
                // יותר ממטופל אחד - לא אמור לקרות
                statusMessage = `👥 מטופלים: ${patientCount} מתוך 1 | 📝 סשנים: ${sessionCount} מתוך 5<br>🚫 חריגה - נקה נתונים`;
                statusColor = '#ef4444';
                bgColor = 'rgba(239, 68, 68, 0.1)';
                borderColor = 'rgba(239, 68, 68, 0.2)';
                needsUpgrade = true;
            }
            
            userInfo.innerHTML = `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <span style="color: ${statusColor}; font-weight: 600; line-height: 1.4;">${statusMessage}</span>
                    ${needsUpgrade ? 
                        '<br><button onclick="openUpgradeModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">💎 שדרג למנוי מלא</button>' : 
                        ''
                    }
                    <br><button onclick="debugAndCleanStorage()" style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px; font-size: 12px;">🔧 נקה נתונים פגומים</button>
                </div>
            `;
            
            appContainer.insertBefore(userInfo, appContainer.firstChild);
        }

        // פונקציה לקבלת סטטיסטיקות מקומיות
        function getLocalUserStats() {
            if (!currentUser) return { patientCount: 0, sessionCount: 0 };
            
            const storageKey = `sessions_${currentUser.email}`;
            let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // ניקוי סשנים פגומים
            userSessions = userSessions.filter(session => 
                session && 
                session.patient_name && 
                session.patient_name.trim() !== '' &&
                session.corrected_transcript &&
                session.corrected_transcript.trim() !== ''
            );
            
            // שמירה חזרה אחרי ניקוי
            localStorage.setItem(storageKey, JSON.stringify(userSessions));
            
            // ספירת מטופלים ייחודיים
            const uniquePatients = new Set();
            userSessions.forEach(session => {
                if (session.patient_name && session.patient_name.trim()) {
                    uniquePatients.add(session.patient_name.trim());
                }
            });
            
            return {
                patientCount: uniquePatients.size,
                sessionCount: userSessions.length
            };
        }


        function showLoginButton() {
            // הצגת כפתור הכניסה
            const userSection = document.getElementById('userSection');
            const loginButton = document.getElementById('loginButton');
            
            if (userSection) {
                userSection.style.display = 'none';
            }
            if (loginButton) {
                loginButton.style.display = 'inline-block';
            }
        }

        function updateUserInterface() {
            if (currentUser) {
                // הצגת שם המשתמש בנאב בר
                const userSection = document.getElementById('userSection');
                const loginButton = document.getElementById('loginButton');
                const userGreeting = document.getElementById('userGreeting');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (userSection && loginButton && userGreeting) {
                    // הסתרת כפתור הכניסה
                    loginButton.style.display = 'none';
                    
                    // הצגת מידע המשתמש
                    userGreeting.textContent = `שלום ${currentUser.full_name}`;
                    userSection.style.display = 'block';
                    
                    // הוספת אירוע יציאה
                    if (logoutBtn) {
                        logoutBtn.onclick = logout;
                    }
                }
                
                // וידוא שדה שם המטופל ריק אחרי התחברות
                const patientNameInput = document.getElementById('patientName');
                if (patientNameInput) {
                    patientNameInput.value = '';
                    patientNameInput.defaultValue = '';
                    patientNameInput.setAttribute('value', '');
                    console.log('🧹 שדה שם המטופל נוקה אחרי התחברות');
                }
                
                // הוספת מידע משתמש בגב האפליקציה עצמה עם מידע על מגבלות
                const appContainer = document.querySelector('.app-container');
                if (appContainer && !document.getElementById('appUserInfo')) {
                    // בדיקת סטטוס מנוי
                    checkSubscriptionStatus().then(subscriptionInfo => {
                        const userInfo = document.createElement('div');
                        userInfo.id = 'appUserInfo';
                        
                        let statusMessage = '';
                        let statusColor = '#2563eb';
                        let bgColor = 'rgba(37, 99, 235, 0.1)';
                        let borderColor = 'rgba(37, 99, 235, 0.2)';
                        
                        if (subscriptionInfo && subscriptionInfo.subscription) {
                            const sub = subscriptionInfo.subscription;
                            if (sub.payment_status === 'paid') {
                                statusMessage = `💎 מנוי ${sub.subscription_type} פעיל`;
                                statusColor = '#10b981';
                                bgColor = 'rgba(16, 185, 129, 0.1)';
                                borderColor = 'rgba(16, 185, 129, 0.2)';
                            } else if (sub.subscription_type === 'trial') {
                                const remaining = sub.sessions_remaining;
                                if (remaining > 0) {
                                    statusMessage = `🆓 נותרו ${remaining} סשנים חינמיים`;
                                    statusColor = '#f59e0b';
                                    bgColor = 'rgba(245, 158, 11, 0.1)';
                                    borderColor = 'rgba(245, 158, 11, 0.2)';
                                } else {
                                    statusMessage = '⚠️ הסשנים החינמיים הסתיימו - יש לשדרג';
                                    statusColor = '#ef4444';
                                    bgColor = 'rgba(239, 68, 68, 0.1)';
                                    borderColor = 'rgba(239, 68, 68, 0.2)';
                                }
                            }
                        }
                        
                        userInfo.innerHTML = `
                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                                <span style="color: ${statusColor}; font-weight: 600;">${statusMessage}</span>
                                ${subscriptionInfo && subscriptionInfo.subscription && subscriptionInfo.subscription.sessions_remaining === 0 ? 
                                    '<br><button onclick="openUpgradeModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">💎 שדרג עכשיו</button>' : 
                                    ''
                                }
                            </div>
                        `;
                        
                        appContainer.insertBefore(userInfo, appContainer.firstChild);
                    });
                }
                
                // בדיקה אם המשתמש הוא מטפל (לפי איימייל או תפקיד)
                const isTherapist = checkIfUserIsTherapist(currentUser);
                
                // הצגת סעיף ניהול המטופלים רק למטפלים מחוברים
                const therapistSection = document.getElementById('therapistSection');
                if (therapistSection) {
                    if (isTherapist) {
                        therapistSection.style.display = 'block';
                        console.log('✅ מטפל מחובר - מציג סעיף ניהול מטופלים');
                    } else {
                        therapistSection.style.display = 'none';
                        console.log('ℹ️ משתמש רגיל - מסתיר סעיף ניהול מטופלים');
                    }
                }
                
                // הסתרת ממשק האורח והצגת מערכת התמלול
                hideGuestInterface();
            } else {
                // הסתרת סעיף ניהול המטופלים למשתמשים לא מחוברים
                const therapistSection = document.getElementById('therapistSection');
                if (therapistSection) {
                    therapistSection.style.display = 'none';
                }
                
                // הצגת ממשק האורח
                showGuestInterface();
            }
        }

        // פונקציה לבדיקה אם המשתמש הוא מטפל
        function checkIfUserIsTherapist(user) {
            if (!user) return false;
            
            // כרגע כל משתמש מחובר נחשב כמטפל
            // בעתיד ניתן להוסיף לוגיקה מתקדמת יותר:
            // - בדיקת תפקיד בבסיס הנתונים
            // - בדיקת דומיין איימייל (למשל @clinic.com)
            // - בדיקת הרשאות מיוחדות
            
            // הדוגמאות לבדיקות מתקדמות:
            // if (user.role === 'therapist') return true;
            // if (user.email.includes('@clinic.') || user.email.includes('@therapy.')) return true;
            // if (user.permissions && user.permissions.includes('patient_management')) return true;
            
            return true; // כרגע כל משתמש מחובר הוא מטפל
        }

        function showGuestInterface() {
            // באapp.html אין ממשק אורח - זה קובץ האפליקציה
            // אם המשתמש לא מחובר, נפנה אותו לדף הבית מיד
            if (!currentUser || !sessionToken) {
                console.log('🔄 משתמש לא מחובר באפליקציה - מפנה לדף הבית');
                window.location.href = '/';
                return;
            }
        }
        
        function hideGuestInterface() {
            // באפליקציה תמיד מציגים את הממשק המלא למשתמש מחובר
            console.log('✅ משתמש מחובר - מציג ממשק אפליקציה מלא');
        }
        
        async function logout() {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
            } catch (error) {
                console.error('שגיאה ביציאה:', error);
            } finally {
                // ניקוי כל המידע המקומי
                localStorage.removeItem('session_token');
                sessionToken = null;
                currentUser = null;
                
                // ניקוי הממשק מסשנים
                clearLocalTranscriptsUI();
                
                // הסתרת מידע המשתמש
                const userSection = document.getElementById('userSection');
                const loginButton = document.getElementById('loginButton');
                const appUserInfo = document.getElementById('appUserInfo');
                
                if (userSection) userSection.style.display = 'none';
                if (loginButton) loginButton.style.display = 'inline-block';
                if (appUserInfo) appUserInfo.remove();
                
                // עדכון הממשק לאחר יציאה - הצגת ממשק אורח
                showGuestInterface();
                
                // הסתרת סעיף המטפלים
                const therapistSection = document.getElementById('therapistSection');
                if (therapistSection) {
                    therapistSection.style.display = 'none';
                }
                
                showStatus('✅ יצאת מהמערכת בהצלחה', 'success');
                
                // מעבר לדף הבית לאחר יציאה
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            }
        }

        // פונקציה לניקוי ממשק התמלולים המקומיים
        function clearLocalTranscriptsUI() {
            const localFilesList = document.getElementById('localFilesList');
            const localFilesContainer = document.getElementById('localFilesContainer');
            
            if (localFilesList) {
                localFilesList.style.display = 'none';
            }
            if (localFilesContainer) {
                localFilesContainer.innerHTML = '';
            }
            
            console.log('🧹 ממשק התמלולים המקומיים נוקה');
        }

        // פונקציות הקלטה
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    
                    // יצירת קובץ להעלאה
                    const file = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('audioFile').files = dataTransfer.files;
                    
                    updateFileName('recording.wav');
                    document.getElementById('transcribeBtn').disabled = false;
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                document.getElementById('recordBtn').textContent = '⏹️ עצור הקלטה';
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingStatus').style.display = 'block';
                
                recordingInterval = setInterval(updateRecordingTime, 1000);
                
            } catch (error) {
                console.error('שגיאה בהקלטה:', error);
                showStatus('שגיאה בגישה למיקרופון', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('recordBtn').textContent = '🎤 התחל הקלטה';
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordingStatus').style.display = 'none';
                
                clearInterval(recordingInterval);
            }
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
        }

        // אירועי הקלטה
        document.getElementById('recordBtn').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // פונקציות העלאת קבצים - עם מניעת מאזינים כפולים
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('audioFile');

        // הוספת מאזין לאזור העלאה - רק אם עוד לא הוסף
        if (uploadArea && !uploadArea.hasAttribute('data-listener-added')) {
            uploadArea.addEventListener('click', (e) => {
                // בדיקה שהלחיצה לא על הכפתור עצמו
                if (!e.target.classList.contains('file-label')) {
                    fileInput.click();
                }
            });
            uploadArea.setAttribute('data-listener-added', 'true');
            console.log('✅ Upload area click listener added');
        }

        // הוספת מאזין לכפתור הכחול - רק אם עוד לא הוסף
        const fileLabel = document.querySelector('.file-label');
        if (fileLabel && !fileLabel.hasAttribute('data-listener-added')) {
            fileLabel.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            fileLabel.setAttribute('data-listener-added', 'true');
            console.log('✅ File label click listener added');
        }

        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updateFileName(files[0].name);
                    document.getElementById('transcribeBtn').disabled = false;
                }
            });
        }

        // מאזין לשינוי קובץ - רק אם עוד לא הוסף
        if (fileInput && !fileInput.hasAttribute('data-listener-added')) {
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileName(e.target.files[0].name);
                    document.getElementById('transcribeBtn').disabled = false;
                }
            });
            fileInput.setAttribute('data-listener-added', 'true');
            console.log('✅ File input change listener added');
        }

        function updateFileName(name) {
            document.getElementById('fileName').textContent = `קובץ נבחר: ${name}`;
        }

        // פונקציות תמלול עם בדיקת מגבלות חדשה
        async function transcribeAudio() {
            const patientName = document.getElementById('patientName').value.trim();
            const sessionDate = document.getElementById('sessionDate').value;
            const qualityMode = document.getElementById('qualityMode').value;
            const audioFile = document.getElementById('audioFile').files[0];
            const directText = document.getElementById('directTextInput').value.trim();
            
            // בדיקה איזה מצב פעיל
            const textModeBtn = document.getElementById('textModeBtn');
            const isTextMode = textModeBtn && textModeBtn.classList.contains('active');

            if (!patientName) {
                showStatus('יש להזין שם מטופל', 'error');
                return;
            }

            // בדיקת אימות תחילה
            if (!currentUser || !sessionToken) {
                showStatus('🔐 יש להתחבר תחילה כדי להשתמש במערכת', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 1500);
                return;
            }

            // בדיקת מגבלות לפני תמלול - לוגיקה חדשה ופשוטה
            const canProceed = await checkSimpleLimits(patientName);
            if (!canProceed) {
                return; // הפונקציה כבר הציגה הודעת שגיאה
            }

            // במצב טקסט - עיבוד טקסט בלבד
            if (isTextMode) {
                if (!directText) {
                    showStatus('יש להזין טקסט לעיבוד', 'error');
                    return;
                }
                
                // עיבוד טקסט ישיר
                return await processDirectText(patientName, sessionDate, directText);
            }

            // במצב שמע - בדיקה שיש קובץ שמע
            if (!audioFile) {
                showStatus('יש לבחור קובץ שמע או להקליט', 'error');
                return;
            }

            // בדיקה אם זה מצב תמלול היברידי מוצפן
            if (qualityMode === 'hybrid-encrypted') {
                return await transcribeWithHybridEncryption(patientName, sessionDate, audioFile);
            }

            // בדיקה אם זה מצב תמלול מאובטח עם AssemblyAI
            if (qualityMode === 'secure-assemblyai') {
                return await transcribeWithSecureAssemblyAI(patientName, sessionDate, audioFile);
            }

            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('patient_name', patientName);
            formData.append('session_date', sessionDate);
            formData.append('quality_mode', qualityMode);

            try {
                showStatus('מתמלל... אנא המתן', 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                const response = await fetch('/transcribe', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('✅ תמלול הושלם בהצלחה!', 'success');
                    displayResults(data);
                    currentPatientName = patientName;
                    loadPatients(); // רענון רשימת המטופלים
                    
                    // עדכון מידע המנוי אחרי תמלול מוצלח
                    if (data.session_info) {
                        updateSubscriptionInfo(data.session_info);
                    }
                } else if (response.status === 402) {
                    // Payment Required - הגעה למגבלת סשנים
                    showStatus('⚠️ הגעת למגבלת הסשנים החינמיים', 'error');
                    setTimeout(() => {
                        showUpgradeModal(data);
                    }, 1500);
                } else {
                    showStatus(`שגיאה: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('שגיאה בתמלול:', error);
                showStatus('שגיאה בחיבור לשרת', 'error');
            } finally {
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // לוגיקה פשוטה ומובנת למגבלות
        async function checkSimpleLimits(patientName) {
            console.log('🔍 בודק מגבלות עבור:', patientName);
            
            const { patientCount, sessionCount } = getLocalUserStats();
            console.log(`📊 מצב נוכחי: ${patientCount} מטופלים, ${sessionCount} סשנים`);
            
            // מגבלות קבועות פשוטות (מה שכתוב ב-.env)
            const MAX_PATIENTS = 1;
            const MAX_SESSIONS = 5;
            
            // בדיקה 1: האם יש יותר מדי סשנים?
            if (sessionCount >= MAX_SESSIONS) {
                console.log(`❌ יותר מדי סשנים: ${sessionCount}/${MAX_SESSIONS}`);
                showStatus(`⚠️ הגעת למגבלה - מותרים ${MAX_SESSIONS} סשנים בלבד`, 'error');
                setTimeout(() => {
                    showLimitWarningModal(
                        'הגעת למגבלת הסשנים', 
                        `יש לך ${sessionCount} סשנים מתוך ${MAX_SESSIONS} המותרים.<br><br>מחק סשנים ישנים כדי להוסיף חדשים.`
                    );
                }, 1000);
                return false;
            }
            
            // בדיקה 2: האם זה מטופל חדש ויש כבר מטופל?
            const isNewPatient = await isPatientNew(patientName);
            if (isNewPatient && patientCount >= MAX_PATIENTS) {
                console.log(`❌ יותר מדי מטופלים: ${patientCount}/${MAX_PATIENTS}`);
                showStatus(`⚠️ הגעת למגבלה - מותר ${MAX_PATIENTS} מטופל בלבד`, 'error');
                setTimeout(() => {
                    showLimitWarningModal(
                        'הגעת למגבלת המטופלים',
                        `במנוי החינמי מותר מטופל אחד בלבד.<br><br>מחק את המטופל הקיים כדי להוסיף חדש.`
                    );
                }, 1000);
                return false;
            }
            
            console.log('✅ הכל בסדר - אפשר להמשיך');
            return true;
        }

        // פונקציה לבדיקה אם מטופל חדש
        async function isPatientNew(patientName) {
            const { patientCount, sessionCount } = getLocalUserStats();
            
            if (!currentUser) return true;
            
            const storageKey = `sessions_${currentUser.email}`;
            const userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // בדיקה אם יש כבר סשנים עם שם המטופל הזה
            const existingSessions = userSessions.filter(session => 
                session && 
                session.patient_name && 
                session.patient_name.trim() === patientName.trim()
            );
            
            return existingSessions.length === 0;
        }

        // פונקציה לקבלת מגבלות מהשרת (מקריאת ENV)
        async function getServerLimits() {
            try {
                console.log('📊 מבקש מגבלות מהשרת...');
                
                const response = await fetch('/api/limits', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (response.ok) {
                    const limits = await response.json();
                    console.log('✅ מגבלות התקבלו מהשרת:', limits);
                    return {
                        maxPatients: limits.max_patients || 1,
                        maxSessions: limits.max_sessions || 5
                    };
                } else {
                    console.log('⚠️ לא הצליח לקבל מגבלות מהשרת - משתמש בברירת מחדל');
                }
            } catch (error) {
                console.error('❌ שגיאה בקבלת מגבלות מהשרת:', error);
            }
            
            // ברירת מחדל אם השרת לא זמין
            console.log('📊 משתמש במגבלות ברירת מחדל');
            return {
                maxPatients: 1,
                maxSessions: 5
            };
        }

        // פונקציית עיבוד טקסט ישיר - עיבוד מקומי פשוט ללא בדיקת מגבלות
        async function processDirectText(patientName, sessionDate, directText) {
            try {
                console.log('📝 מתחיל עיבוד טקסט ישיר עבור:', patientName);
                showStatus('מעבד טקסט...', 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                // עיבוד מקומי פשוט - הצגת הטקסט כתוצאה (ללא בדיקת מגבלות!)
                setTimeout(async () => {
                    const data = {
                        original_transcript: directText,
                        corrected_transcript: directText,
                        corrections_made: []
                    };
                    
                    console.log('✅ עיבוד טקסט הושלם:', data);
                    showStatus('✅ עיבוד טקסט הושלם בהצלחה!', 'success');
                    displayResults(data);
                    currentPatientName = patientName;
                    
                    document.getElementById('transcribeBtn').disabled = false;
                }, 500); // המתנה קצרה לאפקט

            } catch (error) {
                console.error('שגיאה בעיבוד טקסט:', error);
                showStatus('שגיאה בעיבוד טקסט', 'error');
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // פונקציית תמלול היברידי מוצפן
        async function transcribeWithHybridEncryption(patientName, sessionDate, audioFile) {
            const encryptionPassword = document.getElementById('encryptionPassword').value.trim();
            
            if (!encryptionPassword) {
                showStatus('יש להזין סיסמת הצפנה למצב היברידי', 'error');
                return;
            }

            if (!currentUser || !sessionToken) {
                showStatus('יש להתחבר תחילה כדי להשתמש במערכת', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 1500);
                return;
            }

            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('patient_name', patientName);
            formData.append('session_date', sessionDate);
            formData.append('quality_mode', 'hybrid-encrypted');
            formData.append('encryption_key', encryptionPassword);

            try {
                showStatus('מתמלל עם הצפנה היברידית... אנא המתן', 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                const response = await fetch('/transcribe-encrypted', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('✅ תמלול היברידי הושלם בהצלחה!', 'success');
                    displayResults(data);
                    currentPatientName = patientName;
                    loadPatients(); // רענון רשימת המטופלים
                    
                    // הודעה על הצלחת ההצפנה
                    setTimeout(() => {
                        showStatus('🛡️ הסשן נשמר בענן בצורה מוצפנת', 'success');
                    }, 2000);
                } else if (response.status === 401) {
                    showStatus('סיסמת הצפנה שגויה', 'error');
                } else if (response.status === 402) {
                    showStatus('⚠️ הגעת למגבלת הסשנים החינמיים', 'error');
                    setTimeout(() => {
                        showUpgradeModal(data);
                    }, 1500);
                } else {
                    showStatus(`שגיאה: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('שגיאה בתמלול היברידי:', error);
                showStatus('שגיאה בחיבור לשרת', 'error');
            } finally {
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // פונקציית תמלול מאובטח עם AssemblyAI - עם מודל UI יפה
        async function transcribeWithSecureAssemblyAI(patientName, sessionDate, audioFile) {
            // פתיחת מודל הכנסת סיסמה במקום prompt
            return new Promise((resolve) => {
                showEncryptionPasswordModal(patientName, sessionDate, audioFile, resolve);
            });
        }

        // פונקציה להצגת מודל הכנסת סיסמת הצפנה
        function showEncryptionPasswordModal(patientName, sessionDate, audioFile, callback) {
            const modal = document.getElementById('encryptionPasswordModal');
            const passwordInput = document.getElementById('modalEncryptionPassword');
            const confirmBtn = document.getElementById('confirmEncryptionBtn');
            const cancelBtn = document.getElementById('cancelEncryptionBtn');
            const strengthIndicator = document.getElementById('passwordStrength');
            
            // איפוס הטופס
            passwordInput.value = '';
            confirmBtn.disabled = true;
            strengthIndicator.textContent = '';
            
            // הוספת מאזין לבדיקת חוזק סיסמה
            passwordInput.oninput = function() {
                const password = this.value;
                const strength = checkPasswordStrength(password);
                
                if (password.length === 0) {
                    strengthIndicator.textContent = '';
                    confirmBtn.disabled = true;
                } else if (password.length < 8) {
                    strengthIndicator.textContent = '❌ סיסמה קצרה מדי - נדרשים לפחות 8 תווים';
                    strengthIndicator.className = 'password-strength-weak';
                    confirmBtn.disabled = true;
                } else {
                    strengthIndicator.textContent = `${strength.icon} ${strength.text}`;
                    strengthIndicator.className = strength.class;
                    confirmBtn.disabled = false;
                }
            };
            
            // מאזין לכפתור אישור
            confirmBtn.onclick = async function() {
                const encryptionPassword = passwordInput.value.trim();
                
                if (!encryptionPassword || encryptionPassword.length < 8) {
                    showStatus('יש להזין סיסמת הצפנה של לפחות 8 תווים', 'error');
                    return;
                }
                
                // סגירת המודל
                closeEncryptionPasswordModal();
                
                // ביצוע התמלול המאובטח
                await performSecureTranscription(patientName, sessionDate, audioFile, encryptionPassword);
                
                if (callback) callback();
            };
            
            // מאזין לכפתור ביטול
            cancelBtn.onclick = function() {
                closeEncryptionPasswordModal();
                if (callback) callback();
            };
            
            // הצגת המודל
            modal.style.display = 'block';
            
            // מיקוד בשדה הסיסמה
            setTimeout(() => {
                passwordInput.focus();
            }, 300);
        }

        // פונקציה לסגירת מודל הכנסת סיסמה
        function closeEncryptionPasswordModal() {
            const modal = document.getElementById('encryptionPasswordModal');
            modal.style.display = 'none';
        }

        // פונקציה לבדיקת חוזק סיסמה
        function checkPasswordStrength(password) {
            if (password.length < 8) {
                return { icon: '❌', text: 'סיסמה חלשה', class: 'password-strength-weak' };
            }
            
            let score = 0;
            
            // בדיקות שונות לחוזק הסיסמה
            if (password.length >= 12) score++;
            if (/[a-z]/.test(password)) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            
            if (score <= 2) {
                return { icon: '🟡', text: 'סיסמה בינונית', class: 'password-strength-medium' };
            } else {
                return { icon: '✅', text: 'סיסמה חזקה', class: 'password-strength-strong' };
            }
        }

        // פונקציה להחלפת נראות סיסמה
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('modalEncryptionPassword');
            const toggleBtn = document.getElementById('togglePasswordVisibility');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        }

        // פונקציה לביצוע התמלול המאובטח בפועל
        async function performSecureTranscription(patientName, sessionDate, audioFile, encryptionPassword) {
            if (!currentUser || !sessionToken) {
                showStatus('יש להתחבר תחילה כדי להשתמש במערכת', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 1500);
                return;
            }

            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('patient_name', patientName);
            formData.append('session_date', sessionDate);
            formData.append('encryption_key', encryptionPassword);

            try {
                showStatus('🔐 מתחיל תמלול מאובטח עם AssemblyAI... אנא המתן', 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                const response = await fetch('/transcribe-secure-assemblyai', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('✅ תמלול מאובטח הושלם בהצלחה!', 'success');
                    displayResults(data);
                    currentPatientName = patientName;
                    loadPatients(); // רענון רשימת המטופלים
                    
                    // הודעה מיוחדת על הצפנה מקסימלית
                    setTimeout(() => {
                        showStatus('🛡️ התמלול נשמר בהצפנה מקסימלית - רק אתה יכול לפענח אותו!', 'success');
                    }, 2000);
                    
                    // הצגת מידע הצפנה אם קיים
                    if (data.encryption_info) {
                        setTimeout(() => {
                            showStatus(`🔐 ${data.encryption_info.method} | רמת פרטיות: ${data.encryption_info.privacy_level}`, 'success');
                        }, 4000);
                    }
                    
                    // הצגת הודעת אבטחה
                    if (data.security_message) {
                        setTimeout(() => {
                            showStatus(data.security_message, 'success');
                        }, 6000);
                    }
                } else if (response.status === 400) {
                    showStatus('סיסמת הצפנה קצרה מדי - נדרשים לפחות 8 תווים', 'error');
                } else if (response.status === 402) {
                    showStatus('⚠️ הגעת למגבלת הסשנים החינמיים', 'error');
                    setTimeout(() => {
                        showUpgradeModal(data);
                    }, 1500);
                } else if (response.status === 503) {
                    showStatus('שירות התמלול המאובטח לא זמין כרגע', 'error');
                } else {
                    showStatus(`שגיאה: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('שגיאה בתמלול מאובטח:', error);
                showStatus('שגיאה בחיבור לשרת', 'error');
            } finally {
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // פונקציות עזר נוספות
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const originalResult = document.getElementById('originalResult');
            const correctedResult = document.getElementById('correctedResult');
            const textEditor = document.getElementById('textEditor');
            
            if (resultsSection && originalResult && correctedResult && textEditor) {
                originalTranscript = data.original_transcript || '';
                correctedTranscript = data.corrected_transcript || '';
                
                originalResult.textContent = originalTranscript;
                correctedResult.textContent = correctedTranscript;
                textEditor.value = correctedTranscript;
                
                resultsSection.style.display = 'block';
                
                // הצגת סטטיסטיקות
                updateTextStats(correctedTranscript);
                
                // הצגת תיקונים אם יש
                if (data.corrections_made && data.corrections_made.length > 0) {
                    showCorrections(data.corrections_made);
                }
            }
        }

        function updateTextStats(text) {
            const textStats = document.getElementById('textStats');
            if (textStats && text) {
                const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
                const charCount = text.length;
                textStats.textContent = `מילים: ${wordCount} | תווים: ${charCount}`;
            }
        }

        function showCorrections(corrections) {
            const correctionsInfo = document.getElementById('correctionsInfo');
            const correctionsList = document.getElementById('correctionsList');
            
            if (correctionsInfo && correctionsList) {
                correctionsList.innerHTML = '';
                corrections.forEach(correction => {
                    const li = document.createElement('li');
                    li.textContent = correction;
                    correctionsList.appendChild(li);
                });
                correctionsInfo.classList.add('show');
            }
        }

        // פונקציות שמירה בשרת (במקום localStorage) - עם בדיקת מגבלות
        async function saveSessionLocally() {
            // קבלת נתונים מהטופס במקום להסתמך על משתנים גלובליים
            const patientName = document.getElementById('patientName').value.trim();
            const sessionDate = document.getElementById('sessionDate').value;
            const textEditor = document.getElementById('textEditor');
            const editedText = textEditor ? textEditor.value.trim() : '';
            
            // בדיקת שדות חובה
            if (!patientName) {
                showStatus('יש להזין שם מטופל', 'error');
                return;
            }
            
            if (!editedText && !correctedTranscript) {
                showStatus('אין תוכן לשמירה - יש לבצע תמלול תחילה או להזין טקסט', 'error');
                return;
            }

            console.log('💾 מתחיל תהליך שמירת סשן בשרת עבור:', patientName);
            
            // יצירת אובייקט הסשן עם נתונים מהטופס
            const sessionData = {
                patient_name: patientName,
                session_date: sessionDate || new Date().toISOString().split('T')[0],
                original_transcript: originalTranscript || editedText,
                corrected_transcript: correctedTranscript || editedText,
                edited_text: editedText || correctedTranscript, // השדה שהשרת מצפה לו
                audio_filename: document.getElementById('audioFile').files[0]?.name || 'direct_text.txt',
                quality_mode: document.getElementById('qualityMode').value || 'text_processing',
                replace_existing: false
            };

            try {
                showStatus('💾 שומר סשן בשרת...', 'loading');

                // הדפסת נתוני הבקשה לדיבוג
                console.log('📤 שולח נתוני סשן לשרת:', sessionData);
                console.log('🔐 Session token:', sessionToken ? 'קיים' : 'חסר');

                const response = await fetch('/save-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        patient_name: sessionData.patient_name,
                        transcript_text: sessionData.edited_text || sessionData.corrected_transcript
                    })
                });

                console.log('📥 תגובת השרת - סטטוס:', response.status);

                if (response.ok) {
                    let result;
                    try {
                        result = await response.json();
                        console.log('📥 תגובת השרת - תוכן:', result);
                    } catch (jsonError) {
                        console.error('❌ שגיאה בפענוח JSON מהשרת:', jsonError);
                        // אם יש שגיאה בפענוח JSON, נציג הודעת הצלחה כללית
                        result = { success: true };
                    }
                    
                    showStatus('✅ הסשן נשמר בשרת בהצלחה!', 'success');
                    
                    // רענון רשימת המטופלים
                    await loadPatients();
                    
                    // עדכון מידע המגבלות
                    await checkUserLimits();
                    
                    console.log('✅ סשן נשמר בשרת:', result);
                } else {
                    // טיפול בשגיאות - קריאה אחת בלבד לresponse body
                    let result;
                    try {
                        result = await response.json();
                    } catch (jsonError) {
                        console.error('❌ שגיאה בפענוח JSON של שגיאה:', jsonError);
                        try {
                            const textResponse = await response.text();
                            console.log('📥 תגובת השרת כטקסט:', textResponse);
                            result = { error: `שגיאת שרת: ${textResponse}` };
                        } catch (textError) {
                            console.error('❌ שגיאה גם בקריאת טקסט:', textError);
                            result = { error: `שגיאת שרת ${response.status}` };
                        }
                    }
                    
                    if (response.status === 400) {
                        // Bad Request - בדיקה מפורטת של השגיאה
                        console.error('❌ שגיאת 400 - בקשה שגויה:', result);
                        const errorMessage = result.error || 'בקשה שגויה - חסרים נתונים נדרשים';
                        showStatus(`שגיאה בשמירה: ${errorMessage}`, 'error');
                    } else if (response.status === 401) {
                        // Unauthorized - בעיית אימות
                        console.error('❌ שגיאת 401 - אימות נכשל');
                        showStatus('שגיאת אימות - יש להתחבר מחדש', 'error');
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 2000);
                    } else if (response.status === 402) {
                        // Payment Required - הגעה למגבלה
                        showStatus('⚠️ הגעת למגבלה', 'error');
                        setTimeout(() => {
                            showUpgradeModal(result);
                        }, 1500);
                    } else {
                        const errorMessage = result?.error || `שגיאת שרת ${response.status}`;
                        showStatus(`שגיאה בשמירה: ${errorMessage}`, 'error');
                    }
                }
            } catch (error) {
                console.error('❌ שגיאה בשמירת סשן:', error);
                showStatus(`שגיאה בחיבור לשרת: ${error.message}`, 'error');
            }
        }

        // פונקציה מלאה לבדיקת מגבלות לפני שמירה (מטופלים + סשנים)
        async function checkLimitsBeforeSaving(patientName) {
            try {
                console.log('🔍 בודק מגבלות לפני שמירת סשן עבור:', patientName);
                
                // ספירה מקומית של מטופלים וסשנים
                let localPatientCount = 0;
                let totalSessionsCount = 0;
                
                if (currentUser) {
                    const storageKey = `sessions_${currentUser.email}`;
                    let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // ניקוי סשנים פגומים
                    userSessions = userSessions.filter(session => 
                        session && 
                        session.patient_name && 
                        session.patient_name.trim() !== '' &&
                        session.corrected_transcript &&
                        session.corrected_transcript.trim() !== ''
                    );
                    
                    // ספירת מטופלים ייחודיים וסשנים
                    const uniquePatients = new Set();
                    userSessions.forEach(session => {
                        if (session.patient_name && session.patient_name.trim()) {
                            uniquePatients.add(session.patient_name.trim());
                        }
                    });
                    localPatientCount = uniquePatients.size;
                    totalSessionsCount = userSessions.length;
                }
                
                console.log('👥 מספר מטופלים קיימים:', localPatientCount);
                console.log('📝 מספר סשנים קיימים:', totalSessionsCount);
                
                // בדיקת מגבלת סשנים תחילה (5 סשנים מקסימום)
                if (totalSessionsCount >= 5) {
                    console.log('❌ הגעה למגבלת סשנים (5) - חוסם שמירה');
                    showStatus('⚠️ הגעת למגבלת הסשנים החינמיים - מותרים 5 סשנים בלבד', 'error');
                    setTimeout(() => {
                        showLimitWarningModal(
                            'הגעת למגבלת הסשנים החינמיים', 
                            `יש לך כבר ${totalSessionsCount} סשנים מתוך 5 המותרים במנוי החינמי.<br><br>כדי להוסיף סשנים נוספים, מחק סשנים ישנים או שדרג למנוי מלא.`
                        );
                    }, 1500);
                    return false;
                }
                
                // בדיקת מגבלת מטופלים (רק אם זה מטופל חדש)
                const isNewPatient = await checkIfNewPatient(patientName);
                console.log('🆕 האם מטופל חדש לשמירה:', isNewPatient);
                
                if (isNewPatient) {
                    // לוגיקה פשוטה: במנוי חינמי מותר רק מטופל אחד
                    if (localPatientCount >= 1) {
                        console.log('❌ יש כבר מטופל אחד - חוסם הוספת מטופל חדש');
                        showStatus('⚠️ הגעת למגבלת המטופלים החינמיים - מותר מטופל אחד בלבד', 'error');
                        setTimeout(() => {
                            showLimitWarningModal(
                                'הגעת למגבלת המטופלים החינמיים',
                                'במנוי החינמי מותר מטופל אחד בלבד. כדי להוסיף מטופלים נוספים, יש לשדרג למנוי בתשלום'
                            );
                        }, 1500);
                        return false;
                    } else {
                        console.log('✅ אין מטופלים - ניתן להוסיף מטופל ראשון');
                    }
                } else {
                    console.log('✅ מטופל קיים - בודק רק מגבלת סשנים');
                }

                console.log('✅ כל הבדיקות עברו - ניתן לשמור');
                return true;
            } catch (error) {
                console.error('שגיאה בבדיקת מגבלות לשמירה:', error);
                console.log('⚠️ שגיאה בבדיקה - מאפשר לשמור');
                return true; // במקרה של שגיאה, נתן לשמור
            }
        }

        function saveToLocalStorage(sessionData) {
            const storageKey = `sessions_${currentUser.email}`;
            let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // הוספת הסשן החדש
            userSessions.push(sessionData);
            
            // שמירה חזרה ל-localStorage
            localStorage.setItem(storageKey, JSON.stringify(userSessions));
            
            // עדכון התצוגה
            updateLocalSessionsUI();
        }

        function downloadSessionFile(sessionData) {
            const filename = `${sessionData.patient_name}_${sessionData.session_date}_${new Date().getTime()}.json`;
            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            // ניקוי
            URL.revokeObjectURL(link.href);
        }

        function updateLocalSessionsUI() {
            if (!currentUser) return;
            
            const storageKey = `sessions_${currentUser.email}`;
            const userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // קיבוץ לפי מטופלים
            const patientGroups = {};
            userSessions.forEach(session => {
                if (!patientGroups[session.patient_name]) {
                    patientGroups[session.patient_name] = [];
                }
                patientGroups[session.patient_name].push(session);
            });

            // עדכון התצוגה
            const localFilesContainer = document.getElementById('localFilesContainer');
            const localFilesList = document.getElementById('localFilesList');
            
            // ניקוי התוכן הקיים תמיד
            if (localFilesContainer) {
                localFilesContainer.innerHTML = '';
            }
            
            if (Object.keys(patientGroups).length > 0) {
                // יש מטופלים - הצג את הרשימה
                if (localFilesList) {
                    localFilesList.style.display = 'block';
                }
                
                Object.keys(patientGroups).forEach(patientName => {
                    const sessions = patientGroups[patientName];
                    const patientCard = createPatientCard(patientName, sessions);
                    localFilesContainer.appendChild(patientCard);
                });
            } else {
                // אין מטופלים - הסתר את הרשימה
                if (localFilesList) {
                    localFilesList.style.display = 'none';
                }
                console.log('🧹 אין מטופלים מקומיים - מסתיר רשימה');
            }
        }

        function createPatientCard(patientName, sessions) {
            const card = document.createElement('div');
            card.className = 'patient-card';
            card.style.cursor = 'pointer';
            card.style.position = 'relative';
            
            const latestSession = sessions[sessions.length - 1];
            
            card.innerHTML = `
                <button class="delete-patient-btn" onclick="confirmDeletePatient('${patientName.replace(/'/g, "\\'")}', event)" title="מחק מטופל">
                    🗑️
                </button>
                <h3>${patientName}</h3>
                <p>סשנים: ${sessions.length}</p>
                <p>סשן אחרון: ${new Date(latestSession.timestamp).toLocaleDateString('he-IL')}</p>
                <small>לחץ לצפייה בכל הסשנים</small>
            `;
            
            card.addEventListener('click', (e) => {
                // מניעת פתיחת הסשנים אם לחצו על כפתור המחיקה
                if (!e.target.classList.contains('delete-patient-btn')) {
                    showPatientSessions(patientName, sessions);
                }
            });
            
            return card;
        }

        function showPatientSessions(patientName, sessions) {
            const modal = document.getElementById('sessionsModal');
            const modalTitle = document.getElementById('modalTitle');
            const sessionsList = document.getElementById('sessionsList');
            
            modalTitle.textContent = `סשנים של ${patientName}`;
            sessionsList.innerHTML = '';
            
            sessions.forEach((session, index) => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                sessionItem.style.position = 'relative';
                sessionItem.innerHTML = `
                    <button class="delete-session-btn" onclick="confirmDeleteSession('${patientName.replace(/'/g, "\\'")}', ${index}, event)" title="מחק סשן">
                        🗑️
                    </button>
                    <h4>סשן מתאריך ${new Date(session.timestamp).toLocaleDateString('he-IL')}</h4>
                    <p>מילים: ${session.word_count} | תווים: ${session.char_count}</p>
                    <small>נוצר: ${new Date(session.timestamp).toLocaleString('he-IL')}</small>
                `;
                
                sessionItem.addEventListener('click', (e) => {
                    // מניעת פתיחת תוכן הסשן אם לחצו על כפתור המחיקה
                    if (!e.target.classList.contains('delete-session-btn')) {
                        showSessionContent(session);
                    }
                });
                
                sessionsList.appendChild(sessionItem);
            });
            
            modal.style.display = 'block';
        }

        function showSessionContent(session) {
            const modal = document.getElementById('sessionContentModal');
            const title = document.getElementById('sessionContentTitle');
            const body = document.getElementById('sessionContentBody');
            
            title.textContent = `סשן ${session.patient_name} - ${new Date(session.timestamp).toLocaleDateString('he-IL')}`;
            body.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4>פרטי הסשן:</h4>
                    <p><strong>מטופל:</strong> ${session.patient_name}</p>
                    <p><strong>תאריך:</strong> ${session.session_date}</p>
                    <p><strong>נוצר:</strong> ${new Date(session.timestamp).toLocaleString('he-IL')}</p>
                    <p><strong>מילים:</strong> ${session.word_count} | <strong>תווים:</strong> ${session.char_count}</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <h4>תוכן הסשן:</h4>
                    <div style="white-space: pre-wrap; line-height: 1.6; direction: rtl;">${session.corrected_transcript}</div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="copySessionText('${session.corrected_transcript.replace(/'/g, "\\'")}')" class="action-btn copy-btn">📋 העתק טקסט</button>
                    <button onclick="downloadSingleSession(${JSON.stringify(session).replace(/"/g, '&quot;')})" class="action-btn" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white;">💾 הורד קובץ</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function copySessionText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('✅ הטקסט הועתק ללוח', 'success');
            });
        }

        function downloadSingleSession(session) {
            downloadSessionFile(session);
        }

        // משתנים גלובליים למודל המחיקה
        let pendingDeleteAction = null;

        // פונקציות מחיקה עם מודל מותאם אישית
        function confirmDeletePatient(patientName, event) {
            event.stopPropagation();
            
            const message = `האם אתה בטוח שברצונך למחוק את המטופל "<strong>${patientName}</strong>" וכל הסשנים שלו?<br><br>פעולה זו לא ניתנת לביטול!`;
            
            showDeleteConfirmModal('מחיקת מטופל', message, () => {
                deletePatient(patientName);
            });
        }

        function confirmDeleteSession(patientName, sessionIndex, event) {
            event.stopPropagation();
            
            const message = `האם אתה בטוח שברצונך למחוק את הסשן הזה של "<strong>${patientName}</strong>"?<br><br>פעולה זו לא ניתנת לביטול!`;
            
            showDeleteConfirmModal('מחיקת סשן', message, () => {
                deleteSession(patientName, sessionIndex);
            });
        }

        // פונקציה להצגת מודל אישור מחיקה
        function showDeleteConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('deleteConfirmModal');
            const titleElement = document.getElementById('deleteConfirmTitle');
            const messageElement = document.getElementById('deleteConfirmMessage');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            
            // עדכון התוכן
            titleElement.textContent = `⚠️ ${title}`;
            messageElement.innerHTML = message;
            
            // שמירת הפעולה הממתינה
            pendingDeleteAction = onConfirm;
            
            // הוספת מאזינים לכפתורים
            confirmBtn.onclick = () => {
                if (pendingDeleteAction) {
                    pendingDeleteAction();
                    pendingDeleteAction = null;
                }
                closeDeleteConfirm();
            };
            
            cancelBtn.onclick = () => {
                pendingDeleteAction = null;
                closeDeleteConfirm();
            };
            
            // הצגת המודל
            modal.style.display = 'block';
        }

        // פונקציה לסגירת מודל אישור מחיקה
        function closeDeleteConfirm() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'none';
            pendingDeleteAction = null;
        }

        async function deletePatient(patientName) {
            try {
                showStatus('מוחק מטופל...', 'loading');
                
                let deletedSessionsCount = 0;
                
                // מחיקה מקומית
                if (currentUser) {
                    const storageKey = `sessions_${currentUser.email}`;
                    let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // ספירת הסשנים של המטופל לפני המחיקה
                    const patientSessions = userSessions.filter(session => session.patient_name === patientName);
                    deletedSessionsCount = patientSessions.length;
                    
                    // סינון הסשנים - הסרת כל הסשנים של המטופל
                    const filteredSessions = userSessions.filter(session => session.patient_name !== patientName);
                    
                    // שמירה חזרה
                    localStorage.setItem(storageKey, JSON.stringify(filteredSessions));
                    
                    console.log(`🗑️ מחק מטופל "${patientName}" עם ${deletedSessionsCount} סשנים - נותרו ${filteredSessions.length} סשנים`);
                }
                
                // עדכון מונה סשנים בשרת (הפחתה לפי כמות הסשנים שנמחקו)
                if (sessionToken && deletedSessionsCount > 0) {
                    try {
                        // הפחתת המונה לפי כמות הסשנים שנמחקו
                        for (let i = 0; i < deletedSessionsCount; i++) {
                            const response = await fetch('/delete-session', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${sessionToken}`
                                },
                                body: JSON.stringify({
                                    patient_name: patientName,
                                    session_filename: `session_${new Date().toISOString().split('T')[0]}.json`
                                })
                            });
                            
                            if (response.ok) {
                                console.log(`✅ מונה סשנים הופחת בשרת (${i + 1}/${deletedSessionsCount})`);
                            }
                        }
                        
                        // עדכון תצוגת המגבלות אחרי הפחתה
                        await checkUserLimits();
                        
                    } catch (serverError) {
                        console.log('⚠️ מטופל נמחק מקומית, שגיאה בעדכון מונה בשרת:', serverError);
                    }
                }
                
                // מחיקה מהשרת (אם המשתמש מחובר)
                if (sessionToken) {
                    try {
                        const response = await fetch(`/patient/${encodeURIComponent(patientName)}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${sessionToken}`
                            }
                        });
                        
                        if (response.ok) {
                            console.log('✅ מטופל נמחק גם מהשרת');
                        } else {
                            console.log('⚠️ מטופל נמחק מקומית, אך לא מהשרת');
                        }
                    } catch (serverError) {
                        console.log('⚠️ מטופל נמחק מקומית, שגיאה בחיבור לשרת:', serverError);
                    }
                }
                
                        // עדכון מיידי של הממשק - כפול לוודא
                        updateLocalSessionsUI();
                        updatePatientsLimitDisplay(); // עדכון מונה מטופלים
                        
                        // עדכון נוסף אחרי זמן קצר למקרה של עיכוב
                        setTimeout(() => {
                            updateLocalSessionsUI();
                            updatePatientsLimitDisplay(); // עדכון מונה מטופלים
                            console.log('🔄 עדכון ממשק נוסף אחרי מחיקה');
                        }, 100);
                
                showStatus(`✅ המטופל "${patientName}" וכל ${deletedSessionsCount} הסשנים שלו נמחקו בהצלחה`, 'success');
                
                // סגירת מודל אם פתוח
                closeSessions();
                
            } catch (error) {
                console.error('שגיאה במחיקת מטופל:', error);
                showStatus('שגיאה במחיקת המטופל', 'error');
            }
        }

        async function deleteSession(patientName, sessionIndex) {
            try {
                showStatus('מוחק סשן...', 'loading');
                
                // מחיקה מקומית
                if (currentUser) {
                    const storageKey = `sessions_${currentUser.email}`;
                    let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // מציאת הסשנים של המטופל הספציפי
                    const patientSessions = userSessions.filter(session => session.patient_name === patientName);
                    
                    if (sessionIndex >= 0 && sessionIndex < patientSessions.length) {
                        const sessionToDelete = patientSessions[sessionIndex];
                        
                        // הסרת הסשן הספציפי
                        const updatedSessions = userSessions.filter(session => 
                            !(session.patient_name === patientName && session.timestamp === sessionToDelete.timestamp)
                        );
                        
                        // שמירה חזרה
                        localStorage.setItem(storageKey, JSON.stringify(updatedSessions));
                        
                        console.log(`🗑️ מחק סשן של "${patientName}" - נותרו ${updatedSessions.length} סשנים`);
                        
                    // עדכון מיידי של הממשק - כפול לוודא
                    updateLocalSessionsUI();
                    updatePatientsLimitDisplay(); // עדכון מונה מטופלים
                    
                    // עדכון נוסף אחרי זמן קצר למקרה של עיכוב
                    setTimeout(() => {
                        updateLocalSessionsUI();
                        updatePatientsLimitDisplay(); // עדכון מונה מטופלים
                        console.log('🔄 עדכון ממשק נוסף אחרי מחיקת סשן');
                    }, 100);
                        
                        // עדכון מודל הסשנים אם פתוח
                        const updatedPatientSessions = updatedSessions.filter(session => session.patient_name === patientName);
                        if (updatedPatientSessions.length > 0) {
                            showPatientSessions(patientName, updatedPatientSessions);
                        } else {
                            closeSessions();
                        }
                        
                        // עדכון מונה סשנים (הפחתה) בשרת - חשוב לעשות לפני הודעת ההצלחה
                        if (sessionToken) {
                            try {
                                const response = await fetch('/delete-session', {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${sessionToken}`
                                    },
                                    body: JSON.stringify({
                                        patient_name: patientName,
                                        session_filename: `session_${sessionToDelete.session_date || 'unknown'}.json`
                                    })
                                });
                                
                                if (response.ok) {
                                    const result = await response.json();
                                    console.log('✅ מונה סשנים הופחת בשרת:', result.session_info);
                                    // עדכון תצוגת המגבלות אחרי הפחתה
                                    if (result.session_info) {
                                        updateCombinedLimitsDisplay(result.session_info, null);
                                    }
                                    await checkUserLimits();
                                } else {
                                    console.log('⚠️ שגיאה בהפחתת מונה סשנים בשרת');
                                }
                            } catch (serverError) {
                                console.log('⚠️ סשן נמחק מקומית, שגיאה בעדכון מונה בשרת:', serverError);
                            }
                        }
                        
                        showStatus('✅ הסשן נמחק בהצלחה', 'success');
                    }
                }
                
            } catch (error) {
                console.error('שגיאה במחיקת סשן:', error);
                showStatus('שגיאה במחיקת הסשן', 'error');
            }
        }

        // פונקציות סגירת מודלים
        function closeSessions() {
            document.getElementById('sessionsModal').style.display = 'none';
        }

        function closeSessionContent() {
            document.getElementById('sessionContentModal').style.display = 'none';
        }

        // פונקציות בדיקת מגבלות ועדכון מונים - לוגיקה מתוקנת ופשוטה
        async function checkLimitsBeforeProcessing(patientName) {
            try {
                console.log('🔍 בודק מגבלות לפני עיבוד עבור:', patientName);
                
                // בדיקה מקומית פשוטה - ללא תלות בשרת
                if (!currentUser) {
                    console.log('⚠️ אין משתמש מחובר - מאפשר להמשיך');
                    return true;
                }
                
                const storageKey = `sessions_${currentUser.email}`;
                let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                
                // ניקוי סשנים פגומים
                userSessions = userSessions.filter(session => 
                    session && 
                    session.patient_name && 
                    session.patient_name.trim() !== '' &&
                    session.corrected_transcript &&
                    session.corrected_transcript.trim() !== ''
                );
                
                // ספירת מטופלים ייחודיים וסשנים
                const uniquePatients = new Set();
                userSessions.forEach(session => {
                    if (session.patient_name && session.patient_name.trim()) {
                        uniquePatients.add(session.patient_name.trim());
                    }
                });
                const localPatientCount = uniquePatients.size;
                const totalSessionsCount = userSessions.length;
                
                console.log('👥 מספר מטופלים נוכחי:', localPatientCount);
                console.log('📝 מספר סשנים נוכחי:', totalSessionsCount);
                
                // בדיקת מגבלת סשנים תחילה (5 מקסימום)
                if (totalSessionsCount >= 5) {
                    console.log('❌ הגעה למגבלת סשנים (5)');
                    showStatus('⚠️ הגעת למגבלת הסשנים החינמיים - מותרים 5 סשנים בלבד', 'error');
                    setTimeout(() => {
                        showLimitWarningModal(
                            'הגעת למגבלת הסשנים החינמיים', 
                            `יש לך כבר ${totalSessionsCount} סשנים מתוך 5 המותרים במנוי החינמי.<br><br>כדי להוסיף סשנים נוספים, מחק סשנים ישנים או שדרג למנוי מלא.`
                        );
                    }, 1500);
                    return false;
                }
                
                // בדיקת מגבלת מטופלים (רק אם זה מטופל חדש)
                const isNewPatient = !uniquePatients.has(patientName.trim());
                console.log('🆕 האם מטופל חדש:', isNewPatient);
                
                if (isNewPatient && localPatientCount >= 1) {
                    console.log('❌ יש כבר מטופל אחד - לא ניתן להוסיף מטופל חדש');
                    showStatus('⚠️ הגעת למגבלת המטופלים החינמיים - מותר מטופל אחד בלבד', 'error');
                    setTimeout(() => {
                        showLimitWarningModal(
                            'הגעת למגבלת המטופלים החינמיים',
                            'במנוי החינמי מותר מטופל אחד בלבד. כדי להוסיף מטופלים נוספים, יש לשדרג למנוי בתשלום'
                        );
                    }, 1500);
                    return false;
                }
                
                console.log('✅ כל הבדיקות עברו - ניתן להמשיך');
                return true;
                
            } catch (error) {
                console.error('שגיאה בבדיקת מגבלות:', error);
                console.log('⚠️ שגיאה בבדיקה - מאפשר להמשיך');
                return true; // במקרה של שגיאה, נתן להמשיך
            }
        }

        async function checkIfNewPatient(patientName) {
            // בדיקה אם המטופל כבר קיים ב-localStorage
            if (!currentUser) return false;
            
            const storageKey = `sessions_${currentUser.email}`;
            const userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // אם יש כבר סשנים עם שם המטופל הזה, זה לא מטופל חדש
            const existingSessions = userSessions.filter(session => session.patient_name === patientName);
            return existingSessions.length === 0;
        }

        async function updateSessionCounter() {
            try {
                // עדכון מונה סשנים בשרת (רק למשתמשים חינמיים)
                const response = await fetch('/subscription/check-session-limit', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (response.ok) {
                    const sessionData = await response.json();
                    if (sessionData.status === 'trial') {
                        // עדכון המונה בשרת
                        await fetch('/subscription/increment-session', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${sessionToken}`
                            }
                        });
                        
                        // עדכון התצוגה
                        await checkUserLimits();
                        
                        console.log('✅ מונה סשנים עודכן');
                    }
                }
            } catch (error) {
                console.error('שגיאה בעדכון מונה סשנים:', error);
            }
        }

        // פונקציות חסרות נוספות
        async function checkSubscriptionStatus() {
            try {
                const response = await fetch('/subscription/status', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('שגיאה בבדיקת סטטוס מנוי:', error);
            }
            return null;
        }

        function updateSubscriptionInfo(sessionInfo) {
            if (sessionInfo) {
                console.log('עדכון מידע מנוי:', sessionInfo);
                // כאן ניתן להוסיף לוגיקה לעדכון הממשק
            }
        }

        function showUpgradeModal(data) {
            const title = data.subscription_required ? 'הגעת למגבלת המטופלים החינמיים' : 'הגעת למגבלת הסשנים החינמיים';
            const message = data.message || 'במנוי החינמי מותר מטופל אחד בלבד. כדי להוסיף מטופלים נוספים, יש לשדרג למנוי בתשלום';
            
            showLimitWarningModal(title, message);
        }

        function openUpgradeModal() {
            showLimitWarningModal('שדרוג מנוי', 'כדי להוסיף מטופלים נוספים ולקבל יותר סשנים, יש לשדרג למנוי מלא');
        }

        // פונקציה להצגת מודל התרעת מגבלות
        function showLimitWarningModal(title, message) {
            const modal = document.getElementById('limitWarningModal');
            const titleElement = document.getElementById('limitWarningTitle');
            const messageElement = document.getElementById('limitWarningMessage');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const closeLimitBtn = document.getElementById('closeLimitBtn');
            
            // עדכון התוכן
            titleElement.textContent = `⚠️ ${title}`;
            messageElement.innerHTML = message;
            
            // הוספת מאזינים לכפתורים
            upgradeBtn.onclick = () => {
                closeLimitWarning();
                // כאן ניתן להוסיף לוגיקה לשדרוג בעתיד
                alert('פונקציונליות שדרוג תתווסף בקרוב');
            };
            
            closeLimitBtn.onclick = () => {
                closeLimitWarning();
            };
            
            // הצגת המודל
            modal.style.display = 'block';
        }

        // פונקציה לסגירת מודל התרעת מגבלות
        function closeLimitWarning() {
            const modal = document.getElementById('limitWarningModal');
            modal.style.display = 'none';
        }

        function openLoginModal() {
            // מפנה לדף הבית לכניסה
            window.location.href = '/';
        }

        async function loadPatients() {
            // פונקציה לטעינת רשימת מטופלים מהשרת
            if (!currentUser || !sessionToken) {
                console.log('❌ אין משתמש מחובר - לא יכול לטעון מטופלים');
                return;
            }

            try {
                const response = await fetch('/patients', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('👥 מטופלים נטענו מהשרת:', data);
                    
                    // עדכון התצוגה עם הנתונים מהשרת
                    displayPatientsFromServer(data.patients);
                    
                    // עדכון מידע מגבלות
                    if (data.patient_limits) {
                        updatePatientsLimitFromServer(data.patient_limits);
                    }
                } else {
                    console.log('⚠️ שגיאה בטעינת מטופלים מהשרת');
                }
            } catch (error) {
                console.error('שגיאה בטעינת מטופלים:', error);
            }
        }

        // פונקציה להצגת מטופלים מהשרת
        function displayPatientsFromServer(patients) {
            const therapistSection = document.getElementById('therapistSection');
            if (!therapistSection) return;

            // עדכון מונה המטופלים בהתבסס על נתוני השרת
            updatePatientsLimitFromServer(patients);

            // מציאת או יצירת אזור המטופלים
            let patientsContainer = document.getElementById('serverPatientsContainer');
            if (!patientsContainer) {
                patientsContainer = document.createElement('div');
                patientsContainer.id = 'serverPatientsContainer';
                patientsContainer.innerHTML = `
                    <h3 style="color: #1e293b; margin: 30px 0 20px 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                        👥 מטופלים בשרת
                    </h3>
                    <div id="serverPatientsList" class="patients-list"></div>
                `;
                therapistSection.appendChild(patientsContainer);
            }

            const patientsList = document.getElementById('serverPatientsList');
            patientsList.innerHTML = '';

            if (patients && patients.length > 0) {
                patients.forEach(patient => {
                    const patientCard = document.createElement('div');
                    patientCard.className = 'patient-card';
                    patientCard.style.cursor = 'pointer';
                    patientCard.style.position = 'relative';
                    
                    patientCard.innerHTML = `
                        <button class="delete-patient-btn" onclick="confirmDeleteServerPatient('${patient.name.replace(/'/g, "\\'")}', event)" title="מחק מטופל">
                            🗑️
                        </button>
                        <h3>${patient.name}</h3>
                        <p>סשנים: ${patient.session_count}</p>
                        <small>לחץ לצפייה בסשנים</small>
                    `;
                    
                    patientCard.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-patient-btn')) {
                            loadPatientSessions(patient.name);
                        }
                    });
                    
                    patientsList.appendChild(patientCard);
                });
                
                patientsContainer.style.display = 'block';
            } else {
                patientsContainer.style.display = 'none';
            }
        }

        // פונקציה לעדכון מונה מטופלים מנתוני השרת
        function updatePatientsLimitFromServer(patients) {
            const appContainer = document.querySelector('.app-container');
            if (!appContainer || !currentUser) return;
            
            // הסרת תצוגה קיימת אם יש
            const existingInfo = document.getElementById('appUserInfo');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // ספירת מטופלים מהשרת
            const serverPatientCount = patients ? patients.length : 0;
            
            // ספירת סשנים מהשרת (סכום כל הסשנים של כל המטופלים)
            let serverSessionCount = 0;
            if (patients) {
                patients.forEach(patient => {
                    serverSessionCount += patient.session_count || 0;
                });
            }
            
            console.log('👥 מספר מטופלים מהשרת:', serverPatientCount);
            console.log('📝 מספר סשנים מהשרת:', serverSessionCount);
            
            // יצירת תצוגה חדשה
            const userInfo = document.createElement('div');
            userInfo.id = 'appUserInfo';
            
            let statusMessage = '';
            let statusColor = '#10b981';
            let bgColor = 'rgba(16, 185, 129, 0.1)';
            let borderColor = 'rgba(16, 185, 129, 0.2)';
            let needsUpgrade = false;
            
            // לוגיקה מתוקנת בהתבסס על נתוני השרת:
            // מטופלים: 0 או 1 מותר
            // סשנים: 0-5 מותר
            
            if (serverPatientCount === 0) {
                statusMessage = `👥 מטופלים: 0 מתוך 1 | 📝 סשנים: ${serverSessionCount} מתוך 5<br>✅ ניתן להוסיף מטופל ראשון`;
            } else if (serverPatientCount === 1) {
                if (serverSessionCount < 5) {
                    statusMessage = `👥 מטופלים: 1 מתוך 1 | 📝 סשנים: ${serverSessionCount} מתוך 5<br>⚠️ הגעת למגבלת המטופלים - ניתן להוסיף עוד ${5 - serverSessionCount} סשנים למטופל הקיים`;
                    statusColor = '#f59e0b';
                    bgColor = 'rgba(245, 158, 11, 0.1)';
                    borderColor = 'rgba(245, 158, 11, 0.2)';
                } else {
                    statusMessage = `👥 מטופלים: 1 מתוך 1 | 📝 סשנים: ${serverSessionCount} מתוך 5<br>🚫 הגעת למגבלת הסשנים - מחק סשנים או שדרג`;
                    statusColor = '#ef4444';
                    bgColor = 'rgba(239, 68, 68, 0.1)';
                    borderColor = 'rgba(239, 68, 68, 0.2)';
                    needsUpgrade = true;
                }
            } else {
                // יותר ממטופל אחד - לא אמור לקרות במנוי חינמי
                statusMessage = `👥 מטופלים: ${serverPatientCount} מתוך 1 | 📝 סשנים: ${serverSessionCount} מתוך 5<br>🚫 חריגה ממגבלת המנוי החינמי`;
                statusColor = '#ef4444';
                bgColor = 'rgba(239, 68, 68, 0.1)';
                borderColor = 'rgba(239, 68, 68, 0.2)';
                needsUpgrade = true;
            }
            
            userInfo.innerHTML = `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <span style="color: ${statusColor}; font-weight: 600; line-height: 1.4;">${statusMessage}</span>
                    ${needsUpgrade ? 
                        '<br><button onclick="openUpgradeModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">💎 שדרג למנוי מלא</button>' : 
                        ''
                    }
                    <br><button onclick="debugAndCleanStorage()" style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px; font-size: 12px;">🔧 נקה נתונים פגומים</button>
                </div>
            `;
            
            appContainer.insertBefore(userInfo, appContainer.firstChild);
        }

        // פונקציה לעדכון תצוגת מגבלות משולבת (סשנים + מטופלים)
        function updateCombinedLimitsDisplay(sessionData, patientsData) {
            console.log('🔄 מעדכן תצוגת מגבלות משולבת:', { sessionData, patientsData });
            
            // אם יש נתוני סשנים, עדכן את התצוגה
            if (sessionData) {
                console.log('📝 עדכון מידע סשנים:', sessionData);
                // כאן ניתן להוסיף לוגיקה לעדכון ספציפי של מידע הסשנים
            }
            
            // אם יש נתוני מטופלים, עדכן את התצוגה
            if (patientsData) {
                console.log('👥 עדכון מידע מטופלים:', patientsData);
                updatePatientsLimitFromServer(patientsData);
            } else {
                // אם אין נתוני מטופלים ספציפיים, עדכן לפי הנתונים המקומיים
                updatePatientsLimitDisplay();
            }
        }

        // פונקציה לטעינת סשנים של מטופל מהשרת
        async function loadPatientSessions(patientName) {
            try {
                const response = await fetch(`/patients/${encodeURIComponent(patientName)}/sessions`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showServerPatientSessions(patientName, data.sessions);
                } else {
                    showStatus('שגיאה בטעינת סשנים', 'error');
                }
            } catch (error) {
                console.error('שגיאה בטעינת סשנים:', error);
                showStatus('שגיאה בחיבור לשרת', 'error');
            }
        }

        // פונקציה להצגת סשנים מהשרת
        function showServerPatientSessions(patientName, sessions) {
            const modal = document.getElementById('sessionsModal');
            const modalTitle = document.getElementById('modalTitle');
            const sessionsList = document.getElementById('sessionsList');
            
            modalTitle.textContent = `סשנים של ${patientName}`;
            sessionsList.innerHTML = '';
            
            if (sessions && sessions.length > 0) {
                sessions.forEach((session, index) => {
                    const sessionItem = document.createElement('div');
                    sessionItem.className = 'session-item';
                    sessionItem.style.position = 'relative';
                    sessionItem.style.cursor = 'pointer';
                    
                    // עיצוב תאריך נכון
                    const displayDate = session.formatted_datetime || session.formatted_date || session.session_date || 'לא ידוע';
                    
                    sessionItem.innerHTML = `
                        <button class="delete-session-btn" onclick="confirmDeleteServerSession('${patientName.replace(/'/g, "\\'")}', '${session.filename.replace(/'/g, "\\'")}', event)" title="מחק סשן">
                            🗑️
                        </button>
                        <h4>📅 סשן מתאריך ${displayDate}</h4>
                        <p>📝 מילים: ${session.word_count || 0}</p>
                        <p>🎵 קובץ שמע: ${session.audio_filename || 'טקסט ישיר'}</p>
                        <small>🕐 נוצר: ${session.formatted_datetime || session.created_at || 'לא ידוע'}</small>
                        <div style="margin-top: 10px; color: #6366f1; font-size: 14px;">👆 לחץ לצפייה בתמלול</div>
                    `;
                    
                    sessionItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-session-btn')) {
                            console.log('🖱️ לחיצה על סשן:', patientName, session.filename);
                            loadSessionContent(patientName, session.filename);
                        }
                    });
                    
                    sessionsList.appendChild(sessionItem);
                });
            } else {
                sessionsList.innerHTML = '<p style="text-align: center; color: #6b7280;">אין סשנים עבור מטופל זה</p>';
            }
            
            modal.style.display = 'block';
        }

        // פונקציה לטעינת תוכן סשן מהשרת
        async function loadSessionContent(patientName, sessionFilename) {
            try {
                console.log('📥 טוען תוכן סשן:', patientName, sessionFilename);
                const response = await fetch(`/patients/${encodeURIComponent(patientName)}/session/${encodeURIComponent(sessionFilename)}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ תוכן סשן נטען מהשרת:', data);
                    
                    // בדיקה מפורטת של המבנה שהתקבל
                    if (data.session_data) {
                        console.log('📋 נתוני הסשן:', data.session_data);
                        console.log('🔍 שדות זמינים:', Object.keys(data.session_data));
                        
                        // בדיקה של כל השדות האפשריים לתמלול
                        const possibleFields = ['transcript_text', 'corrected_transcript', 'original_transcript', 'edited_transcript'];
                        possibleFields.forEach(field => {
                            if (data.session_data[field]) {
                                console.log(`✅ שדה ${field}:`, data.session_data[field].substring(0, 100) + '...');
                            } else {
                                console.log(`❌ שדה ${field}: לא קיים או ריק`);
                            }
                        });
                        
                        showServerSessionContent(patientName, data.session_data);
                    } else {
                        console.error('❌ לא נמצא session_data בתגובה:', data);
                        showStatus('שגיאה: נתוני הסשן לא נמצאו', 'error');
                    }
                } else {
                    console.error('❌ שגיאה בטעינת סשן:', response.status);
                    const errorText = await response.text();
                    console.error('📥 תגובת השרת:', errorText);
                    showStatus('שגיאה בטעינת תוכן הסשן', 'error');
                }
            } catch (error) {
                console.error('❌ שגיאה בטעינת תוכן סשן:', error);
                showStatus('שגיאה בחיבור לשרת', 'error');
            }
        }

        // פונקציה להצגת תוכן סשן מהשרת
        function showServerSessionContent(patientName, sessionData) {
            const modal = document.getElementById('sessionContentModal');
            const title = document.getElementById('sessionContentTitle');
            const body = document.getElementById('sessionContentBody');
            
            title.textContent = `סשן ${patientName} - ${sessionData.session_date || 'לא ידוע'}`;
            
            // בדיקה אם זה סשן מוצפן
            if (sessionData.needs_decryption || sessionData.is_encrypted) {
                console.log('🔐 זה סשן מוצפן - מציג ממשק פענוח');
                
                body.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4>פרטי הסשן:</h4>
                        <p><strong>מטופל:</strong> ${sessionData.patient_name || patientName}</p>
                        <p><strong>תאריך:</strong> ${sessionData.session_date || 'לא ידוע'}</p>
                        <p><strong>נוצר:</strong> ${sessionData.created_at || 'לא ידוע'}</p>
                        <p><strong>מילים:</strong> ${sessionData.word_count || 0}</p>
                        <p><strong>קובץ שמע:</strong> ${sessionData.audio_filename || 'לא ידוע'}</p>
                        <p><strong>הצפנה:</strong> ${sessionData.encryption_method || 'AES-256'}</p>
                        <p><strong>רמת פרטיות:</strong> ${sessionData.privacy_level || 'מקסימלית'}</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                        <h4 style="color: #92400e; margin-bottom: 15px;">🔐 סשן מוצפן</h4>
                        <p style="color: #92400e; margin-bottom: 20px;">התמלול מוצפן בסיסמה אישית. הזן את הסיסמה כדי לפענח:</p>
                        
                        <div style="margin-bottom: 15px;">
                            <input type="password" id="decryptionPassword" placeholder="הזן סיסמת פענוח..." style="width: 100%; max-width: 300px; padding: 12px; border: 2px solid #f59e0b; border-radius: 8px; font-size: 16px; text-align: center;">
                        </div>
                        
                        <button onclick="decryptSession('${patientName}', '${sessionData.filename || 'unknown'}', document.getElementById('decryptionPassword').value)" 
                                class="action-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; margin: 5px;">
                            🔓 פענח תמלול
                        </button>
                        
                        <button onclick="showPasswordResetOption('${patientName}', '${sessionData.filename || 'unknown'}')" 
                                class="action-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; margin: 5px; font-size: 14px;">
                            🔄 שכחת סיסמת הצפנה?
                        </button>
                    </div>
                    
                    <div id="decryptedContent" style="display: none;">
                        <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                            <h4>תוכן התמלול המפוענח:</h4>
                            <div id="decryptedText" style="white-space: pre-wrap; line-height: 1.6; direction: rtl; min-height: 100px; padding: 15px; background: #f9fafb; border-radius: 8px;"></div>
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="copyDecryptedText()" class="action-btn copy-btn">📋 העתק טקסט מפוענח</button>
                        </div>
                    </div>
                `;
            } else {
                // סשן רגיל - לא מוצפן
                console.log('📝 זה סשן רגיל - מציג תוכן ישירות');
                
                // בדיקה מפורטת יותר של השדות השונים שיכולים להכיל את התמלול
                let transcript = '';
                
                // נסה למצוא את התמלול בשדות השונים
                if (sessionData.transcript_text && sessionData.transcript_text.trim()) {
                    transcript = sessionData.transcript_text;
                    console.log('✅ נמצא תמלול בשדה transcript_text');
                } else if (sessionData.corrected_transcript && sessionData.corrected_transcript.trim()) {
                    transcript = sessionData.corrected_transcript;
                    console.log('✅ נמצא תמלול בשדה corrected_transcript');
                } else if (sessionData.original_transcript && sessionData.original_transcript.trim()) {
                    transcript = sessionData.original_transcript;
                    console.log('✅ נמצא תמלול בשדה original_transcript');
                } else if (sessionData.edited_transcript && sessionData.edited_transcript.trim()) {
                    transcript = sessionData.edited_transcript;
                    console.log('✅ נמצא תמלול בשדה edited_transcript');
                } else {
                    transcript = 'אין תוכן זמין לסשן זה';
                    console.log('❌ לא נמצא תמלול בשום שדה:', sessionData);
                }
                
                body.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <h4>פרטי הסשן:</h4>
                        <p><strong>מטופל:</strong> ${sessionData.patient_name || patientName}</p>
                        <p><strong>תאריך:</strong> ${sessionData.session_date || 'לא ידוע'}</p>
                        <p><strong>נוצר:</strong> ${sessionData.created_at || 'לא ידוע'}</p>
                        <p><strong>מילים:</strong> ${sessionData.word_count || 0}</p>
                        <p><strong>קובץ שמע:</strong> ${sessionData.audio_filename || 'לא ידוע'}</p>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                        <h4>תוכן הסשן:</h4>
                        <div style="white-space: pre-wrap; line-height: 1.6; direction: rtl; min-height: 100px; padding: 15px; background: #f9fafb; border-radius: 8px;">${transcript}</div>
                    </div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button onclick="copySessionText('${transcript.replace(/'/g, "\\'").replace(/"/g, '\\"')}')" class="action-btn copy-btn">📋 העתק טקסט</button>
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }

        // פונקציה לפענוח סשן מוצפן
        async function decryptSession(patientName, sessionFilename, password) {
            if (!password || password.trim().length < 8) {
                showStatus('יש להזין סיסמת פענוח של לפחות 8 תווים', 'error');
                return;
            }

            try {
                showStatus('🔓 מפענח סשן...', 'loading');

                const response = await fetch('/decrypt-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        patient_name: patientName,
                        session_filename: sessionFilename,
                        decryption_password: password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // הצגת התמלול המפוענח
                    const decryptedContent = document.getElementById('decryptedContent');
                    const decryptedText = document.getElementById('decryptedText');
                    
                    if (decryptedContent && decryptedText) {
                        decryptedText.textContent = data.decrypted_transcript;
                        decryptedContent.style.display = 'block';
                        
                        // שמירת הטקסט המפוענח למשתנה גלובלי
                        window.currentDecryptedText = data.decrypted_transcript;
                        
                        showStatus('✅ סשן פוענח בהצלחה!', 'success');
                        
                        // הצגת מידע הצפנה
                        if (data.encryption_info) {
                            setTimeout(() => {
                                showStatus(`🔐 ${data.encryption_info.method} | רמת פרטיות: ${data.encryption_info.privacy_level}`, 'success');
                            }, 2000);
                        }
                    }
                } else {
                    if (response.status === 400) {
                        showStatus('❌ סיסמת פענוח שגויה', 'error');
                    } else if (response.status === 503) {
                        showStatus('❌ מערכת הפענוח לא זמינה', 'error');
                    } else {
                        showStatus(`❌ שגיאה בפענוח: ${data.message || data.error}`, 'error');
                    }
                }
            } catch (error) {
                console.error('שגיאה בפענוח סשן:', error);
                showStatus('❌ שגיאה בחיבור לשרת', 'error');
            }
        }

        // פונקציה להעתקת טקסט מפוענח
        function copyDecryptedText() {
            if (window.currentDecryptedText) {
                navigator.clipboard.writeText(window.currentDecryptedText).then(() => {
                    showStatus('✅ הטקסט המפוענח הועתק ללוח', 'success');
                });
            } else {
                showStatus('❌ אין טקסט מפוענח להעתקה', 'error');
            }
        }

        // פונקציות מחיקה מהשרת
        function confirmDeleteServerPatient(patientName, event) {
            event.stopPropagation();
            
            const message = `האם אתה בטוח שברצונך למחוק את המטופל "<strong>${patientName}</strong>" וכל הסשנים שלו מהשרת?<br><br>פעולה זו לא ניתנת לביטול!`;
            
            showDeleteConfirmModal('מחיקת מטופל מהשרת', message, () => {
                deleteServerPatient(patientName);
            });
        }

        function confirmDeleteServerSession(patientName, sessionFilename, event) {
            event.stopPropagation();
            
            const message = `האם אתה בטוח שברצונך למחוק את הסשן הזה של "<strong>${patientName}</strong>" מהשרת?<br><br>פעולה זו לא ניתנת לביטול!`;
            
            showDeleteConfirmModal('מחיקת סשן מהשרת', message, () => {
                deleteServerSession(patientName, sessionFilename);
            });
        }

        // מחיקת מטופל מהשרת
        async function deleteServerPatient(patientName) {
            try {
                showStatus('מוחק מטופל מהשרת...', 'loading');
                
                const response = await fetch(`/patient/${encodeURIComponent(patientName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus(`✅ המטופל "${patientName}" נמחק מהשרת בהצלחה`, 'success');
                    
                    // רענון רשימת המטופלים
                    await loadPatients();
                    
                    // עדכון מידע המגבלות - חשוב!
                    await checkUserLimits();
                    
                    // עדכון מיידי של תצוגת המגבלות
                    updatePatientsLimitDisplay();
                    
                    // סגירת מודלים
                    closeSessions();
                    
                    console.log(`✅ מטופל ${patientName} נמחק - מונים עודכנו`);
                } else {
                    const error = await response.json();
                    showStatus(`שגיאה במחיקת מטופל: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('שגיאה במחיקת מטופל מהשרת:', error);
                showStatus('שגיאה בחיבור לשרת', 'error');
            }
        }

        // מחיקת סשן מהשרת
        async function deleteServerSession(patientName, sessionFilename) {
            try {
                showStatus('מוחק סשן מהשרת...', 'loading');
                
                const response = await fetch('/delete-session', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        patient_name: patientName,
                        session_filename: sessionFilename
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('✅ הסשן נמחק מהשרת בהצלחה', 'success');
                    
                    // רענון רשימת המטופלים
                    await loadPatients();
                    
                    // עדכון מידע המגבלות - חשוב!
                    await checkUserLimits();
                    
                    // עדכון מיידי של תצוגת המגבלות
                    updatePatientsLimitDisplay();
                    
                    // רענון מודל הסשנים
                    await loadPatientSessions(patientName);
                    
                    console.log(`✅ סשן ${sessionFilename} נמחק - מונים עודכנו`);
                } else {
                    const error = await response.json();
                    showStatus(`שגיאה במחיקת סשן: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('שגיאה במחיקת סשן מהשרת:', error);
                showStatus('שגיאה בחיבור לשרת', 'error');
            }
        }

        // פונקציות בחירת מצב קלט
        function switchInputMode(mode) {
            const audioModeBtn = document.getElementById('audioModeBtn');
            const textModeBtn = document.getElementById('textModeBtn');
            const audioInputSection = document.getElementById('audioInputSection');
            const textInputSection = document.getElementById('textInputSection');
            const whatsappInstructions = document.getElementById('whatsappInstructions');
            const recordingSection = document.getElementById('recordingSection');
            const qualityModeSection = document.getElementById('qualityModeSection');
            const transcribeBtn = document.getElementById('transcribeBtn');

            if (mode === 'audio') {
                // מצב שמע - הצגת כל הסעיפים הרלוונטיים
                audioModeBtn.classList.add('active');
                textModeBtn.classList.remove('active');
                audioInputSection.style.display = 'block';
                textInputSection.style.display = 'none';
                whatsappInstructions.style.display = 'block';
                recordingSection.style.display = 'block';
                qualityModeSection.style.display = 'block'; // הצגת בחירת שירות תמלול
                
                transcribeBtn.textContent = '🎯 התחל תמלול';
                transcribeBtn.disabled = true;
                
                console.log('🎵 מצב שמע - מציג בחירת שירות תמלול');
                
            } else if (mode === 'text') {
                // מצב טקסט - הסתרת סעיפים לא רלוונטיים
                audioModeBtn.classList.remove('active');
                textModeBtn.classList.add('active');
                audioInputSection.style.display = 'none';
                textInputSection.style.display = 'block';
                whatsappInstructions.style.display = 'none';
                recordingSection.style.display = 'none';
                qualityModeSection.style.display = 'none'; // הסתרת בחירת שירות תמלול - לא רלוונטי לטקסט
                
                transcribeBtn.textContent = '🔧 עבד טקסט';
                transcribeBtn.disabled = false;
                
                console.log('📝 מצב טקסט - מסתיר בחירת שירות תמלול');
            }
        }

        // בדיקת מצב הצפנה
        function checkEncryptionMode() {
            const qualityMode = document.getElementById('qualityMode').value;
            const encryptionPasswordSection = document.getElementById('encryptionPasswordSection');
            
            if (qualityMode === 'hybrid-encrypted') {
                encryptionPasswordSection.style.display = 'block';
            } else {
                encryptionPasswordSection.style.display = 'none';
            }
        }

        // הוספת מאזין לשינוי מצב איכות
        document.addEventListener('DOMContentLoaded', () => {
            const qualityModeSelect = document.getElementById('qualityMode');
            if (qualityModeSelect) {
                qualityModeSelect.addEventListener('change', checkEncryptionMode);
            }
        });

        // פונקציה לניקוי מלא של שדה שם המטופל
        function forceCleanPatientNameField() {
            const patientNameInput = document.getElementById('patientName');
            if (patientNameInput) {
                // ניקוי מכל הכיוונים האפשריים
                patientNameInput.value = '';
                patientNameInput.defaultValue = '';
                patientNameInput.setAttribute('value', '');
                patientNameInput.removeAttribute('data-value');
                
                // ניקוי אפשרי של browser cache
                patientNameInput.autocomplete = 'off';
                patientNameInput.setAttribute('autocomplete', 'new-password'); // טריק לניקוי cache
                
                // אירוע לניקוי אוטומטי
                setTimeout(() => {
                    patientNameInput.setAttribute('autocomplete', 'off');
                    patientNameInput.value = '';
                }, 100);
                
                console.log('🧹 שדה שם המטופל נוקה בכוח - ריק לחלוטין');
            }
        }

        // פונקציה לניקוי נתונים פגומים
        function debugAndCleanStorage() {
            if (!currentUser) {
                showStatus('❌ אין משתמש מחובר', 'error');
                return;
            }

            if (confirm('🔧 האם אתה בטוח שברצונך לנקות את כל הנתונים הפגומים?\n\nפעולה זו תמחק סשנים ריקים או פגומים, אך תשמור על סשנים תקינים.')) {
                const storageKey = `sessions_${currentUser.email}`;
                let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const originalCount = userSessions.length;
                
                console.log('🔍 מתחיל ניקוי נתונים פגומים...');
                console.log('📊 מספר סשנים לפני ניקוי:', originalCount);
                
                // ניקוי סשנים פגומים
                const cleanedSessions = userSessions.filter(session => {
                    // בדיקות תקינות
                    const hasValidPatientName = session && session.patient_name && session.patient_name.trim() !== '';
                    const hasValidTranscript = session && session.corrected_transcript && session.corrected_transcript.trim() !== '';
                    const hasValidTimestamp = session && session.timestamp;
                    const hasValidDate = session && session.session_date;
                    
                    const isValid = hasValidPatientName && hasValidTranscript && hasValidTimestamp && hasValidDate;
                    
                    if (!isValid) {
                        console.log('🗑️ מוחק סשן פגום:', {
                            patient_name: session?.patient_name || 'חסר',
                            has_transcript: !!session?.corrected_transcript,
                            has_timestamp: !!session?.timestamp,
                            has_date: !!session?.session_date
                        });
                    }
                    
                    return isValid;
                });
                
                const cleanedCount = cleanedSessions.length;
                const deletedCount = originalCount - cleanedCount;
                
                // שמירה חזרה
                localStorage.setItem(storageKey, JSON.stringify(cleanedSessions));
                
                console.log('✅ ניקוי הושלם:');
                console.log('📊 סשנים לפני:', originalCount);
                console.log('📊 סשנים אחרי:', cleanedCount);
                console.log('🗑️ סשנים שנמחקו:', deletedCount);
                
                // עדכון התצוגה
                updateLocalSessionsUI();
                updatePatientsLimitDisplay();
                
                if (deletedCount > 0) {
                    showStatus(`✅ ניקוי הושלם! נמחקו ${deletedCount} סשנים פגומים, נותרו ${cleanedCount} סשנים תקינים`, 'success');
                } else {
                    showStatus('✅ לא נמצאו נתונים פגומים - הכל תקין!', 'success');
                }
            }
        }

        // פונקציות סנכרון עם אינדיקציות ברורות
        async function syncToCloud() {
            const syncStatus = document.getElementById('syncStatus');
            const syncToCloudBtn = document.getElementById('syncToCloudBtn');
            
            try {
                // הצגת אינדיקציה ברורה
                syncStatus.innerHTML = '📤 <strong>שלב 1/2:</strong> מעלה נתונים לענן...';
                syncStatus.style.background = '#dbeafe';
                syncStatus.style.color = '#1d4ed8';
                syncStatus.style.border = '1px solid #93c5fd';
                
                // השבתת הכפתור
                syncToCloudBtn.disabled = true;
                syncToCloudBtn.innerHTML = '⏳ מסנכרן...';
                
                // סימולציה של סנכרון (כרגע אין backend מלא)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // הצגת שלב 2
                syncStatus.innerHTML = '🔄 <strong>שלב 2/2:</strong> מאמת סנכרון...';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // הצגת הצלחה
                syncStatus.innerHTML = '✅ <strong>סנכרון לענן הושלם בהצלחה!</strong><br>📊 כל הנתונים שלך מוצפנים ומאובטחים בענן';
                syncStatus.style.background = '#dcfce7';
                syncStatus.style.color = '#166534';
                syncStatus.style.border = '1px solid #86efac';
                
                // הצגת זמן סנכרון אחרון
                setTimeout(() => {
                    const now = new Date().toLocaleString('he-IL');
                    syncStatus.innerHTML = `✅ סונכרן לענן בהצלחה<br>🕐 סנכרון אחרון: ${now}`;
                }, 3000);
                
            } catch (error) {
                console.error('שגיאה בסנכרון לענן:', error);
                syncStatus.innerHTML = '❌ <strong>שגיאה בסנכרון לענן</strong><br>נסה שוב מאוחר יותר';
                syncStatus.style.background = '#fee2e2';
                syncStatus.style.color = '#dc2626';
                syncStatus.style.border = '1px solid #fca5a5';
            } finally {
                // החזרת הכפתור למצב רגיל
                syncToCloudBtn.disabled = false;
                syncToCloudBtn.innerHTML = '📤 סנכרן לענן';
            }
        }

        async function syncFromCloud() {
            const syncStatus = document.getElementById('syncStatus');
            const syncFromCloudBtn = document.getElementById('syncFromCloudBtn');
            
            try {
                // הצגת אינדיקציה ברורה
                syncStatus.innerHTML = '📥 <strong>שלב 1/2:</strong> מוריד נתונים מהענן...';
                syncStatus.style.background = '#dbeafe';
                syncStatus.style.color = '#1d4ed8';
                syncStatus.style.border = '1px solid #93c5fd';
                
                // השבתת הכפתור
                syncFromCloudBtn.disabled = true;
                syncFromCloudBtn.innerHTML = '⏳ מסנכרן...';
                
                // סימולציה של סנכרון
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // הצגת שלב 2
                syncStatus.innerHTML = '🔓 <strong>שלב 2/2:</strong> מפענח נתונים מוצפנים...';
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // הצגת הצלחה
                syncStatus.innerHTML = '✅ <strong>סנכרון מהענן הושלם בהצלחה!</strong><br>📱 כל הנתונים שלך זמינים במכשיר זה';
                syncStatus.style.background = '#dcfce7';
                syncStatus.style.color = '#166534';
                syncStatus.style.border = '1px solid #86efac';
                
                // הצגת זמן סנכרון אחרון
                setTimeout(() => {
                    const now = new Date().toLocaleString('he-IL');
                    syncStatus.innerHTML = `✅ סונכרן מהענן בהצלחה<br>🕐 סנכרון אחרון: ${now}`;
                }, 3000);
                
            } catch (error) {
                console.error('שגיאה בסנכרון מהענן:', error);
                syncStatus.innerHTML = '❌ <strong>שגיאה בסנכרון מהענן</strong><br>בדוק את החיבור לאינטרנט ונסה שוב';
                syncStatus.style.background = '#fee2e2';
                syncStatus.style.color = '#dc2626';
                syncStatus.style.border = '1px solid #fca5a5';
            } finally {
                // החזרת הכפתור למצב רגיל
                syncFromCloudBtn.disabled = false;
                syncFromCloudBtn.innerHTML = '📥 סנכרן מהענן';
            }
        }

        async function fullSync() {
            const syncStatus = document.getElementById('syncStatus');
            const fullSyncBtn = document.getElementById('fullSyncBtn');
            
            try {
                // הצגת אינדיקציה ברורה
                syncStatus.innerHTML = '🔄 <strong>שלב 1/4:</strong> מתחיל סנכרון מלא...';
                syncStatus.style.background = '#dbeafe';
                syncStatus.style.color = '#1d4ed8';
                syncStatus.style.border = '1px solid #93c5fd';
                
                // השבתת הכפתור
                fullSyncBtn.disabled = true;
                fullSyncBtn.innerHTML = '⏳ מסנכרן...';
                
                // שלב 1: העלאה לענן
                await new Promise(resolve => setTimeout(resolve, 1500));
                syncStatus.innerHTML = '📤 <strong>שלב 2/4:</strong> מעלה נתונים מקומיים לענן...';
                
                // שלב 2: הורדה מהענן
                await new Promise(resolve => setTimeout(resolve, 1500));
                syncStatus.innerHTML = '📥 <strong>שלב 3/4:</strong> מוריד נתונים מהענן...';
                
                // שלב 3: מיזוג נתונים
                await new Promise(resolve => setTimeout(resolve, 1000));
                syncStatus.innerHTML = '🔄 <strong>שלב 4/4:</strong> מבצע מיזוג נתונים...';
                
                // סיום
                await new Promise(resolve => setTimeout(resolve, 1000));
                syncStatus.innerHTML = '✅ <strong>סנכרון מלא הושלם בהצלחה!</strong><br>🌐 כל המכשירים שלך מסונכרנים עכשיו';
                syncStatus.style.background = '#dcfce7';
                syncStatus.style.color = '#166534';
                syncStatus.style.border = '1px solid #86efac';
                
                // הצגת זמן סנכרון אחרון
                setTimeout(() => {
                    const now = new Date().toLocaleString('he-IL');
                    syncStatus.innerHTML = `✅ סנכרון מלא הושלם<br>🕐 סנכרון אחרון: ${now}`;
                }, 3000);
                
            } catch (error) {
                console.error('שגיאה בסנכרון מלא:', error);
                syncStatus.innerHTML = '❌ <strong>שגיאה בסנכרון מלא</strong><br>חלק מהנתונים עלולים שלא להיות מסונכרנים';
                syncStatus.style.background = '#fee2e2';
                syncStatus.style.color = '#dc2626';
                syncStatus.style.border = '1px solid #fca5a5';
            } finally {
                // החזרת הכפתור למצב רגיל
                fullSyncBtn.disabled = false;
                fullSyncBtn.innerHTML = '🔄 סנכרון מלא';
            }
        }

        async function showSyncStatus() {
            const syncStatus = document.getElementById('syncStatus');
            const syncStatusBtn = document.getElementById('syncStatusBtn');
            
            try {
                // הצגת אינדיקציה של טעינה
                syncStatus.innerHTML = '📊 טוען סטטוס סנכרון...';
                syncStatus.style.background = '#dbeafe';
                syncStatus.style.color = '#1d4ed8';
                syncStatus.style.border = '1px solid #93c5fd';
                
                syncStatusBtn.disabled = true;
                syncStatusBtn.innerHTML = '⏳ טוען...';
                
                // סימולציה של בדיקת סטטוס
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // הצגת סטטוס מפורט
                const now = new Date().toLocaleString('he-IL');
                const mockStats = {
                    totalSessions: Math.floor(Math.random() * 50) + 10,
                    syncedSessions: Math.floor(Math.random() * 40) + 8,
                    lastSync: now,
                    devices: Math.floor(Math.random() * 3) + 1
                };
                
                syncStatus.innerHTML = `
                    📊 <strong>סטטוס סנכרון נוכחי:</strong><br>
                    📝 סשנים כולל: ${mockStats.totalSessions}<br>
                    ✅ סשנים מסונכרנים: ${mockStats.syncedSessions}<br>
                    📱 מכשירים מחוברים: ${mockStats.devices}<br>
                    🕐 סנכרון אחרון: ${mockStats.lastSync}
                `;
                syncStatus.style.background = '#f0f9ff';
                syncStatus.style.color = '#0c4a6e';
                syncStatus.style.border = '1px solid #0ea5e9';
                
            } catch (error) {
                console.error('שגיאה בקבלת סטטוס:', error);
                syncStatus.innerHTML = '❌ <strong>שגיאה בקבלת סטטוס סנכרון</strong><br>נסה שוב מאוחר יותר';
                syncStatus.style.background = '#fee2e2';
                syncStatus.style.color = '#dc2626';
                syncStatus.style.border = '1px solid #fca5a5';
            } finally {
                // החזרת הכפתור למצב רגיל
                syncStatusBtn.disabled = false;
                syncStatusBtn.innerHTML = '📊 סטטוס סנכרון';
            }
        }

        // משתנים לסנכרון אוטומטי
        let autoSyncInterval = null;
        let autoSyncEnabled = true;
        let nextSyncCountdown = null;
        let syncCountdownSeconds = 30;

        // פונקציית סנכרון אוטומטי
        async function performAutoSync() {
            if (!autoSyncEnabled) return;
            
            const syncProgressBar = document.getElementById('syncProgressBar');
            const autoSyncStatus = document.getElementById('autoSyncStatus');
            const lastSyncTime = document.getElementById('lastSyncTime');
            
            try {
                // עדכון סטטוס
                autoSyncStatus.textContent = 'מבצע סנכרון...';
                autoSyncStatus.classList.add('sync-active');
                
                // אנימציית התקדמות
                if (syncProgressBar) {
                    syncProgressBar.style.width = '0%';
                    
                    // אנימציה של בר התקדמות
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += 10;
                        syncProgressBar.style.width = progress + '%';
                        if (progress >= 100) {
                            clearInterval(progressInterval);
                        }
                    }, 200);
                }
                
                // ביצוע סנכרון (סימולציה)
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // עדכון זמן סנכרון אחרון
                const now = new Date().toLocaleString('he-IL');
                if (lastSyncTime) {
                    lastSyncTime.textContent = `סנכרון אחרון: ${now}`;
                }
                
                // עדכון סטטוס הצלחה
                autoSyncStatus.textContent = 'סנכרון הושלם בהצלחה';
                autoSyncStatus.classList.remove('sync-active');
                
                // חזרה לסטטוס רגיל אחרי 3 שניות
                setTimeout(() => {
                    if (autoSyncEnabled) {
                        autoSyncStatus.textContent = 'סנכרון אוטומטי פעיל';
                    }
                }, 3000);
                
            } catch (error) {
                console.error('שגיאה בסנכרון אוטומטי:', error);
                autoSyncStatus.textContent = 'שגיאה בסנכרון - ינסה שוב';
                autoSyncStatus.classList.remove('sync-active');
            }
        }

        // פונקציית עדכון ספירה לאחור
        function updateSyncCountdown() {
            const nextSyncTime = document.getElementById('nextSyncTime');
            if (!nextSyncTime || !autoSyncEnabled) return;
            
            if (syncCountdownSeconds > 0) {
                nextSyncTime.textContent = `סנכרון הבא: ${syncCountdownSeconds} שניות`;
                syncCountdownSeconds--;
            } else {
                nextSyncTime.textContent = 'מסנכרן עכשיו...';
                syncCountdownSeconds = 30; // איפוס לסיבוב הבא
                performAutoSync();
            }
        }

        // פונקציית הפעלת סנכרון אוטומטי
        function startAutoSync() {
            if (autoSyncInterval) return; // כבר פועל
            
            autoSyncEnabled = true;
            syncCountdownSeconds = 30;
            
            // עדכון ממשק
            const autoSyncStatus = document.getElementById('autoSyncStatus');
            const toggleBtn = document.getElementById('toggleAutoSyncBtn');
            const syncToCloudBtn = document.getElementById('syncToCloudBtn');
            const syncFromCloudBtn = document.getElementById('syncFromCloudBtn');
            
            if (autoSyncStatus) {
                autoSyncStatus.textContent = 'סנכרון אוטומטי פעיל';
            }
            
            if (toggleBtn) {
                toggleBtn.innerHTML = '⏸️ עצור סנכרון אוטומטי';
                toggleBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            }
            
            // השבתת כפתורים ידניים
            if (syncToCloudBtn) {
                syncToCloudBtn.disabled = true;
                syncToCloudBtn.innerHTML = '📤 סנכרון אוטומטי פעיל';
                syncToCloudBtn.style.opacity = '0.7';
            }
            
            if (syncFromCloudBtn) {
                syncFromCloudBtn.disabled = true;
                syncFromCloudBtn.innerHTML = '📥 סנכרון אוטומטי פעיל';
                syncFromCloudBtn.style.opacity = '0.7';
            }
            
            // התחלת הטיימרים
            autoSyncInterval = setInterval(performAutoSync, 30000); // כל 30 שניות
            nextSyncCountdown = setInterval(updateSyncCountdown, 1000); // עדכון ספירה כל שנייה
            
            // סנכרון ראשוני
            setTimeout(() => {
                performAutoSync();
            }, 2000);
            
            console.log('✅ סנכרון אוטומטי הופעל');
        }

        // פונקציית עצירת סנכרון אוטומטי
        function stopAutoSync() {
            autoSyncEnabled = false;
            
            // עצירת טיימרים
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
                autoSyncInterval = null;
            }
            
            if (nextSyncCountdown) {
                clearInterval(nextSyncCountdown);
                nextSyncCountdown = null;
            }
            
            // עדכון ממשק
            const autoSyncStatus = document.getElementById('autoSyncStatus');
            const toggleBtn = document.getElementById('toggleAutoSyncBtn');
            const syncToCloudBtn = document.getElementById('syncToCloudBtn');
            const syncFromCloudBtn = document.getElementById('syncFromCloudBtn');
            const nextSyncTime = document.getElementById('nextSyncTime');
            const syncProgressBar = document.getElementById('syncProgressBar');
            
            if (autoSyncStatus) {
                autoSyncStatus.textContent = 'סנכרון אוטומטי מושבת';
                autoSyncStatus.classList.remove('sync-active');
            }
            
            if (toggleBtn) {
                toggleBtn.innerHTML = '▶️ הפעל סנכרון אוטומטי';
                toggleBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }
            
            if (nextSyncTime) {
                nextSyncTime.textContent = 'סנכרון אוטומטי מושבת';
            }
            
            if (syncProgressBar) {
                syncProgressBar.style.width = '0%';
            }
            
            // הפעלת כפתורים ידניים
            if (syncToCloudBtn) {
                syncToCloudBtn.disabled = false;
                syncToCloudBtn.innerHTML = '📤 סנכרן לענן';
                syncToCloudBtn.style.opacity = '1';
                syncToCloudBtn.style.background = 'linear-gradient(135deg, #0891b2 0%, #0e7490 100%)';
            }
            
            if (syncFromCloudBtn) {
                syncFromCloudBtn.disabled = false;
                syncFromCloudBtn.innerHTML = '📥 סנכרן מהענן';
                syncFromCloudBtn.style.opacity = '1';
                syncFromCloudBtn.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
            }
            
            console.log('⏸️ סנכרון אוטומטי הושבת');
        }

        // פונקציית החלפת מצב סנכרון אוטומטי
        function toggleAutoSync() {
            if (autoSyncEnabled && autoSyncInterval) {
                stopAutoSync();
            } else {
                startAutoSync();
            }
        }

        // אתחול האפליקציה
        document.addEventListener('DOMContentLoaded', async () => {
            // הגדרת תאריך ברירת מחדל
            const sessionDateInput = document.getElementById('sessionDate');
            if (sessionDateInput) {
                sessionDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // ניקוי מלא של שדה שם המטופל
            forceCleanPatientNameField();
            
            // ניקוי נוסף אחרי זמן קצר (למקרה של browser cache)
            setTimeout(() => {
                forceCleanPatientNameField();
            }, 500);
            
            // בדיקת אימות
            const isAuthenticated = await checkAuth();
            
            // אם המשתמש מאומת, טען את רשימת המטופלים מהשרת
            if (isAuthenticated && currentUser && sessionToken) {
                console.log('🔄 טוען רשימת מטופלים מהשרת...');
                await loadPatients();
                
                // טעינה נוספת אחרי זמן קצר למקרה של עיכוב
                setTimeout(async () => {
                    await loadPatients();
                    console.log('🔄 טעינה נוספת של מטופלים הושלמה');
                }, 2000);
            }
            
            // ניקוי נוסף אחרי אימות
            setTimeout(() => {
                forceCleanPatientNameField();
            }, 1000);
            
            // הוספת מאזינים לכפתורים
            const transcribeBtn = document.getElementById('transcribeBtn');
            if (transcribeBtn) {
                transcribeBtn.addEventListener('click', transcribeAudio);
            }
            
            // חיבור כפתור שמירת סשן
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveSessionLocally);
            }
            
            // חיבור כפתורי סנכרון
            const syncToCloudBtn = document.getElementById('syncToCloudBtn');
            if (syncToCloudBtn) {
                syncToCloudBtn.addEventListener('click', syncToCloud);
            }
            
            const syncFromCloudBtn = document.getElementById('syncFromCloudBtn');
            if (syncFromCloudBtn) {
                syncFromCloudBtn.addEventListener('click', syncFromCloud);
            }
            
            const fullSyncBtn = document.getElementById('fullSyncBtn');
            if (fullSyncBtn) {
                fullSyncBtn.addEventListener('click', fullSync);
            }
            
            const syncStatusBtn = document.getElementById('syncStatusBtn');
            if (syncStatusBtn) {
                syncStatusBtn.addEventListener('click', showSyncStatus);
            }
            
            // חיבור כפתור החלפת מצב סנכרון אוטומטי
            const toggleAutoSyncBtn = document.getElementById('toggleAutoSyncBtn');
            if (toggleAutoSyncBtn) {
                toggleAutoSyncBtn.addEventListener('click', toggleAutoSync);
            }
            
            // טעינת סשנים מקומיים קיימים
            updateLocalSessionsUI();
            
            // הפעלת סנכרון אוטומטי בהתחלה
            setTimeout(() => {
                startAutoSync();
            }, 1000);
            
            console.log('✅ האפליקציה אותחלה בהצלחה עם סנכרון אוטומטי');
        });
    </script>
</body>
</html>
