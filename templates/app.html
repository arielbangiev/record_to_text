<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Transcription">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
    
    <title>Transcription System for Therapists - Application</title>
    
    <!-- Encryption Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .navbar {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 2px 20px rgba(99, 102, 241, 0.15);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #6366f1;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-links a {
            color: #64748b;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #6366f1;
        }

        /* Language Selector */
        .language-selector {
            display: flex;
            align-items: center;
            margin-right: 20px;
        }

        .language-btn {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #64748b;
            border: 2px solid #e5e7eb;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .language-btn:hover {
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .language-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* App Section */
        .app-section {
            padding: 60px 0;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .app-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        /* Stepper Styles */
        .stepper-container {
            margin-bottom: 40px;
        }

        .stepper {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .step {
            display: flex;
            align-items: center;
            position: relative;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.4s ease;
            border: 3px solid #e5e7eb;
            position: relative;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            transform: scale(1.05);
            animation: activeStep 2s infinite;
        }

        .step.completed .step-circle {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .step.completed .step-circle::after {
            content: '✓';
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            animation: checkmark 0.5s ease-in-out;
        }

        @keyframes activeStep {
            0%, 100% {
                box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            }
            50% {
                box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
            }
        }

        @keyframes checkmark {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .step-label {
            margin-top: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #6b7280;
            text-align: center;
            min-width: 80px;
        }

        .step.active .step-label {
            color: #6366f1;
        }

        .step.completed .step-label {
            color: #10b981;
        }

        .step-connector {
            width: 60px;
            height: 3px;
            background: #e5e7eb;
            margin: 0 10px;
            transition: all 0.3s ease;
        }

        .step.completed + .step .step-connector,
        .step.completed .step-connector {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        /* Step Content */
        .step-content {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.12);
            border: 1px solid rgba(99, 102, 241, 0.1);
            position: relative;
            overflow: hidden;
        }

        .step-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
        }

        .step-card h2 {
            color: #1e293b;
            margin-bottom: 28px;
            font-size: 2em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            border: none;
            padding: 0;
            text-align: center;
            justify-content: center;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 32px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            color: #374151;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group input, 
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 18px 24px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            background: white;
            color: #1f2937;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .form-group input:focus, 
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-1px);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        /* Choice Buttons */
        .choice-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .choice-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #64748b;
            border: 2px solid #e5e7eb;
            padding: 24px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            min-height: 120px;
            justify-content: center;
            text-align: center;
        }

        .choice-btn:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: #cbd5e1;
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .choice-btn.selected {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .choice-btn.selected:hover {
            background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(99, 102, 241, 0.4);
        }

        .choice-btn .icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        /* Navigation Buttons */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #e5e7eb;
        }

        .nav-btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .nav-btn.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .nav-btn.secondary:hover:not(:disabled) {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .nav-btn.neutral {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }

        .nav-btn.neutral:hover:not(:disabled) {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            box-shadow: 0 8px 20px rgba(107, 114, 128, 0.4);
        }

        .nav-btn.special {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .nav-btn.special:hover:not(:disabled) {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
            box-shadow: 0 8px 20px rgba(6, 182, 212, 0.4);
        }

        .nav-btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .nav-btn.danger:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
        }

        .nav-btn.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .nav-btn.orange:hover:not(:disabled) {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }

        .nav-btn.yellow {
            background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%);
            box-shadow: 0 4px 12px rgba(234, 179, 8, 0.3);
            color: #1f2937; /* Dark text on yellow background */
        }

        .nav-btn.yellow:hover:not(:disabled) {
            background: linear-gradient(135deg, #ca8a04 0%, #a16207 100%);
            box-shadow: 0 8px 20px rgba(234, 179, 8, 0.4);
            color: #111827; /* Darker text on hover */
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-btn.primary:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.4);
        }

        .nav-btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .nav-btn.success:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #6366f1;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, #f8fafc 0%, #f0f9ff 100%);
            margin: 30px 0;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .upload-area:hover {
            border-color: #8b5cf6;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #10b981;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: #059669;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 18px 36px;
            border-radius: 16px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(99, 102, 241, 0.3);
            font-size: 16px;
            margin: 10px;
        }

        .file-label:hover {
            background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .record-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 18px 36px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
            display: inline-block;
            margin: 10px;
        }

        .record-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            animation: recordingPulse 1s infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        /* Status Messages */
        .status {
            padding: 16px 24px;
            border-radius: 12px;
            margin: 24px 0;
            font-weight: 500;
            text-align: center;
            border: 1px solid transparent;
        }

        .status.loading {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #93c5fd;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }

        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }

        /* Results Section */
        .result-area {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            direction: rtl;
            position: relative;
            color: #1f2937;
        }

        .result-area:empty::before {
            content: "Transcription will appear here...";
            color: #9ca3af;
            font-style: italic;
        }

        /* Patient and Treatment Cards */
        .patient-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .patient-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-color: #cbd5e1;
        }

        .session-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .session-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-color: #cbd5e1;
        }

        /* Delete buttons */
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
            z-index: 10;
        }

        .delete-btn:hover {
            background: #fecaca;
            opacity: 1;
            transform: scale(1.1);
        }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-header h3 {
            color: #1e293b;
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .modal-body {
            margin-bottom: 25px;
            text-align: center;
            color: #64748b;
        }

        .modal-footer {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .app-container {
                padding: 20px;
                margin: 20px 10px;
            }

            .step-card {
                padding: 24px 20px;
            }

            .step-card h2 {
                font-size: 1.5em;
                flex-direction: column;
                text-align: center;
            }

            /* Mobile Stepper - Horizontal without step names */
            .stepper-container {
                margin-bottom: 30px;
            }

            .stepper {
                flex-direction: row; /* Maintain horizontal direction */
                justify-content: center;
                align-items: center;
                gap: 15px; /* Space between steps */
                flex-wrap: nowrap;
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                border-radius: 20px;
                padding: 20px 15px;
                box-shadow: 0 4px 20px rgba(99, 102, 241, 0.08);
                border: 1px solid rgba(99, 102, 241, 0.1);
                overflow-x: auto; /* Allow horizontal scrolling if needed */
            }

            .step {
                flex-direction: column;
                align-items: center;
                text-align: center;
                position: relative;
                margin: 0;
                background: transparent;
                border-radius: 12px;
                transition: all 0.3s ease;
                flex-shrink: 0; /* Prevent shrinking */
            }

            .step-circle {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: #f3f4f6;
                color: #6b7280;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                font-size: 16px;
                transition: all 0.4s ease;
                border: 3px solid #e5e7eb;
                position: relative;
                z-index: 2;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            .step.active .step-circle {
                background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                color: white;
                border-color: #6366f1;
                box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
                transform: scale(1.1);
            }

            .step.completed .step-circle {
                background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                color: white;
                border-color: #10b981;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            }

            .step.completed .step-circle::after {
                content: '✓';
                position: absolute;
                font-size: 16px;
                font-weight: bold;
            }

            /* Hide step names in mobile */
            .step-label {
                display: none;
            }

            /* Horizontal connection lines */
            .step-connector {
                display: block;
                width: 25px;
                height: 3px;
                background: #e5e7eb;
                margin: 0;
                transition: all 0.3s ease;
                border-radius: 2px;
            }

            .step.completed + .step .step-connector,
            .step.completed .step-connector {
                background: linear-gradient(90deg, #10b981, #059669);
            }

            /* Mobile heading */
            .stepper-container::before {
                content: '📋 Progress';
                display: block;
                font-size: 16px;
                font-weight: 700;
                color: #1e293b;
                text-align: center;
                margin-bottom: 15px;
                padding: 8px 15px;
                background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
                border-radius: 12px;
                border: 1px solid #e2e8f0;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            .choice-buttons {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .step-navigation {
                flex-direction: column;
                gap: 15px;
            }

            .nav-btn {
                width: 100%;
                justify-content: center;
            }

            .upload-area {
                padding: 40px 20px;
            }
        }

        /* Extra Small Mobile Devices */
        @media (max-width: 480px) {
            .stepper {
                padding: 15px 10px;
                gap: 10px;
            }

            .step-circle {
                width: 35px;
                height: 35px;
                font-size: 14px;
            }

            .step-connector {
                width: 20px;
                height: 2px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo" data-translate="logo">Professional Transcription 🎤</a>
            
            <!-- Language Selector -->
            <div class="language-selector">
                <button id="langEn" class="language-btn active" onclick="changeLanguage('en')">🇺🇸 English</button>
                <button id="langHe" class="language-btn" onclick="changeLanguage('he')">🇮🇱 עברית</button>
            </div>
            
            <ul class="nav-links">
                <li><a href="/" data-translate="home">Home</a></li>
            </ul>
            
            <!-- User Info Section -->
            <div id="userSection" style="display: none;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="userGreeting" style="color: #1e293b; font-weight: 600;"></span>
                    <button id="logoutBtn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'" data-translate="logout">🚪 Logout</button>
                </div>
            </div>
            
            <!-- Login Button (shown when not authenticated) -->
            <button id="loginButton" class="cta-button" onclick="openLoginModal()" data-translate="login">Login to System</button>
        </div>
    </nav>

    <!-- App Section -->
    <section class="app-section">
        <div class="container">
            <div class="app-container">
                <!-- Stepper -->
                <div class="stepper-container">
                    <div class="stepper">
                        <div class="step active" data-step="1">
                            <div>
                                <div class="step-circle">1</div>
                                <div class="step-label" data-translate="step1">Patient Name</div>
                            </div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" data-step="2">
                            <div>
                                <div class="step-circle">2</div>
                                <div class="step-label" data-translate="step2">Date</div>
                            </div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" data-step="3">
                            <div>
                                <div class="step-circle">3</div>
                                <div class="step-label" data-translate="step3">Input Type</div>
                            </div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" data-step="4">
                            <div>
                                <div class="step-circle">4</div>
                                <div class="step-label" data-translate="step4">Content</div>
                            </div>
                        </div>
                        <div class="step-connector"></div>
                        <div class="step" data-step="5">
                            <div>
                                <div class="step-circle">5</div>
                                <div class="step-label" data-translate="step5">Transcription</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Patient Name -->
                <div class="step-content active" data-step="1">
                    <div class="step-card">
                        <h2>👤 <span data-translate="patientNameTitle">Patient Name</span></h2>
                        <div class="form-group">
                            <label for="patientName" data-translate="enterPatientName">Enter the patient's name:</label>
                            <input type="text" id="patientName" data-translate-placeholder="patientNamePlaceholder" placeholder="Patient name" value="" required autocomplete="off">
                        </div>
                        <div class="step-navigation">
                            <div></div>
                            <button class="nav-btn primary" onclick="nextStep()" id="step1Next" disabled>
                                <span data-translate="next">Next</span> →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Session Date -->
                <div class="step-content" data-step="2">
                    <div class="step-card">
                        <h2>📅 <span data-translate="treatmentDateTitle">Treatment Date</span></h2>
                        <div class="form-group">
                            <label for="sessionDate" data-translate="chooseTreatmentDate">Choose treatment date:</label>
                            <input type="date" id="sessionDate">
                        </div>
                        <div class="step-navigation">
                            <button class="nav-btn yellow" onclick="prevStep()">
                                ← <span data-translate="back">Back</span>
                            </button>
                            <button class="nav-btn primary" onclick="nextStep()">
                                <span data-translate="next">Next</span> →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Input Type Selection -->
                <div class="step-content" data-step="3">
                    <div class="step-card">
                        <h2>🎯 <span data-translate="chooseInputTypeTitle">Choose Input Type</span></h2>
                        <div class="choice-buttons">
                            <div class="choice-btn" onclick="selectInputType('text')" data-type="text">
                                <div class="icon">📝</div>
                                <div data-translate="enterText">Enter Text</div>
                                <small data-translate="enterTextDesc">Paste or type text directly</small>
                            </div>
                            <div class="choice-btn" onclick="selectInputType('audio')" data-type="audio">
                                <div class="icon">🎵</div>
                                <div data-translate="audioFile">Audio File</div>
                                <small data-translate="audioFileDesc">Upload file or record</small>
                            </div>
                        </div>
                        <div class="step-navigation">
                            <button class="nav-btn yellow" onclick="prevStep()">
                                ← <span data-translate="back">Back</span>
                            </button>
                            <button class="nav-btn primary" onclick="nextStep()" id="step3Next" disabled>
                                <span data-translate="next">Next</span> →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Content Input -->
                <div class="step-content" data-step="4">
                    <!-- Text Input -->
                    <div class="step-card" id="textInputCard" style="display: none;">
                        <h2>📝 <span data-translate="enterTextTitle">Enter Text</span></h2>
                        <div class="form-group">
                            <label for="directTextInput" data-translate="pasteOrTypeText">Paste or type your text:</label>
                            <textarea id="directTextInput" data-translate-placeholder="textAreaPlaceholder" placeholder="Paste or type here the text you want to process..." rows="8"></textarea>
                        </div>
                        <div class="step-navigation">
                            <button class="nav-btn yellow" onclick="prevStep()">
                                ← <span data-translate="back">Back</span>
                            </button>
                            <button class="nav-btn primary" onclick="nextStep()" id="step4NextText" disabled>
                                <span data-translate="next">Next</span> →
                            </button>
                        </div>
                    </div>

                    <!-- Audio Input -->
                    <div class="step-card" id="audioInputCard" style="display: none;">
                        <h2>🎵 <span data-translate="audioFileTitle">Audio File</span></h2>
                        
                        <!-- Service Selection -->
                        <div class="form-group">
                            <label for="qualityMode" data-translate="chooseTranscriptionService">Choose transcription service:</label>
                            <select id="qualityMode">
                                <option value="ivrit-ai" data-translate="ivritAiOption">🏆 ivrit.ai - Specially adapted for Hebrew</option>
                                <option value="assemblyai" data-translate="assemblyAiOption">⚠️ AssemblyAI - High accuracy (cloud - not encrypted!)</option>
                                <option value="secure-assemblyai" data-translate="secureAssemblyAiOption">🔒 AssemblyAI secured - Maximum encryption!</option>
                            </select>
                        </div>

                        <!-- Upload Area -->
                        <div class="upload-area" id="uploadArea">
                            <div style="font-size: 2em; margin-bottom: 15px;">📁</div>
                            <p><strong data-translate="dragAudioFile">Drag an audio file here or click to choose</strong></p>
                            <p style="margin: 10px 0; font-size: 14px;" data-translate="supportedFormats">Supports: MP3, WAV, M4A, WEBM, OGG, OPUS</p>
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                                <label for="audioFile" class="file-label" data-translate="chooseAudioFile">📂 Choose audio file</label>
                                <button id="recordBtn" class="record-btn" data-translate="startRecording">🎤 Start recording</button>
                            </div>
                            
                            <input type="file" id="audioFile" class="file-input" accept="audio/*">
                            
                            <!-- Recording Status -->
                            <div id="recordingStatus" style="display: none; margin-top: 15px; color: #dc2626; font-weight: bold; text-align: center;">
                                🔴 <span data-translate="recording">Recording...</span> <span id="recordingTime">00:00</span>
                            </div>
                            
                            <!-- Audio Player -->
                            <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 15px;"></audio>
                            
                            <!-- File Name Display -->
                            <div id="fileName" style="margin-top: 15px; font-weight: bold; color: #2563eb; text-align: center;"></div>
                        </div>

                        <div class="step-navigation">
                            <button class="nav-btn yellow" onclick="prevStep()">
                                ← <span data-translate="back">Back</span>
                            </button>
                            <button class="nav-btn primary" onclick="nextStep()" id="step4NextAudio" disabled>
                                <span data-translate="next">Next</span> →
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Transcription Results -->
                <div class="step-content" data-step="5">
                    <div class="step-card">
                        <h2>🎯 <span data-translate="transcriptionTitle">Transcription</span></h2>
                        
                        <!-- Status Messages -->
                        <div id="status" class="status" style="display: none;"></div>
                        
                        <!-- Transcribe Button -->
                        <div style="text-align: center; margin: 30px 0;">
                            <button id="transcribeBtn" class="nav-btn orange" style="font-size: 18px; padding: 20px 40px;" disabled>
                                🎯 <span data-translate="startTranscription">Start Transcription</span>
                            </button>
                        </div>

                        <!-- Results Area -->
                        <div id="resultsSection" style="display: none;">
                            <div class="result-area" id="transcriptionResult"></div>
                            
                            <!-- Action Buttons -->
                            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px; flex-wrap: wrap;">
                                <button id="copyBtn" class="nav-btn secondary" data-translate="copyText">📋 Copy Text</button>
                                <button id="saveBtn" class="nav-btn success" data-translate="saveTreatment">💾 Save Treatment</button>
                            </div>
                        </div>

                        <div class="step-navigation">
                            <button class="nav-btn yellow" onclick="prevStep()">
                                ← <span data-translate="back">Back</span>
                            </button>
                            <button class="nav-btn primary" onclick="startNewTranscription()">
                                🆕 <span data-translate="newTranscription">New Transcription</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Patient Management Section -->
                <div id="therapistSection" class="step-card" style="margin-top: 40px; display: none;">
                    <h2>👨‍⚕️ <span data-translate="patientManagement">Patient Management</span></h2>
                    
                    <!-- View Patients Button -->
                    <div style="text-align: center; margin: 20px 0;">
                        <button id="viewPatientsBtn" class="nav-btn primary" onclick="loadPatientsList()">
                            👥 <span data-translate="viewPatientsList">View Patients List</span>
                        </button>
                    </div>
                    
                    <div id="localFilesList" style="display: none;">
                        <h3 style="color: #1e293b; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                            📋 <span data-translate="localTranscriptionFiles">Local Transcription Files</span>
                        </h3>
                        <div id="localFilesContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle" data-translate="confirmAction">Confirm Action</h3>
            </div>
            <div class="modal-body" id="modalMessage" data-translate="confirmActionMessage">
                Are you sure you want to proceed with this action?
            </div>
            <div class="modal-footer">
                <button class="nav-btn neutral" id="cancelBtn" data-translate="cancel">Cancel</button>
                <button class="nav-btn danger" id="confirmBtn" data-translate="confirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentStep = 1;
        let selectedInputType = null;
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let recordingInterval;
        let currentUser = null;
        let sessionToken = null;
        let currentPatientName = null;
        let currentSessionFilename = null;
        let currentLanguage = 'en'; // Default language is English

        // Translations
        const translations = {
            en: {
                // Navigation
                "logo": "Professional Transcription 🎤",
                "home": "Home",
                "login": "Login to System",
                "logout": "🚪 Logout",
                
                // Steps
                "step1": "Patient Name",
                "step2": "Date",
                "step3": "Input Type",
                "step4": "Content",
                "step5": "Transcription",
                
                // Step 1: Patient Name
                "patientNameTitle": "Patient Name",
                "enterPatientName": "Enter the patient's name:",
                "patientNamePlaceholder": "Patient name",
                
                // Step 2: Date
                "treatmentDateTitle": "Treatment Date",
                "chooseTreatmentDate": "Choose treatment date:",
                
                // Step 3: Input Type
                "chooseInputTypeTitle": "Choose Input Type",
                "enterText": "Enter Text",
                "enterTextDesc": "Paste or type text directly",
                "audioFile": "Audio File",
                "audioFileDesc": "Upload file or record",
                
                // Step 4: Content
                "enterTextTitle": "Enter Text",
                "pasteOrTypeText": "Paste or type your text:",
                "textAreaPlaceholder": "Paste or type here the text you want to process...",
                "audioFileTitle": "Audio File",
                "chooseTranscriptionService": "Choose transcription service:",
                "ivritAiOption": "🏆 ivrit.ai - Specially adapted for Hebrew",
                "assemblyAiOption": "⚠️ AssemblyAI - High accuracy (cloud - not encrypted!)",
                "secureAssemblyAiOption": "🔒 AssemblyAI secured - Maximum encryption!",
                "dragAudioFile": "Drag an audio file here or click to choose",
                "supportedFormats": "Supports: MP3, WAV, M4A, WEBM, OGG, OPUS",
                "chooseAudioFile": "📂 Choose audio file",
                "startRecording": "🎤 Start recording",
                "stopRecording": "⏹️ Stop recording",
                "recording": "Recording...",
                "fileSelected": "File selected: ",
                
                // Step 5: Transcription
                "transcriptionTitle": "Transcription",
                "startTranscription": "Start Transcription",
                "processText": "🔧 Process Text",
                "copyText": "📋 Copy Text",
                "saveTreatment": "💾 Save Treatment",
                
                // Navigation buttons
                "next": "Next",
                "back": "Back",
                "newTranscription": "New Transcription",
                
                // Patient Management
                "patientManagement": "Patient Management",
                "viewPatientsList": "View Patients List",
                "localTranscriptionFiles": "Local Transcription Files",
                "patientsListTitle": "Patients list",
                "noPatients": "No patients found",
                "numberOfTreatments": "Number of treatments: ",
                "treatmentsFor": "Treatments for ",
                "noTreatments": "No treatments found for this patient",
                "treatmentFrom": "Treatment from ",
                "wordCount": "Word count: ",
                "backToPatientsList": "Back to patients list",
                "treatmentContent": "Treatment Content - ",
                "date": "Date:",
                "time": "Time:",
                
                // Confirmation Modal
                "confirmAction": "Confirm Action",
                "confirmActionMessage": "Are you sure you want to proceed with this action?",
                "deletePatient": "Delete Patient",
                "deletePatientConfirm": "Are you sure you want to delete patient \"{{name}}\" and all their treatments? This action cannot be undone.",
                "deleteTreatment": "Delete Treatment",
                "deleteTreatmentConfirm": "Are you sure you want to delete this treatment? This action cannot be undone.",
                "cancel": "Cancel",
                "confirm": "Confirm",
                
                // Status Messages
                "processingText": "Processing text...",
                "textProcessingSuccess": "✅ Text processing completed successfully!",
                "pleaseEnterPatientName": "Please enter patient name",
                "pleaseEnterText": "Please enter text for processing",
                "pleaseSelectAudioFile": "Please select an audio file or record",
                "transcribing": "Transcribing... Please wait",
                "transcriptionSuccess": "✅ Transcription completed successfully!",
                "errorAccessingMicrophone": "Error accessing microphone",
                "textCopied": "✅ Text copied to clipboard",
                "savingTreatment": "💾 Saving treatment...",
                "treatmentSaved": "✅ Treatment saved successfully!",
                "treatmentDetailsSaved": "✅ Treatment details saved:",
                "patientName": "Patient name:",
                "loadingPatientsList": "Loading patients list...",
                "loadingTreatments": "Loading treatments for {{name}}...",
                "loadingTreatmentContent": "Loading treatment content...",
                "deletingPatient": "Deleting patient {{name}}...",
                "patientDeleted": "✅ Patient {{name}} deleted successfully!",
                "deletingTreatment": "Deleting treatment...",
                "treatmentDeleted": "✅ Treatment deleted successfully!",
                "errorConnectingToServer": "Error connecting to server",
                
                // Result Area
                "transcriptionWillAppear": "Transcription will appear here...",
                
                // Progress indicator
                "progress": "📋 Progress"
            },
            he: {
                // Navigation
                "logo": "תמלול מקצועי 🎤",
                "home": "בית",
                "login": "התחברות למערכת",
                "logout": "🚪 התנתקות",
                
                // Steps
                "step1": "שם המטופל",
                "step2": "תאריך",
                "step3": "סוג קלט",
                "step4": "תוכן",
                "step5": "תמלול",
                
                // Step 1: Patient Name
                "patientNameTitle": "שם המטופל",
                "enterPatientName": "הזן את שם המטופל:",
                "patientNamePlaceholder": "שם המטופל",
                
                // Step 2: Date
                "treatmentDateTitle": "תאריך הטיפול",
                "chooseTreatmentDate": "בחר תאריך טיפול:",
                
                // Step 3: Input Type
                "chooseInputTypeTitle": "בחר סוג קלט",
                "enterText": "הזנת טקסט",
                "enterTextDesc": "הדבק או הקלד טקסט ישירות",
                "audioFile": "קובץ שמע",
                "audioFileDesc": "העלה קובץ או הקלט",
                
                // Step 4: Content
                "enterTextTitle": "הזנת טקסט",
                "pasteOrTypeText": "הדבק או הקלד את הטקסט שלך:",
                "textAreaPlaceholder": "הדבק או הקלד כאן את הטקסט שברצונך לעבד...",
                "audioFileTitle": "קובץ שמע",
                "chooseTranscriptionService": "בחר שירות תמלול:",
                "ivritAiOption": "🏆 ivrit.ai - מותאם במיוחד לעברית",
                "assemblyAiOption": "⚠️ AssemblyAI - דיוק גבוה (ענן - לא מוצפן!)",
                "secureAssemblyAiOption": "🔒 AssemblyAI מאובטח - הצפנה מקסימלית!",
                "dragAudioFile": "גרור קובץ שמע לכאן או לחץ לבחירה",
                "supportedFormats": "תומך בפורמטים: MP3, WAV, M4A, WEBM, OGG, OPUS",
                "chooseAudioFile": "📂 בחר קובץ שמע",
                "startRecording": "🎤 התחל הקלטה",
                "stopRecording": "⏹️ עצור הקלטה",
                "recording": "מקליט...",
                "fileSelected": "קובץ נבחר: ",
                
                // Step 5: Transcription
                "transcriptionTitle": "תמלול",
                "startTranscription": "התחל תמלול",
                "processText": "🔧 עבד טקסט",
                "copyText": "📋 העתק טקסט",
                "saveTreatment": "💾 שמור טיפול",
                
                // Navigation buttons
                "next": "הבא",
                "back": "חזרה",
                "newTranscription": "תמלול חדש",
                
                // Patient Management
                "patientManagement": "ניהול מטופלים",
                "viewPatientsList": "צפה ברשימת מטופלים",
                "localTranscriptionFiles": "קבצי תמלול מקומיים",
                "patientsListTitle": "רשימת מטופלים",
                "noPatients": "לא נמצאו מטופלים",
                "numberOfTreatments": "מספר טיפולים: ",
                "treatmentsFor": "טיפולים עבור ",
                "noTreatments": "לא נמצאו טיפולים למטופל זה",
                "treatmentFrom": "טיפול מתאריך ",
                "wordCount": "מספר מילים: ",
                "backToPatientsList": "חזרה לרשימת המטופלים",
                "treatmentContent": "תוכן הטיפול - ",
                "date": "תאריך:",
                "time": "שעה:",
                
                // Confirmation Modal
                "confirmAction": "אישור פעולה",
                "confirmActionMessage": "האם אתה בטוח שברצונך להמשיך בפעולה זו?",
                "deletePatient": "מחיקת מטופל",
                "deletePatientConfirm": "האם אתה בטוח שברצונך למחוק את המטופל \"{{name}}\" ואת כל הטיפולים שלו? פעולה זו אינה ניתנת לביטול.",
                "deleteTreatment": "מחיקת טיפול",
                "deleteTreatmentConfirm": "האם אתה בטוח שברצונך למחוק טיפול זה? פעולה זו אינה ניתנת לביטול.",
                "cancel": "ביטול",
                "confirm": "אישור",
                
                // Status Messages
                "processingText": "מעבד טקסט...",
                "textProcessingSuccess": "✅ עיבוד הטקסט הושלם בהצלחה!",
                "pleaseEnterPatientName": "אנא הזן שם מטופל",
                "pleaseEnterText": "אנא הזן טקסט לעיבוד",
                "pleaseSelectAudioFile": "אנא בחר קובץ שמע או הקלט",
                "transcribing": "מתמלל... אנא המתן",
                "transcriptionSuccess": "✅ התמלול הושלם בהצלחה!",
                "errorAccessingMicrophone": "שגיאה בגישה למיקרופון",
                "textCopied": "✅ הטקסט הועתק ללוח",
                "savingTreatment": "💾 שומר טיפול...",
                "treatmentSaved": "✅ הטיפול נשמר בהצלחה!",
                "treatmentDetailsSaved": "✅ פרטי הטיפול נשמרו:",
                "patientName": "שם המטופל:",
                "loadingPatientsList": "טוען רשימת מטופלים...",
                "loadingTreatments": "טוען טיפולים עבור {{name}}...",
                "loadingTreatmentContent": "טוען תוכן טיפול...",
                "deletingPatient": "מוחק מטופל {{name}}...",
                "patientDeleted": "✅ המטופל {{name}} נמחק בהצלחה!",
                "deletingTreatment": "מוחק טיפול...",
                "treatmentDeleted": "✅ הטיפול נמחק בהצלחה!",
                "errorConnectingToServer": "שגיאה בהתחברות לשרת",
                
                // Result Area
                "transcriptionWillAppear": "התמלול יופיע כאן...",
                
                // Progress indicator
                "progress": "📋 התקדמות"
            }
        };

        // Function to change language
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Update language buttons
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            document.getElementById('langHe').classList.toggle('active', lang === 'he');
            
            // Update HTML direction and language attributes
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'he' ? 'rtl' : 'ltr';
            
            // Update all elements with data-translate attribute
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // Update placeholders
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (translations[lang][key]) {
                    element.placeholder = translations[lang][key];
                }
            });
            
            // Update record button text if recording
            const recordBtn = document.getElementById('recordBtn');
            if (recordBtn && recordBtn.classList.contains('recording')) {
                recordBtn.textContent = translations[lang]['stopRecording'];
            }
            
            // Update transcribe button text based on input type
            const transcribeBtn = document.getElementById('transcribeBtn');
            if (transcribeBtn && selectedInputType === 'text') {
                transcribeBtn.textContent = '🔧 ' + translations[lang]['processText'];
            } else if (transcribeBtn) {
                transcribeBtn.textContent = '🎯 ' + translations[lang]['startTranscription'];
            }
            
            // Update file name display if a file is selected
            const fileNameElement = document.getElementById('fileName');
            if (fileNameElement && fileNameElement.textContent) {
                const fileName = fileNameElement.textContent.split(': ')[1];
                if (fileName) {
                    fileNameElement.textContent = translations[lang]['fileSelected'] + fileName;
                }
            }
            
            // Save language preference to localStorage
            localStorage.setItem('preferredLanguage', lang);
        }

        // Step Navigation Functions
        function nextStep() {
            if (currentStep < 5) {
                // Mark current step as completed
                const currentStepElement = document.querySelector(`.step[data-step="${currentStep}"]`);
                currentStepElement.classList.remove('active');
                currentStepElement.classList.add('completed');

                // Move to next step
                currentStep++;
                const nextStepElement = document.querySelector(`.step[data-step="${currentStep}"]`);
                nextStepElement.classList.add('active');

                // Show next step content
                document.querySelectorAll('.step-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');

                // Handle step-specific logic
                if (currentStep === 4) {
                    showSelectedInputCard();
                } else if (currentStep === 5) {
                    prepareTranscriptionStep();
                }
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                // Mark current step as inactive
                const currentStepElement = document.querySelector(`.step[data-step="${currentStep}"]`);
                currentStepElement.classList.remove('active');

                // Move to previous step
                currentStep--;
                const prevStepElement = document.querySelector(`.step[data-step="${currentStep}"]`);
                prevStepElement.classList.remove('completed');
                prevStepElement.classList.add('active');

                // Show previous step content
                document.querySelectorAll('.step-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
            }
        }

        // Input Type Selection
        function selectInputType(type) {
            selectedInputType = type;
            
            // Update UI
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`.choice-btn[data-type="${type}"]`).classList.add('selected');
            
            // Enable next button
            document.getElementById('step3Next').disabled = false;
        }

        // Show Selected Input Card
        function showSelectedInputCard() {
            const textCard = document.getElementById('textInputCard');
            const audioCard = document.getElementById('audioInputCard');
            
            if (selectedInputType === 'text') {
                textCard.style.display = 'block';
                audioCard.style.display = 'none';
            } else if (selectedInputType === 'audio') {
                textCard.style.display = 'none';
                audioCard.style.display = 'block';
            }
        }

        // Prepare Transcription Step
        function prepareTranscriptionStep() {
            const transcribeBtn = document.getElementById('transcribeBtn');

            if (selectedInputType === 'text') {
                const textInput = document.getElementById('directTextInput').value.trim();
                transcribeBtn.disabled = !textInput;
                transcribeBtn.textContent = '🔧 ' + translations[currentLanguage]['processText'];
            } else if (selectedInputType === 'audio') {
                const audioFile = document.getElementById('audioFile').files[0];
                transcribeBtn.disabled = !audioFile;
                transcribeBtn.textContent = '🎯 ' + translations[currentLanguage]['startTranscription'];
            }
        }

        // Recording Functions
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    
                    // Create file for upload
                    const file = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('audioFile').files = dataTransfer.files;
                    
                    updateFileName('recording.wav');
                    document.getElementById('step4NextAudio').disabled = false;
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                document.getElementById('recordBtn').textContent = translations[currentLanguage]['stopRecording'];
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingStatus').style.display = 'block';
                
                recordingInterval = setInterval(updateRecordingTime, 1000);
                
            } catch (error) {
                console.error('Error in recording:', error);
                showStatus(translations[currentLanguage]['errorAccessingMicrophone'], 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('recordBtn').textContent = translations[currentLanguage]['startRecording'];
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordingStatus').style.display = 'none';
                
                clearInterval(recordingInterval);
            }
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
        }

        function updateFileName(name) {
            document.getElementById('fileName').textContent = translations[currentLanguage]['fileSelected'] + name;
        }

        // Transcription Functions
        async function transcribeAudio() {
            const patientName = document.getElementById('patientName').value.trim();
            const sessionDate = document.getElementById('sessionDate').value;
            
            if (!patientName) {
                showStatus(translations[currentLanguage]['pleaseEnterPatientName'], 'error');
                return;
            }

            if (selectedInputType === 'text') {
                const directText = document.getElementById('directTextInput').value.trim();
                if (!directText) {
                    showStatus(translations[currentLanguage]['pleaseEnterText'], 'error');
                    return;
                }
                
                // Process text directly
                showStatus(translations[currentLanguage]['processingText'], 'loading');
                setTimeout(() => {
                    displayResults({
                        original_transcript: directText,
                        corrected_transcript: directText
                    });
                    showStatus(translations[currentLanguage]['textProcessingSuccess'], 'success');
                }, 1000);
                return;
            }

            // Audio processing
            const audioFile = document.getElementById('audioFile').files[0];
            const qualityMode = document.getElementById('qualityMode').value;
            
            if (!audioFile) {
                showStatus(translations[currentLanguage]['pleaseSelectAudioFile'], 'error');
                return;
            }

            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('patient_name', patientName);
            formData.append('session_date', sessionDate);
            formData.append('quality_mode', qualityMode);

            try {
                showStatus(translations[currentLanguage]['transcribing'], 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                const response = await fetch('/transcribe', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus(translations[currentLanguage]['transcriptionSuccess'], 'success');
                    displayResults(data);
                } else {
                    showStatus(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Error in transcription:', error);
                showStatus(translations[currentLanguage]['errorConnectingToServer'], 'error');
            } finally {
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // Display Results
        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const transcriptionResult = document.getElementById('transcriptionResult');
            
            transcriptionResult.textContent = data.corrected_transcript || data.original_transcript || '';
            resultsSection.style.display = 'block';
        }

        // Utility Functions
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }

        function startNewTranscription() {
            // Reset all steps
            currentStep = 1;
            selectedInputType = null;
            
            // Reset stepper UI
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active', 'completed');
            });
            document.querySelector('.step[data-step="1"]').classList.add('active');
            
            // Reset content
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelector('.step-content[data-step="1"]').classList.add('active');
            
            // Clear form data
            document.getElementById('patientName').value = '';
            document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('directTextInput').value = '';
            document.getElementById('audioFile').value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('status').style.display = 'none';
            
            // Reset buttons
            document.getElementById('step1Next').disabled = true;
            document.getElementById('step3Next').disabled = true;
            document.getElementById('step4NextText').disabled = true;
            document.getElementById('step4NextAudio').disabled = true;
            document.getElementById('transcribeBtn').disabled = true;
        }

        function openLoginModal() {
            window.location.href = '/';
        }

        // Confirmation Modal Functions
        function showConfirmationModal(title, message, confirmCallback) {
            document.getElementById('modalTitle').textContent = translations[currentLanguage][title] || title;
            document.getElementById('modalMessage').textContent = message;
            
            const modal = document.getElementById('confirmationModal');
            const confirmBtn = document.getElementById('confirmBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            
            // Clear previous event listeners
            const newConfirmBtn = confirmBtn.cloneNode(true);
            const newCancelBtn = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            
            // Add new event listeners
            newConfirmBtn.addEventListener('click', () => {
                hideConfirmationModal();
                confirmCallback();
            });
            
            newCancelBtn.addEventListener('click', hideConfirmationModal);
            
            // Show modal
            modal.classList.add('active');
        }

        function hideConfirmationModal() {
            document.getElementById('confirmationModal').classList.remove('active');
        }

        // Patient Management Functions
        async function loadPatientsList() {
            try {
                showStatus(translations[currentLanguage]['loadingPatientsList'], 'loading');
                
                const response = await fetch('/patients', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayPatientsList(data.patients);
                } else {
                    showStatus(`Error: ${data.error || 'Error loading patients list'}`, 'error');
                }
            } catch (error) {
                console.error('Error loading patients list:', error);
                showStatus(translations[currentLanguage]['errorConnectingToServer'], 'error');
            }
        }

        function displayPatientsList(patients) {
            // Activate patient management area
            const therapistSection = document.getElementById('therapistSection');
            therapistSection.style.display = 'block';
            
            // Create area for patients list
            let patientsListSection = document.getElementById('patientsListSection');
            
            if (!patientsListSection) {
                patientsListSection = document.createElement('div');
                patientsListSection.id = 'patientsListSection';
                therapistSection.appendChild(patientsListSection);
            }
            
            // Build patients list content
            let patientsHtml = `
                <h3 style="color: #1e293b; margin: 20px 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                    👥 ${translations[currentLanguage]['patientsListTitle']}
                </h3>
            `;
            
            if (patients.length === 0) {
                patientsHtml += `<p>${translations[currentLanguage]['noPatients']}</p>`;
            } else {
                patientsHtml += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                `;
                
                patients.forEach(patient => {
                    patientsHtml += `
                        <div class="patient-card">
                            <button class="delete-btn" onclick="event.stopPropagation(); confirmDeletePatient('${patient.name}')">✕</button>
                            <div onclick="loadPatientSessions('${patient.name}')" style="padding: 10px;">
                                <h4 style="margin: 0 0 10px 0; color: #2563eb;">${patient.name}</h4>
                                <p style="margin: 5px 0;">${translations[currentLanguage]['numberOfTreatments']}${patient.session_count}</p>
                            </div>
                        </div>
                    `;
                });
                
                patientsHtml += `</div>`;
            }
            
            // Update content
            patientsListSection.innerHTML = patientsHtml;
            
            // Hide any session content sections
            const sessionsListSection = document.getElementById('sessionsListSection');
            if (sessionsListSection) {
                sessionsListSection.style.display = 'none';
            }
            
            const sessionContentSection = document.getElementById('sessionContentSection');
            if (sessionContentSection) {
                sessionContentSection.style.display = 'none';
            }
            
            // Scroll to patients list area
            therapistSection.scrollIntoView({ behavior: 'smooth' });
            
            // Remove loading message
            document.getElementById('status').style.display = 'none';
        }

        async function loadPatientSessions(patientName) {
            try {
                const loadingMessage = translations[currentLanguage]['loadingTreatments'].replace('{{name}}', patientName);
                showStatus(loadingMessage, 'loading');
                currentPatientName = patientName;
                
                const response = await fetch(`/patients/${patientName}/sessions`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayPatientSessions(patientName, data.sessions);
                } else {
                    showStatus(`Error: ${data.error || 'Error loading treatments list'}`, 'error');
                }
            } catch (error) {
                console.error('Error loading treatments list:', error);
                showStatus(translations[currentLanguage]['errorConnectingToServer'], 'error');
            }
        }

        function displayPatientSessions(patientName, sessions) {
            // Create area for treatments list
            let sessionsListSection = document.getElementById('sessionsListSection');
            
            if (!sessionsListSection) {
                sessionsListSection = document.createElement('div');
                sessionsListSection.id = 'sessionsListSection';
                document.getElementById('therapistSection').appendChild(sessionsListSection);
            } else {
                sessionsListSection.style.display = 'block';
            }
            
            // Build treatments list content
            let sessionsHtml = `
                <h3 style="color: #1e293b; margin: 20px 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                    📝 ${translations[currentLanguage]['treatmentsFor']}${patientName}
                </h3>
                <div style="margin-bottom: 20px;">
                    <button class="nav-btn secondary" onclick="loadPatientsList()">
                        ← ${translations[currentLanguage]['backToPatientsList']}
                    </button>
                </div>
            `;
            
            if (sessions.length === 0) {
                sessionsHtml += `<p>${translations[currentLanguage]['noTreatments']}</p>`;
            } else {
                sessionsHtml += `
                    <div style="display: flex; flex-direction: column; gap: 15px;">
                `;
                
                sessions.forEach(session => {
                    const sessionDate = session.formatted_date || 'Unknown date';
                    const sessionTime = session.formatted_time || '';
                    const wordCount = session.word_count || 0;
                    
                    sessionsHtml += `
                        <div class="session-card">
                            <button class="delete-btn" onclick="event.stopPropagation(); confirmDeleteSession('${patientName}', '${session.filename}')">✕</button>
                            <div onclick="loadSessionContent('${patientName}', '${session.filename}')" style="padding: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <h4 style="margin: 0; color: #2563eb;">${translations[currentLanguage]['treatmentFrom']}${sessionDate}</h4>
                                    <span style="color: #64748b;">${sessionTime}</span>
                                </div>
                                <p style="margin: 5px 0;">${translations[currentLanguage]['wordCount']}${wordCount}</p>
                            </div>
                        </div>
                    `;
                });
                
                sessionsHtml += `</div>`;
            }
            
            // Update content
            sessionsListSection.innerHTML = sessionsHtml;
            
            // Hide patient list section
            const patientsListSection = document.getElementById('patientsListSection');
            if (patientsListSection) {
                patientsListSection.style.display = 'none';
            }
            
            // Hide session content section if it exists
            const sessionContentSection = document.getElementById('sessionContentSection');
            if (sessionContentSection) {
                sessionContentSection.style.display = 'none';
            }
            
            // Scroll to treatments list area
            sessionsListSection.scrollIntoView({ behavior: 'smooth' });
            
            // Remove loading message
            document.getElementById('status').style.display = 'none';
        }

        async function loadSessionContent(patientName, filename) {
            try {
                showStatus(translations[currentLanguage]['loadingTreatmentContent'], 'loading');
                currentPatientName = patientName;
                currentSessionFilename = filename;
                
                const response = await fetch(`/patients/${patientName}/session/${filename}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displaySessionContent(patientName, data.session_data);
                } else {
                    showStatus(`Error: ${data.error || 'Error loading treatment content'}`, 'error');
                }
            } catch (error) {
                console.error('Error loading treatment content:', error);
                showStatus(translations[currentLanguage]['errorConnectingToServer'], 'error');
            }
        }

        function displaySessionContent(patientName, sessionData) {
            // Create area for treatment content
            let sessionContentSection = document.getElementById('sessionContentSection');
            
            if (!sessionContentSection) {
                sessionContentSection = document.createElement('div');
                sessionContentSection.id = 'sessionContentSection';
                document.getElementById('therapistSection').appendChild(sessionContentSection);
            } else {
                // If area already exists, make sure it's visible
                sessionContentSection.style.display = 'block';
            }
            
            // Get treatment content
            const transcriptText = sessionData.transcript_text || sessionData.corrected_transcript || sessionData.original_transcript || 'No content available';
            const sessionDate = sessionData.formatted_date || 'Unknown date';
            const sessionTime = sessionData.formatted_time || '';
            const wordCount = sessionData.word_count || transcriptText.split(/\s+/).length || 0;
            
            // Build treatment content
            const sessionContentHtml = `
                <div style="background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #e5e7eb; padding-bottom: 10px;">
                        <h3 style="margin: 0; color: #1e293b;">${translations[currentLanguage]['treatmentContent']}${patientName}</h3>
                        <span style="color: #64748b;">${sessionDate} ${sessionTime}</span>
                    </div>
                    
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <div style="background: #f0f9ff; border-radius: 8px; padding: 8px 12px; color: #0369a1; font-size: 14px; font-weight: 500;">
                            <span style="font-weight: bold;">${translations[currentLanguage]['date']}</span> ${sessionDate}
                        </div>
                        <div style="background: #f0f9ff; border-radius: 8px; padding: 8px 12px; color: #0369a1; font-size: 14px; font-weight: 500;">
                            <span style="font-weight: bold;">${translations[currentLanguage]['time']}</span> ${sessionTime}
                        </div>
                        <div style="background: #f0f9ff; border-radius: 8px; padding: 8px 12px; color: #0369a1; font-size: 14px; font-weight: 500;">
                            <span style="font-weight: bold;">${translations[currentLanguage]['wordCount']}</span> ${wordCount}
                        </div>
                    </div>
                    
                    <div class="result-area" style="background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 10px; padding: 15px; margin: 10px 0; white-space: pre-wrap; direction: rtl;">
                        ${transcriptText}
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
                        <button id="copySessionBtn" class="nav-btn secondary">${translations[currentLanguage]['copyText']}</button>
                        <button id="backToSessionsBtn" class="nav-btn primary">${translations[currentLanguage]['backToPatientsList']}</button>
                    </div>
                </div>
            `;
            
            // Update content
            sessionContentSection.innerHTML = sessionContentHtml;
            
            // Add click events for buttons
            document.getElementById('copySessionBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(transcriptText).then(() => {
                    showStatus(translations[currentLanguage]['textCopied'], 'success');
                });
            });
            
            document.getElementById('backToSessionsBtn').addEventListener('click', () => {
                // Hide treatment content and show treatments list
                sessionContentSection.style.display = 'none';
                document.getElementById('sessionsListSection').scrollIntoView({ behavior: 'smooth' });
            });
            
            // Scroll to treatment content area
            sessionContentSection.scrollIntoView({ behavior: 'smooth' });
            
            // Remove loading message
            document.getElementById('status').style.display = 'none';
        }

        // Delete Functions
        function confirmDeletePatient(patientName) {
            const message = translations[currentLanguage]['deletePatientConfirm'].replace('{{name}}', patientName);
            showConfirmationModal('deletePatient', message, () => deletePatient(patientName));
        }

        async function deletePatient(patientName) {
            try {
                const deletingMessage = translations[currentLanguage]['deletingPatient'].replace('{{name}}', patientName);
                showStatus(deletingMessage, 'loading');
                
                const response = await fetch(`/patient/${patientName}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const deletedMessage = translations[currentLanguage]['patientDeleted'].replace('{{name}}', patientName);
                    showStatus(deletedMessage, 'success');
                    loadPatientsList(); // Refresh the patients list
                } else {
                    showStatus(`Error: ${data.error || 'Error deleting patient'}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting patient:', error);
                showStatus(translations[currentLanguage]['errorConnectingToServer'], 'error');
            }
        }

        function confirmDeleteSession(patientName, sessionFilename) {
            showConfirmationModal('deleteTreatment', translations[currentLanguage]['deleteTreatmentConfirm'], () => deleteSession(patientName, sessionFilename));
        }

        async function deleteSession(patientName, sessionFilename) {
            try {
                showStatus(translations[currentLanguage]['deletingTreatment'], 'loading');
                
                const response = await fetch(`/delete-session`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        patient_name: patientName,
                        session_filename: sessionFilename
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showStatus(translations[currentLanguage]['treatmentDeleted'], 'success');
                    loadPatientSessions(patientName); // Refresh the treatments list
                } else {
                    showStatus(`Error: ${data.error || 'Error deleting treatment'}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting treatment:', error);
                showStatus(translations[currentLanguage]['errorConnectingToServer'], 'error');
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved language preference or default to English
            const savedLanguage = localStorage.getItem('preferredLanguage') || 'en';
            changeLanguage(savedLanguage);
            
            // Set default date
            document.getElementById('sessionDate').value = new Date().toISOString().split('T')[0];
            
            // Function to check patient name and update button state
            function checkPatientNameAndUpdateButton() {
                const patientNameInput = document.getElementById('patientName');
                const nextButton = document.getElementById('step1Next');
                if (patientNameInput && nextButton) {
                    const hasValue = patientNameInput.value.trim().length > 0;
                    nextButton.disabled = !hasValue;
                    console.log("Button state updated. Patient name:", patientNameInput.value, "Has value:", hasValue, "Button disabled:", !hasValue);
                }
            }
            
            // Patient name validation on input
            const patientNameInput = document.getElementById('patientName');
            
            // Direct event handler to ensure button state is updated immediately
            patientNameInput.oninput = function() {
                const nextButton = document.getElementById('step1Next');
                nextButton.disabled = this.value.trim().length === 0;
            };
            
            // Add event listeners for all relevant events to ensure robust handling
            ['change', 'keyup', 'paste', 'focus', 'blur'].forEach(eventType => {
                patientNameInput.addEventListener(eventType, function() {
                    const nextButton = document.getElementById('step1Next');
                    nextButton.disabled = this.value.trim().length === 0;
                });
            });
            
            // Check initial state immediately
            document.getElementById('step1Next').disabled = patientNameInput.value.trim().length === 0;
            
            // Force button state check after a short delay to ensure DOM is fully loaded
            setTimeout(function() {
                document.getElementById('step1Next').disabled = patientNameInput.value.trim().length === 0;
            }, 100);
            
            // Text input validation
            document.getElementById('directTextInput').addEventListener('input', (e) => {
                document.getElementById('step4NextText').disabled = !e.target.value.trim();
                if (currentStep === 5) {
                    document.getElementById('transcribeBtn').disabled = !e.target.value.trim();
                }
            });
            
            // Audio file validation
            document.getElementById('audioFile').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileName(e.target.files[0].name);
                    document.getElementById('step4NextAudio').disabled = false;
                    if (currentStep === 5) {
                        document.getElementById('transcribeBtn').disabled = false;
                    }
                }
            });
            
            // Recording button
            document.getElementById('recordBtn').addEventListener('click', () => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                } else {
                    startRecording();
                }
            });
            
            // Transcribe button
            document.getElementById('transcribeBtn').addEventListener('click', transcribeAudio);
            
            // Copy button
            document.getElementById('copyBtn').addEventListener('click', () => {
                const text = document.getElementById('transcriptionResult').textContent;
                navigator.clipboard.writeText(text).then(() => {
                    showStatus(translations[currentLanguage]['textCopied'], 'success');
                });
            });
            
            // Save button
            document.getElementById('saveBtn').addEventListener('click', async () => {
                const patientName = document.getElementById('patientName').value.trim();
                const transcriptText = document.getElementById('transcriptionResult').textContent.trim();
                
                if (!patientName || !transcriptText) {
                    showStatus(translations[currentLanguage]['pleaseEnterPatientName'], 'error');
                    return;
                }
                
                showStatus(translations[currentLanguage]['savingTreatment'], 'loading');
                
                try {
                    const response = await fetch('/save-session', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${sessionToken}`
                        },
                        body: JSON.stringify({
                            patient_name: patientName,
                            transcript_text: transcriptText
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showStatus(translations[currentLanguage]['treatmentSaved'], 'success');
                        
                        // Display patient and treatment details
                        displaySavedSessionInfo(patientName, transcriptText);
                    } else {
                        showStatus(`Error: ${data.error || 'Error saving treatment'}`, 'error');
                    }
                } catch (error) {
                    console.error('Error saving treatment:', error);
                    showStatus(translations[currentLanguage]['errorConnectingToServer'], 'error');
                }
            });
            
            // Function to display patient and treatment details
            function displaySavedSessionInfo(patientName, transcriptText) {
                // Check if info area already exists
                let savedSessionInfo = document.getElementById('savedSessionInfo');
                
                // If not, create new area
                if (!savedSessionInfo) {
                    savedSessionInfo = document.createElement('div');
                    savedSessionInfo.id = 'savedSessionInfo';
                    savedSessionInfo.className = 'status success';
                    savedSessionInfo.style.marginTop = '30px';
                    savedSessionInfo.style.textAlign = currentLanguage === 'he' ? 'right' : 'left';
                    savedSessionInfo.style.padding = '20px';
                    
                    // Add area after results section
                    const resultsSection = document.getElementById('resultsSection');
                    resultsSection.appendChild(savedSessionInfo);
                }
                
                // Create date and time in nice format
                const now = new Date();
                const formattedDate = now.toLocaleDateString(currentLanguage === 'he' ? 'he-IL' : 'en-US');
                const formattedTime = now.toLocaleTimeString(currentLanguage === 'he' ? 'he-IL' : 'en-US', { hour: '2-digit', minute: '2-digit' });
                
                // Update content with patient and treatment details
                savedSessionInfo.innerHTML = `
                    <h3 style="margin-bottom: 10px; color: #166534; font-weight: bold;">${translations[currentLanguage]['treatmentDetailsSaved']}</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div><strong>${translations[currentLanguage]['patientName']}</strong> ${patientName}</div>
                        <div><strong>${translations[currentLanguage]['date']}</strong> ${formattedDate} ${formattedTime}</div>
                        <div><strong>${translations[currentLanguage]['wordCount']}</strong> ${transcriptText.split(/\s+/).length}</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <button id="viewPatientsBtn" class="nav-btn primary" style="margin-top: 10px;">
                            👥 ${translations[currentLanguage]['viewPatientsList']}
                        </button>
                    </div>
                `;
                
                // Add click event for view patients button
                document.getElementById('viewPatientsBtn').addEventListener('click', () => {
                    loadPatientsList();
                });
            }
            
            // Upload area drag and drop
            const uploadArea = document.getElementById('uploadArea');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        document.getElementById('audioFile').files = files;
                        updateFileName(files[0].name);
                        document.getElementById('step4NextAudio').disabled = false;
                    }
                });
            }
            
            // Update result area placeholder based on language
            const style = document.createElement('style');
            style.textContent = `
                .result-area:empty::before {
                    content: "${translations[currentLanguage]['transcriptionWillAppear']}";
                    color: #9ca3af;
                    font-style: italic;
                }
                
                /* Mobile heading */
                .stepper-container::before {
                    content: '${translations[currentLanguage]['progress']}';
                }
            `;
            document.head.appendChild(style);
        });

        // Make functions available globally
        window.loadPatientSessions = loadPatientSessions;
        window.loadSessionContent = loadSessionContent;
        window.loadPatientsList = loadPatientsList;
        window.confirmDeletePatient = confirmDeletePatient;
        window.confirmDeleteSession = confirmDeleteSession;
        window.changeLanguage = changeLanguage;
    </script>
</body>
</html>
