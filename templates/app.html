                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/static/manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="×ª××œ×•×œ">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
    
    <title>××¢×¨×›×ª ×ª××œ×•×œ ×œ××˜×¤×œ×™× - ××¤×œ×™×§×¦×™×”</title>
    
    <!-- ×¡×¤×¨×™×™×ª ×”×¦×¤× ×” -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
            min-height: 100vh;
            color: #1e293b;
            line-height: 1.6;
        }

        /* Header */
        .navbar {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            box-shadow: 0 2px 20px rgba(99, 102, 241, 0.15);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #e2e8f0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #6366f1;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            list-style: none;
        }

        .nav-links a {
            color: #64748b;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #6366f1;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* App Section */
        .app-section {
            padding: 60px 0;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .app-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .section {
            margin-bottom: 40px;
            padding: 32px;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
        }

        .section h2 {
            color: #1e293b;
            margin-bottom: 24px;
            font-size: 1.8em;
            border-bottom: 2px solid #6366f1;
            padding-bottom: 12px;
            font-weight: 600;
        }

        /* Modern Form Styling */
        .modern-form-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 24px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.12);
            border: 1px solid rgba(99, 102, 241, 0.1);
            position: relative;
            overflow: hidden;
        }

        .modern-form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
        }

        .modern-form-section h2 {
            color: #1e293b;
            margin-bottom: 28px;
            font-size: 1.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
            border: none;
            padding: 0;
        }

        .modern-form-section h2::before {
            content: 'ğŸ¤';
            font-size: 0.9em;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 8px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        .modern-form-group {
            position: relative;
        }

        .modern-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modern-form-group input, 
        .modern-form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            background: white;
            color: #1f2937;
            transition: all 0.3s ease;
            font-family: inherit;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
        }

        .modern-form-group input:focus, 
        .modern-form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(99, 102, 241, 0.15);
            transform: translateY(-1px);
        }

        .modern-form-group input::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        .input-mode-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(6, 182, 212, 0.2);
        }

        .input-mode-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .input-mode-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: #64748b;
            border: 2px solid #e5e7eb;
            padding: 14px 28px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 140px;
            justify-content: center;
        }

        .input-mode-btn:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .input-mode-btn.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #6366f1;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .input-mode-btn.active:hover {
            background: linear-gradient(135deg, #5855eb 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        /* Enhanced Action Button */
        .enhanced-transcribe-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            margin-top: 32px;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.3);
            position: relative;
            overflow: hidden;
        }

        .enhanced-transcribe-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s;
        }

        .enhanced-transcribe-btn:hover:not(:disabled)::before {
            left: 100%;
        }

        .enhanced-transcribe-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(16, 185, 129, 0.4);
        }

        .enhanced-transcribe-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            color: #1f2937;
            transition: all 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input::placeholder {
            color: #9ca3af;
        }

        .form-group small {
            color: #6b7280;
            font-size: 12px;
        }

        .recording-section {
            text-align: center;
            margin: 30px 0;
        }

        .record-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 20px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .record-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .record-btn.recording {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            animation: pulse 1s infinite;
        }

        .record-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .upload-area {
            border: 2px dashed #6366f1;
            border-radius: 16px;
            padding: 48px;
            text-align: center;
            background: #f8fafc;
            margin: 24px 0;
            transition: all 0.3s ease;
            color: #64748b;
        }

        .upload-area:hover {
            border-color: #8b5cf6;
            background: #f0f9ff;
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #10b981;
            background: #ecfdf5;
            color: #059669;
        }

        .file-input {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            cursor: pointer;
            display: inline-block;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
        }

        .file-label:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .transcribe-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 18px 36px;
            border-radius: 14px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(16, 185, 129, 0.3);
        }

        .transcribe-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .transcribe-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status {
            padding: 16px 24px;
            border-radius: 12px;
            margin: 24px 0;
            font-weight: 500;
            text-align: center;
            border: 1px solid transparent;
        }

        .status.loading {
            background: #dbeafe;
            color: #1d4ed8;
            border-color: #93c5fd;
        }

        .status.success {
            background: #dcfce7;
            color: #166534;
            border-color: #86efac;
        }

        .status.error {
            background: #fee2e2;
            color: #dc2626;
            border-color: #fca5a5;
        }

        .result-area {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            margin-top: 24px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            direction: rtl;
            position: relative;
            color: #1f2937;
        }

        .result-area:empty::before {
            content: "×”×ª××œ×•×œ ×™×•×¤×™×¢ ×›××Ÿ...";
            color: #9ca3af;
            font-style: italic;
        }

        .result-tabs {
            display: flex;
            margin-top: 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }

        .result-tab {
            padding: 16px 24px;
            cursor: pointer;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            margin-left: 0;
            font-weight: 500;
            transition: all 0.3s ease;
            color: #6b7280;
            flex: 1;
            text-align: center;
        }

        .result-tab.active {
            background: white;
            border-bottom-color: #2563eb;
            color: #2563eb;
        }

        .result-tab:hover:not(.active) {
            background: #f3f4f6;
            color: #374151;
        }

        .text-editor {
            background: #f8fafc;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            margin-top: 16px;
            min-height: 200px;
            font-size: 16px;
            line-height: 1.8;
            direction: rtl;
            resize: vertical;
            width: 100%;
            font-family: inherit;
            outline: none;
            color: #1f2937;
        }

        .text-editor:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .text-editor::placeholder {
            color: #9ca3af;
        }

        .patients-section {
            background: transparent;
        }

        .patients-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .patient-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .patient-card:hover {
            border-color: #2563eb;
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .patient-card h3 {
            color: #1e293b;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .patient-card p {
            color: #64748b;
        }

        .delete-patient-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            background: linear-gradient(135deg, #fca5a5 0%, #fecaca 100%);
            color: #7f1d1d;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(252, 165, 165, 0.6);
            z-index: 10;
            border: 2px solid rgba(127, 29, 29, 0.3);
        }

        .delete-patient-btn:hover {
            background: linear-gradient(135deg, #f87171 0%, #fca5a5 100%);
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(248, 113, 113, 0.8);
            border-color: rgba(127, 29, 29, 0.5);
            color: #7f1d1d;
        }

        .delete-session-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #fca5a5 0%, #fecaca 100%);
            color: #7f1d1d;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 12px rgba(252, 165, 165, 0.6);
            transition: all 0.3s ease;
            z-index: 10;
            border: 2px solid rgba(127, 29, 29, 0.3);
        }

        .delete-session-btn:hover {
            background: linear-gradient(135deg, #f87171 0%, #fca5a5 100%);
            transform: scale(1.1);
            box-shadow: 0 4px 16px rgba(248, 113, 113, 0.8);
            border-color: rgba(127, 29, 29, 0.5);
            color: #7f1d1d;
        }

        .corrections-info {
            background: #ecfdf5;
            border: 1px solid #86efac;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
            display: none;
        }

        .corrections-info.show {
            display: block;
        }

        .corrections-info h4 {
            color: #059669;
            margin-bottom: 12px;
        }

        .corrections-list {
            list-style: none;
            padding: 0;
            margin: 12px 0 0 0;
        }

        .corrections-list li {
            background: white;
            color: #1f2937;
            padding: 12px 16px;
            margin: 8px 0;
            border-radius: 8px;
            border-right: 4px solid #10b981;
        }

        .text-stats {
            background: #f8fafc;
            color: #64748b;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            text-align: center;
            font-size: 14px;
            border: 1px solid #e5e7eb;
        }

        .edit-controls {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .edit-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .fix-btn {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.3);
        }

        .fix-btn:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .revert-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(239, 68, 68, 0.3);
        }

        .revert-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
        }

        .copy-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .save-btn {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
        }

        .sessions-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 900px;
            width: 95%;
            max-height: 85%;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            color: #1f2937;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }

        .session-item {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #1f2937;
        }

        .session-item:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .session-item h4 {
            color: #2563eb;
            margin-bottom: 8px;
        }

        .session-item p {
            color: #64748b;
            margin: 4px 0;
        }

        .session-item small {
            color: #9ca3af;
        }

        .audio-player {
            width: 100%;
            margin: 15px 0;
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            .modern-form-section {
                padding: 20px 16px;
                margin-bottom: 20px;
                border-radius: 16px;
            }

            .form-grid {
                gap: 20px;
            }

            .modern-form-group input,
            .modern-form-group select {
                padding: 14px 16px;
                font-size: 16px; /* Prevents zoom on iOS */
                border-radius: 12px;
            }

            .input-mode-section {
                padding: 20px 16px;
                margin-bottom: 20px;
            }

            .input-mode-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .input-mode-btn {
                width: 100%;
                padding: 14px 20px;
                min-width: auto;
                font-size: 15px;
            }

            .enhanced-transcribe-btn {
                padding: 16px 28px;
                font-size: 17px;
                margin-top: 24px;
                border-radius: 16px;
            }

            .modern-form-section h2 {
                font-size: 1.5em;
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }

            .modern-form-section h2::before {
                font-size: 1.2em;
                padding: 10px;
            }

            /* Improved form labels for mobile */
            .modern-form-group label {
                font-size: 14px;
                margin-bottom: 10px;
            }

            /* Better upload area for mobile */
            .upload-area {
                padding: 30px 16px;
                margin: 20px 0;
            }

            .file-label {
                padding: 14px 24px;
                font-size: 15px;
            }

            /* Responsive recording section */
            .recording-section {
                margin: 20px 0;
            }

            .record-btn {
                width: 100%;
                max-width: 280px;
                padding: 16px 32px;
                font-size: 16px;
            }

            /* Better text input for mobile */
            #directTextInput {
                min-height: 150px;
                padding: 14px;
                font-size: 16px;
                border-radius: 12px;
            }

            /* Responsive tabs */
            .result-tabs {
                border-radius: 12px 12px 0 0;
            }

            .result-tab {
                padding: 12px 16px;
                font-size: 14px;
            }

            /* Better modal for mobile */
            .modal-content {
                width: 95%;
                padding: 24px 16px;
                margin: 20px;
                max-height: 90vh;
            }

            /* Improved action buttons */
            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .action-btn {
                width: 100%;
                padding: 14px 24px;
                font-size: 15px;
            }

            /* Better patient cards */
            .patient-card {
                padding: 20px 16px;
                margin-bottom: 12px;
            }

            /* Improved instructions */
            #whatsappInstructions {
                padding: 20px 16px;
                margin: 16px 0;
            }

            /* Small screen nav */
            .nav-container {
                padding: 0 16px;
            }

            .nav-links {
                display: none;
            }

            /* Focus improvements for mobile */
            .modern-form-group input:focus,
            .modern-form-group select:focus {
                box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
                transform: none; /* Remove transform on mobile for better UX */
            }
        }

        /* Extra small screens */
        @media (max-width: 480px) {
            .modern-form-section {
                padding: 16px 12px;
                margin-bottom: 16px;
            }

            .modern-form-section h2 {
                font-size: 1.4em;
            }

            .enhanced-transcribe-btn {
                padding: 14px 24px;
                font-size: 16px;
            }

            .input-mode-btn {
                padding: 12px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo">ğŸ¤ ×ª××œ×•×œ ××§×¦×•×¢×™</a>
            <ul class="nav-links">
                <li><a href="/">×“×£ ×”×‘×™×ª</a></li>
                <li><a href="/feedback">×”××œ×¦×•×ª</a></li>
                <li><a href="/how-it-works">××™×š ×–×” ×¢×•×‘×“</a></li>
            </ul>
            
            <!-- User Info Section -->
            <div id="userSection" style="display: none;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span id="userGreeting" style="color: #1e293b; font-weight: 600;"></span>
                    <button id="logoutBtn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3); transition: all 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(239, 68, 68, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(239, 68, 68, 0.3)'">ğŸšª ×™×¦×™××”</button>
                </div>
            </div>
            
            <!-- Login Button (shown when not authenticated) -->
            <button id="loginButton" class="cta-button" onclick="openLoginModal()">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
        </div>
    </nav>

    <!-- App Section -->
    <section class="app-section">
        <div class="container">
            <div class="app-container">
                <!-- ×ª××œ×•×œ ×—×“×© -->
                <div class="modern-form-section">
                    <h2>×ª××œ×•×œ ×—×“×©</h2>
                    
                    <!-- ×‘×—×™×¨×ª ×¡×•×’ ×§×œ×˜ -->
                    <div class="input-mode-section">
                        <div class="input-mode-buttons">
                            <button id="audioModeBtn" class="input-mode-btn active" onclick="switchInputMode('audio')">
                                ğŸµ ×§×•×‘×¥ ×©××¢
                            </button>
                            <button id="textModeBtn" class="input-mode-btn" onclick="switchInputMode('text')">
                                ğŸ“ ×”×›× ×¡ ×˜×§×¡×˜
                            </button>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="modern-form-group">
                            <label for="patientName">ğŸ‘¤ ×©× ×”××˜×•×¤×œ:</label>
                            <input type="text" id="patientName" placeholder="×”×–×Ÿ ×©× ×”××˜×•×¤×œ" value="" required autocomplete="off">
                        </div>

                        <div class="modern-form-group">
                            <label for="sessionDate">ğŸ“… ×ª××¨×™×š ×”×¡×©×Ÿ:</label>
                            <input type="date" id="sessionDate">
                        </div>

                        <div id="qualityModeSection" class="modern-form-group">
                            <label for="qualityMode">âš™ï¸ ×‘×—×¨ ×©×™×¨×•×ª ×ª××œ×•×œ:</label>
                            <select id="qualityMode">
                                <option value="faster-whisper">ğŸ”’ Faster-Whisper Large-V3 - ××•××œ×¥ ×œ××˜×¤×œ×™× (××§×•××™ + ××•×¦×¤×Ÿ)</option>
                                <option value="ivrit-ai">ğŸ† ivrit.ai - ××•×ª×× ×‘××™×•×—×“ ×œ×¢×‘×¨×™×ª (××§×•××™ + ××•×¦×¤×Ÿ)</option>
                                <option value="whisper">ğŸ”’ Whisper ×¨×’×™×œ - ××™×›×•×ª ×˜×•×‘×” (××§×•××™ + ××•×¦×¤×Ÿ)</option>
                                <option value="assemblyai">âš ï¸ AssemblyAI - ×“×™×•×§ ×’×‘×•×” (×¢× ×Ÿ + ××•×¦×¤×Ÿ)</option>
                                <option value="hybrid-encrypted" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: bold;">ğŸ›¡ï¸ ×ª××œ×•×œ ×”×™×‘×¨×™×“×™ ××•×¦×¤×Ÿ - ×—×™×¡×™×•×Ÿ ××•×—×œ×˜!</option>
                            </select>
                            <small>
                                <strong>ğŸ›¡ï¸ ×¤×¨×˜×™×•×ª ××•×—×œ×˜×ª - ×›×œ ×”××¤×©×¨×•×™×•×ª ××•×¦×¤× ×•×ª!</strong><br>
                                âœ… <strong>×”×¦×¤× ×” ×“×•-×©×›×‘×ª×™×ª:</strong> ×›×œ ×”× ×ª×•× ×™× ××•×¦×¤× ×™× ×¢× ×”×¡×™×¡××” ×”××™×©×™×ª ×©×œ×š<br>
                                âœ… <strong>××¤×¢×™×œ ×”×©×¨×ª ×œ× ×™×›×•×œ ×œ×¨××•×ª ×›×œ×•×</strong> - ×¨×§ × ×ª×•× ×™× ××•×¦×¤× ×™×<br>
                                âœ… <strong>×¡× ×›×¨×•×Ÿ ×‘×™×Ÿ ××›×©×™×¨×™×:</strong> ×’×© ×œ×¡×©× ×™× ×©×œ×š ××›×œ ××›×©×™×¨ ×¢× ×”×¡×™×¡××”<br>
                                âœ… <strong>×’×™×‘×•×™ ××•×˜×•××˜×™:</strong> ×”×›×œ × ×©××¨ ××•×¦×¤×Ÿ ×‘×¢× ×Ÿ<br><br>
                                ğŸ”’ <strong>××¤×©×¨×•×™×•×ª ××§×•××™×•×ª:</strong> ×¢×™×‘×•×“ ×‘××—×©×‘ ×©×œ×š + ×”×¦×¤× ×” ×œ×¤× ×™ ×©×œ×™×—×”<br>
                                âš ï¸ <strong>AssemblyAI:</strong> ×¢×™×‘×•×“ ×‘×¢× ×Ÿ + ×”×¦×¤× ×” ×©×œ ×”×ª×•×¦××•×ª<br>
                                ğŸ›¡ï¸ <strong>×”×™×‘×¨×™×“×™ ××•×¦×¤×Ÿ:</strong> ×ª××œ×•×œ + ×”×¦×¤× ×” + ×¡× ×›×¨×•×Ÿ ××•×˜×•××˜×™ ×œ×¢× ×Ÿ
                            </small>
                        </div>
                    </div>

                    <!-- ×©×“×” ×¡×™×¡××ª ×”×¦×¤× ×” - ××•×¦×’ ×¨×§ ×‘××¦×‘ ×”×™×‘×¨×™×“×™ -->
                    <div id="encryptionPasswordSection" class="modern-form-group" style="display: none;">
                        <label for="encryptionPassword">ğŸ” ×¡×™×¡××ª ×”×¦×¤× ×” ××™×©×™×ª:</label>
                        <input type="password" id="encryptionPassword" placeholder="×”×–×Ÿ ××ª ×¡×™×¡××ª ×”×”×¦×¤× ×” ×”××™×©×™×ª ×©×œ×š">
                        <small style="color: #ef4444; font-weight: 600;">
                            ğŸ“ <strong>×—×©×•×‘:</strong> ×–×• ×”×¡×™×¡××” ×”××™×©×™×ª ×©×œ×š ×œ×”×¦×¤× ×”. ×‘×œ×¢×“×™×” ×œ× ×ª×•×›×œ ×œ×’×©×ª ×œ×¡×©× ×™× ××•×¦×¤× ×™×!<br>
                            ğŸ’¡ ×× ×¢×“×™×™×Ÿ ×œ× ×™×¦×¨×ª ×¡×™×¡××ª ×”×¦×¤× ×”, ×œ×—×¥ ×¢×œ ×›×¤×ª×•×¨ "ğŸ”’ ×”×¦×¤× ×”" ×œ××¢×œ×”
                        </small>
                    </div>

                    <!-- ×”×§×œ×˜×” -->
                    <div id="recordingSection" class="recording-section">
                        <h3>×”×§×œ×˜×” ×™×©×™×¨×”</h3>
                        <button id="recordBtn" class="record-btn">ğŸ¤ ×”×ª×—×œ ×”×§×œ×˜×”</button>
                        <div id="recordingStatus" style="display: none; margin-top: 15px; color: #dc2626; font-weight: bold;">
                            ğŸ”´ ××§×œ×™×˜... <span id="recordingTime">00:00</span>
                        </div>
                        <audio id="audioPlayer" controls style="display: none; width: 100%; margin-top: 15px;"></audio>
                    </div>

                    <!-- ×”×¢×œ××ª ×§×•×‘×¥ ×©××¢ -->
                    <div id="audioInputSection">
                        <div class="upload-area" id="uploadArea">
                            <div style="font-size: 2em; margin-bottom: 15px;">ğŸ“</div>
                            <p><strong>×’×¨×•×¨ ×§×•×‘×¥ ×©××¢ ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</strong></p>
                            <p style="margin: 10px 0; font-size: 14px;">×ª×•××š ×‘: MP3, WAV, M4A, WEBM, OGG, OPUS</p>
                            <label for="audioFile" class="file-label">×‘×—×¨ ×§×•×‘×¥ ×©××¢</label>
                            <input type="file" id="audioFile" class="file-input" accept="audio/*">
                            <div id="fileName" style="margin-top: 15px; font-weight: bold; color: #2563eb;"></div>
                        </div>
                    </div>

                    <!-- ×”×›× ×¡×ª ×˜×§×¡×˜ ×™×©×™×¨ -->
                    <div id="textInputSection" style="display: none;">
                        <div style="background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 16px; padding: 24px; margin: 20px 0;">
                            <div style="margin-bottom: 16px;">
                                <label for="directTextInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">ğŸ“ ×”×›× ×¡ ×˜×§×¡×˜ ×™×©×™×¨×•×ª:</label>
                                <textarea id="directTextInput" placeholder="×”×“×‘×§ ××• ×”×§×œ×“ ×›××Ÿ ××ª ×”×˜×§×¡×˜ ×©×‘×¨×¦×•× ×š ×œ×¢×‘×“..." style="width: 100%; min-height: 200px; padding: 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 16px; line-height: 1.6; resize: vertical; font-family: inherit; direction: rtl;"></textarea>
                            </div>
                            <div style="color: #6b7280; font-size: 14px;">
                                ğŸ’¡ <strong>×˜×™×¤:</strong> ××¤×©×¨ ×œ×”×“×‘×™×§ ×˜×§×¡×˜ ××ª××œ×•×œ ×§×™×™×, ×××¡×š, ××• ×›×œ ×˜×§×¡×˜ ××—×¨ ×©×‘×¨×¦×•× ×š ×œ×ª×§×Ÿ ×•×œ×¢×‘×“
                            </div>
                        </div>
                    </div>

                    <!-- ×”×•×¨××•×ª ×œ×§×‘×¦×™ ×•×•×˜×¡××¤ -->
                    <div id="whatsappInstructions" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 1px solid #0ea5e9; border-radius: 12px; padding: 24px; margin: 20px 0;">
                        <div style="display: flex; align-items: center; margin-bottom: 16px;">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-left: 8px; flex-shrink: 0;">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.465 3.516" fill="#25D366"/>
                            </svg>
                            <h4 style="color: #0f172a; margin: 0; font-size: 16px; font-weight: 600;">×”×¢×‘×¨×ª ×§×•×‘×¥ ×©××¢ ××•×•×˜×¡××¤</h4>
                        </div>
                        
                        <div style="color: #475569; font-size: 14px; line-height: 1.6; text-align: right;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #0ea5e9; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-left: 8px; flex-shrink: 0;">1</span>
                                <span>×œ×—×¥ ×¢×œ ×”×•×“×¢×ª ×”×©××¢ ×‘×•×•×˜×¡××¤</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #0ea5e9; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-left: 8px; flex-shrink: 0;">2</span>
                                <span>×‘×—×¨ "Share" ××• "×©×ª×£"</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <span style="background: #0ea5e9; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin-left: 8px; flex-shrink: 0;">3</span>
                                <span>×‘×—×¨ ××ª ××¤×œ×™×§×¦×™×™×ª ×”×ª××œ×•×œ</span>
                            </div>
                        </div>
                    </div>

                    <button id="transcribeBtn" class="enhanced-transcribe-btn" disabled>ğŸ¯ ×”×ª×—×œ ×ª××œ×•×œ</button>

                    <div id="status" class="status" style="display: none;"></div>

                    <!-- ×ª×•×¦××•×ª -->
                    <div id="resultsSection" style="display: none;">
                        <div class="result-tabs">
                            <button class="result-tab active" data-tab="original">×˜×§×¡×˜ ××§×•×¨×™</button>
                            <button class="result-tab" data-tab="corrected">×˜×§×¡×˜ ××ª×•×§×Ÿ</button>
                            <button class="result-tab" data-tab="edited">×¢×¨×™×›×” ×™×“× ×™×ª</button>
                        </div>

                        <div id="originalResult" class="result-area"></div>
                        <div id="correctedResult" class="result-area" style="display: none;"></div>
                        
                        <div id="editedSection" style="display: none;">
                            <textarea id="textEditor" class="text-editor" placeholder="×¢×¨×•×š ××ª ×”×˜×§×¡×˜ ×›××Ÿ..."></textarea>
                            <div class="edit-controls">
                                <button id="fixTextBtn" class="edit-btn fix-btn">ğŸ”§ ×ª×§×Ÿ ×˜×§×¡×˜</button>
                                <button id="revertBtn" class="edit-btn revert-btn">â†¶ ×—×–×•×¨ ×œ××§×•×¨</button>
                            </div>
                        </div>

                        <div id="correctionsInfo" class="corrections-info">
                            <h4>×ª×™×§×•× ×™× ×©×‘×•×¦×¢×•:</h4>
                            <ul id="correctionsList" class="corrections-list"></ul>
                        </div>

                        <div id="textStats" class="text-stats"></div>

                        <div class="action-buttons" style="justify-content: center;">
                            <button id="copyBtn" class="action-btn copy-btn">ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜</button>
                            <button id="saveBtn" class="action-btn save-btn">ğŸ’¾ ×©××•×¨ ×¡×©×Ÿ</button>
                            <button id="generateFormBtn" class="action-btn" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white;">ğŸ“‹ ×¦×•×¨ ×˜×•×¤×¡ ×˜×™×¤×•×œ</button>
                        </div>
                    </div>
                </div>

                <!-- × ×™×”×•×œ ××˜×•×¤×œ×™× -->
                <div id="therapistSection" class="section patients-section">
                    <h2>ğŸ‘¨â€âš•ï¸ × ×™×”×•×œ ××˜×•×¤×œ×™×</h2>
                    
                    <!-- ×›×¤×ª×•×¨ ×˜×¢×™× ×ª ×§×‘×¦×™× ××§×•××™×™× -->
                    <div style="text-align: center; margin: 30px 0;">
                        <input type="file" id="localFilesInput" multiple accept=".json" style="display: none;">
                        <button id="loadLocalFilesBtn" class="action-btn" style="background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-size: 16px; padding: 16px 32px;">
                            ğŸ“‚ ×˜×¢×Ÿ ×§×‘×¦×™ ×ª××œ×•×œ ××§×•××™×™×
                        </button>
                    </div>

                    <!-- ×¨×©×™××ª ×§×‘×¦×™× ××§×•××™×™× -->
                    <div id="localFilesList" style="display: none;">
                        <h3 style="color: #1e293b; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                            ğŸ“‹ ×§×‘×¦×™ ×ª××œ×•×œ ××§×•××™×™×
                        </h3>
                        <div id="localFilesContainer"></div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <!-- ××•×“×œ×™× -->
    <div id="sessionsModal" class="sessions-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeSessions()">Ã—</button>
            <h2 id="modalTitle">×¡×©× ×™× ×©×œ ××˜×•×¤×œ</h2>
            <div id="sessionsList"></div>
        </div>
    </div>

    <div id="sessionContentModal" class="sessions-modal">
        <div class="modal-content">
            <button class="close-modal" onclick="closeSessionContent()">Ã—</button>
            <h2 id="sessionContentTitle">×ª×•×›×Ÿ ×¡×©×Ÿ</h2>
            <div id="sessionContentBody"></div>
        </div>
    </div>

    <div id="treatmentFormModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 1000px;">
            <button class="close-modal" onclick="closeTreatmentForm()">Ã—</button>
            <h2>×˜×•×¤×¡ ×˜×™×¤×•×œ ××§×¦×•×¢×™</h2>
            <div id="treatmentFormContent"></div>
            <div style="margin-top: 30px; text-align: center;">
                <button onclick="copyTreatmentForm()" class="action-btn copy-btn">ğŸ“‹ ×”×¢×ª×§ ×˜×•×¤×¡</button>
                <button onclick="exportTreatmentForm()" class="action-btn" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white;">ğŸ“„ ×™×™×¦× ×œWord</button>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×‘×—×™×¨×ª ×¤×¢×•×œ×” ×œ×¡×©×Ÿ ×§×™×™× -->
    <div id="sessionChoiceModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="closeSessionChoice()">Ã—</button>
            <h2 style="color: #f59e0b; text-align: center; margin-bottom: 30px;">âš ï¸ ×§×™×™× ×¡×©×Ÿ ×‘××•×ª×• ×ª××¨×™×š</h2>
            
            <div id="existingSessionInfo" style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 30px; border: 1px solid #e5e7eb;">
                <!-- ×¤×¨×˜×™ ×”×¡×©×Ÿ ×”×§×™×™× ×™×•×¦×’×• ×›××Ÿ -->
            </div>
            
            <div style="text-align: center;">
                <p style="margin-bottom: 30px; font-size: 16px; color: #374151;">××” ×‘×¨×¦×•× ×š ×œ×¢×©×•×ª?</p>
                
                <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto;">
                    <button id="replaceSessionBtn" class="action-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; width: 100%;">
                        ğŸ”„ ×”×—×œ×£ ××ª ×”×¡×©×Ÿ ×”×§×™×™×
                    </button>
                    
                    <button id="createNewSessionBtn" class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; width: 100%;">
                        â• ×¦×•×¨ ×¡×©×Ÿ ×—×“×© ×¢× ×—×•×ª××ª ×–××Ÿ
                    </button>
                    
                    <button id="cancelSaveBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; width: 100%;">
                        âŒ ×‘×™×˜×•×œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ××™×©×•×¨ ××—×™×§×” -->
    <div id="deleteConfirmModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeDeleteConfirm()">Ã—</button>
            <h2 id="deleteConfirmTitle" style="color: #ef4444; text-align: center; margin-bottom: 30px;">âš ï¸ ××™×©×•×¨ ××—×™×§×”</h2>
            
            <div id="deleteConfirmMessage" style="background: #fef2f2; border: 1px solid #fecaca; padding: 20px; border-radius: 12px; margin-bottom: 30px; text-align: center; color: #7f1d1d; font-size: 16px; line-height: 1.6;">
                <!-- ×”×•×“×¢×ª ×”××™×©×•×¨ ×ª×•×¦×’ ×›××Ÿ -->
            </div>
            
            <div style="text-align: center;">
                <div style="display: flex; gap: 15px; max-width: 300px; margin: 0 auto;">
                    <button id="confirmDeleteBtn" class="action-btn" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; flex: 1;">
                        ğŸ—‘ï¸ ××—×§
                    </button>
                    
                    <button id="cancelDeleteBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; flex: 1;">
                        âŒ ×‘×™×˜×•×œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ××•×“×œ ×”×ª×¨×¢×ª ××’×‘×œ×•×ª -->
    <div id="limitWarningModal" class="sessions-modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="close-modal" onclick="closeLimitWarning()">Ã—</button>
            <h2 id="limitWarningTitle" style="color: #f59e0b; text-align: center; margin-bottom: 30px;">âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×”</h2>
            
            <div id="limitWarningMessage" style="background: #fffbeb; border: 1px solid #fde68a; padding: 25px; border-radius: 12px; margin-bottom: 30px; text-align: center; color: #92400e; font-size: 16px; line-height: 1.6;">
                <!-- ×”×•×“×¢×ª ×”××’×‘×œ×” ×ª×•×¦×’ ×›××Ÿ -->
            </div>
            
            <div style="text-align: center;">
                <div style="display: flex; flex-direction: column; gap: 15px; max-width: 400px; margin: 0 auto;">
                    <button id="upgradeBtn" class="action-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; width: 100%; font-size: 16px; padding: 16px 24px;">
                        ğŸ’ ×©×“×¨×’ ×œ×× ×•×™ ××œ×
                    </button>
                    
                    <button id="closeLimitBtn" class="action-btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; width: 100%;">
                        âœ… ×”×‘× ×ª×™
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let recordingInterval;
        let currentPatientName = '';
        let currentSessionFilename = '';
        let originalTranscript = '';
        let correctedTranscript = '';
        let currentUser = null;
        let sessionToken = null;
        let userEncryptionKey = null; // ××¤×ª×— ×”×¦×¤× ×” ××™×©×™ ×©×œ ×”××˜×¤×œ

        // ×¤×•× ×§×¦×™×” ×œ××™×¤×•×¡ ×”×˜×•×¤×¡ ×œ×ª××œ×•×œ ×—×“×©
        function resetFormForNewTranscription() {
            // ××™×¤×•×¡ ×©×“×•×ª ×”×˜×•×¤×¡ - ××‘×œ ×”×©××¨×ª ×ª××¨×™×š × ×•×›×—×™
            const patientNameField = document.getElementById('patientName');
            if (patientNameField) {
                patientNameField.value = ''; // ×©×“×” ×¨×™×§ ×¢×‘×•×¨ ××˜×•×¤×œ ×—×“×© - ×œ× ××™×™×œ!
            }
            
            const sessionDateField = document.getElementById('sessionDate');
            if (sessionDateField) {
                sessionDateField.value = new Date().toISOString().split('T')[0]; // ×ª××¨×™×š ×”×™×•×
            }
            
            // ××™×¤×•×¡ ×§×•×‘×¥ ×©××¢
            const audioFile = document.getElementById('audioFile');
            if (audioFile) {
                audioFile.value = '';
            }
            
            // ××™×¤×•×¡ ×©× ×§×•×‘×¥
            const fileName = document.getElementById('fileName');
            if (fileName) {
                fileName.textContent = '';
            }
            
            // ××™×¤×•×¡ ×˜×§×¡×˜ ×™×©×™×¨
            const directTextInput = document.getElementById('directTextInput');
            if (directTextInput) {
                directTextInput.value = '';
            }
            
            // ×‘×™×˜×•×œ ×›×¤×ª×•×¨ ×ª××œ×•×œ
            const transcribeBtn = document.getElementById('transcribeBtn');
            if (transcribeBtn) {
                transcribeBtn.disabled = true;
            }
            
            // ×”×¡×ª×¨×ª ×ª×•×¦××•×ª ×§×•×“××•×ª
            const resultsSection = document.getElementById('resultsSection');
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            
            // ×”×¡×ª×¨×ª ×”×•×“×¢×•×ª ×¡×˜×˜×•×¡
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
            
            console.log('âœ… ×”×˜×•×¤×¡ ××•×¤×¡ ×œ×ª××œ×•×œ ×—×“×© - ×©×“×” ×©× ×”××˜×•×¤×œ ×¨×™×§');
        }

        // ×¤×•× ×§×¦×™×” ×œ××™×¤×•×¡ ×”×˜×•×¤×¡ ××—×¨×™ ×ª××œ×•×œ ××•×¦×œ×—
        function resetAfterSuccessfulTranscription() {
            setTimeout(() => {
                resetFormForNewTranscription();
                showStatus('âœ¨ ××•×›×Ÿ ×œ×ª××œ×•×œ ×”×‘×! ×”×˜×•×¤×¡ ××•×¤×¡', 'success');
            }, 3000); // ×”××ª× ×” ×©×œ 3 ×©× ×™×•×ª ××—×¨×™ ×”×ª××œ×•×œ
        }

        // ×‘×“×™×§×ª ××™××•×ª ×‘×˜×¢×™× ×ª ×”×“×£
        async function checkAuth() {
            try {
                sessionToken = localStorage.getItem('session_token');
                
                if (!sessionToken) {
                    console.log('××™×Ÿ session token - ××¤× ×” ×œ×“×£ ×”×‘×™×ª');
                    window.location.href = '/';
                    return false;
                }

                const response = await fetch('/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user_info;
                    console.log('××™××•×ª ×”×¦×œ×™×—:', currentUser);
                    updateUserInterface();
                    
                    // ×‘×“×™×§×ª ××’×‘×œ×•×ª ××—×¨×™ ××™××•×ª ××•×¦×œ×—
                    await checkUserLimits();
                    
                    return true;
                } else {
                    localStorage.removeItem('session_token');
                    sessionToken = null;
                    currentUser = null;
                    console.log('××™××•×ª × ×›×©×œ - ××¤× ×” ×œ×“×£ ×”×‘×™×ª');
                    window.location.href = '/';
                    return false;
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×‘×“×™×§×ª ××™××•×ª:', error);
                showStatus('âš ï¸ ×©×’×™××” ×‘×‘×“×™×§×ª ××™××•×ª', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return false;
            }
        }

        // ×‘×“×™×§×ª ××’×‘×œ×•×ª ××©×ª××©
        async function checkUserLimits() {
            if (!currentUser || !sessionToken) return;
            
            try {
                // ×‘×“×™×§×ª ××’×‘×œ×ª ×¡×©× ×™×
                const sessionResponse = await fetch('/subscription/check-session-limit', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                let sessionData = null;
                if (sessionResponse.ok) {
                    sessionData = await sessionResponse.json();
                    console.log('ğŸ“Š × ×ª×•× ×™ ×¡×©× ×™× ××”×©×¨×ª:', sessionData);
                } else {
                    console.log('âš ï¸ ×œ× ×”×¦×œ×™×— ×œ×§×‘×œ × ×ª×•× ×™ ×¡×©× ×™× ××”×©×¨×ª - ×™×•×¦×¨ × ×ª×•× ×™× ×‘×¨×™×¨×ª ××—×“×œ');
                    // ×™×¦×™×¨×ª × ×ª×•× ×™× ×‘×¨×™×¨×ª ××—×“×œ ×¢× ×”×•×“×¢×” ×‘×¨×•×¨×”
                    sessionData = {
                        can_create_session: true,
                        sessions_used: 0,
                        sessions_limit: 5,
                        status: 'trial',
                        sessions_remaining: 5
                    };
                    console.log('ğŸ“Š × ×ª×•× ×™ ×¡×©× ×™× ×‘×¨×™×¨×ª ××—×“×œ:', sessionData);
                }
                
                // ×‘×“×™×§×ª ××’×‘×œ×ª ××˜×•×¤×œ×™×
                const patientsResponse = await fetch('/patients', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                let patientsData = null;
                if (patientsResponse.ok) {
                    patientsData = await patientsResponse.json();
                    console.log('ğŸ‘¥ × ×ª×•× ×™ ××˜×•×¤×œ×™× ××”×©×¨×ª:', patientsData);
                } else {
                    console.log('âš ï¸ ×œ× ×”×¦×œ×™×— ×œ×§×‘×œ × ×ª×•× ×™ ××˜×•×¤×œ×™× ××”×©×¨×ª');
                    // ×™×¦×™×¨×ª × ×ª×•× ×™× ×‘×¨×™×¨×ª ××—×“×œ
                    patientsData = {
                        patients: [],
                        patient_limits: {
                            can_add_patient: true,
                            current_patients: 0,
                            max_patients: 1,
                            status: 'trial'
                        }
                    };
                }
                
                // ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ×¤×©×•×˜×” ×©×œ ××•× ×” ××˜×•×¤×œ×™×
                updatePatientsLimitDisplay();
                
            } catch (error) {
                console.error('×©×’×™××” ×‘×‘×“×™×§×ª ××’×‘×œ×•×ª:', error);
                // ×‘××§×¨×” ×©×œ ×©×’×™××”, × ×¦×™×’ × ×ª×•× ×™× ×‘×¨×™×¨×ª ××—×“×œ
                const defaultSessionData = {
                    can_create_session: true,
                    sessions_used: 0,
                    sessions_limit: 5,
                    status: 'trial',
                    sessions_remaining: 5
                };
                const defaultPatientsData = {
                    patients: [],
                    patient_limits: {
                        can_add_patient: true,
                        current_patients: 0,
                        max_patients: 1,
                        status: 'trial'
                    }
                };
                updateCombinedLimitsDisplay(defaultSessionData, defaultPatientsData);
            }
        }


        // ×¢×“×›×•×Ÿ ×ª×¦×•×’×” ××œ××” ×©×œ ××•× ×” ××˜×•×¤×œ×™× ×•×¡×©× ×™×
        function updatePatientsLimitDisplay() {
            const appContainer = document.querySelector('.app-container');
            if (!appContainer || !currentUser) return;
            
            // ×”×¡×¨×ª ×ª×¦×•×’×” ×§×™×™××ª ×× ×™×©
            const existingInfo = document.getElementById('appUserInfo');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            // ×¡×¤×™×¨×” ××§×•××™×ª ×©×œ ××˜×•×¤×œ×™× ×•×¡×©× ×™× ×¢× × ×™×§×•×™ ××•×˜×•××˜×™
            const storageKey = `sessions_${currentUser.email}`;
            let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // × ×™×§×•×™ ×¡×©× ×™× ×¨×™×§×™× ××• ×¤×’×•××™×
            userSessions = userSessions.filter(session => 
                session && 
                session.patient_name && 
                session.patient_name.trim() !== '' &&
                session.corrected_transcript &&
                session.corrected_transcript.trim() !== ''
            );
            
            // ×©××™×¨×” ×—×–×¨×” ××—×¨×™ × ×™×§×•×™
            localStorage.setItem(storageKey, JSON.stringify(userSessions));
            
            // ×¡×¤×™×¨×ª ××˜×•×¤×œ×™× ×™×™×—×•×“×™×™× ×•×¡×©× ×™×
            const uniquePatients = new Set();
            userSessions.forEach(session => {
                if (session.patient_name && session.patient_name.trim()) {
                    uniquePatients.add(session.patient_name.trim());
                }
            });
            const localPatientCount = uniquePatients.size;
            const totalSessionsCount = userSessions.length;
            
            console.log('ğŸ‘¥ ××¡×¤×¨ ××˜×•×¤×œ×™× × ×•×›×—×™ (××—×¨×™ × ×™×§×•×™):', localPatientCount);
            console.log('ğŸ“‹ ××¡×¤×¨ ×¡×©× ×™× × ×•×›×—×™:', totalSessionsCount);
            console.log('ğŸ“‹ ×¨×©×™××ª ××˜×•×¤×œ×™×:', Array.from(uniquePatients));
            
            // ×™×¦×™×¨×ª ×ª×¦×•×’×” ×—×“×©×”
            const userInfo = document.createElement('div');
            userInfo.id = 'appUserInfo';
            
            let statusMessage = '';
            let statusColor = '#2563eb';
            let bgColor = 'rgba(37, 99, 235, 0.1)';
            let borderColor = 'rgba(37, 99, 235, 0.2)';
            let needsUpgrade = false;
            
            // ×”×•×“×¢×” ××œ××” ×¢×œ ××˜×•×¤×œ×™× ×•×¡×©× ×™×
            if (localPatientCount === 0) {
                statusMessage = `ğŸ‘¥ ××˜×•×¤×œ×™×: 0 ××ª×•×š 1 | ğŸ“ ×¡×©× ×™×: ${totalSessionsCount} ××ª×•×š 5 (×× ×•×™ ×—×™× ××™)<br>âœ… × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××˜×•×¤×œ ×•×¡×©× ×™×`;
                statusColor = '#10b981';
                bgColor = 'rgba(16, 185, 129, 0.1)';
                borderColor = 'rgba(16, 185, 129, 0.2)';
            } else if (localPatientCount === 1) {
                if (totalSessionsCount < 5) {
                    statusMessage = `ğŸ‘¥ ××˜×•×¤×œ×™×: 1 ××ª×•×š 1 | ğŸ“ ×¡×©× ×™×: ${totalSessionsCount} ××ª×•×š 5 (×× ×•×™ ×—×™× ××™)<br>âš ï¸ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¢×•×“ ${5 - totalSessionsCount} ×¡×©× ×™× ×œ××˜×•×¤×œ ×”×§×™×™×`;
                    statusColor = '#f59e0b';
                    bgColor = 'rgba(245, 158, 11, 0.1)';
                    borderColor = 'rgba(245, 158, 11, 0.2)';
                } else {
                    statusMessage = `ğŸ‘¥ ××˜×•×¤×œ×™×: 1 ××ª×•×š 1 | ğŸ“ ×¡×©× ×™×: ${totalSessionsCount} ××ª×•×š 5 (×× ×•×™ ×—×™× ××™)<br>ğŸš« ×”×’×¢×ª ×œ××§×¡×™××•× - ××—×§ ×¡×©× ×™× ×™×©× ×™× ××• ×©×“×¨×’`;
                    statusColor = '#ef4444';
                    bgColor = 'rgba(239, 68, 68, 0.1)';
                    borderColor = 'rgba(239, 68, 68, 0.2)';
                    needsUpgrade = true;
                }
            } else {
                // ×‘××§×¨×” ×©×œ ×™×•×ª×¨ ×××˜×•×¤×œ ××—×“ (×œ× ×××•×¨ ×œ×§×¨×•×ª)
                statusMessage = `ğŸ‘¥ ××˜×•×¤×œ×™×: ${localPatientCount} ××ª×•×š 1 | ğŸ“ ×¡×©× ×™×: ${totalSessionsCount} ××ª×•×š 5 (×× ×•×™ ×—×™× ××™)<br>ğŸš« ×—×¨×™×’×” - × ×§×” × ×ª×•× ×™× ××• ×©×“×¨×’`;
                statusColor = '#ef4444';
                bgColor = 'rgba(239, 68, 68, 0.1)';
                borderColor = 'rgba(239, 68, 68, 0.2)';
                needsUpgrade = true;
            }
            
            console.log('ğŸ“Š ×”×•×“×¢×ª ××˜×•×¤×œ×™× ×•×¡×©× ×™×:', statusMessage);
            
            // ×”×¦×’×ª ×”×”×•×“×¢×” ×¢× ×›×¤×ª×•×¨ × ×™×§×•×™ ×‘××§×¨×” ×©×œ ×‘×¢×™×”
            let debugButton = '';
            if (localPatientCount > 0 || totalSessionsCount > 0) {
                debugButton = `<br><button onclick="debugAndCleanStorage()" style="background: #6b7280; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; margin-top: 8px; font-size: 12px;">ğŸ”§ × ×§×” × ×ª×•× ×™× ×¤×’×•××™×</button>`;
            }
            
            userInfo.innerHTML = `
                <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                    <span style="color: ${statusColor}; font-weight: 600; line-height: 1.4;">${statusMessage}</span>
                    ${needsUpgrade ? 
                        '<br><button onclick="openUpgradeModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">ğŸ’ ×©×“×¨×’ ×œ×× ×•×™ ××œ×</button>' : 
                        ''
                    }
                    ${debugButton}
                </div>
            `;
            
            appContainer.insertBefore(userInfo, appContainer.firstChild);
        }


        function showLoginButton() {
            // ×”×¦×’×ª ×›×¤×ª×•×¨ ×”×›× ×™×¡×”
            const userSection = document.getElementById('userSection');
            const loginButton = document.getElementById('loginButton');
            
            if (userSection) {
                userSection.style.display = 'none';
            }
            if (loginButton) {
                loginButton.style.display = 'inline-block';
            }
        }

        function updateUserInterface() {
            if (currentUser) {
                // ×”×¦×’×ª ×©× ×”××©×ª××© ×‘× ××‘ ×‘×¨
                const userSection = document.getElementById('userSection');
                const loginButton = document.getElementById('loginButton');
                const userGreeting = document.getElementById('userGreeting');
                const logoutBtn = document.getElementById('logoutBtn');
                
                if (userSection && loginButton && userGreeting) {
                    // ×”×¡×ª×¨×ª ×›×¤×ª×•×¨ ×”×›× ×™×¡×”
                    loginButton.style.display = 'none';
                    
                    // ×”×¦×’×ª ××™×“×¢ ×”××©×ª××©
                    userGreeting.textContent = `×©×œ×•× ${currentUser.full_name}`;
                    userSection.style.display = 'block';
                    
                    // ×”×•×¡×¤×ª ××™×¨×•×¢ ×™×¦×™××”
                    if (logoutBtn) {
                        logoutBtn.onclick = logout;
                    }
                }
                
                // ×•×™×“×•× ×©×“×” ×©× ×”××˜×•×¤×œ ×¨×™×§ ××—×¨×™ ×”×ª×—×‘×¨×•×ª
                const patientNameInput = document.getElementById('patientName');
                if (patientNameInput) {
                    patientNameInput.value = '';
                    patientNameInput.defaultValue = '';
                    patientNameInput.setAttribute('value', '');
                    console.log('ğŸ§¹ ×©×“×” ×©× ×”××˜×•×¤×œ × ×•×§×” ××—×¨×™ ×”×ª×—×‘×¨×•×ª');
                }
                
                // ×”×•×¡×¤×ª ××™×“×¢ ××©×ª××© ×‘×’×‘ ×”××¤×œ×™×§×¦×™×” ×¢×¦××” ×¢× ××™×“×¢ ×¢×œ ××’×‘×œ×•×ª
                const appContainer = document.querySelector('.app-container');
                if (appContainer && !document.getElementById('appUserInfo')) {
                    // ×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×× ×•×™
                    checkSubscriptionStatus().then(subscriptionInfo => {
                        const userInfo = document.createElement('div');
                        userInfo.id = 'appUserInfo';
                        
                        let statusMessage = '';
                        let statusColor = '#2563eb';
                        let bgColor = 'rgba(37, 99, 235, 0.1)';
                        let borderColor = 'rgba(37, 99, 235, 0.2)';
                        
                        if (subscriptionInfo && subscriptionInfo.subscription) {
                            const sub = subscriptionInfo.subscription;
                            if (sub.payment_status === 'paid') {
                                statusMessage = `ğŸ’ ×× ×•×™ ${sub.subscription_type} ×¤×¢×™×œ`;
                                statusColor = '#10b981';
                                bgColor = 'rgba(16, 185, 129, 0.1)';
                                borderColor = 'rgba(16, 185, 129, 0.2)';
                            } else if (sub.subscription_type === 'trial') {
                                const remaining = sub.sessions_remaining;
                                if (remaining > 0) {
                                    statusMessage = `ğŸ†“ × ×•×ª×¨×• ${remaining} ×¡×©× ×™× ×—×™× ××™×™×`;
                                    statusColor = '#f59e0b';
                                    bgColor = 'rgba(245, 158, 11, 0.1)';
                                    borderColor = 'rgba(245, 158, 11, 0.2)';
                                } else {
                                    statusMessage = 'âš ï¸ ×”×¡×©× ×™× ×”×—×™× ××™×™× ×”×¡×ª×™×™××• - ×™×© ×œ×©×“×¨×’';
                                    statusColor = '#ef4444';
                                    bgColor = 'rgba(239, 68, 68, 0.1)';
                                    borderColor = 'rgba(239, 68, 68, 0.2)';
                                }
                            }
                        }
                        
                        userInfo.innerHTML = `
                            <div style="background: ${bgColor}; border: 1px solid ${borderColor}; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center;">
                                <span style="color: ${statusColor}; font-weight: 600;">${statusMessage}</span>
                                ${subscriptionInfo && subscriptionInfo.subscription && subscriptionInfo.subscription.sessions_remaining === 0 ? 
                                    '<br><button onclick="openUpgradeModal()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">ğŸ’ ×©×“×¨×’ ×¢×›×©×™×•</button>' : 
                                    ''
                                }
                            </div>
                        `;
                        
                        appContainer.insertBefore(userInfo, appContainer.firstChild);
                    });
                }
                
                // ×‘×“×™×§×” ×× ×”××©×ª××© ×”×•× ××˜×¤×œ (×œ×¤×™ ××™×™××™×™×œ ××• ×ª×¤×§×™×“)
                const isTherapist = checkIfUserIsTherapist(currentUser);
                
                // ×”×¦×’×ª ×¡×¢×™×£ × ×™×”×•×œ ×”××˜×•×¤×œ×™× ×¨×§ ×œ××˜×¤×œ×™× ××—×•×‘×¨×™×
                const therapistSection = document.getElementById('therapistSection');
                if (therapistSection) {
                    if (isTherapist) {
                        therapistSection.style.display = 'block';
                        console.log('âœ… ××˜×¤×œ ××—×•×‘×¨ - ××¦×™×’ ×¡×¢×™×£ × ×™×”×•×œ ××˜×•×¤×œ×™×');
                    } else {
                        therapistSection.style.display = 'none';
                        console.log('â„¹ï¸ ××©×ª××© ×¨×’×™×œ - ××¡×ª×™×¨ ×¡×¢×™×£ × ×™×”×•×œ ××˜×•×¤×œ×™×');
                    }
                }
                
                // ×”×¡×ª×¨×ª ×××©×§ ×”××•×¨×— ×•×”×¦×’×ª ××¢×¨×›×ª ×”×ª××œ×•×œ
                hideGuestInterface();
            } else {
                // ×”×¡×ª×¨×ª ×¡×¢×™×£ × ×™×”×•×œ ×”××˜×•×¤×œ×™× ×œ××©×ª××©×™× ×œ× ××—×•×‘×¨×™×
                const therapistSection = document.getElementById('therapistSection');
                if (therapistSection) {
                    therapistSection.style.display = 'none';
                }
                
                // ×”×¦×’×ª ×××©×§ ×”××•×¨×—
                showGuestInterface();
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×” ×× ×”××©×ª××© ×”×•× ××˜×¤×œ
        function checkIfUserIsTherapist(user) {
            if (!user) return false;
            
            // ×›×¨×’×¢ ×›×œ ××©×ª××© ××—×•×‘×¨ × ×—×©×‘ ×›××˜×¤×œ
            // ×‘×¢×ª×™×“ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ××ª×§×“××ª ×™×•×ª×¨:
            // - ×‘×“×™×§×ª ×ª×¤×§×™×“ ×‘×‘×¡×™×¡ ×”× ×ª×•× ×™×
            // - ×‘×“×™×§×ª ×“×•××™×™×Ÿ ××™×™××™×™×œ (×œ××©×œ @clinic.com)
            // - ×‘×“×™×§×ª ×”×¨×©××•×ª ××™×•×—×“×•×ª
            
            // ×”×“×•×’×××•×ª ×œ×‘×“×™×§×•×ª ××ª×§×“××•×ª:
            // if (user.role === 'therapist') return true;
            // if (user.email.includes('@clinic.') || user.email.includes('@therapy.')) return true;
            // if (user.permissions && user.permissions.includes('patient_management')) return true;
            
            return true; // ×›×¨×’×¢ ×›×œ ××©×ª××© ××—×•×‘×¨ ×”×•× ××˜×¤×œ
        }

        function showGuestInterface() {
            // ×‘×app.html ××™×Ÿ ×××©×§ ××•×¨×— - ×–×” ×§×•×‘×¥ ×”××¤×œ×™×§×¦×™×”
            // ×× ×”××©×ª××© ×œ× ××—×•×‘×¨, × ×¤× ×” ××•×ª×• ×œ×“×£ ×”×‘×™×ª ××™×“
            if (!currentUser || !sessionToken) {
                console.log('ğŸ”„ ××©×ª××© ×œ× ××—×•×‘×¨ ×‘××¤×œ×™×§×¦×™×” - ××¤× ×” ×œ×“×£ ×”×‘×™×ª');
                window.location.href = '/';
                return;
            }
        }
        
        function hideGuestInterface() {
            // ×‘××¤×œ×™×§×¦×™×” ×ª××™×“ ××¦×™×’×™× ××ª ×”×××©×§ ×”××œ× ×œ××©×ª××© ××—×•×‘×¨
            console.log('âœ… ××©×ª××© ××—×•×‘×¨ - ××¦×™×’ ×××©×§ ××¤×œ×™×§×¦×™×” ××œ×');
        }
        
        async function logout() {
            try {
                await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
            } catch (error) {
                console.error('×©×’×™××” ×‘×™×¦×™××”:', error);
            } finally {
                // × ×™×§×•×™ ×›×œ ×”××™×“×¢ ×”××§×•××™
                localStorage.removeItem('session_token');
                sessionToken = null;
                currentUser = null;
                
                // × ×™×§×•×™ ×”×××©×§ ××¡×©× ×™×
                clearLocalTranscriptsUI();
                
                // ×”×¡×ª×¨×ª ××™×“×¢ ×”××©×ª××©
                const userSection = document.getElementById('userSection');
                const loginButton = document.getElementById('loginButton');
                const appUserInfo = document.getElementById('appUserInfo');
                
                if (userSection) userSection.style.display = 'none';
                if (loginButton) loginButton.style.display = 'inline-block';
                if (appUserInfo) appUserInfo.remove();
                
                // ×¢×“×›×•×Ÿ ×”×××©×§ ×œ××—×¨ ×™×¦×™××” - ×”×¦×’×ª ×××©×§ ××•×¨×—
                showGuestInterface();
                
                // ×”×¡×ª×¨×ª ×¡×¢×™×£ ×”××˜×¤×œ×™×
                const therapistSection = document.getElementById('therapistSection');
                if (therapistSection) {
                    therapistSection.style.display = 'none';
                }
                
                showStatus('âœ… ×™×¦××ª ××”××¢×¨×›×ª ×‘×”×¦×œ×—×”', 'success');
                
                // ××¢×‘×¨ ×œ×“×£ ×”×‘×™×ª ×œ××—×¨ ×™×¦×™××”
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ×××©×§ ×”×ª××œ×•×œ×™× ×”××§×•××™×™×
        function clearLocalTranscriptsUI() {
            const localFilesList = document.getElementById('localFilesList');
            const localFilesContainer = document.getElementById('localFilesContainer');
            
            if (localFilesList) {
                localFilesList.style.display = 'none';
            }
            if (localFilesContainer) {
                localFilesContainer.innerHTML = '';
            }
            
            console.log('ğŸ§¹ ×××©×§ ×”×ª××œ×•×œ×™× ×”××§×•××™×™× × ×•×§×”');
        }

        // ×¤×•× ×§×¦×™×•×ª ×”×§×œ×˜×”
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audioPlayer = document.getElementById('audioPlayer');
                    audioPlayer.src = audioUrl;
                    audioPlayer.style.display = 'block';
                    
                    // ×™×¦×™×¨×ª ×§×•×‘×¥ ×œ×”×¢×œ××”
                    const file = new File([audioBlob], 'recording.wav', { type: 'audio/wav' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    document.getElementById('audioFile').files = dataTransfer.files;
                    
                    updateFileName('recording.wav');
                    document.getElementById('transcribeBtn').disabled = false;
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                
                document.getElementById('recordBtn').textContent = 'â¹ï¸ ×¢×¦×•×¨ ×”×§×œ×˜×”';
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('recordingStatus').style.display = 'block';
                
                recordingInterval = setInterval(updateRecordingTime, 1000);
                
            } catch (error) {
                console.error('×©×’×™××” ×‘×”×§×œ×˜×”:', error);
                showStatus('×©×’×™××” ×‘×’×™×©×” ×œ××™×§×¨×•×¤×•×Ÿ', 'error');
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                document.getElementById('recordBtn').textContent = 'ğŸ¤ ×”×ª×—×œ ×”×§×œ×˜×”';
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('recordingStatus').style.display = 'none';
                
                clearInterval(recordingInterval);
            }
        }

        function updateRecordingTime() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const seconds = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
        }

        // ××™×¨×•×¢×™ ×”×§×œ×˜×”
        document.getElementById('recordBtn').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            } else {
                startRecording();
            }
        });

        // ×¤×•× ×§×¦×™×•×ª ×”×¢×œ××ª ×§×‘×¦×™× - ×¢× ×× ×™×¢×ª ×××–×™× ×™× ×›×¤×•×œ×™×
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('audioFile');

        // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ××–×•×¨ ×”×¢×œ××” - ×¨×§ ×× ×¢×•×“ ×œ× ×”×•×¡×£
        if (uploadArea && !uploadArea.hasAttribute('data-listener-added')) {
            uploadArea.addEventListener('click', (e) => {
                // ×‘×“×™×§×” ×©×”×œ×—×™×¦×” ×œ× ×¢×œ ×”×›×¤×ª×•×¨ ×¢×¦××•
                if (!e.target.classList.contains('file-label')) {
                    fileInput.click();
                }
            });
            uploadArea.setAttribute('data-listener-added', 'true');
            console.log('âœ… Upload area click listener added');
        }

        // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×›×¤×ª×•×¨ ×”×›×—×•×œ - ×¨×§ ×× ×¢×•×“ ×œ× ×”×•×¡×£
        const fileLabel = document.querySelector('.file-label');
        if (fileLabel && !fileLabel.hasAttribute('data-listener-added')) {
            fileLabel.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
            fileLabel.setAttribute('data-listener-added', 'true');
            console.log('âœ… File label click listener added');
        }

        if (uploadArea) {
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    updateFileName(files[0].name);
                    document.getElementById('transcribeBtn').disabled = false;
                }
            });
        }

        // ×××–×™×Ÿ ×œ×©×™× ×•×™ ×§×•×‘×¥ - ×¨×§ ×× ×¢×•×“ ×œ× ×”×•×¡×£
        if (fileInput && !fileInput.hasAttribute('data-listener-added')) {
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    updateFileName(e.target.files[0].name);
                    document.getElementById('transcribeBtn').disabled = false;
                }
            });
            fileInput.setAttribute('data-listener-added', 'true');
            console.log('âœ… File input change listener added');
        }

        function updateFileName(name) {
            document.getElementById('fileName').textContent = `×§×•×‘×¥ × ×‘×—×¨: ${name}`;
        }

        // ×¤×•× ×§×¦×™×•×ª ×ª××œ×•×œ
        async function transcribeAudio() {
            const patientName = document.getElementById('patientName').value.trim();
            const sessionDate = document.getElementById('sessionDate').value;
            const qualityMode = document.getElementById('qualityMode').value;
            const audioFile = document.getElementById('audioFile').files[0];
            const directText = document.getElementById('directTextInput').value.trim();
            
            // ×‘×“×™×§×” ××™×–×” ××¦×‘ ×¤×¢×™×œ
            const textModeBtn = document.getElementById('textModeBtn');
            const isTextMode = textModeBtn && textModeBtn.classList.contains('active');

            if (!patientName) {
                showStatus('×™×© ×œ×”×–×™×Ÿ ×©× ××˜×•×¤×œ', 'error');
                return;
            }

            // ×‘×“×™×§×ª ××™××•×ª ×ª×—×™×œ×”
            if (!currentUser || !sessionToken) {
                showStatus('ğŸ” ×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×›×“×™ ×œ×”×©×ª××© ×‘××¢×¨×›×ª', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 1500);
                return;
            }

            // ×‘××¦×‘ ×˜×§×¡×˜ - ×¢×™×‘×•×“ ×˜×§×¡×˜ ×‘×œ×‘×“
            if (isTextMode) {
                if (!directText) {
                    showStatus('×™×© ×œ×”×–×™×Ÿ ×˜×§×¡×˜ ×œ×¢×™×‘×•×“', 'error');
                    return;
                }
                
                // ×¢×™×‘×•×“ ×˜×§×¡×˜ ×™×©×™×¨
                return await processDirectText(patientName, sessionDate, directText);
            }

            // ×‘××¦×‘ ×©××¢ - ×‘×“×™×§×” ×©×™×© ×§×•×‘×¥ ×©××¢
            if (!audioFile) {
                showStatus('×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×©××¢ ××• ×œ×”×§×œ×™×˜', 'error');
                return;
            }

            // ×‘×“×™×§×” ×× ×–×” ××¦×‘ ×ª××œ×•×œ ×”×™×‘×¨×™×“×™ ××•×¦×¤×Ÿ
            if (qualityMode === 'hybrid-encrypted') {
                return await transcribeWithHybridEncryption(patientName, sessionDate, audioFile);
            }

            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('patient_name', patientName);
            formData.append('session_date', sessionDate);
            formData.append('quality_mode', qualityMode);

            try {
                showStatus('××ª××œ×œ... ×× × ×”××ª×Ÿ', 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                const response = await fetch('/transcribe', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('âœ… ×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×”!', 'success');
                    displayResults(data);
                    currentPatientName = patientName;
                    loadPatients(); // ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×”××˜×•×¤×œ×™×
                    
                    // ×¢×“×›×•×Ÿ ××™×“×¢ ×”×× ×•×™ ××—×¨×™ ×ª××œ×•×œ ××•×¦×œ×—
                    if (data.session_info) {
                        updateSubscriptionInfo(data.session_info);
                    }
                } else if (response.status === 402) {
                    // Payment Required - ×”×’×¢×” ×œ××’×‘×œ×ª ×¡×©× ×™×
                    showStatus('âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×ª ×”×¡×©× ×™× ×”×—×™× ××™×™×', 'error');
                    setTimeout(() => {
                        showUpgradeModal(data);
                    }, 1500);
                } else {
                    showStatus(`×©×’×™××”: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×ª××œ×•×œ:', error);
                showStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            } finally {
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×¢×™×‘×•×“ ×˜×§×¡×˜ ×™×©×™×¨ - ×¢×™×‘×•×“ ××§×•××™ ×¤×©×•×˜ ×œ×œ× ×‘×“×™×§×ª ××’×‘×œ×•×ª
        async function processDirectText(patientName, sessionDate, directText) {
            try {
                console.log('ğŸ“ ××ª×—×™×œ ×¢×™×‘×•×“ ×˜×§×¡×˜ ×™×©×™×¨ ×¢×‘×•×¨:', patientName);
                showStatus('××¢×‘×“ ×˜×§×¡×˜...', 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                // ×¢×™×‘×•×“ ××§×•××™ ×¤×©×•×˜ - ×”×¦×’×ª ×”×˜×§×¡×˜ ×›×ª×•×¦××” (×œ×œ× ×‘×“×™×§×ª ××’×‘×œ×•×ª!)
                setTimeout(async () => {
                    const data = {
                        original_transcript: directText,
                        corrected_transcript: directText,
                        corrections_made: []
                    };
                    
                    console.log('âœ… ×¢×™×‘×•×“ ×˜×§×¡×˜ ×”×•×©×œ×:', data);
                    showStatus('âœ… ×¢×™×‘×•×“ ×˜×§×¡×˜ ×”×•×©×œ× ×‘×”×¦×œ×—×”!', 'success');
                    displayResults(data);
                    currentPatientName = patientName;
                    
                    // ×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× ××—×¨×™ ×¢×™×‘×•×“ ××•×¦×œ×— (×¨×§ ×× ×”××©×ª××© ×‘×× ×•×™ ×—×™× ××™)
                    try {
                        await updateSessionCounter();
                        console.log('âœ… ××•× ×” ×¡×©× ×™× ×¢×•×“×›×Ÿ ××—×¨×™ ×¢×™×‘×•×“ ×˜×§×¡×˜');
                    } catch (counterError) {
                        console.log('âš ï¸ ×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•× ×”, ××‘×œ ×”×¢×™×‘×•×“ ×”×¦×œ×™×—:', counterError);
                    }
                    
                    document.getElementById('transcribeBtn').disabled = false;
                }, 500); // ×”××ª× ×” ×§×¦×¨×” ×œ××¤×§×˜

            } catch (error) {
                console.error('×©×’×™××” ×‘×¢×™×‘×•×“ ×˜×§×¡×˜:', error);
                showStatus('×©×’×™××” ×‘×¢×™×‘×•×“ ×˜×§×¡×˜', 'error');
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // ×¤×•× ×§×¦×™×™×ª ×ª××œ×•×œ ×”×™×‘×¨×™×“×™ ××•×¦×¤×Ÿ
        async function transcribeWithHybridEncryption(patientName, sessionDate, audioFile) {
            const encryptionPassword = document.getElementById('encryptionPassword').value.trim();
            
            if (!encryptionPassword) {
                showStatus('×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××ª ×”×¦×¤× ×” ×œ××¦×‘ ×”×™×‘×¨×™×“×™', 'error');
                return;
            }

            if (!currentUser || !sessionToken) {
                showStatus('×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×›×“×™ ×œ×”×©×ª××© ×‘××¢×¨×›×ª', 'error');
                setTimeout(() => {
                    openLoginModal();
                }, 1500);
                return;
            }

            const formData = new FormData();
            formData.append('audio', audioFile);
            formData.append('patient_name', patientName);
            formData.append('session_date', sessionDate);
            formData.append('quality_mode', 'hybrid-encrypted');
            formData.append('encryption_key', encryptionPassword);

            try {
                showStatus('××ª××œ×œ ×¢× ×”×¦×¤× ×” ×”×™×‘×¨×™×“×™×ª... ×× × ×”××ª×Ÿ', 'loading');
                document.getElementById('transcribeBtn').disabled = true;

                const response = await fetch('/transcribe-encrypted', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    showStatus('âœ… ×ª××œ×•×œ ×”×™×‘×¨×™×“×™ ×”×•×©×œ× ×‘×”×¦×œ×—×”!', 'success');
                    displayResults(data);
                    currentPatientName = patientName;
                    loadPatients(); // ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×”××˜×•×¤×œ×™×
                    
                    // ×”×•×“×¢×” ×¢×œ ×”×¦×œ×—×ª ×”×”×¦×¤× ×”
                    setTimeout(() => {
                        showStatus('ğŸ›¡ï¸ ×”×¡×©×Ÿ × ×©××¨ ×‘×¢× ×Ÿ ×‘×¦×•×¨×” ××•×¦×¤× ×ª', 'success');
                    }, 2000);
                } else if (response.status === 401) {
                    showStatus('×¡×™×¡××ª ×”×¦×¤× ×” ×©×’×•×™×”', 'error');
                } else if (response.status === 402) {
                    showStatus('âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×ª ×”×¡×©× ×™× ×”×—×™× ××™×™×', 'error');
                    setTimeout(() => {
                        showUpgradeModal(data);
                    }, 1500);
                } else {
                    showStatus(`×©×’×™××”: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×ª××œ×•×œ ×”×™×‘×¨×™×“×™:', error);
                showStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            } finally {
                document.getElementById('transcribeBtn').disabled = false;
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ × ×•×¡×¤×•×ª
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
                
                if (type === 'success') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const originalResult = document.getElementById('originalResult');
            const correctedResult = document.getElementById('correctedResult');
            const textEditor = document.getElementById('textEditor');
            
            if (resultsSection && originalResult && correctedResult && textEditor) {
                originalTranscript = data.original_transcript || '';
                correctedTranscript = data.corrected_transcript || '';
                
                originalResult.textContent = originalTranscript;
                correctedResult.textContent = correctedTranscript;
                textEditor.value = correctedTranscript;
                
                resultsSection.style.display = 'block';
                
                // ×”×¦×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª
                updateTextStats(correctedTranscript);
                
                // ×”×¦×’×ª ×ª×™×§×•× ×™× ×× ×™×©
                if (data.corrections_made && data.corrections_made.length > 0) {
                    showCorrections(data.corrections_made);
                }
            }
        }

        function updateTextStats(text) {
            const textStats = document.getElementById('textStats');
            if (textStats && text) {
                const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;
                const charCount = text.length;
                textStats.textContent = `××™×œ×™×: ${wordCount} | ×ª×•×•×™×: ${charCount}`;
            }
        }

        function showCorrections(corrections) {
            const correctionsInfo = document.getElementById('correctionsInfo');
            const correctionsList = document.getElementById('correctionsList');
            
            if (correctionsInfo && correctionsList) {
                correctionsList.innerHTML = '';
                corrections.forEach(correction => {
                    const li = document.createElement('li');
                    li.textContent = correction;
                    correctionsList.appendChild(li);
                });
                correctionsInfo.classList.add('show');
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×©××™×¨×” ×‘×©×¨×ª (×‘××§×•× localStorage) - ×¢× ×‘×“×™×§×ª ××’×‘×œ×•×ª
        async function saveSessionLocally() {
            if (!currentPatientName || !correctedTranscript) {
                showStatus('××™×Ÿ ×ª×•×›×Ÿ ×œ×©××™×¨×”', 'error');
                return;
            }

            console.log('ğŸ’¾ ××ª×—×™×œ ×ª×”×œ×™×š ×©××™×¨×ª ×¡×©×Ÿ ×‘×©×¨×ª ×¢×‘×•×¨:', currentPatientName);

            const sessionDate = document.getElementById('sessionDate').value;
            
            // ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ×”×¡×©×Ÿ
            const sessionData = {
                patient_name: currentPatientName,
                session_date: sessionDate,
                original_transcript: originalTranscript,
                corrected_transcript: correctedTranscript,
                edited_transcript: correctedTranscript,
                audio_filename: document.getElementById('audioFile').files[0]?.name || 'direct_text.txt',
                quality_mode: document.getElementById('qualityMode').value,
                replace_existing: false
            };

            try {
                showStatus('ğŸ’¾ ×©×•××¨ ×¡×©×Ÿ ×‘×©×¨×ª...', 'loading');

                const response = await fetch('/save-edited-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify(sessionData)
                });

                const result = await response.json();

                if (response.ok) {
                    showStatus('âœ… ×”×¡×©×Ÿ × ×©××¨ ×‘×©×¨×ª ×‘×”×¦×œ×—×”!', 'success');
                    
                    // ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×”××˜×•×¤×œ×™×
                    await loadPatients();
                    
                    // ×¢×“×›×•×Ÿ ××™×“×¢ ×”××’×‘×œ×•×ª
                    await checkUserLimits();
                    
                    console.log('âœ… ×¡×©×Ÿ × ×©××¨ ×‘×©×¨×ª:', result);
                } else if (response.status === 402) {
                    // Payment Required - ×”×’×¢×” ×œ××’×‘×œ×”
                    showStatus('âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×”', 'error');
                    setTimeout(() => {
                        showUpgradeModal(result);
                    }, 1500);
                } else {
                    showStatus(`×©×’×™××” ×‘×©××™×¨×”: ${result.error}`, 'error');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×©××™×¨×ª ×¡×©×Ÿ:', error);
                showStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ×¤×•× ×§×¦×™×” ××œ××” ×œ×‘×“×™×§×ª ××’×‘×œ×•×ª ×œ×¤× ×™ ×©××™×¨×” (××˜×•×¤×œ×™× + ×¡×©× ×™×)
        async function checkLimitsBeforeSaving(patientName) {
            try {
                console.log('ğŸ” ×‘×•×“×§ ××’×‘×œ×•×ª ×œ×¤× ×™ ×©××™×¨×ª ×¡×©×Ÿ ×¢×‘×•×¨:', patientName);
                
                // ×¡×¤×™×¨×” ××§×•××™×ª ×©×œ ××˜×•×¤×œ×™× ×•×¡×©× ×™×
                let localPatientCount = 0;
                let totalSessionsCount = 0;
                
                if (currentUser) {
                    const storageKey = `sessions_${currentUser.email}`;
                    let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // × ×™×§×•×™ ×¡×©× ×™× ×¤×’×•××™×
                    userSessions = userSessions.filter(session => 
                        session && 
                        session.patient_name && 
                        session.patient_name.trim() !== '' &&
                        session.corrected_transcript &&
                        session.corrected_transcript.trim() !== ''
                    );
                    
                    // ×¡×¤×™×¨×ª ××˜×•×¤×œ×™× ×™×™×—×•×“×™×™× ×•×¡×©× ×™×
                    const uniquePatients = new Set();
                    userSessions.forEach(session => {
                        if (session.patient_name && session.patient_name.trim()) {
                            uniquePatients.add(session.patient_name.trim());
                        }
                    });
                    localPatientCount = uniquePatients.size;
                    totalSessionsCount = userSessions.length;
                }
                
                console.log('ğŸ‘¥ ××¡×¤×¨ ××˜×•×¤×œ×™× ×§×™×™××™×:', localPatientCount);
                console.log('ğŸ“ ××¡×¤×¨ ×¡×©× ×™× ×§×™×™××™×:', totalSessionsCount);
                
                // ×‘×“×™×§×ª ××’×‘×œ×ª ×¡×©× ×™× ×ª×—×™×œ×” (5 ×¡×©× ×™× ××§×¡×™××•×)
                if (totalSessionsCount >= 5) {
                    console.log('âŒ ×”×’×¢×” ×œ××’×‘×œ×ª ×¡×©× ×™× (5) - ×—×•×¡× ×©××™×¨×”');
                    showStatus('âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×ª ×”×¡×©× ×™× ×”×—×™× ××™×™× - ××•×ª×¨×™× 5 ×¡×©× ×™× ×‘×œ×‘×“', 'error');
                    setTimeout(() => {
                        showLimitWarningModal(
                            '×”×’×¢×ª ×œ××’×‘×œ×ª ×”×¡×©× ×™× ×”×—×™× ××™×™×', 
                            `×™×© ×œ×š ×›×‘×¨ ${totalSessionsCount} ×¡×©× ×™× ××ª×•×š 5 ×”××•×ª×¨×™× ×‘×× ×•×™ ×”×—×™× ××™.<br><br>×›×“×™ ×œ×”×•×¡×™×£ ×¡×©× ×™× × ×•×¡×¤×™×, ××—×§ ×¡×©× ×™× ×™×©× ×™× ××• ×©×“×¨×’ ×œ×× ×•×™ ××œ×.`
                        );
                    }, 1500);
                    return false;
                }
                
                // ×‘×“×™×§×ª ××’×‘×œ×ª ××˜×•×¤×œ×™× (×¨×§ ×× ×–×” ××˜×•×¤×œ ×—×“×©)
                const isNewPatient = await checkIfNewPatient(patientName);
                console.log('ğŸ†• ×”×× ××˜×•×¤×œ ×—×“×© ×œ×©××™×¨×”:', isNewPatient);
                
                if (isNewPatient) {
                    // ×œ×•×’×™×§×” ×¤×©×•×˜×”: ×‘×× ×•×™ ×—×™× ××™ ××•×ª×¨ ×¨×§ ××˜×•×¤×œ ××—×“
                    if (localPatientCount >= 1) {
                        console.log('âŒ ×™×© ×›×‘×¨ ××˜×•×¤×œ ××—×“ - ×—×•×¡× ×”×•×¡×¤×ª ××˜×•×¤×œ ×—×“×©');
                        showStatus('âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×ª ×”××˜×•×¤×œ×™× ×”×—×™× ××™×™× - ××•×ª×¨ ××˜×•×¤×œ ××—×“ ×‘×œ×‘×“', 'error');
                        setTimeout(() => {
                            showLimitWarningModal(
                                '×”×’×¢×ª ×œ××’×‘×œ×ª ×”××˜×•×¤×œ×™× ×”×—×™× ××™×™×',
                                '×‘×× ×•×™ ×”×—×™× ××™ ××•×ª×¨ ××˜×•×¤×œ ××—×“ ×‘×œ×‘×“. ×›×“×™ ×œ×”×•×¡×™×£ ××˜×•×¤×œ×™× × ×•×¡×¤×™×, ×™×© ×œ×©×“×¨×’ ×œ×× ×•×™ ×‘×ª×©×œ×•×'
                            );
                        }, 1500);
                        return false;
                    } else {
                        console.log('âœ… ××™×Ÿ ××˜×•×¤×œ×™× - × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××˜×•×¤×œ ×¨××©×•×Ÿ');
                    }
                } else {
                    console.log('âœ… ××˜×•×¤×œ ×§×™×™× - ×‘×•×“×§ ×¨×§ ××’×‘×œ×ª ×¡×©× ×™×');
                }

                console.log('âœ… ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• - × ×™×ª×Ÿ ×œ×©××•×¨');
                return true;
            } catch (error) {
                console.error('×©×’×™××” ×‘×‘×“×™×§×ª ××’×‘×œ×•×ª ×œ×©××™×¨×”:', error);
                console.log('âš ï¸ ×©×’×™××” ×‘×‘×“×™×§×” - ×××¤×©×¨ ×œ×©××•×¨');
                return true; // ×‘××§×¨×” ×©×œ ×©×’×™××”, × ×ª×Ÿ ×œ×©××•×¨
            }
        }

        function saveToLocalStorage(sessionData) {
            const storageKey = `sessions_${currentUser.email}`;
            let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // ×”×•×¡×¤×ª ×”×¡×©×Ÿ ×”×—×“×©
            userSessions.push(sessionData);
            
            // ×©××™×¨×” ×—×–×¨×” ×œ-localStorage
            localStorage.setItem(storageKey, JSON.stringify(userSessions));
            
            // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
            updateLocalSessionsUI();
        }

        function downloadSessionFile(sessionData) {
            const filename = `${sessionData.patient_name}_${sessionData.session_date}_${new Date().getTime()}.json`;
            const dataStr = JSON.stringify(sessionData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = filename;
            link.click();
            
            // × ×™×§×•×™
            URL.revokeObjectURL(link.href);
        }

        function updateLocalSessionsUI() {
            if (!currentUser) return;
            
            const storageKey = `sessions_${currentUser.email}`;
            const userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // ×§×™×‘×•×¥ ×œ×¤×™ ××˜×•×¤×œ×™×
            const patientGroups = {};
            userSessions.forEach(session => {
                if (!patientGroups[session.patient_name]) {
                    patientGroups[session.patient_name] = [];
                }
                patientGroups[session.patient_name].push(session);
            });

            // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
            const localFilesContainer = document.getElementById('localFilesContainer');
            const localFilesList = document.getElementById('localFilesList');
            
            // × ×™×§×•×™ ×”×ª×•×›×Ÿ ×”×§×™×™× ×ª××™×“
            if (localFilesContainer) {
                localFilesContainer.innerHTML = '';
            }
            
            if (Object.keys(patientGroups).length > 0) {
                // ×™×© ××˜×•×¤×œ×™× - ×”×¦×’ ××ª ×”×¨×©×™××”
                if (localFilesList) {
                    localFilesList.style.display = 'block';
                }
                
                Object.keys(patientGroups).forEach(patientName => {
                    const sessions = patientGroups[patientName];
                    const patientCard = createPatientCard(patientName, sessions);
                    localFilesContainer.appendChild(patientCard);
                });
            } else {
                // ××™×Ÿ ××˜×•×¤×œ×™× - ×”×¡×ª×¨ ××ª ×”×¨×©×™××”
                if (localFilesList) {
                    localFilesList.style.display = 'none';
                }
                console.log('ğŸ§¹ ××™×Ÿ ××˜×•×¤×œ×™× ××§×•××™×™× - ××¡×ª×™×¨ ×¨×©×™××”');
            }
        }

        function createPatientCard(patientName, sessions) {
            const card = document.createElement('div');
            card.className = 'patient-card';
            card.style.cursor = 'pointer';
            card.style.position = 'relative';
            
            const latestSession = sessions[sessions.length - 1];
            
            card.innerHTML = `
                <button class="delete-patient-btn" onclick="confirmDeletePatient('${patientName.replace(/'/g, "\\'")}', event)" title="××—×§ ××˜×•×¤×œ">
                    ğŸ—‘ï¸
                </button>
                <h3>${patientName}</h3>
                <p>×¡×©× ×™×: ${sessions.length}</p>
                <p>×¡×©×Ÿ ××—×¨×•×Ÿ: ${new Date(latestSession.timestamp).toLocaleDateString('he-IL')}</p>
                <small>×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×›×œ ×”×¡×©× ×™×</small>
            `;
            
            card.addEventListener('click', (e) => {
                // ×× ×™×¢×ª ×¤×ª×™×—×ª ×”×¡×©× ×™× ×× ×œ×—×¦×• ×¢×œ ×›×¤×ª×•×¨ ×”××—×™×§×”
                if (!e.target.classList.contains('delete-patient-btn')) {
                    showPatientSessions(patientName, sessions);
                }
            });
            
            return card;
        }

        function showPatientSessions(patientName, sessions) {
            const modal = document.getElementById('sessionsModal');
            const modalTitle = document.getElementById('modalTitle');
            const sessionsList = document.getElementById('sessionsList');
            
            modalTitle.textContent = `×¡×©× ×™× ×©×œ ${patientName}`;
            sessionsList.innerHTML = '';
            
            sessions.forEach((session, index) => {
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                sessionItem.style.position = 'relative';
                sessionItem.innerHTML = `
                    <button class="delete-session-btn" onclick="confirmDeleteSession('${patientName.replace(/'/g, "\\'")}', ${index}, event)" title="××—×§ ×¡×©×Ÿ">
                        ğŸ—‘ï¸
                    </button>
                    <h4>×¡×©×Ÿ ××ª××¨×™×š ${new Date(session.timestamp).toLocaleDateString('he-IL')}</h4>
                    <p>××™×œ×™×: ${session.word_count} | ×ª×•×•×™×: ${session.char_count}</p>
                    <small>× ×•×¦×¨: ${new Date(session.timestamp).toLocaleString('he-IL')}</small>
                `;
                
                sessionItem.addEventListener('click', (e) => {
                    // ×× ×™×¢×ª ×¤×ª×™×—×ª ×ª×•×›×Ÿ ×”×¡×©×Ÿ ×× ×œ×—×¦×• ×¢×œ ×›×¤×ª×•×¨ ×”××—×™×§×”
                    if (!e.target.classList.contains('delete-session-btn')) {
                        showSessionContent(session);
                    }
                });
                
                sessionsList.appendChild(sessionItem);
            });
            
            modal.style.display = 'block';
        }

        function showSessionContent(session) {
            const modal = document.getElementById('sessionContentModal');
            const title = document.getElementById('sessionContentTitle');
            const body = document.getElementById('sessionContentBody');
            
            title.textContent = `×¡×©×Ÿ ${session.patient_name} - ${new Date(session.timestamp).toLocaleDateString('he-IL')}`;
            body.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4>×¤×¨×˜×™ ×”×¡×©×Ÿ:</h4>
                    <p><strong>××˜×•×¤×œ:</strong> ${session.patient_name}</p>
                    <p><strong>×ª××¨×™×š:</strong> ${session.session_date}</p>
                    <p><strong>× ×•×¦×¨:</strong> ${new Date(session.timestamp).toLocaleString('he-IL')}</p>
                    <p><strong>××™×œ×™×:</strong> ${session.word_count} | <strong>×ª×•×•×™×:</strong> ${session.char_count}</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <h4>×ª×•×›×Ÿ ×”×¡×©×Ÿ:</h4>
                    <div style="white-space: pre-wrap; line-height: 1.6; direction: rtl;">${session.corrected_transcript}</div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="copySessionText('${session.corrected_transcript.replace(/'/g, "\\'")}')" class="action-btn copy-btn">ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜</button>
                    <button onclick="downloadSingleSession(${JSON.stringify(session).replace(/"/g, '&quot;')})" class="action-btn" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white;">ğŸ’¾ ×”×•×¨×“ ×§×•×‘×¥</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function copySessionText(text) {
            navigator.clipboard.writeText(text).then(() => {
                showStatus('âœ… ×”×˜×§×¡×˜ ×”×•×¢×ª×§ ×œ×œ×•×—', 'success');
            });
        }

        function downloadSingleSession(session) {
            downloadSessionFile(session);
        }

        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ××•×“×œ ×”××—×™×§×”
        let pendingDeleteAction = null;

        // ×¤×•× ×§×¦×™×•×ª ××—×™×§×” ×¢× ××•×“×œ ××•×ª×× ××™×©×™×ª
        function confirmDeletePatient(patientName, event) {
            event.stopPropagation();
            
            const message = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××˜×•×¤×œ "<strong>${patientName}</strong>" ×•×›×œ ×”×¡×©× ×™× ×©×œ×•?<br><br>×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`;
            
            showDeleteConfirmModal('××—×™×§×ª ××˜×•×¤×œ', message, () => {
                deletePatient(patientName);
            });
        }

        function confirmDeleteSession(patientName, sessionIndex, event) {
            event.stopPropagation();
            
            const message = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¡×©×Ÿ ×”×–×” ×©×œ "<strong>${patientName}</strong>"?<br><br>×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`;
            
            showDeleteConfirmModal('××—×™×§×ª ×¡×©×Ÿ', message, () => {
                deleteSession(patientName, sessionIndex);
            });
        }

        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××•×“×œ ××™×©×•×¨ ××—×™×§×”
        function showDeleteConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('deleteConfirmModal');
            const titleElement = document.getElementById('deleteConfirmTitle');
            const messageElement = document.getElementById('deleteConfirmMessage');
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const cancelBtn = document.getElementById('cancelDeleteBtn');
            
            // ×¢×“×›×•×Ÿ ×”×ª×•×›×Ÿ
            titleElement.textContent = `âš ï¸ ${title}`;
            messageElement.innerHTML = message;
            
            // ×©××™×¨×ª ×”×¤×¢×•×œ×” ×”×××ª×™× ×”
            pendingDeleteAction = onConfirm;
            
            // ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×›×¤×ª×•×¨×™×
            confirmBtn.onclick = () => {
                if (pendingDeleteAction) {
                    pendingDeleteAction();
                    pendingDeleteAction = null;
                }
                closeDeleteConfirm();
            };
            
            cancelBtn.onclick = () => {
                pendingDeleteAction = null;
                closeDeleteConfirm();
            };
            
            // ×”×¦×’×ª ×”××•×“×œ
            modal.style.display = 'block';
        }

        // ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ××•×“×œ ××™×©×•×¨ ××—×™×§×”
        function closeDeleteConfirm() {
            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'none';
            pendingDeleteAction = null;
        }

        async function deletePatient(patientName) {
            try {
                showStatus('××•×—×§ ××˜×•×¤×œ...', 'loading');
                
                let deletedSessionsCount = 0;
                
                // ××—×™×§×” ××§×•××™×ª
                if (currentUser) {
                    const storageKey = `sessions_${currentUser.email}`;
                    let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // ×¡×¤×™×¨×ª ×”×¡×©× ×™× ×©×œ ×”××˜×•×¤×œ ×œ×¤× ×™ ×”××—×™×§×”
                    const patientSessions = userSessions.filter(session => session.patient_name === patientName);
                    deletedSessionsCount = patientSessions.length;
                    
                    // ×¡×™× ×•×Ÿ ×”×¡×©× ×™× - ×”×¡×¨×ª ×›×œ ×”×¡×©× ×™× ×©×œ ×”××˜×•×¤×œ
                    const filteredSessions = userSessions.filter(session => session.patient_name !== patientName);
                    
                    // ×©××™×¨×” ×—×–×¨×”
                    localStorage.setItem(storageKey, JSON.stringify(filteredSessions));
                    
                    console.log(`ğŸ—‘ï¸ ××—×§ ××˜×•×¤×œ "${patientName}" ×¢× ${deletedSessionsCount} ×¡×©× ×™× - × ×•×ª×¨×• ${filteredSessions.length} ×¡×©× ×™×`);
                }
                
                // ×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× ×‘×©×¨×ª (×”×¤×—×ª×” ×œ×¤×™ ×›××•×ª ×”×¡×©× ×™× ×©× ××—×§×•)
                if (sessionToken && deletedSessionsCount > 0) {
                    try {
                        // ×”×¤×—×ª×ª ×”××•× ×” ×œ×¤×™ ×›××•×ª ×”×¡×©× ×™× ×©× ××—×§×•
                        for (let i = 0; i < deletedSessionsCount; i++) {
                            const response = await fetch('/delete-session', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${sessionToken}`
                                },
                                body: JSON.stringify({
                                    patient_name: patientName,
                                    session_filename: `session_${new Date().toISOString().split('T')[0]}.json`
                                })
                            });
                            
                            if (response.ok) {
                                console.log(`âœ… ××•× ×” ×¡×©× ×™× ×”×•×¤×—×ª ×‘×©×¨×ª (${i + 1}/${deletedSessionsCount})`);
                            }
                        }
                        
                        // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×”××’×‘×œ×•×ª ××—×¨×™ ×”×¤×—×ª×”
                        await checkUserLimits();
                        
                    } catch (serverError) {
                        console.log('âš ï¸ ××˜×•×¤×œ × ××—×§ ××§×•××™×ª, ×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•× ×” ×‘×©×¨×ª:', serverError);
                    }
                }
                
                // ××—×™×§×” ××”×©×¨×ª (×× ×”××©×ª××© ××—×•×‘×¨)
                if (sessionToken) {
                    try {
                        const response = await fetch(`/patient/${encodeURIComponent(patientName)}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${sessionToken}`
                            }
                        });
                        
                        if (response.ok) {
                            console.log('âœ… ××˜×•×¤×œ × ××—×§ ×’× ××”×©×¨×ª');
                        } else {
                            console.log('âš ï¸ ××˜×•×¤×œ × ××—×§ ××§×•××™×ª, ××š ×œ× ××”×©×¨×ª');
                        }
                    } catch (serverError) {
                        console.log('âš ï¸ ××˜×•×¤×œ × ××—×§ ××§×•××™×ª, ×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª:', serverError);
                    }
                }
                
                        // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×”×××©×§ - ×›×¤×•×œ ×œ×•×•×“×
                        updateLocalSessionsUI();
                        updatePatientsLimitDisplay(); // ×¢×“×›×•×Ÿ ××•× ×” ××˜×•×¤×œ×™×
                        
                        // ×¢×“×›×•×Ÿ × ×•×¡×£ ××—×¨×™ ×–××Ÿ ×§×¦×¨ ×œ××§×¨×” ×©×œ ×¢×™×›×•×‘
                        setTimeout(() => {
                            updateLocalSessionsUI();
                            updatePatientsLimitDisplay(); // ×¢×“×›×•×Ÿ ××•× ×” ××˜×•×¤×œ×™×
                            console.log('ğŸ”„ ×¢×“×›×•×Ÿ ×××©×§ × ×•×¡×£ ××—×¨×™ ××—×™×§×”');
                        }, 100);
                
                showStatus(`âœ… ×”××˜×•×¤×œ "${patientName}" ×•×›×œ ${deletedSessionsCount} ×”×¡×©× ×™× ×©×œ×• × ××—×§×• ×‘×”×¦×œ×—×”`, 'success');
                
                // ×¡×’×™×¨×ª ××•×“×œ ×× ×¤×ª×•×—
                closeSessions();
                
            } catch (error) {
                console.error('×©×’×™××” ×‘××—×™×§×ª ××˜×•×¤×œ:', error);
                showStatus('×©×’×™××” ×‘××—×™×§×ª ×”××˜×•×¤×œ', 'error');
            }
        }

        async function deleteSession(patientName, sessionIndex) {
            try {
                showStatus('××•×—×§ ×¡×©×Ÿ...', 'loading');
                
                // ××—×™×§×” ××§×•××™×ª
                if (currentUser) {
                    const storageKey = `sessions_${currentUser.email}`;
                    let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                    
                    // ××¦×™××ª ×”×¡×©× ×™× ×©×œ ×”××˜×•×¤×œ ×”×¡×¤×¦×™×¤×™
                    const patientSessions = userSessions.filter(session => session.patient_name === patientName);
                    
                    if (sessionIndex >= 0 && sessionIndex < patientSessions.length) {
                        const sessionToDelete = patientSessions[sessionIndex];
                        
                        // ×”×¡×¨×ª ×”×¡×©×Ÿ ×”×¡×¤×¦×™×¤×™
                        const updatedSessions = userSessions.filter(session => 
                            !(session.patient_name === patientName && session.timestamp === sessionToDelete.timestamp)
                        );
                        
                        // ×©××™×¨×” ×—×–×¨×”
                        localStorage.setItem(storageKey, JSON.stringify(updatedSessions));
                        
                        console.log(`ğŸ—‘ï¸ ××—×§ ×¡×©×Ÿ ×©×œ "${patientName}" - × ×•×ª×¨×• ${updatedSessions.length} ×¡×©× ×™×`);
                        
                    // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×”×××©×§ - ×›×¤×•×œ ×œ×•×•×“×
                    updateLocalSessionsUI();
                    updatePatientsLimitDisplay(); // ×¢×“×›×•×Ÿ ××•× ×” ××˜×•×¤×œ×™×
                    
                    // ×¢×“×›×•×Ÿ × ×•×¡×£ ××—×¨×™ ×–××Ÿ ×§×¦×¨ ×œ××§×¨×” ×©×œ ×¢×™×›×•×‘
                    setTimeout(() => {
                        updateLocalSessionsUI();
                        updatePatientsLimitDisplay(); // ×¢×“×›×•×Ÿ ××•× ×” ××˜×•×¤×œ×™×
                        console.log('ğŸ”„ ×¢×“×›×•×Ÿ ×××©×§ × ×•×¡×£ ××—×¨×™ ××—×™×§×ª ×¡×©×Ÿ');
                    }, 100);
                        
                        // ×¢×“×›×•×Ÿ ××•×“×œ ×”×¡×©× ×™× ×× ×¤×ª×•×—
                        const updatedPatientSessions = updatedSessions.filter(session => session.patient_name === patientName);
                        if (updatedPatientSessions.length > 0) {
                            showPatientSessions(patientName, updatedPatientSessions);
                        } else {
                            closeSessions();
                        }
                        
                        // ×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× (×”×¤×—×ª×”) ×‘×©×¨×ª - ×—×©×•×‘ ×œ×¢×©×•×ª ×œ×¤× ×™ ×”×•×“×¢×ª ×”×”×¦×œ×—×”
                        if (sessionToken) {
                            try {
                                const response = await fetch('/delete-session', {
                                    method: 'DELETE',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${sessionToken}`
                                    },
                                    body: JSON.stringify({
                                        patient_name: patientName,
                                        session_filename: `session_${sessionToDelete.session_date || 'unknown'}.json`
                                    })
                                });
                                
                                if (response.ok) {
                                    const result = await response.json();
                                    console.log('âœ… ××•× ×” ×¡×©× ×™× ×”×•×¤×—×ª ×‘×©×¨×ª:', result.session_info);
                                    // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×”××’×‘×œ×•×ª ××—×¨×™ ×”×¤×—×ª×”
                                    if (result.session_info) {
                                        updateCombinedLimitsDisplay(result.session_info, null);
                                    }
                                    await checkUserLimits();
                                } else {
                                    console.log('âš ï¸ ×©×’×™××” ×‘×”×¤×—×ª×ª ××•× ×” ×¡×©× ×™× ×‘×©×¨×ª');
                                }
                            } catch (serverError) {
                                console.log('âš ï¸ ×¡×©×Ÿ × ××—×§ ××§×•××™×ª, ×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•× ×” ×‘×©×¨×ª:', serverError);
                            }
                        }
                        
                        showStatus('âœ… ×”×¡×©×Ÿ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                    }
                }
                
            } catch (error) {
                console.error('×©×’×™××” ×‘××—×™×§×ª ×¡×©×Ÿ:', error);
                showStatus('×©×’×™××” ×‘××—×™×§×ª ×”×¡×©×Ÿ', 'error');
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×¡×’×™×¨×ª ××•×“×œ×™×
        function closeSessions() {
            document.getElementById('sessionsModal').style.display = 'none';
        }

        function closeSessionContent() {
            document.getElementById('sessionContentModal').style.display = 'none';
        }

        // ×¤×•× ×§×¦×™×•×ª ×‘×“×™×§×ª ××’×‘×œ×•×ª ×•×¢×“×›×•×Ÿ ××•× ×™× - ×œ×•×’×™×§×” ××ª×•×§× ×ª
        async function checkLimitsBeforeProcessing(patientName) {
            try {
                console.log('ğŸ” ×‘×•×“×§ ××’×‘×œ×•×ª ×œ×¤× ×™ ×¢×™×‘×•×“ ×¢×‘×•×¨:', patientName);
                
                // ×‘×“×™×§×ª ××’×‘×œ×ª ×¡×©× ×™× - ×¨×§ ×× ×‘×××ª ×”×’×™×¢ ×œ××’×‘×œ×”
                const sessionResponse = await fetch('/subscription/check-session-limit', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (sessionResponse.ok) {
                    const sessionData = await sessionResponse.json();
                    console.log('ğŸ“Š × ×ª×•× ×™ ×¡×©× ×™× ×œ×‘×“×™×§×ª ××’×‘×œ×”:', sessionData);
                    
                    // ×‘×“×™×§×” ××“×•×™×§×ª - ×¨×§ ×× ×‘×××ª ××™×Ÿ ×™×•×ª×¨ ×¡×©× ×™×
                    if (sessionData.status === 'limit_reached' && sessionData.sessions_remaining <= 0) {
                        console.log('âŒ ×‘×××ª ×”×’×™×¢ ×œ××’×‘×œ×ª ×¡×©× ×™×');
                        showStatus('âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×ª ×”×¡×©× ×™× ×”×—×™× ××™×™×', 'error');
                        setTimeout(() => {
                            showUpgradeModal(sessionData);
                        }, 1500);
                        return false;
                    } else {
                        console.log('âœ… ×™×© ×¢×•×“ ×¡×©× ×™× ×–××™× ×™×:', sessionData.sessions_remaining);
                    }
                }

                // ×‘×“×™×§×ª ××’×‘×œ×ª ××˜×•×¤×œ×™× (×¨×§ ×× ×–×” ××˜×•×¤×œ ×—×“×©)
                const isNewPatient = await checkIfNewPatient(patientName);
                console.log('ğŸ†• ×”×× ××˜×•×¤×œ ×—×“×©:', isNewPatient);
                
                if (isNewPatient) {
                    const patientsResponse = await fetch('/patients', {
                        headers: {
                            'Authorization': `Bearer ${sessionToken}`
                        }
                    });
                    
                    if (patientsResponse.ok) {
                        const patientsData = await patientsResponse.json();
                        console.log('ğŸ‘¥ × ×ª×•× ×™ ××˜×•×¤×œ×™× ×œ×‘×“×™×§×ª ××’×‘×œ×”:', patientsData);
                        
                        // ×‘×“×™×§×” ××“×•×™×§×ª ×©×œ ××’×‘×œ×ª ××˜×•×¤×œ×™×
                        if (patientsData.patient_limits && 
                            patientsData.patient_limits.status === 'limit_reached' && 
                            !patientsData.patient_limits.can_add_patient) {
                            console.log('âŒ ×‘×××ª ×”×’×™×¢ ×œ××’×‘×œ×ª ××˜×•×¤×œ×™×');
                            showStatus('âš ï¸ ×”×’×¢×ª ×œ××’×‘×œ×ª ×”××˜×•×¤×œ×™× ×”×—×™× ××™×™×', 'error');
                            setTimeout(() => {
                                showUpgradeModal(patientsData.patient_limits);
                            }, 1500);
                            return false;
                        } else {
                            console.log('âœ… × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××˜×•×¤×œ ×—×“×©');
                        }
                    }
                } else {
                    console.log('âœ… ××˜×•×¤×œ ×§×™×™× - ××™×Ÿ ×¦×•×¨×š ×‘×‘×“×™×§×ª ××’×‘×œ×ª ××˜×•×¤×œ×™×');
                }

                console.log('âœ… ×›×œ ×”×‘×“×™×§×•×ª ×¢×‘×¨×• - × ×™×ª×Ÿ ×œ×”××©×™×š');
                return true;
            } catch (error) {
                console.error('×©×’×™××” ×‘×‘×“×™×§×ª ××’×‘×œ×•×ª:', error);
                console.log('âš ï¸ ×©×’×™××” ×‘×‘×“×™×§×” - ×××¤×©×¨ ×œ×”××©×™×š');
                return true; // ×‘××§×¨×” ×©×œ ×©×’×™××”, × ×ª×Ÿ ×œ×”××©×™×š
            }
        }

        async function checkIfNewPatient(patientName) {
            // ×‘×“×™×§×” ×× ×”××˜×•×¤×œ ×›×‘×¨ ×§×™×™× ×‘-localStorage
            if (!currentUser) return false;
            
            const storageKey = `sessions_${currentUser.email}`;
            const userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            
            // ×× ×™×© ×›×‘×¨ ×¡×©× ×™× ×¢× ×©× ×”××˜×•×¤×œ ×”×–×”, ×–×” ×œ× ××˜×•×¤×œ ×—×“×©
            const existingSessions = userSessions.filter(session => session.patient_name === patientName);
            return existingSessions.length === 0;
        }

        async function updateSessionCounter() {
            try {
                // ×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× ×‘×©×¨×ª (×¨×§ ×œ××©×ª××©×™× ×—×™× ××™×™×)
                const response = await fetch('/subscription/check-session-limit', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (response.ok) {
                    const sessionData = await response.json();
                    if (sessionData.status === 'trial') {
                        // ×¢×“×›×•×Ÿ ×”××•× ×” ×‘×©×¨×ª
                        await fetch('/subscription/increment-session', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${sessionToken}`
                            }
                        });
                        
                        // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
                        await checkUserLimits();
                        
                        console.log('âœ… ××•× ×” ×¡×©× ×™× ×¢×•×“×›×Ÿ');
                    }
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™×:', error);
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×—×¡×¨×•×ª × ×•×¡×¤×•×ª
        async function checkSubscriptionStatus() {
            try {
                const response = await fetch('/subscription/status', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×‘×“×™×§×ª ×¡×˜×˜×•×¡ ×× ×•×™:', error);
            }
            return null;
        }

        function updateSubscriptionInfo(sessionInfo) {
            if (sessionInfo) {
                console.log('×¢×“×›×•×Ÿ ××™×“×¢ ×× ×•×™:', sessionInfo);
                // ×›××Ÿ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×¢×“×›×•×Ÿ ×”×××©×§
            }
        }

        function showUpgradeModal(data) {
            const title = data.subscription_required ? '×”×’×¢×ª ×œ××’×‘×œ×ª ×”××˜×•×¤×œ×™× ×”×—×™× ××™×™×' : '×”×’×¢×ª ×œ××’×‘×œ×ª ×”×¡×©× ×™× ×”×—×™× ××™×™×';
            const message = data.message || '×‘×× ×•×™ ×”×—×™× ××™ ××•×ª×¨ ××˜×•×¤×œ ××—×“ ×‘×œ×‘×“. ×›×“×™ ×œ×”×•×¡×™×£ ××˜×•×¤×œ×™× × ×•×¡×¤×™×, ×™×© ×œ×©×“×¨×’ ×œ×× ×•×™ ×‘×ª×©×œ×•×';
            
            showLimitWarningModal(title, message);
        }

        function openUpgradeModal() {
            showLimitWarningModal('×©×“×¨×•×’ ×× ×•×™', '×›×“×™ ×œ×”×•×¡×™×£ ××˜×•×¤×œ×™× × ×•×¡×¤×™× ×•×œ×§×‘×œ ×™×•×ª×¨ ×¡×©× ×™×, ×™×© ×œ×©×“×¨×’ ×œ×× ×•×™ ××œ×');
        }

        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××•×“×œ ×”×ª×¨×¢×ª ××’×‘×œ×•×ª
        function showLimitWarningModal(title, message) {
            const modal = document.getElementById('limitWarningModal');
            const titleElement = document.getElementById('limitWarningTitle');
            const messageElement = document.getElementById('limitWarningMessage');
            const upgradeBtn = document.getElementById('upgradeBtn');
            const closeLimitBtn = document.getElementById('closeLimitBtn');
            
            // ×¢×“×›×•×Ÿ ×”×ª×•×›×Ÿ
            titleElement.textContent = `âš ï¸ ${title}`;
            messageElement.innerHTML = message;
            
            // ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×›×¤×ª×•×¨×™×
            upgradeBtn.onclick = () => {
                closeLimitWarning();
                // ×›××Ÿ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×©×“×¨×•×’ ×‘×¢×ª×™×“
                alert('×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×©×“×¨×•×’ ×ª×ª×•×•×¡×£ ×‘×§×¨×•×‘');
            };
            
            closeLimitBtn.onclick = () => {
                closeLimitWarning();
            };
            
            // ×”×¦×’×ª ×”××•×“×œ
            modal.style.display = 'block';
        }

        // ×¤×•× ×§×¦×™×” ×œ×¡×’×™×¨×ª ××•×“×œ ×”×ª×¨×¢×ª ××’×‘×œ×•×ª
        function closeLimitWarning() {
            const modal = document.getElementById('limitWarningModal');
            modal.style.display = 'none';
        }

        function openLoginModal() {
            // ××¤× ×” ×œ×“×£ ×”×‘×™×ª ×œ×›× ×™×¡×”
            window.location.href = '/';
        }

        async function loadPatients() {
            // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×¨×©×™××ª ××˜×•×¤×œ×™× ××”×©×¨×ª
            if (!currentUser || !sessionToken) {
                console.log('âŒ ××™×Ÿ ××©×ª××© ××—×•×‘×¨ - ×œ× ×™×›×•×œ ×œ×˜×¢×•×Ÿ ××˜×•×¤×œ×™×');
                return;
            }

            try {
                const response = await fetch('/patients', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ‘¥ ××˜×•×¤×œ×™× × ×˜×¢× ×• ××”×©×¨×ª:', data);
                    
                    // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×” ×¢× ×”× ×ª×•× ×™× ××”×©×¨×ª
                    displayPatientsFromServer(data.patients);
                    
                    // ×¢×“×›×•×Ÿ ××™×“×¢ ××’×‘×œ×•×ª
                    if (data.patient_limits) {
                        updatePatientsLimitFromServer(data.patient_limits);
                    }
                } else {
                    console.log('âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×ª ××˜×•×¤×œ×™× ××”×©×¨×ª');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ××˜×•×¤×œ×™×:', error);
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ××˜×•×¤×œ×™× ××”×©×¨×ª
        function displayPatientsFromServer(patients) {
            const therapistSection = document.getElementById('therapistSection');
            if (!therapistSection) return;

            // ××¦×™××ª ××• ×™×¦×™×¨×ª ××–×•×¨ ×”××˜×•×¤×œ×™×
            let patientsContainer = document.getElementById('serverPatientsContainer');
            if (!patientsContainer) {
                patientsContainer = document.createElement('div');
                patientsContainer.id = 'serverPatientsContainer';
                patientsContainer.innerHTML = `
                    <h3 style="color: #1e293b; margin: 30px 0 20px 0; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;">
                        ğŸ‘¥ ××˜×•×¤×œ×™× ×‘×©×¨×ª
                    </h3>
                    <div id="serverPatientsList" class="patients-list"></div>
                `;
                therapistSection.appendChild(patientsContainer);
            }

            const patientsList = document.getElementById('serverPatientsList');
            patientsList.innerHTML = '';

            if (patients && patients.length > 0) {
                patients.forEach(patient => {
                    const patientCard = document.createElement('div');
                    patientCard.className = 'patient-card';
                    patientCard.style.cursor = 'pointer';
                    patientCard.style.position = 'relative';
                    
                    patientCard.innerHTML = `
                        <button class="delete-patient-btn" onclick="confirmDeleteServerPatient('${patient.name.replace(/'/g, "\\'")}', event)" title="××—×§ ××˜×•×¤×œ">
                            ğŸ—‘ï¸
                        </button>
                        <h3>${patient.name}</h3>
                        <p>×¡×©× ×™×: ${patient.session_count}</p>
                        <small>×œ×—×¥ ×œ×¦×¤×™×™×” ×‘×¡×©× ×™×</small>
                    `;
                    
                    patientCard.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-patient-btn')) {
                            loadPatientSessions(patient.name);
                        }
                    });
                    
                    patientsList.appendChild(patientCard);
                });
                
                patientsContainer.style.display = 'block';
            } else {
                patientsContainer.style.display = 'none';
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×¡×©× ×™× ×©×œ ××˜×•×¤×œ ××”×©×¨×ª
        async function loadPatientSessions(patientName) {
            try {
                const response = await fetch(`/patient/${encodeURIComponent(patientName)}/sessions`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showServerPatientSessions(patientName, data.sessions);
                } else {
                    showStatus('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×©× ×™×', 'error');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×¡×©× ×™×:', error);
                showStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×¡×©× ×™× ××”×©×¨×ª
        function showServerPatientSessions(patientName, sessions) {
            const modal = document.getElementById('sessionsModal');
            const modalTitle = document.getElementById('modalTitle');
            const sessionsList = document.getElementById('sessionsList');
            
            modalTitle.textContent = `×¡×©× ×™× ×©×œ ${patientName} (××”×©×¨×ª)`;
            sessionsList.innerHTML = '';
            
            if (sessions && sessions.length > 0) {
                sessions.forEach((session, index) => {
                    const sessionItem = document.createElement('div');
                    sessionItem.className = 'session-item';
                    sessionItem.style.position = 'relative';
                    sessionItem.innerHTML = `
                        <button class="delete-session-btn" onclick="confirmDeleteServerSession('${patientName.replace(/'/g, "\\'")}', '${session.filename.replace(/'/g, "\\'")}', event)" title="××—×§ ×¡×©×Ÿ">
                            ğŸ—‘ï¸
                        </button>
                        <h4>×¡×©×Ÿ ××ª××¨×™×š ${session.date || '×œ× ×™×“×•×¢'}</h4>
                        <p>××™×œ×™×: ${session.word_count || 0}</p>
                        <p>×§×•×‘×¥ ×©××¢: ${session.audio_filename || '×œ× ×™×“×•×¢'}</p>
                        <small>× ×•×¦×¨: ${session.created_at || '×œ× ×™×“×•×¢'}</small>
                    `;
                    
                    sessionItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-session-btn')) {
                            loadSessionContent(patientName, session.filename);
                        }
                    });
                    
                    sessionsList.appendChild(sessionItem);
                });
            } else {
                sessionsList.innerHTML = '<p style="text-align: center; color: #6b7280;">××™×Ÿ ×¡×©× ×™× ×¢×‘×•×¨ ××˜×•×¤×œ ×–×”</p>';
            }
            
            modal.style.display = 'block';
        }

        // ×¤×•× ×§×¦×™×” ×œ×˜×¢×™× ×ª ×ª×•×›×Ÿ ×¡×©×Ÿ ××”×©×¨×ª
        async function loadSessionContent(patientName, sessionFilename) {
            try {
                const response = await fetch(`/patient/${encodeURIComponent(patientName)}/session/${encodeURIComponent(sessionFilename)}`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const sessionData = await response.json();
                    showServerSessionContent(patientName, sessionData);
                } else {
                    showStatus('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×•×›×Ÿ ×”×¡×©×Ÿ', 'error');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×•×›×Ÿ ×¡×©×Ÿ:', error);
                showStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×ª×•×›×Ÿ ×¡×©×Ÿ ××”×©×¨×ª
        function showServerSessionContent(patientName, sessionData) {
            const modal = document.getElementById('sessionContentModal');
            const title = document.getElementById('sessionContentTitle');
            const body = document.getElementById('sessionContentBody');
            
            title.textContent = `×¡×©×Ÿ ${patientName} - ${sessionData.session_date || '×œ× ×™×“×•×¢'}`;
            
            const transcript = sessionData.corrected_transcript || sessionData.edited_transcript || sessionData.original_transcript || '××™×Ÿ ×ª×•×›×Ÿ';
            
            body.innerHTML = `
                <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                    <h4>×¤×¨×˜×™ ×”×¡×©×Ÿ:</h4>
                    <p><strong>××˜×•×¤×œ:</strong> ${sessionData.patient_name || patientName}</p>
                    <p><strong>×ª××¨×™×š:</strong> ${sessionData.session_date || '×œ× ×™×“×•×¢'}</p>
                    <p><strong>× ×•×¦×¨:</strong> ${sessionData.created_at || '×œ× ×™×“×•×¢'}</p>
                    <p><strong>××™×œ×™×:</strong> ${sessionData.word_count || 0}</p>
                    <p><strong>×§×•×‘×¥ ×©××¢:</strong> ${sessionData.audio_filename || '×œ× ×™×“×•×¢'}</p>
                </div>
                <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb;">
                    <h4>×ª×•×›×Ÿ ×”×¡×©×Ÿ:</h4>
                    <div style="white-space: pre-wrap; line-height: 1.6; direction: rtl;">${transcript}</div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="copySessionText('${transcript.replace(/'/g, "\\'")}')" class="action-btn copy-btn">ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜</button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // ×¤×•× ×§×¦×™×•×ª ××—×™×§×” ××”×©×¨×ª
        function confirmDeleteServerPatient(patientName, event) {
            event.stopPropagation();
            
            const message = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××˜×•×¤×œ "<strong>${patientName}</strong>" ×•×›×œ ×”×¡×©× ×™× ×©×œ×• ××”×©×¨×ª?<br><br>×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`;
            
            showDeleteConfirmModal('××—×™×§×ª ××˜×•×¤×œ ××”×©×¨×ª', message, () => {
                deleteServerPatient(patientName);
            });
        }

        function confirmDeleteServerSession(patientName, sessionFilename, event) {
            event.stopPropagation();
            
            const message = `×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¡×©×Ÿ ×”×–×” ×©×œ "<strong>${patientName}</strong>" ××”×©×¨×ª?<br><br>×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!`;
            
            showDeleteConfirmModal('××—×™×§×ª ×¡×©×Ÿ ××”×©×¨×ª', message, () => {
                deleteServerSession(patientName, sessionFilename);
            });
        }

        // ××—×™×§×ª ××˜×•×¤×œ ××”×©×¨×ª
        async function deleteServerPatient(patientName) {
            try {
                showStatus('××•×—×§ ××˜×•×¤×œ ××”×©×¨×ª...', 'loading');
                
                const response = await fetch(`/patient/${encodeURIComponent(patientName)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus(`âœ… ×”××˜×•×¤×œ "${patientName}" × ××—×§ ××”×©×¨×ª ×‘×”×¦×œ×—×”`, 'success');
                    
                    // ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×”××˜×•×¤×œ×™×
                    await loadPatients();
                    
                    // ×¢×“×›×•×Ÿ ××™×“×¢ ×”××’×‘×œ×•×ª
                    await checkUserLimits();
                    
                    // ×¡×’×™×¨×ª ××•×“×œ×™×
                    closeSessions();
                } else {
                    const error = await response.json();
                    showStatus(`×©×’×™××” ×‘××—×™×§×ª ××˜×•×¤×œ: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘××—×™×§×ª ××˜×•×¤×œ ××”×©×¨×ª:', error);
                showStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ××—×™×§×ª ×¡×©×Ÿ ××”×©×¨×ª
        async function deleteServerSession(patientName, sessionFilename) {
            try {
                showStatus('××•×—×§ ×¡×©×Ÿ ××”×©×¨×ª...', 'loading');
                
                const response = await fetch('/delete-session', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify({
                        patient_name: patientName,
                        session_filename: sessionFilename
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showStatus('âœ… ×”×¡×©×Ÿ × ××—×§ ××”×©×¨×ª ×‘×”×¦×œ×—×”', 'success');
                    
                    // ×¨×¢× ×•×Ÿ ×¨×©×™××ª ×”××˜×•×¤×œ×™×
                    await loadPatients();
                    
                    // ×¢×“×›×•×Ÿ ××™×“×¢ ×”××’×‘×œ×•×ª
                    await checkUserLimits();
                    
                    // ×¨×¢× ×•×Ÿ ××•×“×œ ×”×¡×©× ×™×
                    await loadPatientSessions(patientName);
                } else {
                    const error = await response.json();
                    showStatus(`×©×’×™××” ×‘××—×™×§×ª ×¡×©×Ÿ: ${error.error}`, 'error');
                }
            } catch (error) {
                console.error('×©×’×™××” ×‘××—×™×§×ª ×¡×©×Ÿ ××”×©×¨×ª:', error);
                showStatus('×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×©×¨×ª', 'error');
            }
        }

        // ×¤×•× ×§×¦×™×•×ª ×‘×—×™×¨×ª ××¦×‘ ×§×œ×˜
        function switchInputMode(mode) {
            const audioModeBtn = document.getElementById('audioModeBtn');
            const textModeBtn = document.getElementById('textModeBtn');
            const audioInputSection = document.getElementById('audioInputSection');
            const textInputSection = document.getElementById('textInputSection');
            const whatsappInstructions = document.getElementById('whatsappInstructions');
            const recordingSection = document.getElementById('recordingSection');
            const transcribeBtn = document.getElementById('transcribeBtn');

            if (mode === 'audio') {
                audioModeBtn.classList.add('active');
                textModeBtn.classList.remove('active');
                audioInputSection.style.display = 'block';
                textInputSection.style.display = 'none';
                whatsappInstructions.style.display = 'block';
                recordingSection.style.display = 'block'; // ×”×¦×’×ª ×¡×¢×™×£ ×”×”×§×œ×˜×”
                
                transcribeBtn.textContent = 'ğŸ¯ ×”×ª×—×œ ×ª××œ×•×œ';
                transcribeBtn.disabled = true;
                
            } else if (mode === 'text') {
                audioModeBtn.classList.remove('active');
                textModeBtn.classList.add('active');
                audioInputSection.style.display = 'none';
                textInputSection.style.display = 'block';
                whatsappInstructions.style.display = 'none';
                recordingSection.style.display = 'none'; // ×”×¡×ª×¨×ª ×¡×¢×™×£ ×”×”×§×œ×˜×”
                
                transcribeBtn.textContent = 'ğŸ”§ ×¢×‘×“ ×˜×§×¡×˜';
                transcribeBtn.disabled = false; // ×××¤×©×¨ ×¢×™×‘×•×“ ×˜×§×¡×˜ ××™×“
            }
        }

        // ×‘×“×™×§×ª ××¦×‘ ×”×¦×¤× ×”
        function checkEncryptionMode() {
            const qualityMode = document.getElementById('qualityMode').value;
            const encryptionPasswordSection = document.getElementById('encryptionPasswordSection');
            
            if (qualityMode === 'hybrid-encrypted') {
                encryptionPasswordSection.style.display = 'block';
            } else {
                encryptionPasswordSection.style.display = 'none';
            }
        }

        // ×”×•×¡×¤×ª ×××–×™×Ÿ ×œ×©×™× ×•×™ ××¦×‘ ××™×›×•×ª
        document.addEventListener('DOMContentLoaded', () => {
            const qualityModeSelect = document.getElementById('qualityMode');
            if (qualityModeSelect) {
                qualityModeSelect.addEventListener('change', checkEncryptionMode);
            }
        });

        // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ ××œ× ×©×œ ×©×“×” ×©× ×”××˜×•×¤×œ
        function forceCleanPatientNameField() {
            const patientNameInput = document.getElementById('patientName');
            if (patientNameInput) {
                // × ×™×§×•×™ ××›×œ ×”×›×™×•×•× ×™× ×”××¤×©×¨×™×™×
                patientNameInput.value = '';
                patientNameInput.defaultValue = '';
                patientNameInput.setAttribute('value', '');
                patientNameInput.removeAttribute('data-value');
                
                // × ×™×§×•×™ ××¤×©×¨×™ ×©×œ browser cache
                patientNameInput.autocomplete = 'off';
                patientNameInput.setAttribute('autocomplete', 'new-password'); // ×˜×¨×™×§ ×œ× ×™×§×•×™ cache
                
                // ××™×¨×•×¢ ×œ× ×™×§×•×™ ××•×˜×•××˜×™
                setTimeout(() => {
                    patientNameInput.setAttribute('autocomplete', 'off');
                    patientNameInput.value = '';
                }, 100);
                
                console.log('ğŸ§¹ ×©×“×” ×©× ×”××˜×•×¤×œ × ×•×§×” ×‘×›×•×— - ×¨×™×§ ×œ×—×œ×•×˜×™×Ÿ');
            }
        }

        // ×¤×•× ×§×¦×™×” ×œ× ×™×§×•×™ × ×ª×•× ×™× ×¤×’×•××™×
        function debugAndCleanStorage() {
            if (!currentUser) {
                showStatus('âŒ ××™×Ÿ ××©×ª××© ××—×•×‘×¨', 'error');
                return;
            }

            if (confirm('ğŸ”§ ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ× ×§×•×ª ××ª ×›×œ ×”× ×ª×•× ×™× ×”×¤×’×•××™×?\n\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ×¡×©× ×™× ×¨×™×§×™× ××• ×¤×’×•××™×, ××š ×ª×©××•×¨ ×¢×œ ×¡×©× ×™× ×ª×§×™× ×™×.')) {
                const storageKey = `sessions_${currentUser.email}`;
                let userSessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                const originalCount = userSessions.length;
                
                console.log('ğŸ” ××ª×—×™×œ × ×™×§×•×™ × ×ª×•× ×™× ×¤×’×•××™×...');
                console.log('ğŸ“Š ××¡×¤×¨ ×¡×©× ×™× ×œ×¤× ×™ × ×™×§×•×™:', originalCount);
                
                // × ×™×§×•×™ ×¡×©× ×™× ×¤×’×•××™×
                const cleanedSessions = userSessions.filter(session => {
                    // ×‘×“×™×§×•×ª ×ª×§×™× ×•×ª
                    const hasValidPatientName = session && session.patient_name && session.patient_name.trim() !== '';
                    const hasValidTranscript = session && session.corrected_transcript && session.corrected_transcript.trim() !== '';
                    const hasValidTimestamp = session && session.timestamp;
                    const hasValidDate = session && session.session_date;
                    
                    const isValid = hasValidPatientName && hasValidTranscript && hasValidTimestamp && hasValidDate;
                    
                    if (!isValid) {
                        console.log('ğŸ—‘ï¸ ××•×—×§ ×¡×©×Ÿ ×¤×’×•×:', {
                            patient_name: session?.patient_name || '×—×¡×¨',
                            has_transcript: !!session?.corrected_transcript,
                            has_timestamp: !!session?.timestamp,
                            has_date: !!session?.session_date
                        });
                    }
                    
                    return isValid;
                });
                
                const cleanedCount = cleanedSessions.length;
                const deletedCount = originalCount - cleanedCount;
                
                // ×©××™×¨×” ×—×–×¨×”
                localStorage.setItem(storageKey, JSON.stringify(cleanedSessions));
                
                console.log('âœ… × ×™×§×•×™ ×”×•×©×œ×:');
                console.log('ğŸ“Š ×¡×©× ×™× ×œ×¤× ×™:', originalCount);
                console.log('ğŸ“Š ×¡×©× ×™× ××—×¨×™:', cleanedCount);
                console.log('ğŸ—‘ï¸ ×¡×©× ×™× ×©× ××—×§×•:', deletedCount);
                
                // ×¢×“×›×•×Ÿ ×”×ª×¦×•×’×”
                updateLocalSessionsUI();
                updatePatientsLimitDisplay();
                
                if (deletedCount > 0) {
                    showStatus(`âœ… × ×™×§×•×™ ×”×•×©×œ×! × ××—×§×• ${deletedCount} ×¡×©× ×™× ×¤×’×•××™×, × ×•×ª×¨×• ${cleanedCount} ×¡×©× ×™× ×ª×§×™× ×™×`, 'success');
                } else {
                    showStatus('âœ… ×œ× × ××¦××• × ×ª×•× ×™× ×¤×’×•××™× - ×”×›×œ ×ª×§×™×Ÿ!', 'success');
                }
            }
        }

        // ××ª×—×•×œ ×”××¤×œ×™×§×¦×™×”
        document.addEventListener('DOMContentLoaded', async () => {
            // ×”×’×“×¨×ª ×ª××¨×™×š ×‘×¨×™×¨×ª ××—×“×œ
            const sessionDateInput = document.getElementById('sessionDate');
            if (sessionDateInput) {
                sessionDateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // × ×™×§×•×™ ××œ× ×©×œ ×©×“×” ×©× ×”××˜×•×¤×œ
            forceCleanPatientNameField();
            
            // × ×™×§×•×™ × ×•×¡×£ ××—×¨×™ ×–××Ÿ ×§×¦×¨ (×œ××§×¨×” ×©×œ browser cache)
            setTimeout(() => {
                forceCleanPatientNameField();
            }, 500);
            
            // ×‘×“×™×§×ª ××™××•×ª
            await checkAuth();
            
            // × ×™×§×•×™ × ×•×¡×£ ××—×¨×™ ××™××•×ª
            setTimeout(() => {
                forceCleanPatientNameField();
            }, 1000);
            
            // ×”×•×¡×¤×ª ×××–×™× ×™× ×œ×›×¤×ª×•×¨×™×
            const transcribeBtn = document.getElementById('transcribeBtn');
            if (transcribeBtn) {
                transcribeBtn.addEventListener('click', transcribeAudio);
            }
            
            // ×—×™×‘×•×¨ ×›×¤×ª×•×¨ ×©××™×¨×ª ×¡×©×Ÿ
            const saveBtn = document.getElementById('saveBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveSessionLocally);
            }
            
            // ×˜×¢×™× ×ª ×¡×©× ×™× ××§×•××™×™× ×§×™×™××™×
            updateLocalSessionsUI();
            
            console.log('âœ… ×”××¤×œ×™×§×¦×™×” ××•×ª×—×œ×” ×‘×”×¦×œ×—×”');
        });
    </script>
</body>
</html>
