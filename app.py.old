# app.py - ××¢×¨×›×ª ×ª××œ×•×œ ×œ××˜×¤×œ×™× ×¢× Transkriptor
from flask import Flask, request, render_template, jsonify, send_from_directory
import os
import datetime
import json
from werkzeug.utils import secure_filename
import tempfile
import socket
import re
import requests
import hashlib
import base64
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from dotenv import load_dotenv
from treatment_form_generator import TreatmentFormGenerator
from auth_manager import AuthManager, require_auth, require_auth_html, require_session_limit_check

# ×™×™×‘×•× ××•×ª× ×” ×©×œ ×× ×”×œ×™ ×”×¦×¤× ×” ×•×¡× ×›×¨×•×Ÿ
try:
    from encryption_manager import EncryptionManager
    ENCRYPTION_AVAILABLE = True
except ImportError as e:
    print(f"âš ï¸ ×× ×”×œ ×”×¦×¤× ×” ×œ× ×–××™×Ÿ: {e}")
    EncryptionManager = None
    ENCRYPTION_AVAILABLE = False

try:
    from cloud_sync_manager import CloudSyncManager
    SYNC_AVAILABLE = True
except ImportError as e:
    print(f"âš ï¸ ×× ×”×œ ×¡× ×›×¨×•×Ÿ ×œ× ×–××™×Ÿ: {e}")
    CloudSyncManager = None
    SYNC_AVAILABLE = False

# ×˜×¢×™× ×ª ××©×ª× ×™ ×¡×‘×™×‘×” ××§×•×‘×¥ .env
load_dotenv()

# ×‘×“×™×§×ª ××¢×¨×›×ª ××™××•×ª ×œ×¤× ×™ ×”×¤×¢×œ×ª ×”××¤×œ×™×§×¦×™×”
print("ğŸ” ××›×™×Ÿ ××¢×¨×›×ª ××™××•×ª...")
print("âœ… ××¢×¨×›×ª ××™××•×ª ××•×›× ×” - ××¤×¢×™×œ ××ª ×”××¤×œ×™×§×¦×™×”...")

app = Flask(__name__)

# ×”×’×“×¨×•×ª ××§×•×‘×¥ .env
app.config['UPLOAD_FOLDER'] = os.getenv('UPLOAD_FOLDER', 'uploads')
app.config['TRANSCRIPTS_FOLDER'] = os.getenv('TRANSCRIPTS_FOLDER', 'transcripts')
app.config['MAX_CONTENT_LENGTH'] = int(os.getenv('MAX_FILE_SIZE_MB', '100')) * 1024 * 1024
app.config['DEBUG'] = os.getenv('DEBUG', 'False').lower() == 'true'

# ×™×¦×™×¨×ª ×ª×™×§×™×•×ª
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)
os.makedirs(app.config['TRANSCRIPTS_FOLDER'], exist_ok=True)


# ×”×’×“×¨×•×ª AssemblyAI ××§×•×‘×¥ .env (××¢×•×œ×” ×œ×¢×‘×¨×™×ª)
ASSEMBLYAI_API_KEY = os.getenv('ASSEMBLYAI_API_KEY', '')
ASSEMBLYAI_API_URL = "https://api.assemblyai.com/v2"

# ×”×’×“×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ ××§×•×‘×¥ .env
DEFAULT_LANGUAGE = os.getenv('DEFAULT_LANGUAGE', 'he')
DEFAULT_TRANSCRIPTION_SERVICE = os.getenv('DEFAULT_TRANSCRIPTION_SERVICE', 'transkriptor')
WHISPER_MODEL_SIZE = os.getenv('WHISPER_MODEL_SIZE', 'base')
FASTER_WHISPER_COMPUTE_TYPE = os.getenv('FASTER_WHISPER_COMPUTE_TYPE', 'int8')
FASTER_WHISPER_DEVICE = os.getenv('FASTER_WHISPER_DEVICE', 'cpu')

# ×™×¦×™×¨×ª ××—×•×œ×œ ×˜×•×¤×¡ ×˜×™×¤×•×œ
treatment_generator = TreatmentFormGenerator()

# ×¤×•× ×§×¦×™×•×ª ×”×¦×¤× ×” ×•××‘×˜×—×”
def generate_user_key(patient_name, session_date):
    """×™×¦×™×¨×ª ××¤×ª×— ×”×¦×¤× ×” ×™×™×—×•×“×™ ×œ××˜×•×¤×œ ×•×¡×©×Ÿ"""
    # ×™×¦×™×¨×ª ××¤×ª×— ×‘×¡×™×¡ ××”××˜×•×¤×œ ×•×”×ª××¨×™×š
    base_string = f"{patient_name}_{session_date}_{os.getenv('ENCRYPTION_SALT', 'default_salt')}"
    
    # ×™×¦×™×¨×ª ××¤×ª×— ×—×–×§
    password = base_string.encode('utf-8')
    salt = hashlib.sha256(password).digest()[:16]  # 16 bytes salt
    
    kdf = PBKDF2HMAC(
        algorithm=hashes.SHA256(),
        length=32,
        salt=salt,
        iterations=100000,
    )
    key = base64.urlsafe_b64encode(kdf.derive(password))
    return key

def encrypt_file(file_path, user_key):
    """×”×¦×¤× ×ª ×§×•×‘×¥ ×©××¢ ×œ×¤× ×™ ×©×œ×™×—×” ×œ×¢× ×Ÿ"""
    try:
        print("ğŸ” ××¦×¤×™×Ÿ ×§×•×‘×¥ ×œ×¤× ×™ ×©×œ×™×—×”...")
        
        # ×§×¨×™××ª ×”×§×•×‘×¥
        with open(file_path, 'rb') as f:
            file_data = f.read()
        
        # ×™×¦×™×¨×ª ××¦×¤×™×Ÿ
        fernet = Fernet(user_key)
        
        # ×”×¦×¤× ×ª ×”× ×ª×•× ×™×
        encrypted_data = fernet.encrypt(file_data)
        
        # ×™×¦×™×¨×ª ×§×•×‘×¥ ××•×¦×¤×Ÿ ×–×× ×™
        encrypted_file_path = file_path + '.encrypted'
        with open(encrypted_file_path, 'wb') as f:
            f.write(encrypted_data)
        
        print("âœ… ×§×•×‘×¥ ×”×•×¦×¤×Ÿ ×‘×”×¦×œ×—×”")
        return encrypted_file_path
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×”×¦×¤× ×ª ×§×•×‘×¥: {str(e)}")
        raise Exception(f"×©×’×™××” ×‘×”×¦×¤× ×”: {str(e)}")

def decrypt_file(encrypted_file_path, user_key, output_path):
    """×¤×¢× ×•×— ×§×•×‘×¥ ××•×¦×¤×Ÿ"""
    try:
        print("ğŸ”“ ××¤×¢× ×— ×§×•×‘×¥...")
        
        # ×§×¨×™××ª ×”×§×•×‘×¥ ×”××•×¦×¤×Ÿ
        with open(encrypted_file_path, 'rb') as f:
            encrypted_data = f.read()
        
        # ×™×¦×™×¨×ª ××¤×¢× ×—
        fernet = Fernet(user_key)
        
        # ×¤×¢× ×•×— ×”× ×ª×•× ×™×
        decrypted_data = fernet.decrypt(encrypted_data)
        
        # ×©××™×¨×ª ×”×§×•×‘×¥ ×”××¤×•×¢× ×—
        with open(output_path, 'wb') as f:
            f.write(decrypted_data)
        
        print("âœ… ×§×•×‘×¥ ×¤×•×¢× ×— ×‘×”×¦×œ×—×”")
        return output_path
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×¤×¢× ×•×— ×§×•×‘×¥: {str(e)}")
        raise Exception(f"×©×’×™××” ×‘×¤×¢× ×•×—: {str(e)}")

def secure_delete_file(file_path):
    """××—×™×§×” ×××•×‘×˜×—×ª ×©×œ ×§×•×‘×¥"""
    try:
        if not os.path.exists(file_path):
            return True
            
        print(f"ğŸ—‘ï¸ ××•×—×§ ×‘×¦×•×¨×” ×××•×‘×˜×—×ª: {os.path.basename(file_path)}")
        
        # ×§×‘×œ×ª ×’×•×“×œ ×”×§×•×‘×¥
        file_size = os.path.getsize(file_path)
        
        # ×“×¨×™×¡×ª ×”×§×•×‘×¥ ×‘××¡×¤×¨ ××¢×‘×¨×™×
        with open(file_path, 'r+b') as f:
            # ××¢×‘×¨ 1: ×“×¨×™×¡×” ×‘××¤×¡×™×
            f.write(b'\x00' * file_size)
            f.flush()
            os.fsync(f.fileno())
            
            # ××¢×‘×¨ 2: ×“×¨×™×¡×” ×‘× ×ª×•× ×™× ××§×¨××™×™×
            f.seek(0)
            f.write(os.urandom(file_size))
            f.flush()
            os.fsync(f.fileno())
            
            # ××¢×‘×¨ 3: ×“×¨×™×¡×” ×‘××—×“×™×
            f.seek(0)
            f.write(b'\xFF' * file_size)
            f.flush()
            os.fsync(f.fileno())
        
        # ××—×™×§×ª ×”×§×•×‘×¥
        os.unlink(file_path)
        print("âœ… ×§×•×‘×¥ × ××—×§ ×‘×¦×•×¨×” ×××•×‘×˜×—×ª")
        return True
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘××—×™×§×” ×××•×‘×˜×—×ª: {str(e)}")
        return False

def delete_from_assemblyai(transcript_id):
    """××—×™×§×ª ×ª××œ×•×œ ×-AssemblyAI (×× ×™×© API ×œ××—×™×§×”)"""
    try:
        if not ASSEMBLYAI_API_KEY:
            return True
            
        print("ğŸ—‘ï¸ ××•×—×§ × ×ª×•× ×™× ×-AssemblyAI...")
        
        # AssemblyAI ×œ× ××¡×¤×§ API ×œ××—×™×§×” ×™×©×™×¨×”
        # ××‘×œ ×”× ××•×—×§×™× ××•×˜×•××˜×™×ª ××—×¨×™ 30 ×™×•×
        # ×›××Ÿ × ×•×›×œ ×œ×”×•×¡×™×£ ×‘×§×©×” ×œ××—×™×§×” ××™×™×“×™×ª ×× ×™×”×™×” API ×›×–×”
        
        print("â„¹ï¸ AssemblyAI ××•×—×§ × ×ª×•× ×™× ××•×˜×•××˜×™×ª ××—×¨×™ 30 ×™×•×")
        return True
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘××—×™×§×” ×-AssemblyAI: {str(e)}")
        return False

def generate_temp_encryption_key():
    """×™×¦×™×¨×ª ××¤×ª×— ×”×¦×¤× ×” ×–×× ×™ ×—×–×§"""
    try:
        # ×™×¦×™×¨×ª ××¤×ª×— ××§×¨××™ ×—×–×§
        random_data = os.urandom(32)  # 256 bits
        timestamp = str(datetime.datetime.now().timestamp()).encode('utf-8')
        
        # ×©×™×œ×•×‘ ×¢× ×—×•×ª××ª ×–××Ÿ
        combined_data = random_data + timestamp
        
        # ×™×¦×™×¨×ª ××¤×ª×— PBKDF2
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=32,
            salt=os.urandom(16),
            iterations=100000,
        )
        key = base64.urlsafe_b64encode(kdf.derive(combined_data))
        
        print("ğŸ”‘ ××¤×ª×— ×”×¦×¤× ×” ×–×× ×™ × ×•×¦×¨")
        return key
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×™×¦×™×¨×ª ××¤×ª×— ×”×¦×¤× ×”: {str(e)}")
        raise Exception(f"×©×’×™××” ×‘×™×¦×™×¨×ª ××¤×ª×—: {str(e)}")

def encrypt_audio_data(audio_data, encryption_key):
    """×”×¦×¤× ×ª × ×ª×•× ×™ ×©××¢ ×‘×–×™×›×¨×•×Ÿ"""
    try:
        print("ğŸ” ××¦×¤×™×Ÿ × ×ª×•× ×™ ×©××¢...")
        
        # ×™×¦×™×¨×ª ××¦×¤×™×Ÿ
        fernet = Fernet(encryption_key)
        
        # ×”×¦×¤× ×ª ×”× ×ª×•× ×™×
        encrypted_data = fernet.encrypt(audio_data)
        
        print(f"âœ… × ×ª×•× ×™ ×©××¢ ×”×•×¦×¤× ×• ({len(encrypted_data)} bytes)")
        return encrypted_data
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×”×¦×¤× ×ª × ×ª×•× ×™ ×©××¢: {str(e)}")
        raise Exception(f"×©×’×™××” ×‘×”×¦×¤× ×”: {str(e)}")

def decrypt_audio_data(encrypted_data, encryption_key):
    """×¤×¢× ×•×— × ×ª×•× ×™ ×©××¢ ××•×¦×¤× ×™×"""
    try:
        print("ğŸ”“ ××¤×¢× ×— × ×ª×•× ×™ ×©××¢...")
        
        # ×™×¦×™×¨×ª ××¤×¢× ×—
        fernet = Fernet(encryption_key)
        
        # ×¤×¢× ×•×— ×”× ×ª×•× ×™×
        decrypted_data = fernet.decrypt(encrypted_data)
        
        print(f"âœ… × ×ª×•× ×™ ×©××¢ ×¤×•×¢× ×—×• ({len(decrypted_data)} bytes)")
        return decrypted_data
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×¤×¢× ×•×— × ×ª×•× ×™ ×©××¢: {str(e)}")
        raise Exception(f"×©×’×™××” ×‘×¤×¢× ×•×—: {str(e)}")

def secure_memory_wipe(data):
    """××—×™×§×” ×××•×‘×˜×—×ª ×©×œ × ×ª×•× ×™× ××”×–×™×›×¨×•×Ÿ"""
    try:
        if isinstance(data, bytes):
            # ×“×¨×™×¡×ª ×”× ×ª×•× ×™× ×‘×–×™×›×¨×•×Ÿ
            for i in range(len(data)):
                data = data[:i] + b'\x00' + data[i+1:]
        elif isinstance(data, str):
            # ×”××¨×” ×œbytes ×•×“×¨×™×¡×”
            data_bytes = data.encode('utf-8')
            for i in range(len(data_bytes)):
                data_bytes = data_bytes[:i] + b'\x00' + data_bytes[i+1:]
        
        print("ğŸ§¹ ×–×™×›×¨×•×Ÿ × ×•×§×” ×‘×¦×•×¨×” ×××•×‘×˜×—×ª")
        return True
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘× ×™×§×•×™ ×–×™×›×¨×•×Ÿ: {str(e)}")
        return False

def log_privacy_action(action, patient_name, details=""):
    """×¨×™×©×•× ×¤×¢×•×œ×•×ª ×¤×¨×˜×™×•×ª ×œ×‘×™×§×•×¨×ª"""
    try:
        log_entry = {
            "timestamp": datetime.datetime.now().isoformat(),
            "action": action,
            "patient_name": patient_name,
            "details": details,
            "ip_hash": hashlib.sha256(request.remote_addr.encode()).hexdigest()[:8] if request else "unknown"
        }
        
        # ×™×¦×™×¨×ª ×ª×™×§×™×™×ª ×œ×•×’×™×
        logs_folder = os.path.join(app.config['TRANSCRIPTS_FOLDER'], '_privacy_logs')
        os.makedirs(logs_folder, exist_ok=True)
        
        # ×©××™×¨×ª ×”×œ×•×’
        log_file = os.path.join(logs_folder, f"privacy_log_{datetime.datetime.now().strftime('%Y-%m')}.json")
        
        # ×§×¨×™××ª ×œ×•×’×™× ×§×™×™××™× ××• ×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”
        if os.path.exists(log_file):
            with open(log_file, 'r', encoding='utf-8') as f:
                logs = json.load(f)
        else:
            logs = []
        
        # ×”×•×¡×¤×ª ×”×œ×•×’ ×”×—×“×©
        logs.append(log_entry)
        
        # ×©××™×¨×ª ×”×œ×•×’×™×
        with open(log_file, 'w', encoding='utf-8') as f:
            json.dump(logs, f, ensure_ascii=False, indent=2)
            
        print(f"ğŸ“ ×¤×¢×•×œ×ª ×¤×¨×˜×™×•×ª × ×¨×©××”: {action}")
        
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×¨×™×©×•× ×¤×¢×•×œ×ª ×¤×¨×˜×™×•×ª: {str(e)}")


def transcribe_with_faster_whisper(audio_file_path, language=None):
    """×ª××œ×•×œ ×¢× Faster-Whisper Large V3 + ××•×¤×˜×™××™×–×¦×™×” ×œ×¢×‘×¨×™×ª"""
    if language is None:
        language = DEFAULT_LANGUAGE
        
    try:
        from faster_whisper import WhisperModel
        print(f"××©×ª××© ×‘-Faster-Whisper ×¢× ××•×“×œ {WHISPER_MODEL_SIZE}...")
        
        # ×˜×¢×™× ×ª ××•×“×œ (×¨×§ ×¤×¢× ××—×ª) ×¢× ×”×’×“×¨×•×ª ××§×•×‘×¥ .env
        if not hasattr(transcribe_with_faster_whisper, 'model'):
            print(f"ğŸ”„ ×˜×•×¢×Ÿ ××•×“×œ Whisper {WHISPER_MODEL_SIZE} (×™×™×§×— ×–××Ÿ ×‘×¤×¢× ×”×¨××©×•× ×”)...")
            transcribe_with_faster_whisper.model = WhisperModel(
                WHISPER_MODEL_SIZE, 
                device=FASTER_WHISPER_DEVICE, 
                compute_type=FASTER_WHISPER_COMPUTE_TYPE
            )
            print("âœ… ××•×“×œ × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!")
        
        # ×ª××œ×•×œ ×¢× ×”×’×“×¨×•×ª ××•×ª×××•×ª ×œ×¢×‘×¨×™×ª
        segments, info = transcribe_with_faster_whisper.model.transcribe(
            audio_file_path, 
            language=language,
            beam_size=5,
            best_of=5,
            temperature=0.0,
            condition_on_previous_text=False  # ×˜×•×‘ ×™×•×ª×¨ ×œ×¢×‘×¨×™×ª
        )
        
        # ×—×™×‘×•×¨ ×›×œ ×”×¡×’×× ×˜×™× ×œ×˜×§×¡×˜ ××—×“
        text = " ".join([segment.text for segment in segments])
        
        # ×ª×™×§×•× ×™× ×¡×¤×¦×™×¤×™×™× ×œ×¢×‘×¨×™×ª
        text = advanced_hebrew_cleanup(text)
        
        # ×§×‘×™×¢×ª ×¨××ª ×‘×™×˜×—×•×Ÿ ×œ×¤×™ ×”××•×“×œ
        confidence = 0.90 if WHISPER_MODEL_SIZE.startswith('large') else 0.85 if WHISPER_MODEL_SIZE == 'medium' else 0.8
        
        return {
            'text': text.strip(),
            'confidence': confidence
        }
    except ImportError:
        raise Exception("Faster-Whisper ×œ× ××•×ª×§×Ÿ")
    except Exception as e:
        raise Exception(f"×©×’×™××” ×‘×ª××œ×•×œ ×¢× Faster-Whisper: {str(e)}")

def transcribe_with_ivrit_ai(audio_file_path, language=None):
    """×ª××œ×•×œ ×¢× ××•×“×œ ivrit.ai ×”××•×ª×× ×‘××™×•×—×“ ×œ×¢×‘×¨×™×ª"""
    if language is None:
        language = 'he'  # ivrit.ai ××•×ª×× ×œ×¢×‘×¨×™×ª
        
    try:
        import requests
        print("××©×ª××© ×‘×©×¨×ª ivrit.ai ××§×•××™...")
        
        # ×‘×“×™×§×” ×× ×”×©×¨×ª ×”××§×•××™ ×¤×•×¢×œ
        try:
            health_response = requests.get('http://localhost:8000/health', timeout=2)
            if health_response.status_code == 200:
                print("ğŸŒ ×©×¨×ª ivrit.ai ××§×•××™ ×–××™×Ÿ - ××©×ª××© ×‘×•")
                return transcribe_with_ivrit_ai_server(audio_file_path, language)
        except:
            print("âš ï¸ ×©×¨×ª ivrit.ai ××§×•××™ ×œ× ×–××™×Ÿ - ×¢×•×‘×¨ ×œ××•×“×œ ×™×©×™×¨")
        
        # ×’×™×‘×•×™ - ×©×™××•×© ×‘××•×“×œ ×™×©×™×¨
        import ivrit
        print("××©×ª××© ×‘××•×“×œ ivrit.ai ×™×©×™×¨...")
        
        # ×˜×¢×™× ×ª ××•×“×œ (×¨×§ ×¤×¢× ××—×ª)
        if not hasattr(transcribe_with_ivrit_ai, 'model'):
            print("ğŸ”„ ×˜×•×¢×Ÿ ××•×“×œ ivrit.ai (×™×™×§×— ×–××Ÿ ×‘×¤×¢× ×”×¨××©×•× ×”)...")
            transcribe_with_ivrit_ai.model = ivrit.load_model(
                engine='faster-whisper', 
                model='ivrit-ai/whisper-large-v3-ct2',
                device='cpu'
            )
            print("âœ… ××•×“×œ ivrit.ai × ×˜×¢×Ÿ ×‘×”×¦×œ×—×”!")
        
        # ×ª××œ×•×œ
        result = transcribe_with_ivrit_ai.model.transcribe(
            path=audio_file_path, 
            language=language
        )
        
        # ×—×™×œ×•×¥ ×”×˜×§×¡×˜
        text = result.get('text', '').strip()
        
        # ×ª×™×§×•× ×™× × ×•×¡×¤×™× ×œ×¢×‘×¨×™×ª (×”××•×“×œ ×›×‘×¨ ××•×ª×× ××‘×œ × ×•×¡×™×£ ×¢×•×“ ×ª×™×§×•× ×™×)
        text = advanced_hebrew_cleanup(text)
        
        return {
            'text': text,
            'confidence': 0.95  # ××•×“×œ ××•×ª×× ×‘××™×•×—×“ ×œ×¢×‘×¨×™×ª
        }
    except ImportError:
        raise Exception("ivrit.ai ×œ× ××•×ª×§×Ÿ")
    except Exception as e:
        raise Exception(f"×©×’×™××” ×‘×ª××œ×•×œ ×¢× ivrit.ai: {str(e)}")

def transcribe_with_ivrit_ai_server(audio_file_path, language=None):
    """×ª××œ×•×œ ×‘×××¦×¢×•×ª ×©×¨×ª ivrit.ai ××§×•××™"""
    if language is None:
        language = 'he'
        
    try:
        import requests
        
        # ×©×œ×™×—×ª ×§×•×‘×¥ ×œ×©×¨×ª ×”××§×•××™
        with open(audio_file_path, 'rb') as audio_file:
            files = {'audio': audio_file}
            data = {
                'model': 'ivrit-ai/whisper-large-v3-turbo-ct2',  # ×”××•×“×œ ×”××”×™×¨ ×™×•×ª×¨
                'language': language
            }
            
            print("ğŸ“¡ ×©×•×œ×— ×œ×©×¨×ª ivrit.ai ××§×•××™...")
            response = requests.post(
                'http://localhost:8000/transcribe',
                files=files,
                data=data,
                timeout=300  # 5 ×“×§×•×ª timeout
            )
            
            if response.status_code == 200:
                result = response.json()
                text = result.get('text', '').strip()
                
                # ×ª×™×§×•× ×™× × ×•×¡×¤×™× ×œ×¢×‘×¨×™×ª
                text = advanced_hebrew_cleanup(text)
                
                return {
                    'text': text,
                    'confidence': 0.95
                }
            else:
                raise Exception(f"×©×’×™××” ×‘×©×¨×ª: {response.status_code} - {response.text}")
                
    except Exception as e:
        raise Exception(f"×©×’×™××” ×‘×ª××œ×•×œ ×¢× ×©×¨×ª ivrit.ai: {str(e)}")

def transcribe_with_assemblyai(audio_file_path, language='he'):
    """×ª××œ×•×œ ×‘×××¦×¢×•×ª AssemblyAI SDK - ××¢×•×œ×” ×œ×¢×‘×¨×™×ª"""
    if not ASSEMBLYAI_API_KEY or ASSEMBLYAI_API_KEY == 'your-assemblyai-api-key-here':
        raise Exception("×—×¡×¨ API Key ×©×œ AssemblyAI. ×™×© ×œ×”×’×“×™×¨ ASSEMBLYAI_API_KEY ×‘×§×•×‘×¥ .env")
    
    try:
        import assemblyai as aai
        
        print("×©×•×œ×— ×§×•×‘×¥ ×œ-AssemblyAI ×¢× SDK...")
        print(f"API Key ××ª×—×™×œ ×‘: {ASSEMBLYAI_API_KEY[:10]}...")
        
        # ×‘×“×™×§×ª ×’×•×“×œ ×§×•×‘×¥
        file_size = os.path.getsize(audio_file_path)
        print(f"×’×•×“×œ ×§×•×‘×¥: {file_size / (1024*1024):.2f} MB")
        
        # AssemblyAI ×ª×•××š ×‘×§×‘×¦×™× ×’×“×•×œ×™× ×™×•×ª×¨
        if file_size > 100 * 1024 * 1024:  # 100MB
            raise Exception(f"×§×•×‘×¥ ×’×“×•×œ ××“×™ ×¢×‘×•×¨ AssemblyAI - {file_size / (1024*1024):.1f}MB (××§×¡×™××•× 100MB)")
        
        # ×”×’×“×¨×ª API Key
        aai.settings.api_key = ASSEMBLYAI_API_KEY
        
        # ×”×’×“×¨×ª ×§×•× ×¤×™×’×•×¨×¦×™×” ×œ×¢×‘×¨×™×ª
        config = aai.TranscriptionConfig(
            language_code='he',  # ×¢×‘×¨×™×ª
            punctuate=True,
            format_text=True,
            speaker_labels=False,  # ×œ×œ× ×–×™×”×•×™ ×“×•×‘×¨×™× ×œ×‘×™×¦×•×¢×™× ×˜×•×‘×™× ×™×•×ª×¨
            speech_model=aai.SpeechModel.best  # ×”××•×“×œ ×”×˜×•×‘ ×‘×™×•×ª×¨
        )
        
        print("××ª×—×™×œ ×ª××œ×•×œ ×¢× AssemblyAI SDK...")
        transcriber = aai.Transcriber(config=config)
        transcript = transcriber.transcribe(audio_file_path)
        
        if transcript.status == aai.TranscriptStatus.error:
            raise Exception(f"×©×’×™××” ×‘×ª××œ×•×œ: {transcript.error}")
        
        print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× AssemblyAI!")
        return {
            'text': transcript.text.strip() if transcript.text else '',
            'confidence': transcript.confidence if hasattr(transcript, 'confidence') else 0.9
        }
        
    except ImportError:
        raise Exception("AssemblyAI SDK ×œ× ××•×ª×§×Ÿ. ×”×¨×¥: pip install assemblyai")
    except Exception as e:
        print(f"×©×’×™××” ×‘×ª××œ×•×œ ×¢× AssemblyAI: {str(e)}")
        raise e

def transcribe_with_whisper_fallback(audio_file_path, language=None):
    """×ª××œ×•×œ ×¢× Whisper ×¨×’×™×œ ×›×’×™×‘×•×™"""
    if language is None:
        language = DEFAULT_LANGUAGE
        
    try:
        import whisper
        print("××©×ª××© ×‘-Whisper ×¨×’×™×œ...")
        model = whisper.load_model(WHISPER_MODEL_SIZE)
        result = model.transcribe(audio_file_path, language=language, temperature=0.0)
        return {
            'text': result["text"].strip(),
            'confidence': 0.7
        }
    except ImportError:
        raise Exception("Whisper ×œ× ××•×ª×§×Ÿ")
    except Exception as e:
        raise Exception(f"×©×’×™××” ×‘×ª××œ×•×œ ×¢× Whisper: {str(e)}")

ALLOWED_EXTENSIONS = {'wav', 'mp3', 'mp4', 'm4a', 'webm', 'ogg', 'opus'}

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def get_patient_folder(patient_name, user_id=None):
    # × ×™×§×•×™ ×©× ×”××˜×•×¤×œ ×ª×•×š ×©××™×¨×” ×¢×œ ×¢×‘×¨×™×ª
    safe_name = patient_name.strip()
    if not safe_name:
        safe_name = "unnamed_patient"
    
    # ×”×¡×¨×ª ×ª×•×•×™× ×‘×¢×™×™×ª×™×™× ×œ×©××•×ª ×ª×™×§×™×•×ª ××š ×©××™×¨×” ×¢×œ ×¢×‘×¨×™×ª
    forbidden_chars = ['<', '>', ':', '"', '/', '\\', '|', '?', '*']
    for char in forbidden_chars:
        safe_name = safe_name.replace(char, '_')
    
    # ×”×¡×¨×ª × ×§×•×“×•×ª ×‘×¡×•×£ (×‘×¢×™×™×ª×™ ×‘-Windows)
    safe_name = safe_name.rstrip('.')
    
    # ×•×™×“×•× ×©×”×©× ×œ× ×¨×™×§ ××—×¨×™ ×”× ×™×§×•×™
    if not safe_name:
        safe_name = "unnamed_patient"
    
    # ×™×¦×™×¨×ª ×ª×™×§×™×™×” ×™×™×—×•×“×™×ª ×œ×›×œ ××©×ª××©
    if user_id:
        user_folder = os.path.join(app.config['TRANSCRIPTS_FOLDER'], f'user_{user_id}')
        os.makedirs(user_folder, exist_ok=True)
        patient_folder = os.path.join(user_folder, safe_name)
    else:
        # ×ª××™××•×ª ×œ××—×•×¨ - ×× ××™×Ÿ user_id
        patient_folder = os.path.join(app.config['TRANSCRIPTS_FOLDER'], safe_name)
    
    os.makedirs(patient_folder, exist_ok=True)
    return patient_folder

def advanced_hebrew_cleanup(text):
    """×ª×™×§×•× ×™× ××ª×§×“××™× ×œ×¢×‘×¨×™×ª - ××•×ª×× ×œ-Whisper Large V3"""
    # ×ª×™×§×•× ×™ ×›×¤×™×œ×•×™×•×ª × ×¤×•×¦×•×ª ×‘×¢×‘×¨×™×ª
    hebrew_duplicates = {
        '×× ×™ ×× ×™': '×× ×™',
        '×›×Ÿ ×›×Ÿ': '×›×Ÿ',
        '×œ× ×œ×': '×œ×',
        '××” ××”': '××”',
        '××™×š ××™×š': '××™×š',
        '×›××™×œ×• ×›××™×œ×•': '×›××™×œ×•',
        '×‘×¡×“×¨ ×‘×¡×“×¨': '×‘×¡×“×¨',
        '×˜×•×‘ ×˜×•×‘': '×˜×•×‘',
        '××•×§×™×™ ××•×§×™×™': '××•×§×™×™',
        '× ×›×•×Ÿ × ×›×•×Ÿ': '× ×›×•×Ÿ',
        '×‘×“×™×•×§ ×‘×“×™×•×§': '×‘×“×™×•×§',
        '×××¨ ×××¨': '×××¨',
        '×××¨×” ×××¨×”': '×××¨×”',
        '×¨×•×¦×” ×¨×•×¦×”': '×¨×•×¦×”',
        '×¦×¨×™×š ×¦×¨×™×š': '×¦×¨×™×š',
        '×™×•×“×¢ ×™×•×“×¢': '×™×•×“×¢',
        '×—×•×©×‘ ×—×•×©×‘': '×—×•×©×‘',
        '××¨×’×™×© ××¨×’×™×©': '××¨×’×™×©'
    }
    
    # ×ª×™×§×•× ×™ ××™×œ×•×ª ××™×œ×•×™
    filler_words = {
        '×× ××': '××',
        '××” ××”': '××”',
        '××××': '××',
        '××”×”×”': '××”',
        'mm hmm': '×××',
        'uhh': '××”',
        'umm': '××',
        'eh': '××”'
    }
    
    # ×ª×™×§×•× ×™ ×©×’×™××•×ª × ×¤×•×¦×•×ª ×©×œ Whisper ×‘×¢×‘×¨×™×ª
    common_errors = {
        '×× ×™ ×× ×™ ×¨×•×¦×”': '×× ×™ ×¨×•×¦×”',
        '×–×” ×–×”': '×–×”',
        '×©×œ ×©×œ': '×©×œ',
        '×¢×œ ×¢×œ': '×¢×œ',
        '×¢× ×¢×': '×¢×',
        '××ª ××ª': '××ª',
        '××œ ××œ': '××œ',
        '×›×œ ×›×œ': '×›×œ',
        '×’× ×’×': '×’×',
        '××• ××•': '××•',
        '××‘×œ ××‘×œ': '××‘×œ',
        '×›×™ ×›×™': '×›×™',
        '×©×–×” ×©×–×”': '×©×–×”',
        '×©×× ×™ ×©×× ×™': '×©×× ×™'
    }
    
    # ×”×—×œ×ª ×ª×™×§×•× ×™×
    for wrong, correct in hebrew_duplicates.items():
        text = text.replace(wrong, correct)
    
    for wrong, correct in filler_words.items():
        text = text.replace(wrong, correct)
    
    for wrong, correct in common_errors.items():
        text = text.replace(wrong, correct)
    
    # × ×™×§×•×™ ×¨×•×•×—×™× ××™×•×ª×¨×™×
    text = re.sub(r'\s+', ' ', text)
    text = text.strip()
    
    return text

def simple_text_cleanup(text):
    """×ª×™×§×•×Ÿ ×‘×¡×™×¡×™ ×©×œ ×˜×§×¡×˜ - × ×©××¨ ×œ×ª××™××•×ª ×œ××—×•×¨"""
    return advanced_hebrew_cleanup(text)

def save_transcript(patient_name, transcript_data, session_date=None, user_id=None):
    if not session_date:
        session_date = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
    
    patient_folder = get_patient_folder(patient_name, user_id)
    transcript_filename = f"session_{session_date}.json"
    transcript_path = os.path.join(patient_folder, transcript_filename)
    
    with open(transcript_path, 'w', encoding='utf-8') as f:
        json.dump(transcript_data, f, ensure_ascii=False, indent=2)
    
    return transcript_path

@app.route('/')
def index():
    # Allow access to main page without authentication
    # The frontend will handle showing appropriate content based on auth status
    return render_template('index.html')

@app.route('/app')
def app_page():
    # App page - requires authentication (handled by frontend)
    return render_template('app.html')

@app.route('/feedback')
def feedback_page():
    # Feedback page - public access
    # No authentication required - accessible to all users including guests
    return render_template('feedback.html')

@app.route('/how-it-works')
def how_it_works_page():
    # How it works page - public access
    # No authentication required - accessible to all users including guests
    return render_template('how-it-works.html')

@app.route('/static/<filename>')
def static_files(filename):
    return send_from_directory('static', filename)

@app.route('/transcribe', methods=['POST'])
@require_auth
def transcribe_audio():
    try:
        if 'audio' not in request.files:
            return jsonify({'error': '×œ× × ×‘×—×¨ ×§×•×‘×¥ ×©××¢'}), 400
        
        audio_file = request.files['audio']
        patient_name = request.form.get('patient_name', '').strip()
        session_date = request.form.get('session_date', '')
        quality_mode = request.form.get('quality_mode', 'balanced')
        
        # ×× ×œ× ×”×•×–×Ÿ ×©× ××˜×•×¤×œ, ×”×—×–×¨ ×©×’×™××”
        if not patient_name:
            return jsonify({'error': '×™×© ×œ×”×–×™×Ÿ ×©× ××˜×•×¤×œ'}), 400
        
        if audio_file.filename == '':
            return jsonify({'error': '×œ× × ×‘×—×¨ ×§×•×‘×¥'}), 400
        
        if not allowed_file(audio_file.filename):
            return jsonify({'error': '×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š'}), 400
        
        # ×¨×™×©×•× ×¤×¢×•×œ×ª ×¤×¨×˜×™×•×ª - ×”×ª×—×œ×ª ×ª××œ×•×œ
        log_privacy_action("transcription_start", patient_name, f"×”×ª×—×œ×ª ×ª××œ×•×œ ×××•×‘×˜×— ×¢× {quality_mode}")
        
        # ×©××™×¨×ª ×§×•×‘×¥ ×–×× ×™ ××•×¦×¤×Ÿ - ××‘×˜×—×” ××§×¡×™××œ×™×ª
        file_extension = os.path.splitext(audio_file.filename)[1] or '.wav'
        temp_path = None
        encrypted_path = None
        
        try:
            print(f"ğŸ” ××ª×—×™×œ ×ª××œ×•×œ ×××•×‘×˜×— ×¢×‘×•×¨ {patient_name}...")
            
            # ×™×¦×™×¨×ª ××¤×ª×— ×”×¦×¤× ×” ×–×× ×™ ×™×™×—×•×“×™
            temp_key = generate_temp_encryption_key()
            
            # ×§×¨×™××ª ×”×§×•×‘×¥ ×œ×–×™×›×¨×•×Ÿ
            audio_data = audio_file.read()
            print(f"ğŸ“Š ×’×•×“×œ ×§×•×‘×¥: {len(audio_data) / (1024*1024):.2f} MB")
            
            # ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™ ××•×¦×¤×Ÿ
            with tempfile.NamedTemporaryFile(delete=False, suffix=file_extension) as temp_file:
                # ×”×¦×¤× ×ª ×”× ×ª×•× ×™× ×œ×¤× ×™ ×©××™×¨×”
                encrypted_data = encrypt_audio_data(audio_data, temp_key)
                temp_file.write(encrypted_data)
                temp_file.flush()
                os.fsync(temp_file.fileno())  # ×•×™×“×•× ×©××™×¨×” ×œ×“×™×¡×§
                encrypted_path = temp_file.name
            
            # ×¤×¢× ×•×— ×œ×§×•×‘×¥ ×–×× ×™ ×œ×ª××œ×•×œ
            with tempfile.NamedTemporaryFile(delete=False, suffix=file_extension) as temp_file:
                decrypted_data = decrypt_audio_data(encrypted_data, temp_key)
                temp_file.write(decrypted_data)
                temp_file.flush()
                os.fsync(temp_file.fileno())
                temp_path = temp_file.name
            
            # ××—×™×§×” ×××•×‘×˜×—×ª ×©×œ ×”×§×•×‘×¥ ×”××•×¦×¤×Ÿ ××™×“
            secure_delete_file(encrypted_path)
            encrypted_path = None
            
            print(f"âœ… ×§×•×‘×¥ ×”×•×›×Ÿ ×œ×ª××œ×•×œ ×××•×‘×˜×—")
            
            # ×‘×—×™×¨×ª ×©×™×¨×•×ª ×ª××œ×•×œ ×œ×¤×™ ×”×‘×—×™×¨×” ×©×œ ×”××©×ª××©
            if quality_mode == 'ivrit-ai':
                # ivrit.ai - ××•×“×œ ××•×ª×× ×‘××™×•×—×“ ×œ×¢×‘×¨×™×ª
                try:
                    result = transcribe_with_ivrit_ai(temp_path, language='he')
                    original_text = result["text"].strip()
                    transcription_method = "ivrit.ai (××•×ª×× ×œ×¢×‘×¨×™×ª)"
                    print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× ivrit.ai")
                except Exception as ivrit_error:
                    print(f"×©×’×™××” ×‘-ivrit.ai: {str(ivrit_error)}")
                    print("×× ×¡×” ×¢× Faster-Whisper ×›×’×™×‘×•×™...")
                    try:
                        result = transcribe_with_faster_whisper(temp_path, language='he')
                        original_text = result["text"].strip()
                        transcription_method = "Faster-Whisper (×’×™×‘×•×™)"
                        print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× Faster-Whisper")
                    except Exception as faster_whisper_error:
                        return jsonify({'error': f'×©×’×™××” ×‘×ª××œ×•×œ: ivrit.ai - {str(ivrit_error)}, Faster-Whisper - {str(faster_whisper_error)}'}), 500
                        
            elif quality_mode == 'faster-whisper':
                # Faster-Whisper (××§×•××™ ××”×™×¨)
                try:
                    result = transcribe_with_faster_whisper(temp_path, language='he')
                    original_text = result["text"].strip()
                    transcription_method = "Faster-Whisper"
                    print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× Faster-Whisper")
                except Exception as faster_whisper_error:
                    print(f"×©×’×™××” ×‘-Faster-Whisper: {str(faster_whisper_error)}")
                    print("×× ×¡×” ×¢× Whisper ×¨×’×™×œ ×›×’×™×‘×•×™...")
                    try:
                        result = transcribe_with_whisper_fallback(temp_path, language='he')
                        original_text = result["text"].strip()
                        transcription_method = "Whisper (×’×™×‘×•×™)"
                        print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× Whisper ×¨×’×™×œ")
                    except Exception as whisper_error:
                        return jsonify({'error': f'×©×’×™××” ×‘×ª××œ×•×œ: Faster-Whisper - {str(faster_whisper_error)}, Whisper - {str(whisper_error)}'}), 500
                        
            elif quality_mode == 'assemblyai':
                # AssemblyAI ×¢× ×”×¦×¤× ×”
                try:
                    # ×™×¦×™×¨×ª ××¤×ª×— ×”×¦×¤× ×” ×™×™×—×•×“×™
                    user_key = generate_user_key(patient_name, session_date or datetime.datetime.now().strftime("%Y-%m-%d"))
                    
                    # ×¨×™×©×•× ×¤×¢×•×œ×ª ×¤×¨×˜×™×•×ª
                    log_privacy_action("encryption_start", patient_name, f"××ª×—×™×œ ×”×¦×¤× ×” ×œ×¤× ×™ ×©×œ×™×—×” ×œ-AssemblyAI")
                    
                    # ×”×¦×¤× ×ª ×”×§×•×‘×¥
                    encrypted_path = encrypt_file(temp_path, user_key)
                    
                    try:
                        # ×¤×¢× ×•×— ×”×§×•×‘×¥ ×œ×ª××œ×•×œ (AssemblyAI ×¦×¨×™×š ×§×•×‘×¥ ×œ× ××•×¦×¤×Ÿ)
                        decrypted_path = temp_path + '.decrypted'
                        decrypt_file(encrypted_path, user_key, decrypted_path)
                        
                        # ×ª××œ×•×œ ×¢× ×”×§×•×‘×¥ ×”××¤×•×¢× ×—
                        result = transcribe_with_assemblyai(decrypted_path, language='he')
                        original_text = result["text"].strip()
                        transcription_method = "AssemblyAI (××•×¦×¤×Ÿ)"
                        
                        # ××—×™×§×” ×××•×‘×˜×—×ª ×©×œ ×”×§×•×‘×¥ ×”××¤×•×¢× ×—
                        secure_delete_file(decrypted_path)
                        
                        # ×¨×™×©×•× ×”×©×œ××ª ×”×ª××œ×•×œ
                        log_privacy_action("transcription_complete", patient_name, f"×ª××œ×•×œ ×”×•×©×œ× ×¢× AssemblyAI, ×§×‘×¦×™× × ××—×§×•")
                        
                        print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× AssemblyAI (××•×¦×¤×Ÿ)")
                        
                    finally:
                        # ××—×™×§×” ×××•×‘×˜×—×ª ×©×œ ×”×§×•×‘×¥ ×”××•×¦×¤×Ÿ
                        secure_delete_file(encrypted_path)
                        
                except Exception as assemblyai_error:
                    log_privacy_action("encryption_error", patient_name, f"×©×’×™××” ×‘×”×¦×¤× ×”/×ª××œ×•×œ: {str(assemblyai_error)}")
                    return jsonify({'error': f'×©×’×™××” ×‘-AssemblyAI: {str(assemblyai_error)}'}), 500
                    
            elif quality_mode == 'whisper':
                # ×¨×§ Whisper ×¨×’×™×œ
                try:
                    result = transcribe_with_whisper_fallback(temp_path, language='he')
                    original_text = result["text"].strip()
                    transcription_method = "Whisper"
                    print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× Whisper")
                except Exception as whisper_error:
                    return jsonify({'error': f'×©×’×™××” ×‘-Whisper: {str(whisper_error)}'}), 500
                    
            else:  # ×‘×¨×™×¨×ª ××—×“×œ - AssemblyAI
                # ×‘×¨×™×¨×ª ××—×“×œ AssemblyAI
                try:
                    result = transcribe_with_assemblyai(temp_path, language='he')
                    original_text = result["text"].strip()
                    transcription_method = "AssemblyAI"
                    print("×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× AssemblyAI")
                except Exception as assemblyai_error:
                    return jsonify({'error': f'×©×’×™××” ×‘-AssemblyAI: {str(assemblyai_error)}'}), 500
            
            if not original_text:
                return jsonify({'error': '×œ× ×–×•×”×” ×˜×§×¡×˜ ×‘×§×•×‘×¥ ×”×©××¢'}), 400
            
            # ×ª×™×§×•×Ÿ ×‘×¡×™×¡×™
            corrected_text = simple_text_cleanup(original_text)
            corrections_made = ["×ª×™×§×•×Ÿ ×‘×¡×™×¡×™ ×©×œ ×˜×§×¡×˜"] if corrected_text != original_text else []
            
            # ×¨×™×©×•× ×”×©×œ××ª ×”×ª××œ×•×œ
            log_privacy_action("transcription_complete", patient_name, f"×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢× {transcription_method}")
            
            # ×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× ×—×™× ××™×™× (×¨×§ ×× ×–×” ×œ× ×× ×•×™ ×‘×ª×©×œ×•×)
            user_id = request.current_user['user_id']
            auth_manager = AuthManager()
            
            # ×‘×“×™×§×” ×× ×”××©×ª××© ×‘×× ×•×™ ×—×™× ××™
            if request.session_status['status'] == 'trial':
                auth_manager.increment_free_session(user_id)
                print(f"âœ… ××•× ×” ×¡×©× ×™× ×—×™× ××™×™× ×¢×•×“×›×Ÿ ×¢×‘×•×¨ ××©×ª××© {user_id}")
            
            print(f"âœ… ×ª××œ×•×œ ×”×•×©×œ× ×‘×”×¦×œ×—×” ×¢×‘×•×¨ {patient_name}")
            
            return jsonify({
                'success': True,
                'original_transcript': original_text,
                'corrected_transcript': corrected_text,
                'corrections_made': corrections_made,
                'patient_name': patient_name,
                'session_date': session_date if session_date else datetime.datetime.now().strftime("%Y-%m-%d"),
                'audio_filename': audio_file.filename,
                'quality_mode': quality_mode,
                'word_count': len(corrected_text.split()),
                'session_info': {
                    'sessions_used': request.session_status['sessions_used'] + (1 if request.session_status['status'] == 'trial' else 0),
                    'sessions_limit': request.session_status['sessions_limit'],
                    'status': request.session_status['status']
                }
            })
            
        finally:
            # ××—×™×§×” ×××•×‘×˜×—×ª ×©×œ ×›×œ ×”×§×‘×¦×™× ×”×–×× ×™×™×
            if temp_path and os.path.exists(temp_path):
                print("ğŸ—‘ï¸ ××•×—×§ ×§×•×‘×¥ ×–×× ×™ ×××•×‘×˜×—...")
                secure_delete_file(temp_path)
            
            if encrypted_path and os.path.exists(encrypted_path):
                print("ğŸ—‘ï¸ ××•×—×§ ×§×•×‘×¥ ××•×¦×¤×Ÿ ×–×× ×™...")
                secure_delete_file(encrypted_path)
            
            # × ×™×§×•×™ ×–×™×›×¨×•×Ÿ ×××•×‘×˜×—
            if 'audio_data' in locals():
                secure_memory_wipe(audio_data)
            if 'encrypted_data' in locals():
                secure_memory_wipe(encrypted_data)
            if 'decrypted_data' in locals():
                secure_memory_wipe(decrypted_data)
            if 'temp_key' in locals():
                secure_memory_wipe(temp_key)
            
            # ×¨×™×©×•× ×¡×™×•× ×××•×‘×˜×—
            log_privacy_action("secure_cleanup", patient_name, "× ×™×§×•×™ ×××•×‘×˜×— ×©×œ ×›×œ ×”×§×‘×¦×™× ×•×”×–×™×›×¨×•×Ÿ ×”×•×©×œ×")
    
    except Exception as e:
        print(f"×©×’×™××” ×‘×ª××œ×•×œ: {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘×¢×™×‘×•×“: {str(e)}'}), 500

@app.route('/share-target', methods=['POST'])
def share_target():
    """×§×‘×œ×ª ×§×‘×¦×™× ××©×•×ª×¤×™× ×××¤×œ×™×§×¦×™×•×ª ××—×¨×•×ª"""
    try:
        import tempfile
        import base64
        from flask import redirect
        
        # ×‘×“×™×§×” ×× ×™×© ×§×•×‘×¥ ×©××¢
        if 'audio' in request.files:
            audio_file = request.files['audio']
            if audio_file.filename != '':
                print(f"×§×•×‘×¥ ×©××¢ ×”×ª×§×‘×œ ×“×¨×š Share: {audio_file.filename}")
                
                # ×©××™×¨×ª ×”×§×•×‘×¥ ×–×× ×™×ª ×•×™×¦×™×¨×ª data URL
                file_data = audio_file.read()
                file_type = audio_file.content_type or 'audio/opus'
                
                # ×™×¦×™×¨×ª data URL
                file_base64 = base64.b64encode(file_data).decode('utf-8')
                data_url = f"data:{file_type};base64,{file_base64}"
                
                # ×”×—×–×¨×ª ×“×£ ×¢× ×”×§×•×‘×¥ ××•×˜××¢
                return render_template('share_received.html', 
                                     filename=audio_file.filename,
                                     data_url=data_url,
                                     file_type=file_type)
        
        # ×‘×“×™×§×” ×× ×™×© URL ××©×•×ª×£
        url = request.form.get('url', '')
        if url:
            print(f"URL ×”×ª×§×‘×œ ×“×¨×š Share: {url}")
            return redirect(f'/?shared_url={url}')
        
        # ×× ××™×Ÿ ×§×•×‘×¥ ××• URL, ×¤×©×•×˜ ×¤×ª×— ××ª ×”××¤×œ×™×§×¦×™×”
        return redirect('/#app')
        
    except Exception as e:
        print(f"×©×’×™××” ×‘×§×‘×œ×ª ×§×•×‘×¥ ××©×•×ª×£: {e}")
        return redirect('/#app')

@app.route('/patients')
@require_auth
def get_patients():
    try:
        user_id = request.current_user['user_id']
        patients = []
        
        # ×‘×“×™×§×ª ×ª×™×§×™×™×ª ×”××©×ª××© ×”×¡×¤×¦×™×¤×™
        user_folder = os.path.join(app.config['TRANSCRIPTS_FOLDER'], f'user_{user_id}')
        
        if os.path.exists(user_folder):
            for patient_folder in os.listdir(user_folder):
                patient_path = os.path.join(user_folder, patient_folder)
                if os.path.isdir(patient_path):
                    session_count = len([f for f in os.listdir(patient_path) if f.endswith('.json')])
                    patients.append({
                        'name': patient_folder,
                        'session_count': session_count
                    })
        
        # ×”×•×¡×¤×ª ××™×“×¢ ×¢×œ ××’×‘×œ×•×ª
        auth_manager = AuthManager()
        can_add_patient, current_patients, max_patients, status = auth_manager.check_free_patient_limit(user_id)
        
        return jsonify({
            'patients': patients,
            'patient_limits': {
                'can_add_patient': can_add_patient,
                'current_patients': current_patients,
                'max_patients': max_patients,
                'status': status
            }
        })
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/patient/<patient_name>/sessions')
def get_patient_sessions(patient_name):
    try:
        patient_folder = get_patient_folder(patient_name)
        sessions = []
        
        if os.path.exists(patient_folder):
            for filename in os.listdir(patient_folder):
                if filename.endswith('.json'):
                    filepath = os.path.join(patient_folder, filename)
                    with open(filepath, 'r', encoding='utf-8') as f:
                        session_data = json.load(f)
                        sessions.append({
                            'filename': filename,
                            'date': session_data.get('session_date'),
                            'created_at': session_data.get('created_at'),
                            'word_count': session_data.get('word_count', 0),
                            'audio_filename': session_data.get('audio_filename')
                        })
        
        sessions.sort(key=lambda x: x['created_at'], reverse=True)
        return jsonify({'sessions': sessions})
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/patient/<patient_name>/session/<session_filename>')
def get_session_content(patient_name, session_filename):
    try:
        patient_folder = get_patient_folder(patient_name)
        session_path = os.path.join(patient_folder, session_filename)
        
        if not os.path.exists(session_path):
            return jsonify({'error': '×¡×©×Ÿ ×œ× × ××¦×'}), 404
        
        with open(session_path, 'r', encoding='utf-8') as f:
            session_data = json.load(f)
        
        # ×ª××™×›×” ×‘×¤×•×¨××˜×™× ×™×©× ×™× ×•×—×“×©×™×
        if 'original_transcript' not in session_data and 'transcript' in session_data:
            session_data['original_transcript'] = session_data['transcript']
            session_data['corrected_transcript'] = session_data.get('edited_transcript', session_data['transcript'])
        
        return jsonify(session_data)
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/correct-text', methods=['POST'])
def correct_text_manually():
    try:
        data = request.json
        text = data.get('text', '').strip()
        
        if not text:
            return jsonify({'error': '×œ× × ×©×œ×— ×˜×§×¡×˜ ×œ×ª×™×§×•×Ÿ'}), 400
        
        corrected_text = simple_text_cleanup(text)
        corrections_made = ["×ª×™×§×•×Ÿ ×‘×¡×™×¡×™ ×©×œ ×˜×§×¡×˜"] if corrected_text != text else []
        
        return jsonify({
            'success': True,
            'original_text': text,
            'corrected_text': corrected_text,
            'corrections_made': corrections_made,
            'changes_count': len(corrections_made)
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×ª×™×§×•×Ÿ: {str(e)}'}), 500

@app.route('/generate-treatment-form', methods=['POST'])
def generate_treatment_form():
    """×™×¦×™×¨×ª ×˜×•×¤×¡ ×˜×™×¤×•×œ ××§×¦×•×¢×™ ××˜×§×¡×˜ ××ª×•××œ×œ"""
    try:
        data = request.json
        transcript_text = data.get('transcript_text', '').strip()
        patient_name = data.get('patient_name', '').strip()
        session_date = data.get('session_date', '')
        therapist_name = data.get('therapist_name', '').strip()
        
        if not transcript_text:
            return jsonify({'error': '×œ× × ×©×œ×— ×˜×§×¡×˜ ×œ× ×™×ª×•×—'}), 400
        
        if not patient_name:
            return jsonify({'error': '×™×© ×œ×”×–×™×Ÿ ×©× ××˜×•×¤×œ'}), 400
        
        print(f"×™×•×¦×¨ ×˜×•×¤×¡ ×˜×™×¤×•×œ ×¢×‘×•×¨ {patient_name}...")
        
        # ×™×¦×™×¨×ª ×”×˜×•×¤×¡ ×”××§×¦×•×¢×™
        treatment_form = treatment_generator.generate_treatment_form(
            transcript_text=transcript_text,
            patient_name=patient_name,
            session_date=session_date,
            therapist_name=therapist_name
        )
        
        # ×™×¦×™×¨×ª HTML ××¢×•×¦×‘
        html_form = treatment_generator.format_treatment_form_html(treatment_form)
        
        # ×™×¦×™×¨×ª ×˜×§×¡×˜ ××•×‘× ×” ×œ×™×™×¦×•×
        text_form = treatment_generator.export_to_word_format(treatment_form)
        
        print(f"×˜×•×¤×¡ ×˜×™×¤×•×œ × ×•×¦×¨ ×‘×”×¦×œ×—×” ×¢×‘×•×¨ {patient_name}")
        
        return jsonify({
            'success': True,
            'treatment_form': treatment_form,
            'html_form': html_form,
            'text_form': text_form,
            'confidence_score': treatment_form['analysis_confidence'],
            'patient_name': patient_name
        })
        
    except Exception as e:
        print(f"×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×¤×¡ ×˜×™×¤×•×œ: {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×¤×¡: {str(e)}'}), 500

@app.route('/patient/<patient_name>/session/<session_filename>/treatment-form')
def get_session_treatment_form(patient_name, session_filename):
    """×™×¦×™×¨×ª ×˜×•×¤×¡ ×˜×™×¤×•×œ ××¡×©×Ÿ ×§×™×™×"""
    try:
        patient_folder = get_patient_folder(patient_name)
        session_path = os.path.join(patient_folder, session_filename)
        
        if not os.path.exists(session_path):
            return jsonify({'error': '×¡×©×Ÿ ×œ× × ××¦×'}), 404
        
        with open(session_path, 'r', encoding='utf-8') as f:
            session_data = json.load(f)
        
        # ×—×™×œ×•×¥ ×”×˜×§×¡×˜ ×”××ª×•××œ×œ
        transcript_text = session_data.get('corrected_transcript') or \
                         session_data.get('edited_transcript') or \
                         session_data.get('original_transcript') or \
                         session_data.get('transcript', '')
        
        if not transcript_text:
            return jsonify({'error': '×œ× × ××¦× ×˜×§×¡×˜ ××ª×•××œ×œ ×‘×¡×©×Ÿ'}), 400
        
        # ×™×¦×™×¨×ª ×”×˜×•×¤×¡
        treatment_form = treatment_generator.generate_treatment_form(
            transcript_text=transcript_text,
            patient_name=session_data.get('patient_name', patient_name),
            session_date=session_data.get('session_date', ''),
            therapist_name=''
        )
        
        # ×™×¦×™×¨×ª HTML ××¢×•×¦×‘
        html_form = treatment_generator.format_treatment_form_html(treatment_form)
        
        # ×™×¦×™×¨×ª ×˜×§×¡×˜ ××•×‘× ×” ×œ×™×™×¦×•×
        text_form = treatment_generator.export_to_word_format(treatment_form)
        
        return jsonify({
            'success': True,
            'treatment_form': treatment_form,
            'html_form': html_form,
            'text_form': text_form,
            'confidence_score': treatment_form['analysis_confidence'],
            'session_info': {
                'patient_name': session_data.get('patient_name'),
                'session_date': session_data.get('session_date'),
                'audio_filename': session_data.get('audio_filename'),
                'word_count': session_data.get('word_count')
            }
        })
        
    except Exception as e:
        print(f"×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×¤×¡ ×˜×™×¤×•×œ ××¡×©×Ÿ: {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘×™×¦×™×¨×ª ×˜×•×¤×¡: {str(e)}'}), 500

@app.route('/patient/<patient_name>', methods=['DELETE'])
@require_auth
def delete_patient(patient_name):
    """××—×™×§×ª ××˜×•×¤×œ ×•×›×œ ×”×¡×©× ×™× ×©×œ×•"""
    try:
        import shutil
        
        user_id = request.current_user['user_id']
        patient_folder = get_patient_folder(patient_name, user_id)
        
        if not os.path.exists(patient_folder):
            return jsonify({'error': '××˜×•×¤×œ ×œ× × ××¦×'}), 404
        
        # ×¡×¤×™×¨×ª ×”×¡×©× ×™× ×œ×¤× ×™ ×”××—×™×§×”
        session_files = [f for f in os.listdir(patient_folder) if f.endswith('.json')]
        deleted_sessions_count = len(session_files)
        
        # ××—×™×§×ª ×›×œ ×”×ª×™×§×™×™×” ×©×œ ×”××˜×•×¤×œ
        shutil.rmtree(patient_folder)
        
        # ×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× ×—×™× ××™×™× (×”×¤×—×ª×” ×œ×¤×™ ×›××•×ª ×”×¡×©× ×™× ×©× ××—×§×•)
        auth_manager = AuthManager()
        
        # ×‘×“×™×§×” ×× ×”××©×ª××© ×‘×× ×•×™ ×—×™× ××™
        can_create, sessions_used, sessions_limit, status = auth_manager.check_free_session_limit(user_id)
        if status == 'trial' and deleted_sessions_count > 0:
            # ×”×¤×—×ª×ª ×”××•× ×” ×œ×¤×™ ×›××•×ª ×”×¡×©× ×™× ×©× ××—×§×•
            for i in range(deleted_sessions_count):
                success = auth_manager.decrement_free_session(user_id)
                if success:
                    print(f"âœ… ××•× ×” ×¡×©× ×™× ×—×™× ××™×™× ×”×•×¤×—×ª ×¢×‘×•×¨ ××©×ª××© {user_id} (×¡×©×Ÿ {i + 1}/{deleted_sessions_count})")
                else:
                    print(f"âš ï¸ ×©×’×™××” ×‘×”×¤×—×ª×ª ××•× ×” ×¡×©× ×™× ×¢×‘×•×¨ ××©×ª××© {user_id} (×¡×©×Ÿ {i + 1}/{deleted_sessions_count})")
        
        print(f"××˜×•×¤×œ '{patient_name}' × ××—×§ ×‘×”×¦×œ×—×” ×¢× {deleted_sessions_count} ×¡×©× ×™×")
        
        # ×§×‘×œ×ª ×”××¦×‘ ×”××¢×•×“×›×Ÿ
        can_create_updated, sessions_used_updated, sessions_limit_updated, status_updated = auth_manager.check_free_session_limit(user_id)
        
        return jsonify({
            'success': True,
            'message': f'×”××˜×•×¤×œ "{patient_name}" ×•×›×œ {deleted_sessions_count} ×”×¡×©× ×™× ×©×œ×• × ××—×§×• ×‘×”×¦×œ×—×”',
            'deleted_sessions_count': deleted_sessions_count,
            'session_info': {
                'sessions_used': sessions_used_updated,
                'sessions_limit': sessions_limit_updated,
                'status': status_updated,
                'can_create_new': can_create_updated
            }
        })
        
    except Exception as e:
        print(f"×©×’×™××” ×‘××—×™×§×ª ××˜×•×¤×œ '{patient_name}': {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘××—×™×§×ª ××˜×•×¤×œ: {str(e)}'}), 500

@app.route('/check-existing-session', methods=['POST'])
def check_existing_session():
    """×‘×“×™×§×” ×× ×§×™×™× ×¡×©×Ÿ ×‘××•×ª×• ×ª××¨×™×š"""
    try:
        data = request.json
        patient_name = data.get('patient_name', '').strip()
        session_date = data.get('session_date', '').strip()
        
        if not patient_name or not session_date:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        patient_folder = get_patient_folder(patient_name)
        session_filename = f"session_{session_date}.json"
        session_path = os.path.join(patient_folder, session_filename)
        
        if os.path.exists(session_path):
            # ×§×™×™× ×¡×©×Ÿ ×‘××•×ª×• ×ª××¨×™×š
            with open(session_path, 'r', encoding='utf-8') as f:
                existing_session = json.load(f)
            
            return jsonify({
                'exists': True,
                'existing_session': {
                    'date': existing_session.get('session_date'),
                    'created_at': existing_session.get('created_at'),
                    'word_count': existing_session.get('word_count', 0),
                    'audio_filename': existing_session.get('audio_filename')
                }
            })
        else:
            return jsonify({'exists': False})
            
    except Exception as e:
        print(f"×©×’×™××” ×‘×‘×“×™×§×ª ×¡×©×Ÿ ×§×™×™×: {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘×‘×“×™×§×”: {str(e)}'}), 500

@app.route('/save-edited-text', methods=['POST'])
@require_auth
def save_edited_text():
    """×©××™×¨×ª ×¡×©×Ÿ ×—×“×© ×¢× ×”×˜×§×¡×˜ ×”×¢×¨×•×š"""
    try:
        data = request.json
        patient_name = data.get('patient_name', '').strip()
        edited_text = data.get('edited_text', '').strip()
        original_transcript = data.get('original_transcript', '').strip()
        corrected_transcript = data.get('corrected_transcript', '').strip()
        session_date = data.get('session_date', '').strip()
        audio_filename = data.get('audio_filename', '').strip()
        quality_mode = data.get('quality_mode', 'assemblyai')
        replace_existing = data.get('replace_existing', False)
        
        if not patient_name or not edited_text:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        # ×‘×“×™×§×” ×× ×–×” ××˜×•×¤×œ ×—×“×©
        user_folder = os.path.join(app.config['TRANSCRIPTS_FOLDER'], f'user_{user_id}')
        patient_folder = os.path.join(user_folder, patient_name)
        is_new_patient = not os.path.exists(patient_folder)
        
        # ×× ×–×” ××˜×•×¤×œ ×—×“×©, ×‘×“×•×§ ××’×‘×œ×•×ª
        if is_new_patient:
            can_add_patient, current_patients, max_patients, status = auth_manager.check_free_patient_limit(user_id)
            if not can_add_patient and status == 'limit_reached':
                return jsonify({
                    'error': '×”×’×¢×ª ×œ××’×‘×œ×ª ×”××˜×•×¤×œ×™× ×”×—×™× ××™×™×',
                    'message': '×‘×× ×•×™ ×”×—×™× ××™ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××˜×•×¤×œ ××—×“ ×‘×œ×‘×“. ×›×“×™ ×œ×”×•×¡×™×£ ××˜×•×¤×œ×™× × ×•×¡×¤×™×, ×™×© ×œ×©×“×¨×’ ×œ×× ×•×™ ×‘×ª×©×œ×•×',
                    'current_patients': current_patients,
                    'max_patients': max_patients,
                    'subscription_required': True,
                    'upgrade_url': '/subscription/upgrade'
                }), 402  # Payment Required
        
        # ×™×¦×™×¨×ª × ×ª×•× ×™ ×”×¡×©×Ÿ ×”×—×“×©
        transcript_data = {
            "patient_name": patient_name,
            "session_date": session_date if session_date else datetime.datetime.now().strftime("%Y-%m-%d"),
            "audio_filename": audio_filename,
            "original_transcript": original_transcript,
            "corrected_transcript": corrected_transcript,
            "edited_transcript": edited_text,
            "created_at": datetime.datetime.now().isoformat(),
            "word_count": len(edited_text.split()),
            "quality_mode": quality_mode
        }
        
        # ×‘×“×™×§×” ×× ×¦×¨×™×š ×œ×”×—×œ×™×£ ×§×™×™× ××• ×œ×™×¦×•×¨ ×—×“×©
        if replace_existing:
            # ×”×—×œ×¤×ª ×”×¡×©×Ÿ ×”×§×™×™×
            transcript_path = save_transcript(patient_name, transcript_data, session_date, user_id)
            message = '×”×¡×©×Ÿ ×”×•×—×œ×£ ×‘×”×¦×œ×—×”'
        else:
            # ×™×¦×™×¨×ª ×¡×©×Ÿ ×—×“×© ×¢× ×—×•×ª××ª ×–××Ÿ
            current_time = datetime.datetime.now().strftime("%Y-%m-%d_%H-%M-%S")
            transcript_path = save_transcript(patient_name, transcript_data, current_time, user_id)
            message = '×¡×©×Ÿ ×—×“×© × ×•×¦×¨ ×‘×”×¦×œ×—×”'
        
        print(f"×¡×©×Ÿ × ×©××¨ ×‘×”×¦×œ×—×” ×¢×‘×•×¨ {patient_name}")
        
        return jsonify({
            'success': True,
            'message': message,
            'word_count': len(edited_text.split()),
            'transcript_path': os.path.basename(transcript_path)
        })
        
    except Exception as e:
        print(f"×©×’×™××” ×‘×©××™×¨×ª ×¡×©×Ÿ: {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘×©××™×¨×”: {str(e)}'}), 500

@app.route('/check-patient-limit', methods=['POST'])
@require_auth
def check_patient_limit():
    """×‘×“×™×§×ª ××’×‘×œ×ª ××˜×•×¤×œ×™× ×œ×¤× ×™ ×™×¦×™×¨×ª ××˜×•×¤×œ ×—×“×©"""
    try:
        data = request.json
        patient_name = data.get('patient_name', '').strip()
        
        if not patient_name:
            return jsonify({'error': '×—×¡×¨ ×©× ××˜×•×¤×œ'}), 400
        
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        # ×‘×“×™×§×” ×× ×”××˜×•×¤×œ ×›×‘×¨ ×§×™×™×
        user_folder = os.path.join(app.config['TRANSCRIPTS_FOLDER'], f'user_{user_id}')
        patient_folder = os.path.join(user_folder, patient_name)
        patient_exists = os.path.exists(patient_folder)
        
        if patient_exists:
            # ×”××˜×•×¤×œ ×›×‘×¨ ×§×™×™× - ××™×Ÿ ×¦×•×¨×š ×‘×‘×“×™×§×ª ××’×‘×œ×”
            return jsonify({
                'can_create': True,
                'patient_exists': True,
                'message': '×”××˜×•×¤×œ ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª'
            })
        
        # ×‘×“×™×§×ª ××’×‘×œ×ª ××˜×•×¤×œ×™× ×—×“×©×™×
        can_add_patient, current_patients, max_patients, status = auth_manager.check_free_patient_limit(user_id)
        
        if not can_add_patient and status == 'limit_reached':
            return jsonify({
                'can_create': False,
                'patient_exists': False,
                'error': '×”×’×¢×ª ×œ××’×‘×œ×ª ×”××˜×•×¤×œ×™× ×”×—×™× ××™×™×',
                'message': '×‘×× ×•×™ ×”×—×™× ××™ × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ××˜×•×¤×œ ××—×“ ×‘×œ×‘×“. ×›×“×™ ×œ×”×•×¡×™×£ ××˜×•×¤×œ×™× × ×•×¡×¤×™×, ×™×© ×œ×©×“×¨×’ ×œ×× ×•×™ ×‘×ª×©×œ×•×',
                'current_patients': current_patients,
                'max_patients': max_patients,
                'subscription_required': True,
                'upgrade_url': '/subscription/upgrade'
            })
        
        return jsonify({
            'can_create': True,
            'patient_exists': False,
            'current_patients': current_patients,
            'max_patients': max_patients,
            'status': status,
            'message': '× ×™×ª×Ÿ ×œ×™×¦×•×¨ ××˜×•×¤×œ ×—×“×©'
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×‘×“×™×§×ª ××’×‘×œ×ª ××˜×•×¤×œ×™×: {str(e)}'}), 500

@app.route('/delete-session', methods=['DELETE'])
@require_auth
def delete_session():
    """××—×™×§×ª ×¡×©×Ÿ ×•×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™×"""
    try:
        data = request.json
        patient_name = data.get('patient_name', '').strip()
        session_filename = data.get('session_filename', '').strip()
        
        if not patient_name or not session_filename:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        user_id = request.current_user['user_id']
        patient_folder = get_patient_folder(patient_name, user_id)
        session_path = os.path.join(patient_folder, session_filename)
        
        if not os.path.exists(session_path):
            return jsonify({'error': '×¡×©×Ÿ ×œ× × ××¦×'}), 404
        
        # ××—×™×§×ª ×”×¡×©×Ÿ
        os.remove(session_path)
        
        # ×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× ×—×™× ××™×™× (×”×¤×—×ª×”) - ×¨×§ ×× ×–×” ×× ×•×™ ×—×™× ××™
        auth_manager = AuthManager()
        
        # ×‘×“×™×§×” ×× ×”××©×ª××© ×‘×× ×•×™ ×—×™× ××™
        can_create, sessions_used, sessions_limit, status = auth_manager.check_free_session_limit(user_id)
        if status == 'trial':
            success = auth_manager.decrement_free_session(user_id)
            if success:
                print(f"âœ… ××•× ×” ×¡×©× ×™× ×—×™× ××™×™× ×”×•×¤×—×ª ×¢×‘×•×¨ ××©×ª××© {user_id} (×”×™×”: {sessions_used}, ×¢×›×©×™×•: {sessions_used - 1})")
            else:
                print(f"âš ï¸ ×©×’×™××” ×‘×”×¤×—×ª×ª ××•× ×” ×¡×©× ×™× ×¢×‘×•×¨ ××©×ª××© {user_id}")
        
        print(f"×¡×©×Ÿ × ××—×§ ×‘×”×¦×œ×—×”: {session_filename} ×¢×‘×•×¨ {patient_name}")
        
        # ×§×‘×œ×ª ×”××¦×‘ ×”××¢×•×“×›×Ÿ
        can_create_updated, sessions_used_updated, sessions_limit_updated, status_updated = auth_manager.check_free_session_limit(user_id)
        
        return jsonify({
            'success': True,
            'message': '×”×¡×©×Ÿ × ××—×§ ×‘×”×¦×œ×—×”',
            'session_info': {
                'sessions_used': sessions_used_updated,
                'sessions_limit': sessions_limit_updated,
                'status': status_updated,
                'can_create_new': can_create_updated
            }
        })
        
    except Exception as e:
        print(f"×©×’×™××” ×‘××—×™×§×ª ×¡×©×Ÿ: {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘××—×™×§×ª ×¡×©×Ÿ: {str(e)}'}), 500


# × ×ª×™×‘×™ ××™××•×ª ×—×“×©×™×
@app.route('/login')
def login_page():
    """×“×£ ×›× ×™×¡×”"""
    return render_template('login.html')

@app.route('/register')
def register_page():
    """×“×£ ×”×¨×©××”"""
    return render_template('register.html')

@app.route('/encryption-setup')
def encryption_setup_page():
    """×“×£ ×”×’×“×¨×ª ×”×¦×¤× ×”"""
    return render_template('encryption_setup.html')

@app.route('/encryption-dashboard')
@require_auth
def encryption_dashboard():
    """×œ×•×— ×‘×§×¨×ª ×”×¦×¤× ×” ×”×™×‘×¨×™×“×™×ª"""
    return render_template('encryption_dashboard.html')

@app.route('/sync-dashboard')
@require_auth_html
def sync_dashboard():
    """×œ×•×— ×‘×§×¨×ª ×¡× ×›×¨×•×Ÿ ×‘×™×Ÿ ××›×©×™×¨×™×"""
    try:
        if not SYNC_AVAILABLE:
            return render_template('sync_dashboard.html', sync_available=False, error_message='××¢×¨×›×ª ×¡× ×›×¨×•×Ÿ ×œ× ×–××™× ×” ×›×¨×’×¢')
        
        return render_template('sync_dashboard.html', sync_available=True)
    except Exception as e:
        print(f"âŒ ×©×’×™××” ×‘×˜×¢×™× ×ª ×“×£ ×¡× ×›×¨×•×Ÿ: {str(e)}")
        return render_template('sync_dashboard.html', sync_available=False, error_message=f'×©×’×™××” ×‘×˜×¢×™× ×ª ×“×£ ×¡× ×›×¨×•×Ÿ: {str(e)}')

@app.route('/auth/register', methods=['POST'])
def auth_register():
    """×¨×™×©×•× ××©×ª××© ×—×“×©"""
    try:
        data = request.json
        email = data.get('email', '').strip()
        password = data.get('password', '').strip()
        full_name = data.get('full_name', '').strip()
        
        if not email or not password or not full_name:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        auth_manager = AuthManager()
        success, result = auth_manager.register_user(email, password, full_name)
        
        if success:
            return jsonify({
                'success': True,
                'message': '×”×¨×©××” ×‘×”×¦×œ×—×”',
                'user_id': result
            })
        else:
            return jsonify({'error': result}), 400
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¨×™×©×•×: {str(e)}'}), 500

@app.route('/auth/login', methods=['POST'])
def auth_login():
    """×›× ×™×¡×ª ××©×ª××©"""
    try:
        data = request.json
        email = data.get('email', '').strip()
        password = data.get('password', '').strip()
        
        if not email or not password:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        auth_manager = AuthManager()
        success, result = auth_manager.login_user(email, password)
        
        if success:
            return jsonify({
                'success': True,
                'message': '×›× ×™×¡×” ×‘×”×¦×œ×—×”',
                'session_token': result['session_token'],
                'user_info': {
                    'email': result['email'],
                    'full_name': result['full_name']
                }
            })
        else:
            return jsonify({'error': result}), 401
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×›× ×™×¡×”: {str(e)}'}), 500


@app.route('/auth/verify', methods=['GET'])
def auth_verify():
    """××™××•×ª session token"""
    try:
        auth_manager = AuthManager()
        
        # ×‘×“×™×§×ª session token
        session_token = request.headers.get('Authorization')
        if session_token and session_token.startswith('Bearer '):
            session_token = session_token[7:]
        else:
            session_token = request.cookies.get('session_token')
        
        if not session_token:
            return jsonify({'error': '×—×¡×¨ ×˜×•×§×Ÿ ××™××•×ª'}), 401
        
        is_valid, user_data = auth_manager.verify_session(session_token)
        
        if is_valid:
            return jsonify({
                'valid': True,
                'user_info': user_data
            })
        else:
            return jsonify({'error': '×˜×•×§×Ÿ ×œ× ×ª×§×™×Ÿ'}), 401
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘××™××•×ª: {str(e)}'}), 500

@app.route('/auth/logout', methods=['POST'])
def auth_logout():
    """×™×¦×™××ª ××©×ª××©"""
    try:
        auth_manager = AuthManager()
        
        # ×‘×“×™×§×ª session token
        session_token = request.headers.get('Authorization')
        if session_token and session_token.startswith('Bearer '):
            session_token = session_token[7:]
        else:
            session_token = request.cookies.get('session_token')
        
        if session_token:
            auth_manager.logout_user(session_token)
        
        return jsonify({
            'success': True,
            'message': '×™×¦×™××” ×‘×”×¦×œ×—×”'
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×™×¦×™××”: {str(e)}'}), 500

@app.route('/auth/google-config', methods=['GET'])
def google_config():
    """×”×—×–×¨×ª ×”×’×“×¨×•×ª Google OAuth"""
    try:
        google_client_id = os.getenv('GOOGLE_CLIENT_ID', 'your-google-client-id-here')
        
        return jsonify({
            'client_id': google_client_id,
            'enabled': google_client_id != 'your-google-client-id-here'
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×”×’×“×¨×•×ª Google: {str(e)}'}), 500

@app.route('/auth/google', methods=['POST'])
def auth_google():
    """×›× ×™×¡×”/×”×¨×©××” ×¢× Google"""
    try:
        data = request.json
        google_token = data.get('google_token', '').strip()
        
        if not google_token:
            return jsonify({'error': '×—×¡×¨ ×˜×•×§×Ÿ Google'}), 400
        
        auth_manager = AuthManager()
        success, result = auth_manager.login_with_google(google_token)
        
        if success:
            return jsonify({
                'success': True,
                'message': '×›× ×™×¡×” ×¢× Google ×‘×”×¦×œ×—×”',
                'session_token': result['session_token'],
                'user_info': {
                    'email': result['email'],
                    'full_name': result['full_name']
                }
            })
        else:
            return jsonify({'error': result}), 400
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×›× ×™×¡×” ×¢× Google: {str(e)}'}), 500

@app.route('/auth/profile')
@require_auth
def auth_profile():
    """×¤×¨×•×¤×™×œ ××©×ª××©"""
    try:
        auth_manager = AuthManager()
        user_info = auth_manager.get_user_info(request.current_user['user_id'])
        
        if user_info:
            return jsonify({
                'success': True,
                'user_info': user_info
            })
        else:
            return jsonify({'error': '××©×ª××© ×œ× × ××¦×'}), 404
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¤×¨×•×¤×™×œ: {str(e)}'}), 500

@app.route('/auth/forgot-password', methods=['POST'])
def forgot_password():
    """×‘×§×©×ª ××™×¤×•×¡ ×¡×™×¡××”"""
    try:
        data = request.json
        email = data.get('email', '').strip()
        
        if not email:
            return jsonify({'error': '×—×¡×¨ ××™××™×™×œ'}), 400
        
        auth_manager = AuthManager()
        success, result = auth_manager.generate_password_reset_token(email)
        
        if success:
            # ×›××Ÿ ×ª×•×›×œ ×œ×”×•×¡×™×£ ×©×œ×™×—×ª ××™××™×™×œ ×¢× ×”×˜×•×§×Ÿ
            # ×œ×¢×ª ×¢×ª×” × ×—×–×™×¨ ××ª ×”×˜×•×§×Ÿ (×‘×¤×¨×•×“×§×©×Ÿ ×œ× ×œ×¢×©×•×ª ××ª ×–×”!)
            return jsonify({
                'success': True,
                'message': '×˜×•×§×Ÿ ××™×¤×•×¡ × ×•×¦×¨ ×‘×”×¦×œ×—×”',
                'reset_token': result  # ×‘×¤×¨×•×“×§×©×Ÿ - ×œ×©×œ×•×— ×‘××™××™×™×œ!
            })
        else:
            return jsonify({'error': result}), 400
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×‘×§×©×ª ××™×¤×•×¡: {str(e)}'}), 500

@app.route('/auth/reset-password', methods=['POST'])
def reset_password():
    """××™×¤×•×¡ ×¡×™×¡××” ×¢× ×˜×•×§×Ÿ"""
    try:
        data = request.json
        token = data.get('token', '').strip()
        new_password = data.get('new_password', '').strip()
        
        if not token or not new_password:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        if len(new_password) < 6:
            return jsonify({'error': '×”×¡×™×¡××” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 6 ×ª×•×•×™×'}), 400
        
        auth_manager = AuthManager()
        success, result = auth_manager.reset_password(token, new_password)
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 400
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘××™×¤×•×¡ ×¡×™×¡××”: {str(e)}'}), 500

@app.route('/admin/users')
@require_auth
def admin_get_users():
    """×§×‘×œ×ª ×¨×©×™××ª ××©×ª××©×™× (×œ×× ×”×œ×™×)"""
    try:
        # ×‘×“×™×§×” ×× ×”××©×ª××© ×”×•× ×× ×”×œ (×œ×¢×ª ×¢×ª×” ×›×œ ××©×ª××© ×™×›×•×œ ×œ×¨××•×ª)
        # ×‘×¢×ª×™×“ ×ª×•×›×œ ×œ×”×•×¡×™×£ ×‘×“×™×§×ª ×”×¨×©××•×ª
        
        auth_manager = AuthManager()
        users = auth_manager.get_all_users()
        
        return jsonify({
            'success': True,
            'users': users,
            'total_users': len(users)
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¨×©×™××ª ××©×ª××©×™×: {str(e)}'}), 500

# × ×ª×™×‘×™ ×”×¦×¤× ×” ×”×™×‘×¨×™×“×™×ª ×—×“×©×™×
@app.route('/encryption/setup', methods=['POST'])
@require_auth
def setup_encryption():
    """×”×’×“×¨×ª ××¤×ª×— ×”×¦×¤× ×” ××™×©×™ ×œ××˜×¤×œ"""
    try:
        data = request.json
        master_password = data.get('master_password', '').strip()
        
        if not master_password:
            return jsonify({'error': '×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××ª ×”×¦×¤× ×”'}), 400
        
        if len(master_password) < 8:
            return jsonify({'error': '×¡×™×¡××ª ×”×¦×¤× ×” ×—×™×™×‘×ª ×œ×”×›×™×œ ×œ×¤×—×•×ª 8 ×ª×•×•×™×'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        success, result = encryption_manager.generate_user_encryption_key(user_id, master_password)
        
        if success:
            return jsonify({
                'success': True,
                'message': '××¤×ª×— ×”×¦×¤× ×” ××™×©×™ × ×•×¦×¨ ×‘×”×¦×œ×—×”',
                'encryption_key': result  # ×‘×¤×¨×•×“×§×©×Ÿ - ×œ× ×œ×”×—×–×™×¨ ××ª ×”××¤×ª×—!
            })
        else:
            return jsonify({'error': result}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×”×’×“×¨×ª ×”×¦×¤× ×”: {str(e)}'}), 500

@app.route('/encryption/verify', methods=['POST'])
@require_auth
def verify_encryption_password():
    """××™××•×ª ×¡×™×¡××ª ×”×¦×¤× ×” ×©×œ ×”××˜×¤×œ"""
    try:
        data = request.json
        master_password = data.get('master_password', '').strip()
        
        if not master_password:
            return jsonify({'error': '×™×© ×œ×”×–×™×Ÿ ×¡×™×¡××ª ×”×¦×¤× ×”'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        success, result = encryption_manager.verify_user_password(user_id, master_password)
        
        if success:
            return jsonify({
                'success': True,
                'message': '×¡×™×¡××ª ×”×¦×¤× ×” × ×›×•× ×”',
                'encryption_key': result  # ×‘×¤×¨×•×“×§×©×Ÿ - ×œ× ×œ×”×—×–×™×¨ ××ª ×”××¤×ª×—!
            })
        else:
            return jsonify({'error': result}), 401
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘××™××•×ª ×”×¦×¤× ×”: {str(e)}'}), 500

@app.route('/encryption/save-session', methods=['POST'])
@require_auth
def save_encrypted_session():
    """×©××™×¨×ª ×¡×©×Ÿ ××•×¦×¤×Ÿ ×‘×¢× ×Ÿ"""
    try:
        data = request.json
        session_data = data.get('session_data', {})
        encryption_key = data.get('encryption_key', '').strip()
        
        if not session_data or not encryption_key:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        # ×”×¦×¤× ×ª ×”×¡×©×Ÿ
        success, encrypted_data = encryption_manager.encrypt_session_data(
            user_id, session_data, encryption_key
        )
        
        if not success:
            return jsonify({'error': encrypted_data}), 500
        
        # ×©××™×¨×” ×‘×¢× ×Ÿ
        session_date = session_data.get('session_date', datetime.datetime.now().strftime("%Y-%m-%d"))
        success, session_id = encryption_manager.save_encrypted_session(
            user_id, encrypted_data, session_date
        )
        
        if success:
            return jsonify({
                'success': True,
                'message': '×¡×©×Ÿ × ×©××¨ ×‘×¢× ×Ÿ ×‘×¦×•×¨×” ××•×¦×¤× ×ª',
                'session_id': session_id
            })
        else:
            return jsonify({'error': session_id}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×©××™×¨×ª ×¡×©×Ÿ ××•×¦×¤×Ÿ: {str(e)}'}), 500

@app.route('/encryption/sessions')
@require_auth
def get_encrypted_sessions():
    """×§×‘×œ×ª ×›×œ ×”×¡×©× ×™× ×”××•×¦×¤× ×™× ×©×œ ×”××˜×¤×œ"""
    try:
        user_id = request.current_user['user_id']
        patient_name_filter = request.args.get('patient_name')
        
        encryption_manager = EncryptionManager()
        success, sessions = encryption_manager.get_user_encrypted_sessions(
            user_id, patient_name_filter
        )
        
        if success:
            return jsonify({
                'success': True,
                'sessions': sessions,
                'total_sessions': len(sessions)
            })
        else:
            return jsonify({'error': sessions}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¡×©× ×™× ××•×¦×¤× ×™×: {str(e)}'}), 500

@app.route('/encryption/decrypt-session', methods=['POST'])
@require_auth
def decrypt_session():
    """×¤×¢× ×•×— ×¡×©×Ÿ ××•×¦×¤×Ÿ"""
    try:
        data = request.json
        session_id = data.get('session_id', '').strip()
        encryption_key = data.get('encryption_key', '').strip()
        
        if not session_id or not encryption_key:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        # ×§×‘×œ×ª ×”×¡×©×Ÿ ×”××•×¦×¤×Ÿ
        success, sessions = encryption_manager.get_user_encrypted_sessions(user_id)
        if not success:
            return jsonify({'error': sessions}), 500
        
        # ×—×™×¤×•×© ×”×¡×©×Ÿ ×”×¡×¤×¦×™×¤×™
        target_session = None
        for session in sessions:
            if session['session_id'] == session_id:
                target_session = session
                break
        
        if not target_session:
            return jsonify({'error': '×¡×©×Ÿ ×œ× × ××¦×'}), 404
        
        # ×¤×¢× ×•×— ×”×¡×©×Ÿ
        success, decrypted_data = encryption_manager.decrypt_session_data(
            target_session, encryption_key
        )
        
        if success:
            return jsonify({
                'success': True,
                'session_data': decrypted_data
            })
        else:
            return jsonify({'error': decrypted_data}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¤×¢× ×•×— ×¡×©×Ÿ: {str(e)}'}), 500

@app.route('/encryption/sync', methods=['POST'])
@require_auth
def sync_encrypted_sessions():
    """×¡× ×›×¨×•×Ÿ ×¡×©× ×™× ××•×¦×¤× ×™× ×œ×¢× ×Ÿ"""
    try:
        data = request.json
        encryption_key = data.get('encryption_key', '').strip()
        
        if not encryption_key:
            return jsonify({'error': '×—×¡×¨ ××¤×ª×— ×”×¦×¤× ×”'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        success, result = encryption_manager.sync_sessions_to_cloud(user_id, encryption_key)
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ: {str(e)}'}), 500

@app.route('/encryption/backup', methods=['POST'])
@require_auth
def export_encrypted_backup():
    """×™×¦×•× ×’×™×‘×•×™ ××•×¦×¤×Ÿ ×©×œ ×›×œ ×”×¡×©× ×™×"""
    try:
        data = request.json
        encryption_key = data.get('encryption_key', '').strip()
        
        if not encryption_key:
            return jsonify({'error': '×—×¡×¨ ××¤×ª×— ×”×¦×¤× ×”'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        success, backup_data = encryption_manager.export_encrypted_backup(user_id, encryption_key)
        
        if success:
            return jsonify({
                'success': True,
                'backup_data': backup_data,
                'message': '×’×™×‘×•×™ ××•×¦×¤×Ÿ × ×•×¦×¨ ×‘×”×¦×œ×—×”'
            })
        else:
            return jsonify({'error': backup_data}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×™×¦×™×¨×ª ×’×™×‘×•×™: {str(e)}'}), 500

@app.route('/encryption/restore', methods=['POST'])
@require_auth
def import_encrypted_backup():
    """×™×‘×•× ×’×™×‘×•×™ ××•×¦×¤×Ÿ"""
    try:
        data = request.json
        backup_data = data.get('backup_data', '').strip()
        encryption_key = data.get('encryption_key', '').strip()
        
        if not backup_data or not encryption_key:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        success, result = encryption_manager.import_encrypted_backup(
            user_id, backup_data, encryption_key
        )
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×™×‘×•× ×’×™×‘×•×™: {str(e)}'}), 500

@app.route('/encryption/stats')
@require_auth
def get_encryption_stats():
    """×¡×˜×˜×™×¡×˜×™×§×•×ª ×”×¦×¤× ×” ×œ××˜×¤×œ"""
    try:
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        success, stats = encryption_manager.get_encryption_stats(user_id)
        
        if success:
            return jsonify({
                'success': True,
                'stats': stats
            })
        else:
            return jsonify({'error': stats}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª: {str(e)}'}), 500

@app.route('/encryption/delete-session', methods=['DELETE'])
@require_auth
def delete_encrypted_session():
    """××—×™×§×ª ×¡×©×Ÿ ××•×¦×¤×Ÿ"""
    try:
        data = request.json
        session_id = data.get('session_id', '').strip()
        
        if not session_id:
            return jsonify({'error': '×—×¡×¨ ××–×”×” ×¡×©×Ÿ'}), 400
        
        user_id = request.current_user['user_id']
        encryption_manager = EncryptionManager()
        
        success, result = encryption_manager.delete_encrypted_session(user_id, session_id)
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 404
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘××—×™×§×ª ×¡×©×Ÿ: {str(e)}'}), 500

# × ×ª×™×‘×™ ×× ×•×™×™× ×•×ª×©×œ×•××™× ×—×“×©×™×
@app.route('/subscription/status')
@require_auth
def get_subscription_status():
    """×§×‘×œ×ª ×¡×˜×˜×•×¡ ×× ×•×™ ×©×œ ×”××©×ª××©"""
    try:
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        subscription_status = auth_manager.get_subscription_status(user_id)
        
        if subscription_status:
            return jsonify({
                'success': True,
                'subscription': subscription_status
            })
        else:
            return jsonify({'error': '×œ× × ××¦× ××™×“×¢ ×¢×œ ×”×× ×•×™'}), 404
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¡×˜×˜×•×¡ ×× ×•×™: {str(e)}'}), 500

@app.route('/subscription/check-session-limit')
@require_auth
def check_session_limit():
    """×‘×“×™×§×ª ××’×‘×œ×ª ×¡×©× ×™× ×—×™× ××™×™×"""
    try:
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        can_create, sessions_used, sessions_limit, status = auth_manager.check_free_session_limit(user_id)
        
        return jsonify({
            'success': True,
            'can_create_session': can_create,
            'sessions_used': sessions_used,
            'sessions_limit': sessions_limit,
            'status': status,
            'sessions_remaining': max(0, sessions_limit - sessions_used) if sessions_limit > 0 else -1
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×‘×“×™×§×ª ××’×‘×œ×ª ×¡×©× ×™×: {str(e)}'}), 500

@app.route('/subscription/increment-session', methods=['POST'])
@require_auth
def increment_session_counter():
    """×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™× ×—×™× ××™×™×"""
    try:
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        # ×‘×“×™×§×” ×× ×”××©×ª××© ×‘×× ×•×™ ×—×™× ××™
        can_create, sessions_used, sessions_limit, status = auth_manager.check_free_session_limit(user_id)
        
        if status == 'trial':
            success = auth_manager.increment_free_session(user_id)
            if success:
                return jsonify({
                    'success': True,
                    'message': '××•× ×” ×¡×©× ×™× ×¢×•×“×›×Ÿ',
                    'sessions_used': sessions_used + 1,
                    'sessions_limit': sessions_limit
                })
            else:
                return jsonify({'error': '×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™×'}), 500
        else:
            return jsonify({
                'success': True,
                'message': '×× ×•×™ ×‘×ª×©×œ×•× - ××™×Ÿ ×¦×•×¨×š ×‘×¢×“×›×•×Ÿ ××•× ×”',
                'sessions_used': -1,
                'sessions_limit': -1
            })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¢×“×›×•×Ÿ ××•× ×” ×¡×©× ×™×: {str(e)}'}), 500

@app.route('/subscription/upgrade', methods=['POST'])
@require_auth
def create_upgrade_session():
    """×™×¦×™×¨×ª ×¡×©×Ÿ ×©×“×¨×•×’ ×œ×× ×•×™ ×¤×¨×™××™×•×"""
    try:
        data = request.json
        plan_type = data.get('plan_type', 'premium')
        
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        success, payment_info = auth_manager.create_payment_session(user_id, plan_type)
        
        if success:
            return jsonify({
                'success': True,
                'payment_session': payment_info,
                'message': '×¡×©×Ÿ ×ª×©×œ×•× × ×•×¦×¨ ×‘×”×¦×œ×—×”'
            })
        else:
            return jsonify({'error': payment_info}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×™×¦×™×¨×ª ×¡×©×Ÿ ×©×“×¨×•×’: {str(e)}'}), 500

@app.route('/subscription/complete-payment', methods=['POST'])
@require_auth
def complete_payment_session():
    """×”×©×œ××ª ×ª×©×œ×•× ×•×©×“×¨×•×’ ×”××©×ª××©"""
    try:
        data = request.json
        payment_session_id = data.get('payment_session_id', '').strip()
        payment_method = data.get('payment_method', 'manual')
        
        if not payment_session_id:
            return jsonify({'error': '×—×¡×¨ ××–×”×” ×¡×©×Ÿ ×ª×©×œ×•×'}), 400
        
        auth_manager = AuthManager()
        success, result = auth_manager.complete_payment(payment_session_id, payment_method)
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 400
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×”×©×œ××ª ×ª×©×œ×•×: {str(e)}'}), 500

@app.route('/subscription/upgrade-demo', methods=['POST'])
@require_auth
def demo_upgrade():
    """×©×“×¨×•×’ ×“××• ×œ×× ×•×™ ×¤×¨×™××™×•× (×œ×‘×“×™×§×•×ª)"""
    try:
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        success, result = auth_manager.upgrade_to_premium(user_id, 'demo')
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×©×“×¨×•×’ ×“××•: {str(e)}'}), 500

@app.route('/subscription/reset-sessions-counter', methods=['POST'])
@require_auth
def reset_sessions_counter():
    """××™×¤×•×¡ ××•× ×” ×¡×©× ×™× ×—×™× ××™×™× (×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª)"""
    try:
        user_id = request.current_user['user_id']
        auth_manager = AuthManager()
        
        success = auth_manager.reset_free_sessions_counter(user_id)
        
        if success:
            return jsonify({
                'success': True,
                'message': '××•× ×” ×”×¡×©× ×™× ××•×¤×¡ ×‘×”×¦×œ×—×”'
            })
        else:
            return jsonify({'error': '×©×’×™××” ×‘××™×¤×•×¡ ××•× ×” ×”×¡×©× ×™×'}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘××™×¤×•×¡ ××•× ×”: {str(e)}'}), 500

@app.route('/api/limits')
@require_auth
def get_server_limits():
    """×§×‘×œ×ª ××’×‘×œ×•×ª ××”×’×“×¨×•×ª ×”×©×¨×ª (ENV)"""
    try:
        # ×§×¨×™××ª ×”××’×‘×œ×•×ª ××§×•×‘×¥ .env
        max_patients = int(os.getenv('FREE_MAX_PATIENTS', '1'))
        max_sessions = int(os.getenv('FREE_MAX_SESSIONS', '5'))
        
        return jsonify({
            'success': True,
            'max_patients': max_patients,
            'max_sessions': max_sessions,
            'source': 'server_env'
        })
        
    except Exception as e:
        # ×‘×¨×™×¨×ª ××—×“×œ ×‘××§×¨×” ×©×œ ×©×’×™××”
        return jsonify({
            'success': True,
            'max_patients': 1,
            'max_sessions': 5,
            'source': 'default_fallback',
            'error': str(e)
        })

@app.route('/payment/<payment_session_id>')
def payment_page(payment_session_id):
    """×“×£ ×ª×©×œ×•×"""
    try:
        # ×›××Ÿ ×ª×•×›×œ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×‘×“×™×§×ª ×ª×•×§×£ ×”×¡×©×Ÿ
        # ×•×œ×”×¦×™×’ ×“×£ ×ª×©×œ×•× ××•×ª××
        return render_template('payment.html', payment_session_id=payment_session_id)
        
    except Exception as e:
        return f"×©×’×™××” ×‘×˜×¢×™× ×ª ×“×£ ×ª×©×œ×•×: {str(e)}", 500

# × ×ª×™×‘×™ ×¡× ×›×¨×•×Ÿ ×××•×‘×˜×— ×‘×™×Ÿ ××›×©×™×¨×™×
@app.route('/sync/register-device', methods=['POST'])
@require_auth
def register_device():
    """×¨×™×©×•× ××›×©×™×¨ ×—×“×© ×œ××˜×¤×œ"""
    try:
        if not SYNC_AVAILABLE:
            return jsonify({'error': '××¢×¨×›×ª ×¡× ×›×¨×•×Ÿ ×œ× ×–××™× ×”'}), 503
            
        data = request.json
        device_name = data.get('device_name', '').strip()
        device_type = data.get('device_type', '').strip()
        
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        success, result = sync_manager.register_device(user_id, device_name, device_type)
        
        if success:
            return jsonify({
                'success': True,
                'message': '××›×©×™×¨ × ×¨×©× ×‘×”×¦×œ×—×”',
                'device_info': result
            })
        else:
            return jsonify({'error': result}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¨×™×©×•× ××›×©×™×¨: {str(e)}'}), 500

@app.route('/sync/devices')
@require_auth
def get_user_devices():
    """×§×‘×œ×ª ×¨×©×™××ª ××›×©×™×¨×™× ××•×¨×©×™× ×œ××˜×¤×œ"""
    try:
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        success, devices = sync_manager.get_user_devices(user_id)
        
        if success:
            return jsonify({
                'success': True,
                'devices': devices,
                'total_devices': len(devices)
            })
        else:
            return jsonify({'error': devices}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¨×©×™××ª ××›×©×™×¨×™×: {str(e)}'}), 500

@app.route('/sync/session', methods=['POST'])
@require_auth
def sync_session_to_cloud():
    """×¡× ×›×¨×•×Ÿ ×¡×©×Ÿ ×‘×•×“×“ ×œ×¢× ×Ÿ"""
    try:
        data = request.json
        session_data = data.get('session_data', {})
        encryption_key = data.get('encryption_key', '').strip()
        
        if not session_data or not encryption_key:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        success, session_id = sync_manager.sync_session_to_cloud(
            user_id, session_data, encryption_key
        )
        
        if success:
            return jsonify({
                'success': True,
                'message': '×¡×©×Ÿ ×¡×•× ×›×¨×Ÿ ×‘×”×¦×œ×—×”',
                'session_id': session_id
            })
        else:
            return jsonify({'error': session_id}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ×¡×©×Ÿ: {str(e)}'}), 500

@app.route('/sync/all-sessions', methods=['POST'])
@require_auth
def sync_all_sessions():
    """×¡× ×›×¨×•×Ÿ ×›×œ ×”×¡×©× ×™× ×œ×¢× ×Ÿ"""
    try:
        data = request.json
        encryption_key = data.get('encryption_key', '').strip()
        
        if not encryption_key:
            return jsonify({'error': '×—×¡×¨ ××¤×ª×— ×”×¦×¤× ×”'}), 400
        
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        success, result = sync_manager.sync_all_sessions_to_cloud(user_id, encryption_key)
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ×›×œ×œ×™: {str(e)}'}), 500

@app.route('/sync/from-cloud', methods=['POST'])
@require_auth
def sync_from_cloud():
    """×¡× ×›×¨×•×Ÿ ×¡×©× ×™× ××”×¢× ×Ÿ ×œ××›×©×™×¨ ×”× ×•×›×—×™"""
    try:
        data = request.json
        encryption_key = data.get('encryption_key', '').strip()
        
        if not encryption_key:
            return jsonify({'error': '×—×¡×¨ ××¤×ª×— ×”×¦×¤× ×”'}), 400
        
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        success, result = sync_manager.sync_from_cloud(user_id, encryption_key)
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ××”×¢× ×Ÿ: {str(e)}'}), 500

@app.route('/sync/status')
@require_auth
def get_sync_status():
    """×§×‘×œ×ª ×¡×˜×˜×•×¡ ×¡× ×›×¨×•×Ÿ"""
    try:
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        success, status = sync_manager.get_sync_status(user_id)
        
        if success:
            return jsonify({
                'success': True,
                'sync_status': status
            })
        else:
            return jsonify({'error': status}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¡×˜×˜×•×¡ ×¡× ×›×¨×•×Ÿ: {str(e)}'}), 500

@app.route('/sync/conflicts')
@require_auth
def get_sync_conflicts():
    """×§×‘×œ×ª ×¨×©×™××ª ×§×•× ×¤×œ×™×§×˜×™× ×‘×¡× ×›×¨×•×Ÿ"""
    try:
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        # ×§×‘×œ×ª ×§×•× ×¤×œ×™×§×˜×™× ×¤×ª×•×—×™×
        conn = sqlite3.connect(sync_manager.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT id, session_id, conflict_type, local_data, remote_data, created_at
            FROM sync_conflicts 
            WHERE user_id = ? AND resolved = 0
            ORDER BY created_at DESC
        ''', (user_id,))
        
        conflicts = []
        for row in cursor.fetchall():
            conflicts.append({
                'conflict_id': row[0],
                'session_id': row[1],
                'conflict_type': row[2],
                'local_data': json.loads(row[3]) if row[3] else {},
                'remote_data': json.loads(row[4]) if row[4] else {},
                'created_at': row[5]
            })
        
        conn.close()
        
        return jsonify({
            'success': True,
            'conflicts': conflicts,
            'total_conflicts': len(conflicts)
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×§×•× ×¤×œ×™×§×˜×™×: {str(e)}'}), 500

@app.route('/sync/resolve-conflict', methods=['POST'])
@require_auth
def resolve_sync_conflict():
    """×¤×ª×¨×•×Ÿ ×§×•× ×¤×œ×™×§×˜ ×¡× ×›×¨×•×Ÿ"""
    try:
        data = request.json
        conflict_id = data.get('conflict_id')
        resolution_action = data.get('resolution_action', '').strip()
        
        if not conflict_id or not resolution_action:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        if resolution_action not in ['keep_local', 'keep_remote', 'merge']:
            return jsonify({'error': '×¤×¢×•×œ×ª ×¤×ª×¨×•×Ÿ ×œ× ×ª×§×™× ×”'}), 400
        
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        success, result = sync_manager.resolve_sync_conflict(
            user_id, conflict_id, resolution_action
        )
        
        if success:
            return jsonify({
                'success': True,
                'message': result
            })
        else:
            return jsonify({'error': result}), 400
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¤×ª×¨×•×Ÿ ×§×•× ×¤×œ×™×§×˜: {str(e)}'}), 500

@app.route('/sync/synced-sessions')
@require_auth
def get_synced_sessions():
    """×§×‘×œ×ª ×›×œ ×”×¡×©× ×™× ×”××¡×•× ×›×¨× ×™×"""
    try:
        user_id = request.current_user['user_id']
        patient_name_filter = request.args.get('patient_name')
        
        sync_manager = CloudSyncManager()
        
        # ×§×‘×œ×ª ×¡×©× ×™× ××¡×•× ×›×¨× ×™×
        conn = sqlite3.connect(sync_manager.db_path)
        cursor = conn.cursor()
        
        if patient_name_filter:
            # ×—×™×¤×•×© ×œ×¤×™ hash ×©×œ ×©× ×”××˜×•×¤×œ
            patient_hash = hashlib.sha256(f"{user_id}_{patient_name_filter}".encode('utf-8')).hexdigest()
            cursor.execute('''
                SELECT session_id, patient_name_hash, session_date, 
                       metadata, device_origin, last_modified, sync_status
                FROM synced_sessions 
                WHERE user_id = ? AND patient_name_hash = ?
                ORDER BY session_date DESC, last_modified DESC
            ''', (user_id, patient_hash))
        else:
            cursor.execute('''
                SELECT session_id, patient_name_hash, session_date, 
                       metadata, device_origin, last_modified, sync_status
                FROM synced_sessions 
                WHERE user_id = ?
                ORDER BY session_date DESC, last_modified DESC
            ''', (user_id,))
        
        sessions = []
        for row in cursor.fetchall():
            metadata = json.loads(row[3]) if row[3] else {}
            sessions.append({
                'session_id': row[0],
                'patient_name_hash': row[1],
                'session_date': row[2],
                'metadata': metadata,
                'device_origin': row[4],
                'last_modified': row[5],
                'sync_status': row[6],
                'word_count': metadata.get('word_count', 0),
                'audio_filename': metadata.get('audio_filename', ''),
                'created_at': metadata.get('created_at', '')
            })
        
        conn.close()
        
        return jsonify({
            'success': True,
            'sessions': sessions,
            'total_sessions': len(sessions)
        })
        
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×§×‘×œ×ª ×¡×©× ×™× ××¡×•× ×›×¨× ×™×: {str(e)}'}), 500

@app.route('/sync/decrypt-synced-session', methods=['POST'])
@require_auth
def decrypt_synced_session():
    """×¤×¢× ×•×— ×¡×©×Ÿ ××¡×•× ×›×¨×Ÿ"""
    try:
        data = request.json
        session_id = data.get('session_id', '').strip()
        encryption_key = data.get('encryption_key', '').strip()
        
        if not session_id or not encryption_key:
            return jsonify({'error': '×—×¡×¨×™× × ×ª×•× ×™× × ×“×¨×©×™×'}), 400
        
        user_id = request.current_user['user_id']
        sync_manager = CloudSyncManager()
        
        # ×§×‘×œ×ª ×”×¡×©×Ÿ ×”××¡×•× ×›×¨×Ÿ
        conn = sqlite3.connect(sync_manager.db_path)
        cursor = conn.cursor()
        
        cursor.execute('''
            SELECT session_id, patient_name_hash, session_date, 
                   encrypted_data, metadata
            FROM synced_sessions 
            WHERE user_id = ? AND session_id = ?
        ''', (user_id, session_id))
        
        result = cursor.fetchone()
        conn.close()
        
        if not result:
            return jsonify({'error': '×¡×©×Ÿ ×œ× × ××¦×'}), 404
        
        session = {
            'session_id': result[0],
            'patient_name_hash': result[1],
            'session_date': result[2],
            'encrypted_data': result[3],
            'metadata': result[4]
        }
        
        # ×¤×¢× ×•×— ×”×¡×©×Ÿ
        encryption_manager = EncryptionManager()
        success, decrypted_data = encryption_manager.decrypt_session_data(
            session, encryption_key
        )
        
        if success:
            return jsonify({
                'success': True,
                'session_data': decrypted_data
            })
        else:
            return jsonify({'error': decrypted_data}), 500
            
    except Exception as e:
        return jsonify({'error': f'×©×’×™××” ×‘×¤×¢× ×•×— ×¡×©×Ÿ ××¡×•× ×›×¨×Ÿ: {str(e)}'}), 500

# × ×ª×™×‘ ××©×•×œ×‘ - ×ª××œ×•×œ + ×”×¦×¤× ×” ××•×˜×•××˜×™×ª
@app.route('/transcribe-encrypted', methods=['POST'])
@require_auth
def transcribe_and_encrypt():
    """×ª××œ×•×œ ×¢× ×”×¦×¤× ×” ××•×˜×•××˜×™×ª ×•×¡× ×›×¨×•×Ÿ ×œ×¢× ×Ÿ"""
    try:
        if 'audio' not in request.files:
            return jsonify({'error': '×œ× × ×‘×—×¨ ×§×•×‘×¥ ×©××¢'}), 400
        
        audio_file = request.files['audio']
        patient_name = request.form.get('patient_name', '').strip()
        session_date = request.form.get('session_date', '')
        quality_mode = request.form.get('quality_mode', 'balanced')
        encryption_key = request.form.get('encryption_key', '').strip()
        
        # ×× ×œ× ×”×•×–×Ÿ ×©× ××˜×•×¤×œ, ×”×©×ª××© ×‘××™×™×œ ×”××˜×¤×œ ×›×‘×¨×™×¨×ª ××—×“×œ
        if not patient_name:
            user_email = request.current_user.get('email', 'unknown@example.com')
            patient_name = user_email
        
        if not encryption_key:
            return jsonify({'error': '×—×¡×¨ ××¤×ª×— ×”×¦×¤× ×”'}), 400
        
        if audio_file.filename == '':
            return jsonify({'error': '×œ× × ×‘×—×¨ ×§×•×‘×¥'}), 400
        
        if not allowed_file(audio_file.filename):
            return jsonify({'error': '×¡×•×’ ×§×•×‘×¥ ×œ× × ×ª××š'}), 400
        
        user_id = request.current_user['user_id']
        
        # ××™××•×ª ××¤×ª×— ×”×¦×¤× ×”
        encryption_manager = EncryptionManager()
        success, verified_key = encryption_manager.verify_user_password(user_id, encryption_key)
        if not success:
            return jsonify({'error': '×¡×™×¡××ª ×”×¦×¤× ×” ×©×’×•×™×”'}), 401
        
        # ×¨×™×©×•× ×¤×¢×•×œ×ª ×¤×¨×˜×™×•×ª
        log_privacy_action("hybrid_transcription_start", patient_name, 
                          f"×”×ª×—×œ×ª ×ª××œ×•×œ ×”×™×‘×¨×™×“×™ ××•×¦×¤×Ÿ ×¢× {quality_mode}")
        
        # ×ª××œ×•×œ ×¨×’×™×œ (×›××• ×‘×¤×•× ×§×¦×™×” ×”×§×™×™××ª)
        file_extension = os.path.splitext(audio_file.filename)[1] or '.wav'
        temp_path = None
        
        try:
            # ×™×¦×™×¨×ª ××¤×ª×— ×”×¦×¤× ×” ×–×× ×™
            temp_key = generate_temp_encryption_key()
            
            # ×§×¨×™××ª ×”×§×•×‘×¥ ×œ×–×™×›×¨×•×Ÿ
            audio_data = audio_file.read()
            
            # ×™×¦×™×¨×ª ×§×•×‘×¥ ×–×× ×™ ×œ×ª××œ×•×œ
            with tempfile.NamedTemporaryFile(delete=False, suffix=file_extension) as temp_file:
                temp_file.write(audio_data)
                temp_file.flush()
                os.fsync(temp_file.fileno())
                temp_path = temp_file.name
            
            # ×ª××œ×•×œ (×œ×¤×™ quality_mode)
            if quality_mode == 'assemblyai':
                result = transcribe_with_assemblyai(temp_path, language='he')
                transcription_method = "AssemblyAI"
            elif quality_mode == 'faster-whisper':
                result = transcribe_with_faster_whisper(temp_path, language='he')
                transcription_method = "Faster-Whisper"
            else:
                result = transcribe_with_assemblyai(temp_path, language='he')
                transcription_method = "AssemblyAI (×‘×¨×™×¨×ª ××—×“×œ)"
            
            original_text = result["text"].strip()
            if not original_text:
                return jsonify({'error': '×œ× ×–×•×”×” ×˜×§×¡×˜ ×‘×§×•×‘×¥ ×”×©××¢'}), 400
            
            # ×ª×™×§×•×Ÿ ×˜×§×¡×˜
            corrected_text = simple_text_cleanup(original_text)
            
            # ×™×¦×™×¨×ª × ×ª×•× ×™ ×”×¡×©×Ÿ
            session_data = {
                "patient_name": patient_name,
                "session_date": session_date if session_date else datetime.datetime.now().strftime("%Y-%m-%d"),
                "audio_filename": audio_file.filename,
                "original_transcript": original_text,
                "corrected_transcript": corrected_text,
                "created_at": datetime.datetime.now().isoformat(),
                "word_count": len(corrected_text.split()),
                "quality_mode": quality_mode,
                "transcription_method": transcription_method
            }
            
            # ×”×¦×¤× ×” ×•×©××™×¨×” ×‘×¢× ×Ÿ
            success, encrypted_data = encryption_manager.encrypt_session_data(
                user_id, session_data, verified_key
            )
            
            if not success:
                return jsonify({'error': f'×©×’×™××” ×‘×”×¦×¤× ×”: {encrypted_data}'}), 500
            
            success, session_id = encryption_manager.save_encrypted_session(
                user_id, encrypted_data, session_data['session_date']
            )
            
            if not success:
                return jsonify({'error': f'×©×’×™××” ×‘×©××™×¨×”: {session_id}'}), 500
            
            # ×¨×™×©×•× ×”×©×œ××”
            log_privacy_action("hybrid_transcription_complete", patient_name, 
                              f"×ª××œ×•×œ ×”×™×‘×¨×™×“×™ ×”×•×©×œ× - ×¡×©×Ÿ {session_id[:8]}...")
            
            return jsonify({
                'success': True,
                'original_transcript': original_text,
                'corrected_transcript': corrected_text,
                'patient_name': patient_name,
                'session_date': session_data['session_date'],
                'audio_filename': audio_file.filename,
                'quality_mode': quality_mode,
                'word_count': len(corrected_text.split()),
                'session_id': session_id,
                'encrypted': True,
                'message': '×ª××œ×•×œ ×”×•×©×œ× ×•× ×©××¨ ×‘×¢× ×Ÿ ×‘×¦×•×¨×” ××•×¦×¤× ×ª'
            })
            
        finally:
            # ××—×™×§×” ×××•×‘×˜×—×ª
            if temp_path and os.path.exists(temp_path):
                secure_delete_file(temp_path)
            
            # × ×™×§×•×™ ×–×™×›×¨×•×Ÿ
            if 'audio_data' in locals():
                secure_memory_wipe(audio_data)
            if 'temp_key' in locals():
                secure_memory_wipe(temp_key)
            
            log_privacy_action("hybrid_secure_cleanup", patient_name, 
                              "× ×™×§×•×™ ×××•×‘×˜×— ×©×œ ×ª××œ×•×œ ×”×™×‘×¨×™×“×™ ×”×•×©×œ×")
    
    except Exception as e:
        print(f"×©×’×™××” ×‘×ª××œ×•×œ ×”×™×‘×¨×™×“×™: {str(e)}")
        return jsonify({'error': f'×©×’×™××” ×‘×ª××œ×•×œ ×”×™×‘×¨×™×“×™: {str(e)}'}), 500

if __name__ == '__main__':
    def get_local_ip():
        try:
            with socket.socket(socket.AF_INET, socket.SOCK_DGRAM) as s:
                s.connect(("8.8.8.8", 80))
                return s.getsockname()[0]
        except:
            return "localhost"
    
    # ×§×¨×™××ª ×”×’×“×¨×•×ª ××§×•×‘×¥ .env
    HOST = os.getenv('HOST', '0.0.0.0')
    PORT = int(os.getenv('PORT', '5000'))
    DEBUG = os.getenv('DEBUG', 'True').lower() == 'true'
    
    local_ip = get_local_ip()
    
    print("ğŸ¤ ××¢×¨×›×ª ×ª××œ×•×œ ×œ××˜×¤×œ×™×")
    print(f"ğŸŒ ×’×™×©×” ××”××—×©×‘: http://localhost:{PORT}")
    if local_ip != "localhost":
        print(f"ğŸ“± ×’×™×©×” ××”×˜×œ×¤×•×Ÿ: http://{local_ip}:{PORT}")
    
    # ×”×¦×’×ª ××¦×‘ AssemblyAI
    if ASSEMBLYAI_API_KEY and ASSEMBLYAI_API_KEY != 'your-assemblyai-api-key-here':
        print("âœ… AssemblyAI API Key ××•×’×“×¨")
    else:
        print("âš ï¸  AssemblyAI API Key ×œ× ××•×’×“×¨ - ×™×¢×‘×•×¨ ×œ×’×™×‘×•×™ Whisper")
    
    print("ğŸ”¥ ××•×›×Ÿ ×œ×¤×¢×•×œ×”!")
    
    app.run(debug=DEBUG, host=HOST, port=PORT)

# For production deployment (Gunicorn will use this)
# This ensures the app object is available for Gunicorn
application = app
